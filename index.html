<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ù†ØµØ© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© - Pi</title>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --p:#7f5cff;
  --bg:#0f0f1a;
  --card:rgba(255,255,255,.08);
}
*{box-sizing:border-box;font-family:Tajawal,system-ui}
body{margin:0;background:var(--bg);color:#fff}
header{padding:15px;text-align:center;font-size:20px;background:#141428}
.container{padding:12px}
.card{background:var(--card);padding:12px;border-radius:14px;margin-bottom:10px}
.btn{background:var(--p);border:none;color:#fff;padding:10px 14px;border-radius:10px}
input,textarea{width:100%;padding:8px;border-radius:8px;border:none}
.ads img{width:100%;border-radius:10px}
.badge{background:gold;color:#000;padding:3px 8px;border-radius:8px;font-size:12px}
.chat{height:200px;overflow:auto;background:#111;border-radius:10px;padding:6px}
.msg{margin:4px 0}
.me{color:#7f5cff}
</style>
</head>

<body>

<header>ğŸ”§ Ø®Ø¯Ù…Ø§Øª Ù…Ù†Ø²Ù„ÙŠØ© Ø¨Ø¹Ù…Ù„Ø© Pi</header>

<div class="container">

<div class="card" id="loginBox">
  <button class="btn" onclick="piLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi</button>
</div>

<div class="card" id="userBox" style="display:none">
  ğŸ‘¤ <span id="uName"></span>
</div>

<div id="ads" class="ads"></div>

<div class="card" id="chatBox" style="display:none">
  <h4>ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h4>
  <div class="chat" id="chat"></div>
  <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
  <button class="btn" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

</div>

<script>
const SUPABASE_URL = "https://axjkwrssmofzavaoqutq.supabase.co";
const SUPABASE_KEY = "sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let user=null, accessToken=null, currentAd=null, convId=null;

async function piLogin(){
  const res = await Pi.authenticate(["username","payments"], onIncomplete);
  user = res.user;
  accessToken = res.accessToken;

  document.getElementById("loginBox").style.display="none";
  document.getElementById("userBox").style.display="block";
  uName.innerText=user.username;

  loadAds();
}

function onIncomplete(){}

async function loadAds(){
  const {data} = await sb.from("ads").select(`
    id,title,description,is_featured,
    provider_profiles(display_name)
  `).eq("is_active",true).order("is_featured",{ascending:false});

  ads.innerHTML="";
  data.forEach(a=>{
    ads.innerHTML+=`
    <div class="card">
      ${a.is_featured?'<span class="badge">Ù…Ù…ÙŠØ²</span>':''}
      <h4>${a.title}</h4>
      <p>${a.description||''}</p>
      <small>ğŸ‘¨â€ğŸ”§ ${a.provider_profiles.display_name}</small><br><br>
      <button class="btn" onclick="openChat('${a.id}')">ØªÙˆØ§ØµÙ„</button>
      <button class="btn" onclick="boost('${a.id}')">ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
    </div>`;
  });
}

async function openChat(adId){
  currentAd=adId;
  chatBox.style.display="block";
  chat.innerHTML="";
}

async function sendMsg(){
  chat.innerHTML+=`<div class="msg me">Ø£Ù†Ø§: ${msg.value}</div>`;
  msg.value="";
}

/* ========== BOOST PAYMENT ========== */
async function boost(adId){
  const payment = await Pi.createPayment({
    amount:1,
    memo:"Boost Ad",
    metadata:{adId}
  },{
    onReadyForServerApproval: async (paymentId)=>{
      await fetch("/api/pi/approve",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          paymentId, adId, boostPlanId:null, piAccessToken:accessToken
        })
      });
    },
    onReadyForServerCompletion: async (paymentId)=>{
      await fetch("/api/pi/complete",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({paymentId, piAccessToken:accessToken})
      });
      alert("ØªÙ… ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† âœ…");
      loadAds();
    },
    onCancel:()=>alert("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡"),
    onError:(e)=>alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹")
  });
}
</script>
</body>
</html>
