<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content"/>
<title>Nano Banana Chat</title>

<!-- ✅ Supabase UMD (مهم عشان window.supabase تشتغل) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<style>
/* --- Design System --- */
:root {
  --bg: #09090b;
  --chat-bg: #000000;
  --card: #18181b;
  --user-msg-bg: #27272a;
  --bot-msg-bg: #18181b;
  --accent: #d1fa31; /* Nano Banana Green */
  --purple: #a855f7; /* Purple Accent */
  --warning: #f59e0b;
  --text-main: #ffffff;
  --text-sub: #a1a1aa;
  --border: #27272a;
  --error: #ef4444;
  --ok: #10b981;
  --pi-color: #fdb927;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--chat-bg);
  color: var(--text-main);
  display: flex;
  flex-direction: column;
  height: 100dvh;
  overflow: hidden;
}

/* --- Landing Page --- */
.landing-overlay {
  position: fixed; inset: 0;
  background: #000;
  z-index: 9999;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 20px;
  text-align: center;
  transition: opacity 0.5s ease;
}
.landing-content { max-width: 500px; animation: fadeUp 0.8s ease; }
.landing-logo {
  font-size: 80px; font-weight: 900; margin-bottom: 10px;
  background: linear-gradient(135deg, #ffffff 20%, var(--purple) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 0 25px rgba(168, 85, 247, 0.5));
  letter-spacing: -3px;
}
.landing-title { font-size: 28px; font-weight: 800; margin-bottom: 10px; color: var(--text-main); }
.landing-desc { color: var(--text-sub); line-height: 1.6; margin-bottom: 30px; font-size: 15px; }
.feature-tags { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 30px; }
.tag { background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; font-size: 12px; border: 1px solid rgba(255,255,255,0.1); }
.pi-login-btn {
  background: var(--pi-color); color: #333;
  border: none; padding: 14px 40px; border-radius: 30px;
  font-weight: 800; font-size: 16px; cursor: pointer;
  box-shadow: 0 0 20px rgba(253, 185, 39, 0.3);
  transition: transform 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 10px;
}
.pi-login-btn:active { transform: scale(0.95); }
.pi-icon { width: 24px; height: 24px; fill: #333; }

/* --- Header --- */
.header {
  padding: 10px 16px;
  background: rgba(9, 9, 11, 0.95);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  z-index: 100;
  height: 60px;
  flex-shrink: 0;
  position: relative;
}
.header-title { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 4px 8px; border-radius: 12px; transition: background 0.2s; }
.header-title:active { background: rgba(255,255,255,0.05); }
.header-chevron { width: 20px; height: 20px; fill: var(--text-sub); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
.logo-circle {
  width: 34px; height: 34px;
  background: #1c241d; border: 1px solid #2d382e;
  color: var(--accent); border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 16px;
  box-shadow: 0 0 15px rgba(209, 250, 49, 0.1);
}
.header h1 { font-size: 15px; margin: 0; font-weight: 700; letter-spacing: 0.5px; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.status-dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 8px var(--accent); display: inline-block; }
.header-actions { display: flex; gap: 8px; }
.lang-btn, .clear-btn {
  background: var(--card); border: 1px solid var(--border);
  color: var(--text-main); font-size: 11px;
  cursor: pointer; padding: 6px 10px; border-radius: 20px;
  font-weight: 600; transition: 0.2s; min-width: 40px;
}
.lang-btn:active, .clear-btn:active { transform: scale(0.95); }

/* --- Model Menu --- */
.model-menu-overlay {
  position: absolute; top: 60px; left: 0; right: 0;
  background: rgba(9, 9, 11, 0.98); backdrop-filter: blur(20px);
  z-index: 90; padding: 12px; display: none;
  flex-direction: column; gap: 8px;
  border-bottom: 1px solid var(--border);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  animation: curtainDown 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes curtainDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
.model-option {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 16px; background: var(--card);
  border: 1px solid var(--border); border-radius: 14px;
  color: var(--text-main); cursor: pointer; transition: 0.2s;
}
.model-option:active { transform: scale(0.98); }
.model-option.active { border-color: var(--accent); background: #1c241d; box-shadow: 0 0 0 1px var(--accent); }
.model-name { font-weight: 700; font-size: 14px; margin-bottom: 2px; }
.model-desc { font-size: 11px; color: var(--text-sub); }
.check-icon { width: 20px; height: 20px; fill: var(--accent); opacity: 0; transition: 0.2s; }
.model-option.active .check-icon { opacity: 1; }

/* --- Chat Area --- */
.chat-container {
  flex: 1; overflow-y: auto; padding: 15px;
  display: flex; flex-direction: column;
  gap: 20px; scroll-behavior: smooth; padding-bottom: 20px;
}
.message { display: flex; flex-direction: column; max-width: 90%; animation: slideUp 0.3s ease; }
@keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
.message.user { align-self: flex-end; align-items: flex-end; }
.message.bot { align-self: flex-start; align-items: flex-start; }
.msg-bubble { padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.5; position: relative; word-wrap: break-word; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.message.user .msg-bubble { background: var(--user-msg-bg); color: #fff; border-bottom-left-radius: 4px; border-bottom-right-radius: 18px; }
.message.bot .msg-bubble { background: transparent; padding: 0; border-radius: 20px; overflow: hidden; border: 1px solid var(--border); width: 100%; max-width: 340px; }

/* Image Styles */
.image-wrapper { position: relative; width: 100%; min-height: 250px; background: #111; display: flex; align-items: center; justify-content: center; }
.msg-image { display: block; width: 100%; height: auto; opacity: 0; transition: opacity 0.5s ease; }
.msg-image.loaded { opacity: 1; }

/* Download Button */
.download-btn-container {
  padding: 10px; background: rgba(24, 24, 27, 0.9);
  backdrop-filter: blur(5px); display: flex; justify-content: center;
  border-top: 1px solid rgba(255,255,255,0.05);
}
.btn-download-hd {
  display: flex; align-items: center; gap: 8px;
  background: var(--accent); color: black;
  text-decoration: none; padding: 10px 0; border-radius: 10px;
  font-weight: 700; font-size: 13px; width: 100%;
  justify-content: center; cursor: pointer; border: none;
}
.btn-download-hd:disabled { opacity: 0.6; cursor: not-allowed; }
.btn-download-hd svg { width: 16px; height: 16px; fill: black; }

/* Loader */
.blur-wave-container {
  width: 280px; height: 280px; border-radius: 20px;
  background: #000; position: relative; overflow: hidden;
  border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
}
.blur-wave-bg {
  position: absolute; inset: -50%;
  background: conic-gradient(from 0deg, transparent 0deg, var(--accent) 60deg, transparent 120deg, var(--purple) 180deg, transparent 240deg, var(--accent) 300deg, transparent 360deg);
  filter: blur(40px); opacity: 0.4; animation: rotateWave 3s linear infinite;
}
@keyframes rotateWave { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.blur-wave-text {
  position: relative; z-index: 2; font-weight: 700; font-size: 14px;
  color: var(--text-main); background: rgba(0,0,0,0.6);
  padding: 10px 20px; border-radius: 30px;
  backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.15);
  animation: pulseText 1.5s infinite ease-in-out;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
@keyframes pulseText { 0%, 100% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } }

/* Footer */
.footer-container { background: #09090b; border-top: 1px solid var(--border); display: flex; flex-direction: column; padding-bottom: max(12px, env(safe-area-inset-bottom)); flex-shrink: 0; z-index: 100; position: relative; }
.control-bar { padding: 8px 12px 0 12px; display: flex; justify-content: flex-start; gap: 10px; position: relative; overflow-x: auto; }
.control-btn {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 12px; padding: 6px 12px;
  color: var(--text-sub); font-size: 11px; font-weight: 600;
  cursor: pointer; transition: all 0.2s ease;
  display: flex; align-items: center; gap: 8px;
  min-width: 90px; justify-content: space-between;
}
.control-btn:active { transform: scale(0.98); }
.control-btn svg.icon { width: 14px; height: 14px; fill: currentColor; }
.control-btn svg.arrow { width: 12px; height: 12px; fill: var(--text-sub); transition: transform 0.2s; }
.control-btn.open svg.arrow { transform: rotate(180deg); }
.gallery-btn { justify-content: center; gap: 6px; min-width: auto; }

/* Pi User Badge */
.pi-user-badge {
  display: flex; align-items: center; gap: 6px;
  background: rgba(253, 185, 39, 0.1);
  border: 1px solid var(--pi-color);
  border-radius: 12px; padding: 6px 10px;
  color: var(--pi-color); font-size: 11px; font-weight: 700;
  white-space: nowrap;
}
.pi-user-badge svg { width: 12px; height: 12px; fill: var(--pi-color); }

/* ✅ Aspect dropdown (يشتغل فعلياً) */
.aspect-menu-dropdown {
  position: absolute;
  bottom: calc(100% + 8px);
  right: 12px;
  width: 200px;
  background: rgba(24, 24, 27, 0.95);
  backdrop-filter: blur(12px);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 6px;
  display: none;
  flex-direction: column;
  gap: 4px;
  box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
  z-index: 200;
  animation: fadeUp 0.2s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.aspect-option {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border-radius: 10px;
  cursor: pointer; transition: 0.2s; color: var(--text-sub);
}
.aspect-option:hover { background: rgba(255,255,255,0.05); }
.aspect-option.selected { background: #1c241d; color: var(--accent); border: 1px solid rgba(209, 250, 49, 0.2); }
.aspect-option svg { width: 16px; height: 16px; fill: currentColor; }
.aspect-info { display: flex; flex-direction: column; gap: 2px; }
.aspect-label { font-size: 12px; font-weight: 700; }
.aspect-ratio-text { font-size: 10px; opacity: 0.7; }

/* Input */
.input-row { padding: 8px 12px; display: flex; gap: 8px; align-items: flex-end; }
.input-box {
  flex: 1; background: var(--card); border: 1px solid var(--border);
  border-radius: 20px; padding: 12px 16px; color: white; font-size: 14px;
  max-height: 100px; overflow-y: auto; resize: none; outline: none;
  line-height: 1.4; transition: border-color 0.2s;
}
.input-box:focus { border-color: var(--accent); }
.send-btn {
  width: 44px; height: 44px; border-radius: 50%;
  background: var(--accent); color: black; border: none;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; flex-shrink: 0;
}
.send-btn svg { width: 18px; height: 18px; fill: black; margin-right: 2px; }

/* Empty State */
.empty-state { text-align: center; margin-top: auto; margin-bottom: auto; color: var(--text-sub); padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
.empty-logo { width: 60px; height: 60px; background: var(--card); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; color: var(--accent); font-size: 26px; border: 1px solid var(--border); box-shadow: 0 0 20px rgba(0,0,0,0.3); }

/* Gallery Modal */
.gallery-modal { position: fixed; inset: 0; background: #000; z-index: 500; display: none; flex-direction: column; animation: fadeUp 0.3s ease; }
.gallery-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(9, 9, 11, 0.95); backdrop-filter: blur(10px); }
.gallery-title { font-size: 16px; font-weight: 700; color: #fff; }
.close-gallery { background: none; border: none; color: var(--text-sub); font-size: 20px; cursor: pointer; }
.gallery-grid { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.gallery-item { background: var(--card); border-radius: 12px; overflow: hidden; position: relative; border: 1px solid var(--border); display: flex; flex-direction: column; }
.gallery-img { width: 100%; height: auto; display: block; aspect-ratio: 1/1; object-fit: cover; }
.gallery-actions { display: flex; gap: 5px; padding: 8px; background: #1c1c1e; }
.g-btn { flex: 1; border: none; border-radius: 6px; padding: 6px; font-size: 11px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 4px; }
.g-download { background: var(--accent); color: black; font-weight: 600; }
.g-delete { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

/* ✅ Debug Error Card */
.error-card {
  padding: 18px; text-align: center;
  background: rgba(39, 39, 42, 0.5);
  display: flex; flex-direction: column; align-items: center;
  gap: 10px; min-width: 250px;
}
.error-icon { width: 40px; height: 40px; margin-bottom: 2px; opacity: 0.9; }
.error-title { font-weight: 800; font-size: 14px; color: #fff; }
.error-desc { font-size: 12px; color: var(--text-sub); line-height: 1.4; }
.retry-btn {
  margin-top: 6px; background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.1); color: white;
  padding: 8px 14px; border-radius: 12px; font-size: 12px;
  cursor: pointer; transition: 0.2s;
  display: flex; align-items: center; gap: 6px;
}
.retry-btn:hover { background: rgba(255,255,255,0.15); }
.retry-btn svg { width: 14px; height: 14px; fill: white; }

.debug-toggle {
  margin-top: 6px;
  background: transparent;
  border: 1px solid rgba(255,255,255,0.12);
  color: rgba(255,255,255,0.85);
  padding: 7px 12px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 12px;
}
.debug-box {
  width: 100%;
  margin-top: 8px;
  text-align: left;
  direction: ltr;
  background: rgba(0,0,0,0.45);
  border: 1px solid rgba(255,255,255,0.10);
  padding: 10px;
  border-radius: 12px;
  display: none;
  overflow: auto;
  max-height: 180px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 11px;
  color: rgba(255,255,255,0.9);
}
.debug-actions { display:flex; gap:8px; margin-top:8px; }
.copy-btn {
  flex:1;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.12);
  color: #fff;
  padding: 8px 10px;
  border-radius: 12px;
  cursor:pointer;
  font-size: 12px;
}

.error-card.rate-limit .error-icon { fill: var(--warning); }
.error-card.rate-limit .error-title { color: var(--warning); }
.error-card.generic .error-icon { fill: var(--error); }
.error-card.generic .error-title { color: var(--error); }

@media (max-width: 400px) {
  .header h1 { font-size: 14px; }
  .logo-circle { width: 30px; height: 30px; font-size: 14px; }
  .msg-bubble { font-size: 13px; }
  .blur-wave-container { width: 220px; height: 220px; }
  .gallery-grid { grid-template-columns: 1fr; }
}
</style>
</head>

<body>

<!-- Landing -->
<div id="landingPage" class="landing-overlay">
  <div class="landing-content">
    <div class="landing-logo">Ai</div>
    <div class="landing-title">AI Imagen</div>
    <div class="landing-desc">
      مرحباً بك في الجيل الجديد من توليد الصور.<br>
      يجب تسجيل الدخول باستخدام محفظة Pi للمتابعة.
    </div>
    <div class="feature-tags">
      <span class="tag">Flux Pro</span>
      <span class="tag">Nano Banana Pro</span>
      <span class="tag">High Speed</span>
    </div>

    <!-- ✅ بدون Backticks -->
    <button class="pi-login-btn" onclick="loginWithPi()">
      <svg class="pi-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
      تسجيل دخول Pi
    </button>
  </div>
</div>

<!-- Gallery Modal -->
<div id="galleryModal" class="gallery-modal">
  <div class="gallery-header">
    <div class="gallery-title" id="txtGalleryTitle">معرضي</div>
    <button class="close-gallery" onclick="closeGallery()">✕</button>
  </div>
  <div class="gallery-grid" id="galleryGrid"></div>
</div>

<!-- Header -->
<div class="header">
  <div class="header-title" onclick="toggleModelMenu()">
    <div class="logo-circle">G</div>
    <div>
      <h1 id="headerModelName">Nano Banana Pro</h1>
      <div style="font-size: 11px; color: var(--accent); display:flex; align-items:center; gap:5px; margin-top:2px;">
        <span class="status-dot"></span> <span id="txtOnline">متصل</span>
      </div>
    </div>
    <svg class="header-chevron" id="chevron" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
  </div>
  <div class="header-actions">
    <button class="lang-btn" id="langBtn" onclick="toggleLanguage()">EN</button>
    <button class="clear-btn" id="clearBtn" onclick="clearAllData()">مسح</button>
  </div>
</div>

<div class="model-menu-overlay" id="modelMenu"></div>

<!-- Chat -->
<div class="chat-container" id="chatContainer">
  <div class="empty-state" id="emptyState">
    <div class="empty-logo">✨</div>
    <p id="txtWelcome">أهلاً بك! أنا AI Imagen.<br>اكتب أي وصف وسأقوم بتحويله لصورة.</p>
  </div>
</div>

<!-- Footer -->
<div class="footer-container">
  <div class="control-bar" id="controlBar">

    <!-- ✅ ده الـ dropdown الحقيقي -->
    <div class="aspect-menu-dropdown" id="aspectMenu"></div>

    <!-- ✅ زر الأبعاد بدون Backticks -->
    <button class="control-btn" id="aspectTriggerBtn" onclick="toggleAspectMenu()">
      <div style="display:flex; align-items:center; gap:8px;">
        <span id="currentAspectIcon"></span>
        <span id="currentAspectLabel">1:1</span>
      </div>
      <svg class="arrow" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
    </button>

    <button class="control-btn gallery-btn" onclick="openGallery()">
      <svg class="icon" viewBox="0 0 24 24"><path d="M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2zm-11-4l2.03 2.71L16 11l4 5H8l3-4zM2 6v14c0 1.1.9 2 2 2h14v-2H4V6H2z"/></svg>
      <span id="txtGallery">معرضي</span>
    </button>

    <div id="piUserBadge" class="pi-user-badge" style="display:none;">
      <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
      <span id="piUsernameDisplay">User</span>
    </div>
  </div>

  <div class="input-row">
    <textarea id="promptInput" class="input-box" rows="1" placeholder="تخيل أي شيء..." dir="auto"></textarea>
    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
      <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>

<script>
/* =========================================
   SUPABASE CONFIG
========================================= */
const supabaseUrl = 'https://jtbxdymviqmfhffixmat.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp0YnhkeW12aXFtZmhmZml4bWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNDA5OTUsImV4cCI6MjA4NjcxNjk5NX0.tzhiOph4Q-GPOIrm1KfvxlnqygI4qXdUCzXlmsJiPjM'; // <-- سيب مفتاحك الحالي مكان ده

let supabaseClient = null;
try {
  if (window.supabase?.createClient) {
    supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
  } else {
    console.error("Supabase UMD not loaded");
  }
} catch (e) {
  console.error("Supabase init error", e);
}

/* =========================================
   PI NETWORK AUTH LOGIC
========================================= */
let currentUser = null;
let piInited = false;

async function loginWithPi() {
  try {
    if (!window.Pi) {
      alert("Pi SDK غير متاح. افتح الموقع من داخل Pi Browser.");
      return;
    }
    if (!piInited) {
      window.Pi.init({ version: "2.0", sandbox: false });
      piInited = true;
    }

    const scopes = ['username', 'payments'];

    function onIncompletePaymentFound(payment) {
      console.log("Incomplete payment found", payment);
    }

    const authResult = await window.Pi.authenticate(scopes, onIncompletePaymentFound);
    if (!authResult?.user?.uid) throw new Error("Invalid Pi auth result");

    currentUser = authResult.user;
    await registerPiUser(currentUser);
    updateUIForLogin();
  } catch (err) {
    console.error("Pi Login Error:", err);
    alert("فشل تسجيل الدخول عبر Pi Network. تأكد أنك داخل Pi Browser وأن الدومين مسجل في تطبيقك.");
  }
}

async function registerPiUser(user) {
  if (!supabaseClient) return;
  try {
    const { error } = await supabaseClient
      .from('pi_users')
      .upsert({ uid: user.uid, username: user.username }, { onConflict: 'uid' });

    if (error) console.error("DB Register Error:", error);
  } catch (e) {
    console.error("registerPiUser exception:", e);
  }
}

function updateUIForLogin() {
  const landingPage = document.getElementById('landingPage');
  const badge = document.getElementById('piUserBadge');
  const nameDisplay = document.getElementById('piUsernameDisplay');

  landingPage.style.opacity = '0';
  setTimeout(() => { landingPage.style.display = 'none'; }, 500);

  if (currentUser) {
    nameDisplay.innerText = currentUser.username || "Pi User";
    badge.style.display = 'flex';
  }
}

/* =========================================
   APP LOGIC
========================================= */
let currentLang = localStorage.getItem('nanoLang') || 'ar';
let currentModel = 'imagen-4';
let currentWidth = 1024;
let currentHeight = 1024;
let currentRatioId = 'square';

const RATIOS = [
  { id: 'square', label: '1:1', ratioText: '1:1', w: 1024, h: 1024, icon: '<rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>' },
  { id: 'portrait', label: '9:16', ratioText: '9:16', w: 768, h: 1344, icon: '<rect x="6" y="3" width="12" height="18" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>' },
  { id: 'landscape', label: '16:9', ratioText: '16:9', w: 1344, h: 768, icon: '<rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>' },
  { id: 'wide', label: '21:9', ratioText: '21:9', w: 1536, h: 640, icon: '<rect x="2" y="8" width="20" height="8" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>' }
];

const MODELS = [
  { id: 'imagen-4', name: 'Nano Banana Pro', desc: 'Google Flagship' },
  { id: 'flux-klein', name: 'FLUX.2 Klein 4B', desc: 'Fast Detail' },
  { id: 'flux-klein-9b', name: 'FLUX.2 Klein 9B', desc: 'High Fidelity' },
  { id: 'gpt-image-1-mini', name: 'GPT Image 1 Mini', desc: 'Creative' }
];

const chatContainer = document.getElementById('chatContainer');
const promptInput = document.getElementById('promptInput');
const sendBtn = document.getElementById('sendBtn');
const emptyState = document.getElementById('emptyState');
const modelMenu = document.getElementById('modelMenu');
const headerModelName = document.getElementById('headerModelName');
const chevron = document.getElementById('chevron');
const aspectMenu = document.getElementById('aspectMenu');
const aspectTriggerBtn = document.getElementById('aspectTriggerBtn');
const currentAspectLabel = document.getElementById('currentAspectLabel');
const currentAspectIcon = document.getElementById('currentAspectIcon');
const galleryModal = document.getElementById('galleryModal');
const galleryGrid = document.getElementById('galleryGrid');

const translations = {
  ar: {
    online: "متصل",
    clear: "مسح الكل",
    welcome: "أهلاً بك! أنا AI Imagen.<br>اكتب أي وصف وسأقوم بتحويله لصورة.",
    placeholder: "تخيل أي شيء...",
    generating: "إنشاء صورة...",
    download: "تحميل HD",
    downloading: "جاري التحميل...",
    error: "حدث خطأ غير متوقع",
    confirmClear: "تحذير: سيتم حذف جميع الصور والبيانات الخاصة بك نهائياً من السيرفر. هل أنت متأكد؟",
    langLabel: "EN",
    translating: "جاري ترجمة الوصف...",
    retry: "إعادة المحاولة",
    rateLimitTitle: "السيرفر مشغول حالياً",
    rateLimitDesc: "يوجد ضغط كبير على الموديل. يرجى الانتظار بضع ثوانٍ ثم المحاولة مجدداً.",
    genericError: "تعذر إنشاء الصورة",
    gallery: "معرضي",
    noImages: "لا توجد صور محفوظة.",
    delete: "حذف",
    loadingGallery: "جاري التحميل...",
    debugDetails: "تفاصيل الخطأ",
    copyDebug: "نسخ التفاصيل"
  },
  en: {
    online: "Online",
    clear: "Clear All",
    welcome: "Welcome! I am AI Imagen.<br>Type any description to generate an image.",
    placeholder: "Imagine anything...",
    generating: "Creating Image...",
    download: "Download HD",
    downloading: "Downloading...",
    error: "Unexpected error",
    confirmClear: "Warning: All your images and data will be permanently deleted from the server. Are you sure?",
    langLabel: "عربي",
    translating: "Translating prompt...",
    retry: "Retry",
    rateLimitTitle: "Server Busy",
    rateLimitDesc: "High traffic on this model. Please wait a few seconds and try again.",
    genericError: "Failed to generate",
    gallery: "My Gallery",
    noImages: "No images saved.",
    delete: "Delete",
    loadingGallery: "Loading...",
    debugDetails: "Error details",
    copyDebug: "Copy details"
  }
};

let isGenerating = false;

window.onload = function() {
  applyLanguage(currentLang);
  renderModelMenu();
  renderAspectMenu();
  updateTriggerUI();
  loadChatHistory();
};

/* =========================================
   Helpers
========================================= */
function getTrans(key) { return translations[currentLang][key] || key; }
function isArabic(text) { return /[\u0600-\u06FF]/.test(text); }

function escapeHtml(text) {
  return String(text)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function scrollToBottom() {
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

function safeJsonStringify(obj) {
  try { return JSON.stringify(obj, null, 2); }
  catch { return String(obj); }
}

function isProbablyBase64(s) {
  if (!s || typeof s !== 'string') return false;
  const t = s.trim();
  if (t.length < 200) return false;
  // base64 غالباً حروف/أرقام/+ /=
  return /^[A-Za-z0-9+/=\s]+$/.test(t);
}

async function fetchWithTimeout(url, opts = {}, timeoutMs = 30000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeoutMs);
  try {
    const res = await fetch(url, { ...opts, signal: controller.signal });
    clearTimeout(id);
    return res;
  } catch (e) {
    clearTimeout(id);
    throw e;
  }
}

/* =========================================
   Translation (best-effort)
========================================= */
async function translateToEnglish(text) {
  try {
    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=en&dt=t&q=${encodeURIComponent(text)}`);
    const data = await res.json();
    return (data && data[0] && data[0][0] && data[0][0][0]) ? data[0][0][0] : text;
  } catch {
    return text;
  }
}

/* =========================================
   History
========================================= */
function loadChatHistory() {
  const history = JSON.parse(localStorage.getItem('nanoBananaChat')) || [];
  if (history.length > 0) {
    emptyState.style.display = 'none';
    history.forEach(msg => {
      if (msg.type === 'user') renderUserMessage(msg.content);
      else if (msg.type === 'bot_img') renderBotMessage(msg.content, false);
    });
    scrollToBottom();
  }
}

function saveToHistory(type, content) {
  const history = JSON.parse(localStorage.getItem('nanoBananaChat')) || [];
  history.push({ type, content, timestamp: Date.now() });
  localStorage.setItem('nanoBananaChat', JSON.stringify(history));
}

/* =========================================
   Render Messages
========================================= */
function renderUserMessage(text) {
  const div = document.createElement('div');
  div.className = 'message user';
  div.innerHTML = `<div class="msg-bubble">${escapeHtml(text)}</div>`;
  chatContainer.appendChild(div);
  scrollToBottom();
}

function renderBotMessage(imageUrl, save = true) {
  const div = document.createElement('div');
  div.className = 'message bot';
  div.innerHTML = `
    <div class="msg-bubble">
      <div class="image-wrapper">
        <img src="${imageUrl}" class="msg-image" alt="Art" onload="this.classList.add('loaded')">
      </div>
      <div class="download-btn-container">
        <button onclick="downloadImage(${JSON.stringify(imageUrl)})" class="btn-download-hd">
          <svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/></svg>
          <span>${getTrans('download')}</span>
        </button>
      </div>
    </div>
  `;
  chatContainer.appendChild(div);
  scrollToBottom();
  if (save) saveToHistory('bot_img', imageUrl);
}

function renderLoader(statusTextKey = 'generating') {
  const div = document.createElement('div');
  div.className = 'message bot loading-msg';
  div.id = 'loading-' + Date.now();
  div.innerHTML = `
    <div class="blur-wave-container">
      <div class="blur-wave-bg"></div>
      <div class="blur-wave-text" id="loaderText">${getTrans(statusTextKey)}</div>
    </div>
  `;
  chatContainer.appendChild(div);
  scrollToBottom();
  return div.id;
}

function updateLoaderText(id, key) {
  const loader = document.getElementById(id);
  if (loader) {
    const txt = loader.querySelector('#loaderText');
    if (txt) txt.innerText = getTrans(key);
  }
}

function removeLoader(id) {
  const loader = document.getElementById(id);
  if (loader) loader.remove();
}

/* =========================================
   Download
========================================= */
async function forceDownload(url, btn) {
  const span = btn?.querySelector?.('span');
  const originalText = span ? span.innerText : getTrans('download');
  if (span) span.innerText = getTrans('downloading');
  if (btn) btn.disabled = true;

  try {
    const response = await fetch(url, { mode: 'cors' });
    if (!response.ok) throw new Error("download_failed");
    const blob = await response.blob();
    const blobUrl = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = blobUrl;
    a.download = `nano-art-${Date.now()}.jpg`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(blobUrl);
  } catch (err) {
    console.error(err);
    alert(getTrans('error'));
  } finally {
    if (btn) btn.disabled = false;
    if (span) span.innerText = originalText;
  }
}

function downloadImage(url) {
  const btn = document.createElement('button');
  btn.innerHTML = `<span>${getTrans('download')}</span>`;
  forceDownload(url, btn);
}

/* =========================================
   DEBUG ERROR SYSTEM
========================================= */
function stageTitle(stage){
  const map = {
    auth: "مشكلة تسجيل الدخول (Pi)",
    translate: "مشكلة ترجمة الوصف",
    backend: "مشكلة في السيرفر (Netlify Function)",
    model: "مشكلة من مزود التوليد/الموديل",
    decode: "مشكلة تحويل الصورة (Base64)",
    supabase_storage: "مشكلة رفع الصورة (Supabase Storage)",
    supabase_db: "مشكلة حفظ البيانات (Supabase DB)",
    unknown: "خطأ غير معروف"
  };
  return map[stage] || map.unknown;
}

function userHint(stage, status){
  if (stage === "auth") return "افتح الموقع من داخل Pi Browser وتأكد إن الدومين متسجل في Pi Developer Portal.";
  if (stage === "backend") return "تأكد إن Netlify Function شغالة وإن الـEndpoint بيرد. لو فيه Rate limit جرّب بعد شوية.";
  if (stage === "model") return "الموديل نفسه ممكن يكون عليه ضغط أو API محدود.";
  if (stage === "decode") return "السيرفر غالباً رجّع نص خطأ بدل Base64. شوف التفاصيل.";
  if (stage === "supabase_storage") return "اتأكد من Bucket permissions وCORS و إن الـanon key صحيح.";
  if (status === 429) return getTrans('rateLimitDesc');
  return getTrans('error');
}

function renderDebugErrorCard(errInfo, originalPrompt) {
  const div = document.createElement('div');
  div.className = 'message bot';

  const status = errInfo?.status;
  const is429 = status === 429;

  const icon = '<svg class="error-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>';

  const title = is429 ? getTrans('rateLimitTitle') : stageTitle(errInfo.stage || 'unknown');
  const desc  = is429 ? getTrans('rateLimitDesc') : userHint(errInfo.stage || 'unknown', status);

  const debugText = safeJsonStringify({
    time: new Date().toISOString(),
    stage: errInfo.stage,
    status: errInfo.status,
    message: errInfo.message,
    details: errInfo.details,
    request: errInfo.request,
  });

  const debugId = 'dbg-' + Date.now();

  div.innerHTML = `
    <div class="msg-bubble">
      <div class="error-card ${is429 ? 'rate-limit' : 'generic'}">
        ${icon}
        <div class="error-title">${escapeHtml(title)}</div>
        <div class="error-desc">${escapeHtml(desc)}</div>

        <button class="retry-btn" onclick='retryLastMessage(${JSON.stringify(originalPrompt)})'>
          <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
          <span>${getTrans('retry')}</span>
        </button>

        <button class="debug-toggle" onclick="toggleDebugBox('${debugId}')">${getTrans('debugDetails')}</button>
        <div class="debug-box" id="${debugId}">${escapeHtml(debugText)}</div>
        <div class="debug-actions">
          <button class="copy-btn" onclick="copyDebug('${debugId}')">${getTrans('copyDebug')}</button>
        </div>
      </div>
    </div>
  `;
  chatContainer.appendChild(div);
  scrollToBottom();
}

function toggleDebugBox(id){
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display = (el.style.display === 'block') ? 'none' : 'block';
}

async function copyDebug(id){
  const el = document.getElementById(id);
  if (!el) return;
  const text = el.innerText;
  try {
    await navigator.clipboard.writeText(text);
  } catch {
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
  }
  alert("تم النسخ ✅");
}

function retryLastMessage(prompt) {
  const last = chatContainer.lastElementChild;
  if (last) last.remove();
  sendMessage(prompt);
}

/* =========================================
   Supabase Storage helpers
========================================= */
function extractStoragePath(publicUrl){
  const marker = '/nano_images/';
  const i = publicUrl.indexOf(marker);
  if (i === -1) return null;
  return publicUrl.substring(i + marker.length);
}

/* =========================================
   Save to Supabase (PI users only)
========================================= */
async function saveToSupabase(blob, prompt) {
  if (!supabaseClient) return URL.createObjectURL(blob);

  if (!currentUser?.uid) {
    alert("يرجى تسجيل الدخول لحفظ الصور.");
    return URL.createObjectURL(blob);
  }

  try {
    const filePath = `${currentUser.uid}/${Date.now()}.jpg`;

    const { error: uploadError } = await supabaseClient.storage
      .from('nano_images')
      .upload(filePath, blob, { contentType: 'image/jpeg', upsert: true });

    if (uploadError) {
      throw { stage: "supabase_storage", message: "Upload failed", details: uploadError };
    }

    const { data: publicUrlData } = supabaseClient.storage
      .from('nano_images')
      .getPublicUrl(filePath);

    const publicUrl = publicUrlData?.publicUrl;
    if (!publicUrl) {
      throw { stage: "supabase_storage", message: "No public URL returned", details: publicUrlData };
    }

    const { error: dbError } = await supabaseClient
      .from('generated_images')
      .insert([{
        prompt: prompt,
        image_url: publicUrl,
        model: currentModel,
        width: currentWidth,
        height: currentHeight,
        user_id: currentUser.uid
      }]);

    if (dbError) {
      // نخلي الصورة تظهر حتى لو DB وقع
      console.error("Database Insert Error:", dbError);
    }

    return publicUrl;
  } catch (err) {
    console.error("saveToSupabase error:", err);
    // رجّع رابط محلي عشان المستخدم ما يخسرش الصورة
    return URL.createObjectURL(blob);
  }
}

/* =========================================
   Gallery
========================================= */
async function openGallery() {
  if (!supabaseClient) { alert("Supabase غير متاح."); return; }
  if (!currentUser?.uid) { alert("يجب تسجيل الدخول باستخدام Pi لفتح المعرض."); return; }

  galleryModal.style.display = 'flex';
  galleryGrid.innerHTML = `<div style="color:#888; text-align:center; grid-column:span 2;">${getTrans('loadingGallery')}</div>`;

  const { data, error } = await supabaseClient
    .from('generated_images')
    .select('*')
    .eq('user_id', currentUser.uid)
    .order('created_at', { ascending: false });

  galleryGrid.innerHTML = '';

  if (error || !data || data.length === 0) {
    galleryGrid.innerHTML = `<div style="color:#888; text-align:center; grid-column:span 2;">${getTrans('noImages')}</div>`;
    return;
  }

  data.forEach(item => {
    const div = document.createElement('div');
    div.className = 'gallery-item';
    div.innerHTML = `
      <img src="${item.image_url}" class="gallery-img" loading="lazy">
      <div class="gallery-actions">
        <button class="g-btn g-download" onclick="downloadImage(${JSON.stringify(item.image_url)})">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="black"><path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z"/></svg>
          ${getTrans('download')}
        </button>
        <button class="g-btn g-delete" onclick="deleteImage(${JSON.stringify(item.id)}, ${JSON.stringify(item.image_url)}, this)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          ${getTrans('delete')}
        </button>
      </div>
    `;
    galleryGrid.appendChild(div);
  });
}

function closeGallery() { galleryModal.style.display = 'none'; }

async function deleteImage(id, url, btnElement) {
  if (!confirm('حذف هذه الصورة؟')) return;
  if (!currentUser?.uid) return;

  const parent = btnElement.closest('.gallery-item');
  if (parent) parent.style.opacity = '0.5';

  try {
    const path = extractStoragePath(url);
    if (path) await supabaseClient.storage.from('nano_images').remove([path]);

    const { error } = await supabaseClient
      .from('generated_images')
      .delete()
      .eq('id', id)
      .eq('user_id', currentUser.uid);

    if (!error) {
      if (parent) parent.remove();
    } else {
      alert('حدث خطأ أثناء الحذف');
      if (parent) parent.style.opacity = '1';
    }
  } catch (e) {
    console.error(e);
    alert('حدث خطأ أثناء الحذف');
    if (parent) parent.style.opacity = '1';
  }
}

/* =========================================
   Clear All (server + local)
========================================= */
async function clearAllData() {
  if (!currentUser?.uid) { alert("سجّل دخول الأول."); return; }
  if (!confirm(getTrans('confirmClear'))) return;

  localStorage.removeItem('nanoBananaChat');
  chatContainer.innerHTML = '';
  chatContainer.appendChild(emptyState);
  emptyState.style.display = 'flex';

  if (!supabaseClient) return;

  const { data: files, error: selErr } = await supabaseClient
    .from('generated_images')
    .select('image_url')
    .eq('user_id', currentUser.uid);

  if (!selErr && files && files.length > 0) {
    const paths = files.map(f => extractStoragePath(f.image_url)).filter(Boolean);
    if (paths.length) await supabaseClient.storage.from('nano_images').remove(paths);
  }

  await supabaseClient
    .from('generated_images')
    .delete()
    .eq('user_id', currentUser.uid);

  alert('تم مسح جميع البيانات بنجاح.');
}

/* =========================================
   UI: Aspect menu + model menu + lang
========================================= */
function toggleAspectMenu() {
  const isHidden = aspectMenu.style.display === 'none' || aspectMenu.style.display === '';
  aspectMenu.style.display = isHidden ? 'flex' : 'none';
  if (isHidden) aspectTriggerBtn.classList.add('open');
  else aspectTriggerBtn.classList.remove('open');
}

document.addEventListener('click', function(event) {
  // close aspect menu
  if (!aspectMenu.contains(event.target) && !aspectTriggerBtn.contains(event.target)) {
    aspectMenu.style.display = 'none';
    aspectTriggerBtn.classList.remove('open');
  }
  // close model menu
  const headerTitle = document.querySelector('.header-title');
  if (headerTitle && !modelMenu.contains(event.target) && !headerTitle.contains(event.target)) {
    modelMenu.style.display = 'none';
    chevron.style.transform = 'rotate(0deg)';
  }
});

function renderAspectMenu() {
  aspectMenu.innerHTML = '';
  RATIOS.forEach(r => {
    const div = document.createElement('div');
    const isSelected = r.id === currentRatioId;
    div.className = `aspect-option ${isSelected ? 'selected' : ''}`;
    div.onclick = () => selectRatio(r);
    div.innerHTML = `
      <svg viewBox="0 0 24 24">${r.icon}</svg>
      <div class="aspect-info">
        <span class="aspect-label">${r.label}</span>
        <span class="aspect-ratio-text">${r.ratioText} • ${r.w}×${r.h}</span>
      </div>
    `;
    aspectMenu.appendChild(div);
  });
}

function selectRatio(r) {
  currentWidth = r.w;
  currentHeight = r.h;
  currentRatioId = r.id;

  localStorage.setItem('nanoRatio', currentRatioId);
  updateTriggerUI();
  renderAspectMenu();
  aspectMenu.style.display = 'none';
  aspectTriggerBtn.classList.remove('open');
}

function updateTriggerUI() {
  const r = RATIOS.find(x => x.id === currentRatioId);
  if (r) {
    currentAspectLabel.innerText = r.ratioText;
    currentAspectIcon.innerHTML = `<svg class="icon" viewBox="0 0 24 24">${r.icon}</svg>`;
  }
}

function renderModelMenu() {
  modelMenu.innerHTML = '';
  MODELS.forEach(m => {
    const div = document.createElement('div');
    div.className = `model-option ${m.id === currentModel ? 'active' : ''}`;
    div.onclick = () => selectModel(m.id, m.name);
    div.innerHTML = `<div><div class="model-name">${m.name}</div><div class="model-desc">${m.desc}</div></div><svg class="check-icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`;
    modelMenu.appendChild(div);
  });
}

function toggleModelMenu() {
  const isHidden = modelMenu.style.display === 'none' || modelMenu.style.display === '';
  modelMenu.style.display = isHidden ? 'flex' : 'none';
  chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
}

function selectModel(id, name) {
  currentModel = id;
  headerModelName.textContent = name;
  modelMenu.style.display = 'none';
  chevron.style.transform = 'rotate(0deg)';
  renderModelMenu();
}

function toggleLanguage() {
  currentLang = currentLang === 'ar' ? 'en' : 'ar';
  localStorage.setItem('nanoLang', currentLang);
  applyLanguage(currentLang);
}

function applyLanguage(lang) {
  const t = translations[lang];
  document.getElementById('txtOnline').innerText = t.online;
  document.getElementById('clearBtn').innerText = t.clear;
  document.getElementById('txtWelcome').innerHTML = t.welcome;
  document.getElementById('promptInput').placeholder = t.placeholder;
  document.getElementById('langBtn').innerText = t.langLabel;
  document.getElementById('txtGallery').innerText = t.gallery;
  document.getElementById('txtGalleryTitle').innerText = t.gallery;
  renderAspectMenu();
  updateTriggerUI();
}

/* =========================================
   Backend Call (Compatible with latest)
   - Try POST JSON first
   - Fallback to GET query
   - Supports JSON response or base64 text
========================================= */
async function requestGenerateImage(payload) {
  const endpoint = new URL('/.netlify/functions/generate', window.location.origin).toString();

  // 1) POST JSON
  try {
    const res = await fetchWithTimeout(endpoint, {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload)
    }, 30000);

    // لو السيرفر بيرفض POST
    if (res.status === 404 || res.status === 405) throw { __fallback: true, res };

    return res;
  } catch (e) {
    // fallback only if 404/405 or explicit marker
    if (e?.__fallback) {
      // 2) GET fallback
      const u = new URL('/.netlify/functions/generate', window.location.origin);
      Object.entries(payload).forEach(([k, v]) => u.searchParams.set(k, String(v)));
      return await fetchWithTimeout(u.toString(), {}, 30000);
    }
    throw e;
  }
}

async function parseImageResponse(response) {
  const ct = (response.headers.get('content-type') || '').toLowerCase();

  // JSON
  if (ct.includes('application/json')) {
    const j = await response.json().catch(() => ({}));
    // متوقع: {base64, contentType} أو {image, mime} أو {error}
    if (j?.error || j?.success === false) {
      throw { stage: "backend", status: response.status, message: j?.error || j?.message || "Backend returned error", details: j };
    }
    const base64 = j.base64 || j.image || j.data;
    const contentType = j.contentType || j.mime || 'image/jpeg';
    if (!isProbablyBase64(base64)) {
      throw { stage: "decode", status: response.status, message: "Invalid base64 in JSON response", details: j };
    }
    return { base64, contentType };
  }

  // Text base64
  const text = await response.text();
  if (!isProbablyBase64(text)) {
    // غالباً ده نص خطأ من الفنكشن
    throw { stage: "backend", status: response.status, message: "Non-base64 response", details: text?.slice?.(0, 600) || text };
  }
  return { base64: text.trim(), contentType: ct.includes('image/') ? ct : 'image/jpeg' };
}

/* =========================================
   Send Message
========================================= */
async function sendMessage(manualPrompt = null) {
  const text = manualPrompt || promptInput.value.trim();
  if (!text || isGenerating) return;

  if (!currentUser?.uid) {
    alert("يرجى تسجيل الدخول أولاً.");
    return;
  }

  if (!manualPrompt) {
    promptInput.value = '';
    promptInput.style.height = 'auto';
    emptyState.style.display = 'none';
    isGenerating = true;
    sendBtn.disabled = true;
    promptInput.blur();
    renderUserMessage(text);
    saveToHistory('user', text);
  } else {
    isGenerating = true;
    sendBtn.disabled = true;
  }

  const loaderId = renderLoader('generating');

  // Debug context
  const reqMeta = {
    model: currentModel,
    width: currentWidth,
    height: currentHeight,
    ratio: currentRatioId
  };

  try {
    let finalPrompt = text;

    if (isArabic(text)) {
      updateLoaderText(loaderId, 'translating');
      finalPrompt = await translateToEnglish(text);
      updateLoaderText(loaderId, 'generating');
    }

    const seed = Math.floor(Math.random() * 1000000);

    // payload compatible with new backend
    const payload = {
      prompt: finalPrompt,
      model: currentModel,
      width: currentWidth,
      height: currentHeight,
      seed,
      uid: currentUser.uid,
      username: currentUser.username || ''
    };

    const response = await requestGenerateImage(payload);

    if (response.status === 429) {
      throw { stage: "backend", status: 429, message: "Rate limit", request: payload };
    }
    if (!response.ok) {
      const peek = await response.text().catch(() => "");
      throw { stage: "backend", status: response.status, message: "Backend not ok", details: peek?.slice?.(0, 600), request: payload };
    }

    const { base64, contentType } = await parseImageResponse(response);

    // base64 -> blob
    let bytes;
    try {
      bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
    } catch (e) {
      throw { stage: "decode", status: response.status, message: "atob failed (base64 invalid)", details: String(e), request: payload };
    }
    const blob = new Blob([bytes], { type: contentType || 'image/jpeg' });

    // save
    const finalImageUrl = await saveToSupabase(blob, finalPrompt);

    removeLoader(loaderId);
    renderBotMessage(finalImageUrl, true);

  } catch (error) {
    console.error("GEN ERROR:", error);
    removeLoader(loaderId);

    // normalize error
    const errInfo = {
      stage: error?.stage || (error?.name === 'AbortError' ? 'backend' : 'unknown'),
      status: error?.status || (error?.message === '429' ? 429 : undefined),
      message: error?.message || (error?.name === 'AbortError' ? 'Request timeout' : 'Unknown error'),
      details: error?.details || error,
      request: error?.request || reqMeta
    };

    renderDebugErrorCard(errInfo, text);
  } finally {
    isGenerating = false;
    sendBtn.disabled = false;
  }
}

/* =========================================
   Input autosize + Enter send
========================================= */
promptInput.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = (this.scrollHeight) + 'px';
  if (this.value === '') this.style.height = 'auto';
});

promptInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

/* =========================================
   Init ratio from storage
========================================= */
(function initRatio(){
  const saved = localStorage.getItem('nanoRatio');
  if (saved && RATIOS.some(r => r.id === saved)) {
    currentRatioId = saved;
    const r = RATIOS.find(x => x.id === saved);
    currentWidth = r.w;
    currentHeight = r.h;
  }
})();
</script>

</body>
</html>
