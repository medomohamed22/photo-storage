<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª | Donate Way</title>
    
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

    <style>
        :root {
            --primary: #673ab7; /* Pi Purple */
            --accent: #fbc02d;  /* Pi Gold */
            --bg: #f5f7fa;
            --text: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #673ab7 0%, #512da8 100%);
            height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            width: 85%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .icon-circle {
            width: 60px;
            height: 60px;
            background: #eee;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }

        h2 { margin: 0; color: var(--primary); font-size: 22px; }
        p { color: #666; margin-bottom: 25px; font-size: 14px; line-height: 1.5; }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-pi {
            background: var(--accent);
            color: #333;
        }

        .btn-notify {
            background: #ff5252;
            color: white;
            display: none; /* Ù…Ø®ÙÙŠ */
        }

        .btn:disabled { opacity: 0.7; cursor: not-allowed; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¨Ø´ÙƒÙ„ Ø¬Ù…ÙŠÙ„ */
        .status-log {
            margin-top: 20px;
            background: #2d2d2d;
            color: #00e676;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            text-align: left;
            direction: ltr;
            max-height: 120px;
            overflow-y: auto;
            border-left: 4px solid var(--accent);
        }
        .error-log { color: #ff5252; }
    </style>
</head>
<body>

    <div class="card">
        <div class="icon-circle">ğŸ””</div>
        <h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
        <p id="desc">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨Ùƒ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª.</p>

        <button id="piBtn" class="btn btn-pi" onclick="startProcess()">
            <span>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Pi</span>
        </button>

        <button id="notifyBtn" class="btn btn-notify" onclick="subscribePush()">
            <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
        </button>

        <div id="console" class="status-log">Ready...</div>
    </div>

    <script>
        // Ø¯Ø§Ù„Ø© Ù„Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡
        function log(msg, isError = false) {
            const c = document.getElementById('console');
            const span = document.createElement('div');
            span.textContent = "> " + msg;
            if(isError) span.className = "error-log";
            c.appendChild(span);
            c.scrollTop = c.scrollHeight;
        }

        // 1. ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù† (Ø£Ù‡Ù… Ø®Ø·ÙˆØ© Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„ØªÙƒ)
        if (location.protocol !== 'https:') {
            log("CRITICAL ERROR: Not HTTPS!", true);
            alert("Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ø¢Ù…Ù†! Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù† ØªØ¹Ù…Ù„.");
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ OneSignal
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            await OneSignal.init({
                appId: "46c0fdfe-2b48-474f-b840-8b1a44c22d02",
                allowLocalhostAsSecureOrigin: true,
            });
            log("OneSignal Init Done.");
        });

        // Ø¥Ø¹Ø¯Ø§Ø¯ Pi Network
        const Pi = window.Pi;
        try {
            Pi.init({ version: "2.0", sandbox: false }); // ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± Ù„Ù€ FALSE
            log("Pi SDK (Prod) Ready.");
        } catch (e) { log("Pi Error: " + e, true); }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø¡
        async function startProcess() {
            const btn = document.getElementById('piBtn');
            btn.disabled = true;
            btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...";

            try {
                // Ù…ØµØ§Ø¯Ù‚Ø© Pi
                const scopes = ['username', 'payments'];
                const auth = await Pi.authenticate(scopes, () => {});
                
                log("Auth Success: " + auth.user.username);
                document.getElementById('desc').innerHTML = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ <b>${auth.user.username}</b>`;
                
                // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Pi ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                btn.style.display = 'none';
                document.getElementById('notifyBtn').style.display = 'flex';

                // Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù€ OneSignal
                window.OneSignalDeferred.push(function(OneSignal) {
                    OneSignal.login(auth.user.uid);
                    log("User Linked to OneSignal.");
                });

            } catch (err) {
                log("Auth Failed: " + err, true);
                btn.disabled = false;
                btn.innerHTML = "Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©)
        async function subscribePush() {
            const btn = document.getElementById('notifyBtn');
            btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
            
            // 1. Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Service Worker ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯
            if ('serviceWorker' in navigator) {
                try {
                    // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø³ÙŠÙƒØ´Ù Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙÙ‚ÙˆØ¯Ø§Ù‹ Ø£Ùˆ Ù…Ø­Ø¸ÙˆØ±Ø§Ù‹
                    const reg = await navigator.serviceWorker.register('/OneSignalSDKWorker.js');
                    log("SW Registered manually: " + reg.scope);
                } catch (err) {
                    log("SW Error (Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§): " + err, true);
                    alert("Ø®Ø·Ø£: Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ±ÙØ¶ Ù…Ù„Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† HTTPS!");
                    return; // ØªÙˆÙ‚Ù
                }
            }

            // 2. Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø¹Ø¨Ø± OneSignal
            window.OneSignalDeferred.push(async function(OneSignal) {
                try {
                    log("Requesting Opt-In...");
                    await OneSignal.User.PushSubscription.optIn();
                    
                    // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„ØªØ­Ù‚Ù‚
                    setTimeout(() => {
                        if (OneSignal.User.PushSubscription.optedIn) {
                            log("SUCCESS! Subscribed.");
                            btn.style.background = "#4CAF50";
                            btn.innerHTML = "âœ… ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­";
                        } else {
                            log("Permission denied or closed.", true);
                            btn.innerHTML = "ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª";
                        }
                    }, 3000);
                } catch (e) {
                    log("OptIn Error: " + e, true);
                }
            });
        }
    </script>
</body>
</html>
