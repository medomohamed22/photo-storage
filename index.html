<!DOCTYPE html>
<!--
CHANGELOG (Top 10 UI/UX Updates)
1) ØªØµÙ…ÙŠÙ… Ù‡ÙŠØ¯Ø± Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø¹ Ø²Ø± Ø±Ø¬ÙˆØ¹ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ ÙˆØ´Ø±ÙŠØ· Ø¨Ø­Ø« ØµØºÙŠØ± ÙÙŠ Ø§Ù„Ù‡ÙˆÙ….
2) ØªØ­Ø³ÙŠÙ† Ø´Ø§Ø±Ø§Øª Ø­Ø§Ù„Ø© Pi (Browser/Web + SDK) Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ù‡ÙˆÙ….
3) ØªØ­ÙˆÙŠÙ„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Stepper ÙˆØ§Ø¶Ø­ Ø¨Ù€ 4 Ø®Ø·ÙˆØ§Øª Ù…Ø¹ Ø¨Ø·Ø§Ù‚Ø© Ù…Ù„Ø®Øµ Ø£Ø¬Ù…Ù„.
4) Ø¥Ø¶Ø§ÙØ© Timeline Ù„Ù„Ø­Ø§Ù„Ø© ÙÙŠ ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ + ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ù‡ÙŠÙƒÙ„.
5) ØªØ­Ø¯ÙŠØ« ØµÙØ­Ø© Ø§Ù„Ø¯Ù„ÙŠÙØ±ÙŠ: ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Sticky Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª + Ø£Ø²Ø±Ø§Ø± ÙˆØµÙˆÙ„/ØªØ³Ù„ÙŠÙ… Ù…Ø¤Ù…Ù†Ø©.
6) ØªØµÙ…ÙŠÙ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© ÙƒØ¨Ø·Ø§Ù‚Ø§Øª Ù…Ù†Ø¸Ù…Ø© Ù…Ø¹ Ø²Ø± Ù‚Ø¨ÙˆÙ„ ÙˆØ²Ø± ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.
7) ØªØ­ÙˆÙŠÙ„ ØªØ¨ÙˆÙŠØ¨ Discover Ø¥Ù„Ù‰ â€œMoreâ€ Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨Ø£Ù‚Ø³Ø§Ù… ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ³Ù‡Ù… + Debug checklist.
8) ØªØ­Ø¯ÙŠØ« Bottom Nav Ø¥Ù„Ù‰ Ø´ÙƒÙ„ iOS pill Ù…Ø¹ Ù…Ø¤Ø´Ø± Ù†Ø´Ø· ÙˆØªØ£Ø«ÙŠØ±Ø§Øª Ù„Ù…Ø³.
9) Ø¥Ø¶Ø§ÙØ© Skeleton loaders ÙˆLogs Ø¯ÙØ§Ø¹ÙŠØ© Ù„ØªÙØ§Ø¯ÙŠ ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù†Ø¯ delivered.
10) Ø¥ØµÙ„Ø§Ø­ Ù…Ù†Ø·Ù‚ delivery completion Ù…Ø¹ Ù‚ÙÙ„/ØªØ­Ù‚Ù‚/ØªØ­Ø¯ÙŠØ« Ø§Ø­ØªÙŠØ§Ø·ÙŠ.
-->
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>QuickCart | ÙˆØ§Ø¬Ù‡Ø© Pi (Talabat-style)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase + SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap');

    :root{
      --bg0:#f5f7f8;
      --bg1:#ffffff;
      --bg2:#eef7f2;
      --card:#ffffff;
      --card2:#f6fbf7;
      --stroke:rgba(16,185,129,.15);

      --txt:#0f172a;
      --muted:rgba(15,23,42,.62);
      --p:#10b981;
      --p2:#22c55e;
      --p3:#34d399;

      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#d97706;
      --info:#2563eb;

      --shadow: 0 18px 60px rgba(16,185,129,.12);
      --shadow2: 0 12px 30px rgba(16,185,129,.1);
      --r1:22px;
      --r2:16px;
    }

    *{box-sizing:border-box}
    body{
      font-family:Tajawal,system-ui;
      color:var(--txt);
      min-height:100vh;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(16,185,129,.18), transparent 60%),
        radial-gradient(900px 520px at 95% 0%, rgba(34,197,94,.16), transparent 60%),
        radial-gradient(900px 520px at 70% 110%, rgba(52,211,153,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, var(--bg2));
    }

    /* Safe area bottom for iOS */
    .safeBottom{ padding-bottom: calc(96px + env(safe-area-inset-bottom)); }

    /* Glass / Cards */
    .glass{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      box-shadow: var(--shadow);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .glass:hover{
      transform: translateY(-2px);
      box-shadow: 0 20px 60px rgba(16,185,129,.16);
    }
    .soft{
      background: var(--card2);
      border: 1px solid rgba(16,185,129,.12);
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .soft:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(16,185,129,.14);
    }

    .miniCard, .soft, .glass { overflow: hidden; }

    /* Talabat-like top bar */
    .topBar{
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(16,185,129,.12);
    }

    /* Brand badge */
    .brandBadge{
      width: 44px; height: 44px;
      border-radius: 16px;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(18px 18px at 30% 30%, rgba(16,185,129,.35), rgba(34,197,94,.2));
      border:1px solid rgba(16,185,129,.35);
      box-shadow: 0 16px 40px rgba(16,185,129,.2);
    }

    .headerBack{
      width:40px; height:40px;
      border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(16,185,129,.2);
      background: rgba(255,255,255,.9);
      transition:.2s;
    }
    .headerBack:active{transform:scale(.98)}

    .headerSearch{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(16,185,129,.18);
      background: rgba(255,255,255,.9);
    }
    .headerSearch input{
      border:none !important;
      background: transparent !important;
      padding:0 !important;
      font-size:12px;
    }

    /* Chips */
    .chip{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(16,185,129,.18);
      background: rgba(16,185,129,.08);
      color:var(--txt);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .chip:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(16,185,129,.12); }
    .chipP{ background: rgba(16,185,129,.18); border-color: rgba(16,185,129,.4); }
    .chipB{ background: rgba(15,23,42,.08); border-color: rgba(15,23,42,.14); }
    .chipG{ background: rgba(34,197,94,.15); border-color: rgba(34,197,94,.35); }
    .chipS{ background: rgba(255,255,255,.7); }
    .chipW{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.25); color:#92400e; }

    /* Buttons */
    .btn{
      border-radius:18px;
      padding:12px 14px;
      font-weight:900;
      transition:.15s;
      user-select:none;
      border:1px solid rgba(16,185,129,.2);
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 22px rgba(16,185,129,.18); }
    .btn:active{transform:scale(.98)}
    .btnA{
      background: linear-gradient(135deg, rgba(16,185,129,.95), rgba(34,197,94,.85));
      border-color: rgba(16,185,129,.4);
      color:#fff;
      box-shadow: 0 16px 45px rgba(16,185,129,.25);
    }
    .btnP{
      background: linear-gradient(135deg, rgba(22,163,74,.92), rgba(16,185,129,.85));
      border-color: rgba(22,163,74,.4);
      color:#fff;
      box-shadow: 0 16px 45px rgba(16,185,129,.2);
    }
    .btnG{
      background: linear-gradient(135deg, rgba(34,197,94,.92), rgba(22,163,74,.75));
      border-color: rgba(34,197,94,.35);
      color:#fff;
    }
    .btnB{
      background: linear-gradient(135deg, rgba(96,165,250,.92), rgba(37,99,235,.75));
      border-color: rgba(96,165,250,.35);
      color:#fff;
    }
    .btnS{
      background: rgba(255,255,255,.85);
      border-color: rgba(16,185,129,.2);
      color: var(--txt);
    }

    /* Inputs */
    input,textarea,select{
      width: 100%;
      background: rgba(255,255,255,.9) !important;
      border: 1px solid rgba(16,185,129,.18) !important;
      color: var(--txt) !important;
      border-radius: 16px !important;
      outline: none !important;
      transition: .15s;
      padding: 14px 14px !important;
    }
    input::placeholder, textarea::placeholder{
      color: rgba(15,23,42,.35);
    }
    input:focus,textarea:focus,select:focus{
      border-color: rgba(16,185,129,.6) !important;
      box-shadow: 0 0 0 4px rgba(16,185,129,.15);
    }
    textarea{min-height:96px}

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .tiny{font-size:11px;color:rgba(0,0,0,.55)}
    .muted{color:rgba(0,0,0,.6)}
    .truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

    /* Section Title */
    .secTitle{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .secTitle b{
      font-size:14px;
      letter-spacing:.2px;
    }
    .sectionHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .sectionHeader h3{
      font-size:15px;
      font-weight:800;
    }
    .sectionSub{
      font-size:12px;
      color:var(--muted);
    }
    .pageShell{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .pageSection{
      padding:16px;
    }
    .statsGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .statCard{
      padding:12px;
      border-radius:16px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(16,185,129,.12);
      text-align:center;
    }
    .statCard b{
      display:block;
      font-size:16px;
    }
    .featureGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    .infoCard{
      padding:14px;
      border-radius:16px;
      background: rgba(255,255,255,.9);
      border:1px dashed rgba(16,185,129,.2);
    }
    .listCard{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(16,185,129,.12);
      background: rgba(255,255,255,.9);
    }
    .listIcon{
      width:36px;
      height:36px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(16,185,129,.08);
      border:1px solid rgba(16,185,129,.18);
    }
    .listIcon i{
      color: var(--p);
    }
    .ratingStars{
      display:flex;
      gap:8px;
      justify-content:center;
    }
    .ratingStar{
      width:40px;
      height:40px;
      border-radius:14px;
      border:1px solid rgba(16,185,129,.2);
      background: #fff;
      color: rgba(16,185,129,.6);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .ratingStar:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(16,185,129,.12);
    }
    .ratingStar.active{
      background: rgba(16,185,129,.12);
      color: rgba(16,185,129,1);
      border-color: rgba(16,185,129,.35);
    }

    /* Talabat-like feature cards */
    .miniCard{
      background: var(--card2);
      border: 1px solid rgba(16,185,129,.15);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 25px rgba(16,185,129,.12);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .miniCard:hover{
      transform: translateY(-2px);
      box-shadow: 0 18px 35px rgba(16,185,129,.18);
    }
    .miniIcon{
      width: 40px; height: 40px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(16,185,129,.1);
      border:1px solid rgba(16,185,129,.18);
      box-shadow: 0 12px 28px rgba(16,185,129,.18);
    }
    .miniIcon i{
      color: var(--p);
    }
    .featureGrid .miniCard{
      padding: 16px;
    }
    .featureGrid .miniCard > div{
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    /* Stepper */
    .stepper{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:8px;
    }
    .step{
      border-radius:14px;
      padding:10px;
      border:1px solid rgba(16,185,129,.18);
      background: rgba(255,255,255,.9);
      text-align:center;
      font-size:11px;
      font-weight:700;
    }
    .step .num{
      width:22px;height:22px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      background: rgba(16,185,129,.18);
      color:#065f46;
      margin-bottom:4px;
      font-weight:900;
    }

    /* Timeline */
    .timeline{
      position:relative;
      padding-right:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .timeline::before{
      content:'';
      position:absolute;
      right:6px;
      top:6px;
      bottom:6px;
      width:2px;
      background: rgba(16,185,129,.15);
    }
    .timelineItem{
      display:flex;
      gap:10px;
      align-items:center;
      position:relative;
    }
    .timelineDot{
      width:12px;height:12px;border-radius:999px;
      background: rgba(16,185,129,.2);
      border:2px solid rgba(16,185,129,.3);
      position:relative;
      z-index:1;
    }
    .timelineItem.active .timelineDot{
      background: rgba(16,185,129,.8);
      border-color: rgba(16,185,129,.9);
      box-shadow: 0 0 0 6px rgba(16,185,129,.15);
    }

    /* Chat bubbles */
    .msg{
      max-width:78%;
      padding:10px 12px;
      border-radius:18px;
      font-size:13px;
      word-break:break-word;
      border:1px solid rgba(16,185,129,.15);
      animation: pop .2s ease-in-out;
    }
    @keyframes pop{
      from{transform:scale(.96);opacity:.5}
      to{transform:scale(1);opacity:1}
    }
    .c{ background: rgba(16,185,129,.18); color: var(--txt); align-self:flex-start; }
    .d{ background: rgba(255,255,255,.9); color: var(--txt); align-self:flex-end; }
    .chatImage{
      width:100%;
      max-height:220px;
      object-fit:cover;
      border-radius:14px;
      border:1px solid rgba(16,185,129,.2);
    }
    .chatLayout{
      display:flex;
      flex-direction:column;
      gap:10px;
      height: calc(100vh - 220px);
    }
    .chatScroll{
      flex:1;
      min-height:180px;
      overflow-y:auto;
      overscroll-behavior: contain;
    }
    .page{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    .card{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:12px;
    }
    .card-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .chat-card{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .chat-messages{
      flex:1;
      min-height:180px;
      max-height:38vh;
      overflow:auto;
      padding:8px;
      border-radius:14px;
      background: rgba(0,0,0,.08);
      overscroll-behavior: contain;
    }
    .chat-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .chat-composer{
      display:flex;
      gap:6px;
      position: sticky;
      bottom: 0;
      background: rgba(10,10,20,.55);
      border-top:1px solid rgba(255,255,255,.12);
      padding:10px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      border-radius:14px;
      margin-top:10px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .chatStickyHeader{
      position: sticky;
      top: 0;
      z-index: 5;
      background: rgba(255,255,255,.96);
      border-bottom:1px solid rgba(16,185,129,.12);
      padding-bottom:8px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .actions-card .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .actions-card .btn{
      flex:1;
      min-width:140px;
    }

    /* Bottom nav - app style */
    .bottomNav{
      position: fixed;
      left: 0; right: 0;
      bottom: calc(12px + env(safe-area-inset-bottom));
      z-index: 50;
      padding: 0 14px;
    }
    .bottomNav .wrap{
      max-width: 480px;
      margin: 0 auto;
      padding: 8px;
      border-radius: 26px;
      background: rgba(255,255,255,.95);
      border:1px solid rgba(16,185,129,.12);
      box-shadow: 0 18px 40px rgba(16,185,129,.18);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:flex;
      gap:6px;
    }
    .navItem{
      flex:1;
      padding:10px 8px;
      border-radius:20px;
      border:1px solid transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-size:12px;
      font-weight:800;
      color:#0f172a;
      background: transparent;
      transition:.2s;
    }
    .navItem.active{
      background: rgba(16,185,129,.12);
      border-color: rgba(16,185,129,.3);
      color:#065f46;
      box-shadow: 0 12px 24px rgba(16,185,129,.16);
    }
    .navItem:active{transform:scale(.98)}

    /* Tabs animation */
    .tabPane{opacity:0; transform: translateY(8px);}
    .tabPane.active{opacity:1; transform: translateY(0); transition: .25s ease;}
    .fadeIn{animation: fadeSlide .25s ease;}
    @keyframes fadeSlide{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

    /* Small tweaks */
    .divider{
      height:1px;
      background: rgba(16,185,129,.12);
      margin: 10px 0;
    }
    a.linkP{ color: rgba(16,185,129,1); text-decoration: underline; }

    .row{display:flex;justify-content:space-between;gap:10px;align-items:center;}

    /* Withdraw row */
    .wdRow{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      min-width:0;
    }
    .wdLabel{flex:0 0 auto;white-space:nowrap;opacity:.85;}
    .wdValue{
      flex:1 1 auto;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      padding:6px 10px;
      border:1px solid rgba(16,185,129,.15);
      border-radius:12px;
      background: rgba(255,255,255,.9);
    }

    /* Skeleton */
    .skeletonCard{
      padding:14px;
      border-radius:16px;
      background: rgba(255,255,255,.8);
      border:1px dashed rgba(16,185,129,.2);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .skeletonLine{
      height:10px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(16,185,129,.08), rgba(16,185,129,.18), rgba(16,185,129,.08));
      background-size:200% 100%;
      animation: shimmer 1.2s infinite;
    }
    .skeletonLine.short{width:40%}
    .skeletonLine.mid{width:70%}
    @keyframes shimmer{
      0%{background-position:200% 0}
      100%{background-position:-200% 0}
    }
    .skeletonBadge{
      width:90px;height:18px;border-radius:999px;
      background: linear-gradient(90deg, rgba(16,185,129,.08), rgba(16,185,129,.2), rgba(16,185,129,.08));
      background-size:200% 100%;
      animation: shimmer 1.2s infinite;
    }

    /* Empty state */
    .emptyState{
      text-align:center;
      padding:18px;
      border-radius:16px;
      border:1px dashed rgba(16,185,129,.2);
      background: rgba(255,255,255,.85);
    }

    /* Sticky actions */
    .stickyActions{
      position: sticky;
      bottom: calc(90px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.95);
      border:1px solid rgba(16,185,129,.12);
      border-radius:16px;
      padding:10px;
      box-shadow: 0 16px 30px rgba(16,185,129,.12);
    }

    /* SweetAlert */
    .swal2-popup{
      background: #ffffff !important;
      color: var(--txt) !important;
      border: 1px solid rgba(16,185,129,.18) !important;
      border-radius: 20px !important;
      box-shadow: 0 18px 40px rgba(16,185,129,.18) !important;
    }
    .swal2-title{color: var(--txt) !important;}
    .swal2-html-container{color: var(--muted) !important;}
    .swal2-styled.swal2-confirm{
      background: linear-gradient(135deg, rgba(16,185,129,.95), rgba(34,197,94,.85)) !important;
      border: none !important;
      border-radius: 14px !important;
      box-shadow: 0 12px 25px rgba(16,185,129,.2) !important;
    }
    .swal2-styled.swal2-cancel{
      background: rgba(255,255,255,.9) !important;
      color: var(--txt) !important;
      border: 1px solid rgba(16,185,129,.2) !important;
      border-radius: 14px !important;
      box-shadow: 0 12px 25px rgba(16,185,129,.1) !important;
    }

    /* Header tag */
    .piTag{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(16,185,129,.12);
      border:1px solid rgba(16,185,129,.25);
      color:#065f46;
    }

    /* Cards / lists */
    .orderCard{
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(16,185,129,.15);
      background: rgba(255,255,255,.9);
      box-shadow: 0 12px 25px rgba(16,185,129,.12);
    }
    .orderCard .title{
      font-size:14px;
      font-weight:800;
      margin-bottom:6px;
    }
    .orderCard .meta{
      font-size:12px;
      color:var(--muted);
    }
    .orderCard .meta b{color:var(--txt)}
    .orderCard .actions{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .orderCard .actions .btn{flex:1}
    .nearList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* Customer card */
    .custCard{
      padding:16px;
      border-radius:18px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(16,185,129,.2);
    }
    .custCard .title{
      font-size:14px;
      font-weight:900;
    }
    .custCard .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    /* Tags */
    .tag{
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(16,185,129,.2);
      background: rgba(16,185,129,.1);
    }
    .tag.warn{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.25); color:#92400e; }
    .tag.bad{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.25); color:#991b1b; }
    .tag.info{ background: rgba(96,165,250,.12); border-color: rgba(96,165,250,.25); color:#1e3a8a; }
    .tag.ok{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.25); color:#166534; }

    /* Header */
    .topBar .wrap{
      max-width: 480px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 14px;
      gap:10px;
    }
    .topBar .title{
      font-size:15px;
      font-weight:900;
    }
    .topBar .sub{
      font-size:11px;
      color:var(--muted);
    }

    /* Container */
    .app{
      max-width: 480px;
      margin: 0 auto;
      padding-bottom: 120px;
    }

    .hidden{display:none}

    /* Images in history */
    .historyImage{
      width:100%;
      max-height:160px;
      border-radius:12px;
      border:1px solid rgba(16,185,129,.2);
      object-fit:cover;
    }

    /* Table-like rows */
    .tableRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(16,185,129,.15);
    }
    .tableRow .left{
      display:flex; flex-direction:column;
      gap:2px;
    }

    /* Debug checklist */
    .debugBox{
      padding:14px;
      border-radius:16px;
      background: rgba(255,255,255,.9);
      border:1px dashed rgba(16,185,129,.2);
      font-size:12px;
      line-height:1.7;
    }
  </style>
</head>
<body>
  <div class="topBar">
    <div class="wrap">
      <button class="headerBack hidden" id="headerBack" onclick="handleHeaderBack()">
        <i class="fa-solid fa-chevron-right"></i>
      </button>

      <div class="flex items-center gap-2">
        <div class="brandBadge">
          <i class="fa-solid fa-bag-shopping"></i>
        </div>
        <div>
          <div class="title">QuickCart</div>
          <div class="sub">Ù…ØªØ¬Ø± Ø³Ø±ÙŠØ¹ â€¢ Ø·Ù„Ø¨Ø§Øª ÙÙˆØ±ÙŠØ©</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <span class="piTag" id="piTag">Web</span>
      </div>
    </div>
  </div>

  <!-- HEADER SEARCH -->
  <div class="topBar" style="border-top:1px solid rgba(16,185,129,.1);">
    <div class="wrap">
      <button class="headerBack hidden" id="headerBack" onclick="handleHeaderBack()">
        <i class="fa-solid fa-chevron-right"></i>
      </button>

      <div class="headerSearch" id="headerSearch">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="homeSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø·Ø¹Ù… Ø£Ùˆ Ù…Ù†ØªØ¬" />
      </div>

      <div class="flex items-center gap-2">
        <span class="piTag" id="piSdkBadge"><i class="fa-solid fa-circle-check"></i> <span id="piStateText">SDK</span></span>
      </div>
    </div>
  </div>

  <main class="app safeBottom">
    <!-- LOGIN / HERO -->
    <section id="loginBox" class="pageSection space-y-3 glass">
      <div class="secTitle">
        <b>Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹</b>
        <span class="chip chipP" id="piTag2">Web</span>
      </div>
      <div class="text-sm muted">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Pi.</div>

      <div class="infoCard space-y-2" id="piHint">
        <div class="text-sm font-bold">ØªØ­ØªØ§Ø¬ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Pi Browser</div>
        <div class="tiny">Ù„Ùˆ Ø¨ØªØ³ØªØ®Ø¯Ù… Ù…ØªØµÙØ­ Ø¹Ø§Ø¯ÙŠØŒ Ø§Ù„Ø¯ÙØ¹ Ù‡ÙŠÙƒÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ Ø£Ùˆ ØºÙŠØ± Ù…ØªØ§Ø­.</div>
      </div>

      <div class="space-y-2">
        <button class="btn btnA w-full" onclick="piLogin()">
          <i class="fa-solid fa-right-to-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi
        </button>
        <button class="btn btnS w-full" onclick="devLogin()">
          <i class="fa-solid fa-flask"></i> Ø¯Ø®ÙˆÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ (DEV)
        </button>
      </div>
    </section>

    <!-- MAIN TABS -->
    <div id="homeTab" class="pageShell tabPane active">
      <!-- ================= CUSTOMER (HOME) ================= -->
      <div id="customerHome" class="space-y-3">

        <!-- INTRO -->
        <section class="glass pageSection space-y-3">
          <div class="secTitle">
            <b>ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±ØŒ <span id="custName">Ø¶ÙŠÙ</span> ğŸ‘‹</b>
            <span class="chip chipS">Pi Wallet</span>
          </div>

          <div class="miniCard space-y-2">
            <div class="row">
              <div class="text-sm">Ø­Ø§Ù„Ø© Pi SDK:</div>
              <span class="chip chipP"><i class="fa-solid fa-circle-check"></i> Ready</span>
            </div>
            <div class="row">
              <div class="text-sm">Ø§Ù„ÙˆØ¶Ø¹:</div>
              <span class="chip chipB" id="piSdkBadge2">Browser</span>
            </div>
            <div class="tiny muted">Ù‚Ù… Ø¨ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Pi Browser Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª.</div>
          </div>

          <div class="featureGrid">
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-burger"></i></span>
                <div>
                  <div class="text-sm font-bold">Ù…Ø·Ø§Ø¹Ù…</div>
                  <div class="tiny muted">ÙˆØ¬Ø¨Ø§Øª Ø³Ø§Ø®Ù†Ø© ÙˆØªÙˆØµÙŠÙ„ Ø³Ø±ÙŠØ¹</div>
                </div>
              </div>
            </div>
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-pills"></i></span>
                <div>
                  <div class="text-sm font-bold">ØµÙŠØ¯Ù„ÙŠØ§Øª</div>
                  <div class="tiny muted">Ø£Ø¯ÙˆÙŠØ© Ø¹Ø§Ø¬Ù„Ø© ÙˆØªÙˆØµÙŠÙ„ Ø¢Ù…Ù†</div>
                </div>
              </div>
            </div>
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-cart-shopping"></i></span>
                <div>
                  <div class="text-sm font-bold">Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</div>
                  <div class="tiny muted">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨ÙŠØª ÙÙŠ Ø¯Ù‚Ø§Ø¦Ù‚</div>
                </div>
              </div>
            </div>
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-bolt"></i></span>
                <div>
                  <div class="text-sm font-bold">Ø·Ù„Ø¨Ø§Øª ÙÙˆØ±ÙŠØ©</div>
                  <div class="tiny muted">ØªÙˆØµÙŠÙ„ Ø³Ø±ÙŠØ¹ Ù…Ø¹ ÙƒØ§Ø¨ØªÙ† Ù‚Ø±ÙŠØ¨</div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ================= DELIVERY (HOME) ================= -->
      <div id="deliveryHome" class="hidden space-y-3">
    <section class="glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-motorcycle mr-1"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¯Ù„ÙŠÙØ±ÙŠ</b>
            <button onclick="loadOrders()" class="chip chipS">
              <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
            </button>
          </div>

          <div class="miniCard">
            <div class="flex items-center justify-between">
              <div class="text-sm">Ø§Ù„ÙƒØ§Ø¨ØªÙ†: <b id="delName">â€”</b></div>
              <span class="miniIcon"><i class="fa-solid fa-helmet-safety"></i></span>
            </div>

            <div class="soft p-3 mt-3 space-y-2">
              <div class="flex items-center justify-between">
                <span class="muted text-sm">Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙƒØ§Ø¨ØªÙ†</span>
                <button class="chip chipG" onclick="setDeliveryLocation()">
                  <i class="fa-solid fa-crosshairs"></i> ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ
                </button>
              </div>
              <div id="delLocStatus" class="tiny muted">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯.</div>
              <div id="delLocHint" class="tiny hidden" style="color:#b45309">ÙØ¹Ù‘Ù„ GPS ÙˆØ§Ø³Ù…Ø­ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹.</div>
              <div class="tiny muted">Ø³ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ 5 ÙƒÙ… ÙÙ‚Ø·.</div>
            </div>
          </div>
        </section>

        <div id="ordersBox" class="space-y-2"></div>
        <div class="glass pageSection space-y-3">
          <div class="sectionHeader">
            <div>
              <h3>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
              <div class="sectionSub">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© Ù„Ù„ÙƒØ§Ø¨ØªÙ†.</div>
            </div>
            <span class="chip chipS"><i class="fa-solid fa-chart-line"></i> Ø§Ù„ÙŠÙˆÙ…</span>
          </div>
          <div class="statsGrid">
            <div class="statCard">
              <b id="statOrders">0</b>
              <span class="tiny muted">Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</span>
            </div>
            <div class="statCard">
              <b id="statRating">4.9</b>
              <span class="tiny muted">ØªÙ‚ÙŠÙŠÙ… Ù…ØªÙˆØ³Ø·</span>
            </div>
            <div class="statCard">
              <b id="statZone">5km</b>
              <span class="tiny muted">Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙˆØµÙŠÙ„</span>
            </div>
          </div>
        </div>

        <section class="glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-hand-holding-dollar mr-1"></i> Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯</b>
            <button class="chip chipS" onclick="loadWalletPi()">
              <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
            </button>
          </div>

          <div class="miniCard space-y-1">
            <div class="text-sm">
              Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:
              <b class="mono text-emerald-500"><span id="walletPi">0.000000</span> Pi</b>
            </div>
            <div class="tiny muted">ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¯Ù„ÙŠÙØ±ÙŠ Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø§Øª.</div>
          </div>

          <div class="space-y-2">
            <label class="tiny muted">Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© Pi</label>
            <input id="wdWallet" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© Pi" />
          </div>

          <div class="space-y-2">
            <label class="tiny muted">Ø§Ù„Ù…Ø¨Ù„Øº (Pi)</label>
            <input id="wdAmountPi" type="number" step="0.0000001" placeholder="ÙƒÙ… Pi Ù‡ØªØ³Ø­Ø¨ØŸ" />
          </div>

          <button id="withdrawBtn" data-label="Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯" onclick="withdrawPi()" class="btn btnP w-full">
            <i class="fa-solid fa-wallet"></i>
            Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯
          </button>
          <div id="withdrawStatus" class="tiny muted"></div>
        </section>
      </div>
    </div>

    <!-- ================= TRACK TAB ================= -->
    <div id="trackTab" class="hidden pageShell tabPane">

      <!-- ================= CUSTOMER (TRACK) ================= -->
      <div id="customerTrackTab" class="hidden space-y-3">
        <!-- TRACK -->
        <section id="custTrack" class="hidden glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-route mr-1"></i> Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨</b>
            <div class="flex items-center gap-2">
              <button class="chip chipS" onclick="refreshCustomerStatus()">
                <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
              </button>
              <span class="chip chipP"><i class="fa-solid fa-circle-info"></i> Live</span>
            </div>
          </div>

          <div class="miniCard space-y-2">
            <div class="flex items-center justify-between">
              <span class="muted text-sm">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</span>
              <b id="custStatus" class="text-emerald-500">pending</b>
            </div>

            <div class="flex items-center justify-between text-sm">
              <span class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span>
              <b id="custAddressView" class="truncate">â€”</b>
            </div>

            <div class="flex items-center justify-between text-sm">
              <span class="muted">Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
              <a id="custTrackMapLink" class="linkP hidden" target="_blank" rel="noopener noreferrer" onclick="return openMapUrl(this.href)">
                ÙØªØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
              </a>
            </div>

            <div id="otpBox" class="hidden text-sm">
              <span class="muted">ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</span>:
              <b id="otp" class="text-emerald-500 text-lg mono"></b>
              <div class="tiny muted mt-1">Ù‚Ø¯Ù‘Ù… Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„ÙƒØ§Ø¨ØªÙ† Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„.</div>
            </div>
          </div>

          <div class="miniCard">
            <div class="text-sm font-bold mb-2">ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø§Ù„Ø©</div>
            <div id="custTimeline" class="timeline">
              <div class="timelineItem" data-status="pending">
                <span class="timelineDot"></span>
                <div class="text-sm">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</div>
              </div>
              <div class="timelineItem" data-status="accepted">
                <span class="timelineDot"></span>
                <div class="text-sm">ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</div>
              </div>
              <div class="timelineItem" data-status="shipping">
                <span class="timelineDot"></span>
                <div class="text-sm">Ø§Ù„ÙƒØ§Ø¨ØªÙ† ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</div>
              </div>
              <div class="timelineItem" data-status="arrived">
                <span class="timelineDot"></span>
                <div class="text-sm">Ø§Ù„ÙƒØ§Ø¨ØªÙ† ÙˆØµÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹</div>
              </div>
              <div class="timelineItem" data-status="delivered">
                <span class="timelineDot"></span>
                <div class="text-sm">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
              </div>
            </div>
          </div>
        </section>

        <!-- RATING -->
        <section id="custRating" class="hidden glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-star mr-1"></i> ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙƒØ§Ø¨ØªÙ†</b>
            <span class="chip chipS">Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</span>
          </div>
          <div class="miniCard space-y-3 text-center">
            <div class="text-sm">Ù‚ÙŠÙ‘Ù… ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ù† 1 Ø¥Ù„Ù‰ 5 Ù†Ø¬ÙˆÙ….</div>
            <div class="ratingStars" id="ratingStars">
              <button class="ratingStar" onclick="selectRating(1)">1</button>
              <button class="ratingStar" onclick="selectRating(2)">2</button>
              <button class="ratingStar" onclick="selectRating(3)">3</button>
              <button class="ratingStar" onclick="selectRating(4)">4</button>
              <button class="ratingStar" onclick="selectRating(5)">5</button>
            </div>
            <textarea id="ratingNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù„Ù„Ø¯Ù„ÙŠÙØ±ÙŠ"></textarea>
            <button class="btn btnP w-full" onclick="submitRating()">
              Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
            </button>
          </div>
        </section>

        <!-- HISTORY -->
        <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-clock-rotate-left mr-1"></i> Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ</b>
            <button class="chip chipS" onclick="loadCustomerHistory()">
              <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
            </button>
          </div>
          <div id="custHistory" class="space-y-2 text-sm"></div>
        </section>
      </div>

      <!-- ================= DELIVERY (TRACK) ================= -->
      <div id="deliveryTrackTab" class="hidden space-y-3">
        <main class="chatLayout">
          <header class="chatStickyHeader">
            <div class="secTitle">
              <b><i class="fa-solid fa-comments mr-1"></i> Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</b>
              <button class="chip chipS" onclick="refreshDeliveryChat()">
                <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
              </button>
            </div>
            <div class="tiny muted">Ø±Ø³Ø§Ø¦Ù„ Ø³Ø±ÙŠØ¹Ø© Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆØµÙŠÙ„.</div>
          </header>

          <section class="card chat-card">
            <div id="delChat" class="chat-messages"></div>
            <div class="chat-composer items-center">
              <input id="msgD" class="flex-1" placeholder="Ø±Ø³Ø§Ù„Ø©..." />
              <label class="chip chipS cursor-pointer">
                <i class="fa-regular fa-image"></i>
                <input type="file" id="imgD" accept="image/*" class="hidden" />
                ØµÙˆØ±Ø©
              </label>
              <button onclick="sendMsg('delivery')" class="btn btnB" style="padding:12px 14px">
                <i class="fa-solid fa-arrow-up"></i>
              </button>
            </div>
          </section>

          <section class="card actions-card">
            <header class="card-head">
              <b><i class="fa-solid fa-headset mr-1"></i> Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø·Ù„Ø¨</b>
            </header>
            <div class="btn-row mt-3">
              <button id="arrivedBtn" onclick="setOrderStatus('arrived')" class="btn btnA">
                <i class="fa-solid fa-location-crosshairs"></i> ÙˆØµÙ„Øª
              </button>
              <button id="finishBtn" onclick="finishWithOtp()" class="btn btnG">
                <i class="fa-solid fa-check"></i> ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…
              </button>
            </div>
          </section>
        </main>


        <!-- WITHDRAW HISTORY -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-list mr-1"></i> Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨</b>
            <button class="chip chipS" onclick="loadWithdrawHistory()">
              <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
            </button>
          </div>
          <div id="wdHistory" class="space-y-2 text-sm"></div>
        </section>

        <!-- DELIVERY HISTORY -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-clock-rotate-left mr-1"></i> Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ ÙƒØ¯Ù„ÙŠÙØ±ÙŠ</b>
            <button class="chip chipS" onclick="loadDeliveryHistory()">
              <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
            </button>
          </div>
          <div id="delHistory" class="space-y-2 text-sm"></div>
        </section>
      </div>
    </div>

    <!-- ================= DISCOVER TAB ================= -->
    <div id="discoverTab" class="hidden pageShell tabPane">
      <section class="glass pageSection space-y-3">
        <div class="sectionHeader">
          <div>
            <h3>Ø§Ù„Ù…Ø²ÙŠØ¯</h3>
            <div class="sectionSub">ÙƒÙ„ Ù…Ø§ ØªØ­ØªØ§Ø¬Ù‡ ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯.</div>
          </div>
          <span class="chip chipP"><i class="fa-solid fa-ellipsis"></i> More</span>
        </div>
        <div class="space-y-2">
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-headset"></i></span>
            <div class="flex-1">
              <div class="text-sm font-bold">Ø§Ù„Ø¯Ø¹Ù…</div>
              <div class="tiny muted">ØªÙˆØ§ØµÙ„ Ø³Ø±ÙŠØ¹ Ù…Ø¹ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-question"></i></span>
            <div class="flex-1">
              <div class="text-sm font-bold">Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</div>
              <div class="tiny muted">Ø­Ù„ Ø³Ø±ÙŠØ¹ Ù„Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø·Ù„Ø¨.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-shield"></i></span>
            <div class="flex-1">
              <div class="text-sm font-bold">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</div>
              <div class="tiny muted">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­ÙˆÙ„ Ø­Ù…Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-bug"></i></span>
            <div class="flex-1">
              <div class="text-sm font-bold">Debug Checklist</div>
              <div class="tiny muted">ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¯ÙØ¹ Ùˆ Pi SDK ÙŠØ¹Ù…Ù„Ø§Ù†.</div>
            </div>
          </div>
          <div class="debugBox">
            <div>âœ… Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Pi Browser Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Pi SDK.</div>
            <div>âœ… Ø¬Ø±Ù‘Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø«Ù… Ø§Ø¯ÙØ¹ 0.1 Pi.</div>
            <div>âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø¯ÙˆÙ„ orders ÙÙŠ Supabase.</div>
            <div>âœ… Ø¬Ø±Ù‘Ø¨ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙƒØ¯Ù„ÙŠÙØ±ÙŠ ÙˆØ§Ù„ØªØ³Ù„ÙŠÙ….</div>
            <div>âœ… Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª realtime Ù…Ù† Ø®Ù„Ø§Ù„ Console logs Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©.</div>
            <div>âœ… ØªØ£ÙƒØ¯ Ø£Ù† Ù‚Ø³Ù… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø¸Ù‡Ø± ÙˆØªÙ… Ø¹Ù…Ù„ scroll Ø¥Ù„ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- BOTTOM NAV -->
  <div id="bottomNav" class="bottomNav hidden">
    <div class="wrap">
      <button id="navHome" onclick="setMainTab('home')" class="navItem">
        <i class="fa-solid fa-plus"></i>
        <span>Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</span>
      </button>
      <button id="navTrack" onclick="setMainTab('track')" class="navItem">
        <i class="fa-solid fa-route"></i>
        <span>Ù…ØªØ§Ø¨Ø¹Ø©</span>
      </button>
      <button id="navDiscover" onclick="setMainTab('discover')" class="navItem">
        <i class="fa-solid fa-compass"></i>
        <span>Ø§Ù„Ù…Ø²ÙŠØ¯</span>
      </button>
    </div>
  </div>

  <script>
/* ================== CONFIG ================== */
Pi.init({ version: "2.0", sandbox: false });

const SUPABASE_URL = window.SUPABASE_URL || '';
const SUPABASE_KEY = window.SUPABASE_ANON_KEY || '';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================== FEES ================== */
const DELIVERY_FEE_EGP = 20;
const PLATFORM_FEE_EGP = 10;

/* ================== GLOBALS ================== */
let PI_USER = null;
let PI_USERNAME = null;
let PI_UID = null;
let ACTIVE_ORDER = null;
let CUSTOMER_LOCATION = null;
let DELIVERY_LOCATION = null;
let HAS_LOCATION_COLUMNS = true;
let ACTIVE_ROLE = 'customer';
let ACTIVE_MAIN_TAB = 'home';
let ACTIVE_RATING = 0;
let FINISH_LOCK = false;
let LAST_DELIVERED_ORDER_ID = null;

/* ================== RATES ================== */
let PI_USDT = 0;     // 1 PI in USDT
let USD_EGP = 0;     // 1 USD in EGP

/* ================== UI: DETECT + INIT ================== */
function detectPi() {
  const hasPi = typeof window.Pi !== 'undefined';
  const ua = (navigator.userAgent || '').toLowerCase();
  const isPiBrowser = ua.includes('pibrowser') || hasPi;

  document.getElementById('piStateText').innerText = hasPi ? 'SDK Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ¬Ø§Ù‡Ø²' : 'SDK ØºÙŠØ± Ù…ØªØ§Ø­';
  document.getElementById('piTag').innerText = isPiBrowser ? 'Pi Browser' : 'Web';
  document.getElementById('piTag2').innerText = isPiBrowser ? 'Pi Browser' : 'Web';
  document.getElementById('piSdkBadge').classList.toggle('chipW', !hasPi);
  document.getElementById('piHint').classList.toggle('hidden', isPiBrowser);
}

function handleHeaderBack(){
  if (ACTIVE_MAIN_TAB !== 'home') {
    setMainTab('home');
  } else if (ACTIVE_ORDER) {
    setMainTab('track');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  detectPi();
  initRatingStars();
  refreshRates();
  setInterval(fetchPiFromOKX, 30000);
  setInterval(fetchUsdEgp, 60000);
});

/* ================== DATA: RATES ================== */
async function refreshRates(){
  await Promise.allSettled([fetchPiFromOKX(), fetchUsdEgp()]);
  recalcInvoice();
}

function setRateHint(show){
  document.getElementById('rateHint').classList.toggle('hidden', !show);
}

async function fetchPiFromOKX(){
  try{
    const r = await fetch("https://www.okx.com/api/v5/market/ticker?instId=PI-USDT", { cache: "no-store" });
    const j = await r.json();
    const last = parseFloat(j?.data?.[0]?.last || "0");
    if(last > 0) PI_USDT = last;

    document.getElementById('piUsdt').innerText = PI_USDT ? PI_USDT.toFixed(6) : 'â€”';
    updatePiEgpOne();
    setRateHint(!(PI_USDT > 0 && USD_EGP > 0));
  }catch(e){
    console.warn('OKX PI ticker failed:', e);
    setRateHint(true);
  }
}

async function fetchUsdEgp(){
  try{
    const r = await fetch("https://open.er-api.com/v6/latest/USD", { cache: "no-store" });
    const j = await r.json();
    const rate = parseFloat(j?.rates?.EGP || "0");
    if(rate > 0) USD_EGP = rate;

    document.getElementById('usdEgp').innerText = USD_EGP ? USD_EGP.toFixed(4) : 'â€”';
    updatePiEgpOne();
    setRateHint(!(PI_USDT > 0 && USD_EGP > 0));
  }catch(e){
    console.warn('USD/EGP failed:', e);
    document.getElementById('usdEgp').innerText = 'ÙØ´Ù„';
    setRateHint(true);
  }
}

function updatePiEgpOne(){
  const piEgp = (PI_USDT && USD_EGP) ? (PI_USDT * USD_EGP) : 0;
  document.getElementById('piEgpOne').innerText = piEgp ? piEgp.toFixed(3) : 'â€”';
}

function egpToPi(egp){
  const piEgp = PI_USDT * USD_EGP;
  if(!piEgp || piEgp <= 0) return 0;
  return egp / piEgp;
}

/* ================== HELPERS: LOCATION ================== */
function getCurrentLocation(){
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'));
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
      (err) => reject(err),
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  });
}

function buildMapUrl(lat, lng){
  return `https://www.google.com/maps?q=${encodeURIComponent(lat)},${encodeURIComponent(lng)}`;
}

function openMapUrl(url){
  if (!url || url === '#') return false;
  if (window.Pi && typeof Pi.openUrlInSystemBrowser === 'function') {
    Pi.openUrlInSystemBrowser(url);
    return false;
  }
  window.open(url, '_blank', 'noopener,noreferrer');
  return false;
}

async function setCustomerLocation(){
  try{
    const loc = await getCurrentLocation();
    CUSTOMER_LOCATION = loc;
    const status = `ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}`;
    document.getElementById('custLocStatus').innerText = status;
    document.getElementById('custLocHint').classList.add('hidden');
    const link = document.getElementById('custMapLink');
    link.href = buildMapUrl(loc.lat, loc.lng);
    link.classList.remove('hidden');
    link.onclick = () => openMapUrl(link.href);
  }catch(e){
    document.getElementById('custLocHint').classList.remove('hidden');
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ' });
  }
}

async function setDeliveryLocation(){
  try{
    const loc = await getCurrentLocation();
    DELIVERY_LOCATION = loc;
    const status = `ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}`;
    document.getElementById('delLocStatus').innerText = status;
    document.getElementById('delLocHint').classList.add('hidden');
    await loadOrders();
  }catch(e){
    document.getElementById('delLocHint').classList.remove('hidden');
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ' });
  }
}

function distanceKm(a, b){
  if(!a || !b) return null;
  const R = 6371;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const lat1 = a.lat * Math.PI / 180;
  const lat2 = b.lat * Math.PI / 180;
  const sinDLat = Math.sin(dLat / 2);
  const sinDLng = Math.sin(dLng / 2);
  const h = sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLng * sinDLng;
  return 2 * R * Math.asin(Math.sqrt(h));
}

function hasMissingLocationColumn(error){
  const msg = String(error?.message || '').toLowerCase();
  return msg.includes('customer_lat') || msg.includes('customer_lng') || msg.includes('customer_address');
}

/* ================== AUTH ================== */
async function piLogin() {
  try {
    if (!window.Pi || !Pi.authenticate) {
      return Swal.fire({ icon: 'warning', title: 'Pi SDK ØºÙŠØ± Ù…ØªØ§Ø­', text: 'Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Pi Browser Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯ÙØ¹.' });
    }

    const ua = (navigator.userAgent || '').toLowerCase();
    if (!ua.includes('pibrowser')) {
      const r = await Swal.fire({
        icon: 'info',
        title: 'Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©',
        text: 'Ø§Ù„Ø£ÙØ¶Ù„ ØªÙØªØ­ Ø¯Ø§Ø®Ù„ Pi Browser Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯ÙØ¹ ÙŠØ´ØªØºÙ„ 100%.',
        showCancelButton: true,
        confirmButtonText: 'ÙƒÙ…Ù‘Ù„',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
      });
      if (!r.isConfirmed) return;
    }

    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    const scopes = ['username', 'payments'];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);

    const username = auth?.user?.username || auth?.username || null;
    const uid = auth?.user?.uid || auth?.user?.id || auth?.uid || null;
    if (!username) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… username Ù…Ù† Pi');

    PI_USER = auth;
    PI_USERNAME = username;
    PI_UID = uid || username;

    document.getElementById('custName').innerText = PI_USERNAME;
    document.getElementById('delName').innerText = PI_USERNAME;

    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('bottomNav').classList.remove('hidden');
    document.getElementById('roleToggle').classList.remove('hidden');

    // Ø²Ø± Admin ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø£Ø¯Ù…Ù†
    if (PI_USERNAME === 'medomohamed22') {
      document.getElementById('adminLink').classList.remove('hidden');
    } else {
      document.getElementById('adminLink').classList.add('hidden');
    }

    setMainTab('home');
    setRole('customer');

    await refreshRates();
    await restoreActiveOrder();
    loadOrders();
    loadWalletPi();
    loadCustomerHistory();
    loadDeliveryHistory();
    loadWithdrawHistory();

    Swal.close();

  } catch (e) {
    console.error('piLogin error:', e);
    Swal.fire({ icon: 'error', title: 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

function devLogin(){
  PI_USERNAME = 'dev_user_' + Math.floor(Math.random()*9999);
  PI_UID = PI_USERNAME;

  document.getElementById('custName').innerText = PI_USERNAME;
  document.getElementById('delName').innerText = PI_USERNAME;

  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('bottomNav').classList.remove('hidden');
  document.getElementById('roleToggle').classList.remove('hidden');

  document.getElementById('adminLink').classList.add('hidden');

  setMainTab('home');
  setRole('customer');

  restoreActiveOrder();
  refreshRates();
  loadOrders();
  loadWalletPi();
  loadCustomerHistory();
  loadDeliveryHistory();
  loadWithdrawHistory();
}

function onIncompletePaymentFound(payment) {
  console.log('incomplete payment found:', payment);
}

/* ================== RESTORE ACTIVE ORDER ================== */
function activeOrderStorageKey(){
  return PI_USERNAME ? `qc_active_order_${PI_USERNAME}` : 'qc_active_order';
}

function setActiveOrderId(orderId){
  ACTIVE_ORDER = orderId;
  if (orderId) {
    localStorage.setItem(activeOrderStorageKey(), orderId);
  } else {
    localStorage.removeItem(activeOrderStorageKey());
  }
}

async function restoreActiveOrder(){
  const cached = localStorage.getItem(activeOrderStorageKey());
  if(!cached) return;
  ACTIVE_ORDER = cached;
  await loadOrderDetailsForDelivery(cached);
  markSeen('delivery');
  listenDeliveryStatus();
}

function markSeen(role){
  const key = `qc_seen_${role}_${PI_USERNAME || 'guest'}`;
  localStorage.setItem(key, Date.now().toString());
}

/* ================== NAV ================== */
function setActiveTab(tabId) {
  const tabs = document.querySelectorAll('.tabPane');
  tabs.forEach(t => t.classList.add('hidden'));
  document.getElementById(tabId).classList.remove('hidden');
  setTimeout(() => document.getElementById(tabId).classList.add('active'), 50);
}

/* ================== CART ================== */
let CART = [];

function addToCart(name, price){
  CART.push({ name, price: Number(price || 0) });
  renderCart();
}

function removeFromCart(idx){
  CART.splice(idx, 1);
  renderCart();
}

function renderCart(){
  const box = document.getElementById('cartList');
  if(!box) return;
  if(!CART.length){
    box.innerHTML = `<div class="tiny muted">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø¶ÙŠØ©.</div>`;
    return;
  }
  box.innerHTML = CART.map((c, i) => `
    <div class="tableRow">
      <div class="left">
        <div><b>${escapeHtml(c.name)}</b></div>
        <div class="tiny muted">${Number(c.price).toFixed(2)} Ø¬</div>
      </div>
      <button class="btn btnS" onclick="removeFromCart(${i})"><i class="fa-solid fa-trash"></i></button>
    </div>
  `).join('');
}

function cartTotal(){
  return CART.reduce((sum, i) => sum + Number(i.price || 0), 0);
}

/* ================== INVOICE ================== */
function recalcInvoice(){
  const price = cartTotal();
  const delFee = DELIVERY_FEE_EGP;
  const platformFee = PLATFORM_FEE_EGP;
  const total = price + delFee + platformFee;

  document.getElementById('invPrice').innerText = price.toFixed(2);
  document.getElementById('invDel').innerText = delFee.toFixed(2);
  document.getElementById('invPlatform').innerText = platformFee.toFixed(2);
  document.getElementById('invTotal').innerText = total.toFixed(2);

  const piEgp = PI_USDT * USD_EGP;
  const totalPi = piEgp ? total / piEgp : 0;
  document.getElementById('invTotalPi').innerText = totalPi ? totalPi.toFixed(6) : 'â€”';
}

function orderDataFromForm() {
  const productName = document.getElementById('prod').value.trim();
  const price = parseFloat(document.getElementById('price').value || "0");
  const notes = document.getElementById('notes').value.trim();
  const orderType = document.getElementById('orderType').value;
  const customerAddress = document.getElementById('custAddress').value.trim();

  if (!productName || !price || price <= 0 || !customerAddress) {
    Swal.fire('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©');
    return null;
  }

  return {
    product_name: productName,
    price,
    notes,
    order_type: orderType,
    customer_address: customerAddress
  };
}

async function payOrder(){
  try {
    if (!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    const data = orderDataFromForm();
    if (!data) return;

    const total = cartTotal() + DELIVERY_FEE_EGP + PLATFORM_FEE_EGP;
    const totalPi = egpToPi(total);

    const confirm = await Swal.fire({
      icon: 'question',
      title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨',
      html: `
        <div style="text-align:right">
          <div>Ø§Ù„Ù…Ù†ØªØ¬: <b>${escapeHtml(data.product_name)}</b></div>
          <div>Ø§Ù„Ø³Ø¹Ø±: <b>${total.toFixed(2)} Ø¬</b></div>
          <div>Ø¨Ø§Ù„Ù€ Pi: <b>${Number(totalPi||0).toFixed(6)} Pi</b></div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†',
      cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    if (!confirm.isConfirmed) return;

    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯ÙØ¹...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    const paymentData = {
      amount: Number(totalPi||0).toFixed(6),
      memo: `Order-${Date.now()}`,
      metadata: { customer: PI_USERNAME }
    };

    if (!window.Pi || !Pi.createPayment) throw new Error('Pi SDK ØºÙŠØ± Ù…ØªØ§Ø­');

    const payment = await Pi.createPayment(paymentData, {
      onReadyForServerApproval: async (paymentId) => {
        await fetch('/.netlify/functions/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paymentId })
        });
      },
      onReadyForServerCompletion: async (paymentId, txid) => {
        await fetch('/.netlify/functions/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paymentId, txid })
        });
      },
      onCancel: () => {
        console.log('Payment canceled');
      },
      onError: (error) => {
        console.error('Payment error:', error);
      }
    });

    const payload = {
      ...data,
      customer_pi_username: PI_USERNAME,
      status: 'pending',
      total_price: total,
      pricing_snapshot: {
        total_pi: Number(totalPi||0),
        platform_fee_pi: Number(egpToPi(PLATFORM_FEE_EGP)||0),
        pi_egp: Number(PI_USDT*USD_EGP||0)
      }
    };

    const { data: order, error } = await db.from('orders').insert([payload]).select().single();
    if (error) throw error;

    setActiveOrderId(order.id);
    setMainTab('track');
    await refreshCustomerStatus();
    await refreshRates();
    await loadCustomerHistory();

    Swal.close();
  } catch (e) {
    console.error(e);
    Swal.fire({ icon: 'error', title: 'ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹', text: e?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£' });
  }
}

/* ================== CUSTOMER: TRACK ================== */
async function refreshCustomerStatus(){
  try{
    if(!PI_USERNAME || !ACTIVE_ORDER) return;

    const { data, error } = await db.from('orders')
      .select('status,customer_address,customer_lat,customer_lng,otp_code')
      .eq('id', ACTIVE_ORDER)
      .eq('customer_pi_username', PI_USERNAME)
      .single();

    if(error) throw error;

    const status = data.status || 'pending';
    document.getElementById('custStatus').innerText = status;
    updateTimeline(status);

    if (data.customer_address) {
      document.getElementById('custAddressView').innerText = data.customer_address;
    }

    if (data.customer_lat && data.customer_lng) {
      const link = document.getElementById('custTrackMapLink');
      link.href = buildMapUrl(data.customer_lat, data.customer_lng);
      link.classList.remove('hidden');
      link.onclick = () => openMapUrl(link.href);
    }

    if (status === 'delivered' && data.otp_code) {
      document.getElementById('otpBox').classList.remove('hidden');
      document.getElementById('otp').innerText = data.otp_code;
    }
  }catch(e){
    console.error(e);
  }
}

function updateTimeline(status){
  document.querySelectorAll('#custTimeline .timelineItem').forEach(item => {
    const s = item.getAttribute('data-status');
    item.classList.toggle('active', s === status);
  });
}

/* ================== CUSTOMER: HISTORY ================== */
async function loadCustomerHistory(){
  try{
    if(!PI_USERNAME) return;
    const box = document.getElementById('custHistory');
    box.innerHTML = ordersSkeleton();

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,total_price,status,created_at,pricing_snapshot,delivery_id')
      .eq('customer_pi_username', PI_USERNAME)
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data?.length){
      box.innerHTML = `<div class="tiny">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯.</div>`;
      return;
    }

    const orderIds = data.map(o => o.id);
    let ratingMap = {};
    if (orderIds.length) {
      const { data: ratings } = await db.from('delivery_ratings')
        .select('order_id,rating')
        .in('order_id', orderIds);
      (ratings || []).forEach(r => {
        ratingMap[r.order_id] = r.rating;
      });
    }

    box.innerHTML = data.map(o => {
      const totalEgp = Number(o.total_price||0);
      const totalPi = Number(o?.pricing_snapshot?.total_pi || (egpToPi(totalEgp) || 0));
      const s = o.status || 'pending';
      const rating = ratingMap[o.id];

      const color =
        s==='delivered' ? 'text-emerald-500' :
        s==='canceled' ? 'text-red-400' :
        'text-emerald-600';

      return `
        <div class="soft p-3">
          <div class="row">
            <b class="truncate">${escapeHtml(o.product_name)}</b>
            <span class="chip ${color}">${escapeHtml(s)}</span>
          </div>
          <div class="tiny mt-1">Ù†ÙˆØ¹: <b>${escapeHtml(o.order_type||'any')}</b>${o.delivery_id ? ` | ÙƒØ§Ø¨ØªÙ†: <b>${escapeHtml(o.delivery_id)}</b>` : ``}</div>
          <div class="row mt-1">
            <span class="tiny">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
            <b class="text-emerald-500">${totalEgp.toFixed(2)} Ø¬</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">Ø¨Ø§Ù„Ù€ Pi</span>
            <b class="mono text-emerald-600">${Number(totalPi||0).toFixed(6)} Pi</b>
          </div>
          ${typeof rating === 'number' ? `<div class="tiny mt-1">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙƒØ§Ø¨ØªÙ†: <b>${rating}</b> â­</div>` : ``}
          <div class="tiny mt-1">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
        </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('custHistory').innerHTML = `<div class="tiny" style="color:#fca5a5">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>`;
  }
}

/* ================== DELIVERY: ORDERS ================== */
async function loadOrders(){
  try{
    if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ ÙƒØ§Ø¨ØªÙ† Ø§Ù„Ø£ÙˆÙ„');
    if(!DELIVERY_LOCATION) return Swal.fire('Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø£ÙˆÙ„Ø§Ù‹');

    document.getElementById('ordersBox').innerHTML = ordersSkeleton();

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,total_price,status,created_at,customer_lat,customer_lng,customer_address,pricing_snapshot')
      .eq('status','pending')
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    const near = (data || []).filter(o => {
      const loc = { lat: o.customer_lat, lng: o.customer_lng };
      const d = distanceKm(DELIVERY_LOCATION, loc);
      return d !== null && d <= 5;
    });

    if(!near.length){
      document.getElementById('ordersBox').innerHTML = `
        <div class="emptyState">
          <div class="text-sm font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù‚Ø±ÙŠØ¨Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>
          <div class="tiny muted">Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.</div>
        </div>
      `;
      return;
    }

    document.getElementById('ordersBox').innerHTML = near.map(o => {
      const totalEgp = Number(o.total_price||0);
      const totalPi = Number(o?.pricing_snapshot?.total_pi || (egpToPi(totalEgp) || 0));
      return `
        <div class="orderCard">
          <div class="title">${escapeHtml(o.product_name)}</div>
          <div class="meta">Ù†ÙˆØ¹: <b>${escapeHtml(o.order_type||'any')}</b></div>
          <div class="meta">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <b>${escapeHtml(o.customer_address||'')}</b></div>
          <div class="row mt-2">
            <span class="tiny">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
            <b class="text-emerald-500">${totalEgp.toFixed(2)} Ø¬</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">Ø¨Ø§Ù„Ù€ Pi</span>
            <b class="mono text-emerald-600">${Number(totalPi||0).toFixed(6)} Pi</b>
          </div>
          <div class="actions">
            <button class="btn btnA" onclick="acceptOrder('${o.id}')"><i class="fa-solid fa-check"></i> Ù‚Ø¨ÙˆÙ„</button>
            <button class="btn btnS" onclick="openMap('${o.customer_lat}','${o.customer_lng}')"><i class="fa-solid fa-map"></i> Ø®Ø±ÙŠØ·Ø©</button>
          </div>
        </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('ordersBox').innerHTML = `<div class="tiny" style="color:#fca5a5">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>`;
  }
}

function openMap(lat, lng){
  if(!lat || !lng) return;
  openMapUrl(buildMapUrl(lat, lng));
}

async function acceptOrder(orderId){
  try{
    if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„');
    const { error } = await db.from('orders')
      .update({ status:'accepted', delivery_id: PI_USERNAME })
      .eq('id', orderId)
      .eq('status', 'pending');
    if(error) throw error;

    setActiveOrderId(orderId);
    await loadOrderDetailsForDelivery(orderId);
    markSeen('delivery');
    listenDeliveryStatus();
    await loadOrders();
  }catch(e){
    console.error(e);
    Swal.fire('ÙØ´Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨');
  }
}

async function loadOrderDetailsForDelivery(orderId){
  try{
    const { data, error } = await db.from('orders')
      .select('product_name,order_type,notes,price,delivery_fee,total_price,platform_fee,customer_address,customer_lat,customer_lng,status')
      .eq('id', orderId)
      .single();
    if(error) throw error;

    const el = document.getElementById('delChat');
    if(!el) return;

    const delFee = (data.delivery_fee ?? DELIVERY_FEE_EGP);
    const platformFee = (data.platform_fee ?? PLATFORM_FEE_EGP);
    const total = (data.total_price ?? (Number(data.price||0) + delFee + platformFee));

    const totalPi = egpToPi(total);

    el.innerHTML = `
      <div class="tiny muted">Ø·Ù„Ø¨: <b>${escapeHtml(data.product_name)}</b></div>
      <div class="tiny muted">Ù†ÙˆØ¹: <b>${escapeHtml(data.order_type||'any')}</b></div>
      <div class="tiny muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <b>${escapeHtml(data.customer_address||'')}</b></div>
      <div class="tiny muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: <b>${escapeHtml(data.notes||'â€”')}</b></div>
      <div class="tiny muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b>${Number(total||0).toFixed(2)} Ø¬</b></div>
      <div class="tiny muted">Ø¨Ø§Ù„Ù€ Pi: <b>${Number(totalPi||0).toFixed(6)} Pi</b></div>
    `;

    document.getElementById('delChat').classList.remove('hidden');
  }catch(e){
    console.error(e);
  }
}

async function setOrderStatus(st){
  if(!ACTIVE_ORDER) return;
  if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„');
  const ok = await Swal.fire({
    icon: 'question',
    title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø©',
    text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ØŸ',
    showCancelButton: true,
    confirmButtonText: 'Ù†Ø¹Ù…ØŒ ÙˆØµÙ„Øª',
    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
  });
  if (!ok.isConfirmed) return;
  await db.from('orders').update({ status: st }).eq('id', ACTIVE_ORDER);
}

async function verifyDeliveredStatus(orderId){
  for (let i = 0; i < 3; i += 1) {
    const { data, error } = await db.from('orders')
      .select('status')
      .eq('id', orderId)
      .single();
    if (error) {
      console.warn('[verifyDeliveredStatus] query failed', error);
    } else {
      const normalized = normalizeStatus(data?.status);
      console.log('[verifyDeliveredStatus] attempt', i + 1, normalized);
      if (['delivered','completed'].includes(normalized)) {
        return true;
      }
    }
    await new Promise(resolve => setTimeout(resolve, 700));
  }
  return false;
}

async function finishWithOtp(){
  try{
    if(FINISH_LOCK) return;
    if(!ACTIVE_ORDER) return;
    if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„');

    const confirm = await Swal.fire({
      icon: 'warning',
      title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…',
      text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ø³Ù„Ù…Øª Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„ØŸ',
      showCancelButton: true,
      confirmButtonText: 'Ù…ØªØ£ÙƒØ¯',
      cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    if (!confirm.isConfirmed) return;

    const { value: code } = await Swal.fire({
      title: 'ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…',
      input: 'text',
      inputPlaceholder: 'Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„',
      showCancelButton: true,
      confirmButtonText: 'ØªØ£ÙƒÙŠØ¯',
      cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    if(!code) return;

    FINISH_LOCK = true;
    safeDom('finishBtn')?.setAttribute('disabled', 'true');
    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    const rpcPromise = db.rpc('complete_delivery', {
      p_order_id: ACTIVE_ORDER,
      p_otp: String(code).trim(),
      p_delivery_id: PI_USERNAME
    });
    const timeoutPromise = new Promise((_, reject) => {
      setTimeout(() => reject(new Error('timeout')), 8000);
    });

    const { error } = await Promise.race([rpcPromise, timeoutPromise]);
    if(error) throw error;

    const deliveredOk = await verifyDeliveredStatus(ACTIVE_ORDER);
    if (!deliveredOk) {
      const { data: current, error: readErr } = await db.from('orders')
        .select('status')
        .eq('id', ACTIVE_ORDER)
        .single();
      if (readErr) throw readErr;
      const normalized = normalizeStatus(current?.status);
      if (['arrived','shipping'].includes(normalized)) {
        await db.from('orders')
          .update({ status: 'delivered' })
          .eq('id', ACTIVE_ORDER)
          .eq('delivery_id', PI_USERNAME)
          .in('status', ['arrived','shipping']);
      }
      await verifyDeliveredStatus(ACTIVE_ORDER);
    }

    Swal.fire({ icon:'success', title:'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…' });
    await loadWalletPi();
    await loadDeliveryHistory();
    await loadOrders();
    safeDom('delChat')?.classList.add('hidden');
    setActiveOrderId(null);
    if (chatChannel) {
      try { db.removeChannel(chatChannel); } catch {}
      chatChannel = null;
    }
    if (chatPollTimer) clearInterval(chatPollTimer);
    if (statusPollTimer) clearInterval(statusPollTimer);
    if (deliveryStatusChannel) {
      try { db.removeChannel(deliveryStatusChannel); } catch {}
      deliveryStatusChannel = null;
    }

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ…', text: e?.message || 'OTP ØºÙ„Ø· Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­' });
  } finally {
    FINISH_LOCK = false;
    safeDom('finishBtn')?.removeAttribute('disabled');
  }
}

/* ================== WALLET (Pi) ================== */
/**
 * âœ… Ø£ÙˆÙ„Ø§Ù‹: delivery_wallet.balance_pi
 * âœ… Ø®ØµÙ… Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø§Øª: withdrawals
 * âœ… fallback: Ø­Ø³Ø§Ø¨ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¯Ù„ÙŠÙØ±ÙŠ Ù…Ù† orders delivered (total_pi - platform_fee_pi)
 */
function toNum(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

function calcDeliveryEarningsPi(order) {
  const snap = order?.pricing_snapshot || {};
  const totalPi = toNum(snap.total_pi);
  const platformFeePi = toNum(snap.platform_fee_pi);
  
  // Ø§Ù„Ø£ÙØ¶Ù„: snapshot Ù…ÙˆØ¬ÙˆØ¯
  if (totalPi > 0) return Math.max(0, totalPi - platformFeePi);
  
  // fallback (Ù„Ùˆ snapshot Ù†Ø§Ù‚Øµ)
  const priceEgp = toNum(order?.price);
  const deliveryFeeEgp = toNum(order?.delivery_fee);
  const totalPriceEgp = toNum(order?.total_price);
  const platformFeeEgp = toNum(order?.platform_fee);
  
  const baseEgp = (priceEgp || deliveryFeeEgp) ?
    (priceEgp + deliveryFeeEgp) :
    Math.max(0, totalPriceEgp - platformFeeEgp);
  
  const piEgp = toNum(snap.pi_egp);
  if (baseEgp > 0 && piEgp > 0) return baseEgp / piEgp;
  
  return 0;
}

async function getWithdrawnSum() {
  if (!PI_UID) return 0;
  const { data, error } = await db.from('withdrawals')
    .select('amount')
    .eq('pi_user_id', PI_UID)
    .limit(1000);
  
  if (error) throw error;
  
  let sum = 0;
  (data || []).forEach(w => {
    sum += toNum(w.amount);
  });
  return sum;
}

async function loadWalletPi() {
  try {
    if (!PI_UID) return;

    const balanceRes = await fetch('/.netlify/functions/get-balance', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ uid: PI_UID })
    });
    if (balanceRes.ok) {
      const out = await balanceRes.json().catch(() => ({}));
      const balance = Math.max(0, toNum(out?.balance));
      document.getElementById('walletPi').innerText = balance.toFixed(6);
      return;
    }

    // fallback: Ø­Ø³Ø§Ø¨ Ù…Ø­Ù„ÙŠ ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ø³ÙŠØ±ÙØ±
    const withdrawnSum = await getWithdrawnSum();
    const { data: earnings, error: e2 } = await db.from('delivery_earnings')
      .select('amount_pi')
      .eq('delivery_id', PI_UID)
      .limit(1000);

    if (e2) throw e2;

    let earned = 0;
    (earnings || []).forEach((row) => {
      earned += toNum(row.amount_pi);
    });

    const available = Math.max(0, earned - withdrawnSum);
    document.getElementById('walletPi').innerText = available.toFixed(6);
    
  } catch (e) {
    console.warn(e);
    document.getElementById('walletPi').innerText = '0.000000';
  }
}

/* ================== WITHDRAW ================== */
/**
 * âœ… Flow Ø§Ù„ØµØ­ÙŠØ­:
 * 1) Call /.netlify/functions/withdraw -> Netlify function (withdraw.js)
 * 2) Ù„Ùˆ Ù†Ø¬Ø­: ÙŠØ¸Ù‡Ø± TX Ù…Ø¨Ø§Ø´Ø±Ø©
 */
function setWithdrawStatus(message, state) {
  const statusEl = document.getElementById('withdrawStatus');
  if (!statusEl) return;
  statusEl.textContent = message || '';
  statusEl.style.color = state === 'error'
    ? '#dc2626'
    : state === 'success'
      ? '#16a34a'
      : state === 'loading'
        ? '#2563eb'
        : 'rgba(0,0,0,.6)';
}

async function withdrawPi() {
  try {
    const btn = document.getElementById('withdrawBtn');
    const originalLabel = btn?.dataset?.label || btn?.innerText;

    if (!PI_USERNAME || !PI_UID) {
      setWithdrawStatus('âŒ Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
      return;
    }

    const amount = parseFloat(document.getElementById('wdAmountPi').value || "0");
    const walletAddress = (document.getElementById('wdWallet').value || '').trim();

    if (!amount || amount <= 0) {
      setWithdrawStatus('âŒ Ø§ÙƒØªØ¨ ÙƒÙ…ÙŠØ© Pi ØµØ­ÙŠØ­Ø©', 'error');
      return;
    }
    if (!walletAddress || walletAddress.length < 10) {
      setWithdrawStatus('âŒ Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© Pi ØµØ­ÙŠØ­', 'error');
      return;
    }

    const available = parseFloat(document.getElementById('walletPi').innerText || "0") || 0;
    if (amount > available) {
      setWithdrawStatus('âŒ Ø§Ù„Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­', 'error');
      return;
    }

    setWithdrawStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø³Ø­Ø¨...', 'loading');
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø³Ø­Ø¨...';
    }

    const res = await fetch('/.netlify/functions/withdraw', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        uid: PI_UID,
        username: PI_USERNAME,
        amount,
        walletAddress
      })
    });
      
    const out = await res.json().catch(() => ({}));
    if (!res.ok || !out?.success) {
      const msg = out?.error || out?.details || 'ÙØ´Ù„ Ø§Ù„Ø³Ø­Ø¨';
      throw new Error(msg);
    }

    setWithdrawStatus(`âœ… ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ ${out.txid ? `- ${out.txid}` : ''}`, 'success');

    document.getElementById('wdAmountPi').value = '';
    document.getElementById('wdWallet').value = '';

    const balanceAfter = Number(out?.balance_after);
    if (Number.isFinite(balanceAfter)) {
      document.getElementById('walletPi').innerText = balanceAfter.toFixed(6);
    } else {
      await loadWalletPi();
    }
    await loadWithdrawHistory();

  } catch (e) {
    console.error(e);
    setWithdrawStatus(`âŒ ${e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£'}`, 'error');
  } finally {
    const btn = document.getElementById('withdrawBtn');
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = `<i class="fa-solid fa-wallet"></i> ${btn.dataset?.label || 'Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯'}`;
    }
  }
}

async function copyWalletAddress(){
  const walletInput = document.getElementById('wdWallet');
  const val = walletInput.value.trim();
  if (!val) return Swal.fire('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†ÙˆØ§Ù† Ù„Ù„Ù†Ø³Ø®');
  try{
    await navigator.clipboard.writeText(val);
    Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…', timer: 1200, showConfirmButton: false });
  }catch(e){
    walletInput.select();
    document.execCommand('copy');
    Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…', timer: 1200, showConfirmButton: false });
  }
}

async function pasteWalletAddress(){
  try{
    const text = await navigator.clipboard.readText();
    if (!text) return Swal.fire('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ø­Ø§ÙØ¸Ø©');
    document.getElementById('wdWallet').value = text.trim();
  }catch(e){
    Swal.fire('ØªØ¹Ø°Ø± Ù„ØµÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†. Ø§Ù„ØµÙ‚Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§.');
  }
}

/* ================== WITHDRAW HISTORY ================== */
async function loadWithdrawHistory() {
  try {
    if (!PI_USERNAME) return;
    if (!PI_UID) return;
      
    const box = document.getElementById('wdHistory');
    if (!box) return;
      
    box.innerHTML = `
      <div class="skeletonCard">
        <div class="skeletonLine mid"></div>
        <div class="skeletonLine"></div>
      </div>
    `;
      
    const { data, error } = await db.from('withdrawals')
      .select('id,amount,wallet_address,created_at,txid')
      .eq('pi_user_id', PI_UID)
      .order('created_at', { ascending: false })
      .limit(50);
    
    if (error) throw error;
    
    if (!data || !data.length) {
      box.innerHTML = `<div class="tiny muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨.</div>`;
      return;
    }
    
    box.innerHTML = data.map(w => `
      <div class="soft p-3 space-y-1">
        <div class="row">
          <b class="mono text-emerald-500">${Number(w.amount||0).toFixed(6)} Pi</b>
          <span class="chip chipG">Ù…ÙƒØªÙ…Ù„</span>
        </div>

        <div class="tiny muted break-all">
          <b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b>
          <span class="mono">${escapeHtml(w.wallet_address || '-')}</span>
        </div>

        ${w.txid ? `
          <div class="tiny muted break-all">
            <b>TX:</b>
            <span class="mono">${escapeHtml(w.txid)}</span>
          </div>` : ``}
      </div>
    `).join('');
    
  } catch (e) {
    console.error(e);
    const box = document.getElementById('wdHistory');
    if (box) {
      box.innerHTML = `<div class="tiny" style="color:#fca5a5">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨</div>`;
    }
  }
}
/* ================== HISTORY: CUSTOMER + DELIVERY ================== */
async function loadCustomerHistory(){
  try{
    if(!PI_USERNAME) return;
    const box = document.getElementById('custHistory');
    box.innerHTML = ordersSkeleton();

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,total_price,status,created_at,pricing_snapshot,delivery_id')
      .eq('customer_pi_username', PI_USERNAME)
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data?.length){
      box.innerHTML = `<div class="tiny">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯.</div>`;
      return;
    }

    const orderIds = data.map(o => o.id);
    let ratingMap = {};
    if (orderIds.length) {
      const { data: ratings } = await db.from('delivery_ratings')
        .select('order_id,rating')
        .in('order_id', orderIds);
      (ratings || []).forEach(r => {
        ratingMap[r.order_id] = r.rating;
      });
    }

    box.innerHTML = data.map(o => {
      const totalEgp = Number(o.total_price||0);
      const totalPi = Number(o?.pricing_snapshot?.total_pi || (egpToPi(totalEgp) || 0));
      const s = o.status || 'pending';
      const rating = ratingMap[o.id];

      const color =
        s==='delivered' ? 'text-emerald-500' :
        s==='canceled' ? 'text-red-400' :
        'text-emerald-600';

      return `
        <div class="soft p-3">
          <div class="row">
            <b class="truncate">${escapeHtml(o.product_name)}</b>
            <span class="chip ${color}">${escapeHtml(s)}</span>
          </div>
          <div class="tiny mt-1">Ù†ÙˆØ¹: <b>${escapeHtml(o.order_type||'any')}</b>${o.delivery_id ? ` | ÙƒØ§Ø¨ØªÙ†: <b>${escapeHtml(o.delivery_id)}</b>` : ``}</div>
          <div class="row mt-1">
            <span class="tiny">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
            <b class="text-emerald-500">${totalEgp.toFixed(2)} Ø¬</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">Ø¨Ø§Ù„Ù€ Pi</span>
            <b class="mono text-emerald-600">${Number(totalPi||0).toFixed(6)} Pi</b>
          </div>
          ${typeof rating === 'number' ? `<div class="tiny mt-1">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙƒØ§Ø¨ØªÙ†: <b>${rating}</b> â­</div>` : ``}
          <div class="tiny mt-1">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
        </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('custHistory').innerHTML = `<div class="tiny" style="color:#fca5a5">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>`;
  }
}

async function loadDeliveryHistory(){
  try{
    if(!PI_USERNAME) return;
    const box = document.getElementById('delHistory');
    box.innerHTML = ordersSkeleton();

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,total_price,status,created_at,pricing_snapshot,customer_pi_username')
      .eq('delivery_id', PI_USERNAME)
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data?.length){
      box.innerHTML = `<div class="tiny">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¹Ù„ÙŠÙƒ Ø¨Ø¹Ø¯.</div>`;
      const statOrders = document.getElementById('statOrders');
      if (statOrders) statOrders.innerText = '0';
      return;
    }

    const statOrders = document.getElementById('statOrders');
    if (statOrders) statOrders.innerText = String(data.length);

    const orderIds = data.map(o => o.id);
    let ratingMap = {};
    if (orderIds.length) {
      const { data: ratings } = await db.from('delivery_ratings')
        .select('order_id,rating')
        .in('order_id', orderIds);
      (ratings || []).forEach(r => {
        ratingMap[r.order_id] = r.rating;
      });
    }

    const ratingValues = Object.values(ratingMap).filter(v => typeof v === 'number');
    const statRating = document.getElementById('statRating');
    if (statRating) {
      if (ratingValues.length) {
        const avg = ratingValues.reduce((sum, v) => sum + v, 0) / ratingValues.length;
        statRating.innerText = avg.toFixed(1);
      } else {
        statRating.innerText = 'â€”';
      }
    }

    box.innerHTML = data.map(o => {
      const totalEgp = Number(o.total_price||0);
      const totalPi = Number(o?.pricing_snapshot?.total_pi || (egpToPi(totalEgp) || 0));
      const profitPi = Number(o?.pricing_snapshot?.delivery_fee_pi || 0);
      const s = o.status || 'pending';
      const rating = ratingMap[o.id];

      return `
        <div class="soft p-3">
          <div class="row">
            <b class="truncate">${escapeHtml(o.product_name)}</b>
            <span class="chip">${escapeHtml(s)}</span>
          </div>
          <div class="tiny mt-1">Ø¹Ù…ÙŠÙ„: <b>${escapeHtml(o.customer_pi_username||'â€”')}</b></div>
          <div class="row mt-1">
            <span class="tiny">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
            <b class="text-emerald-500">${totalEgp.toFixed(2)} Ø¬</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">Ø¨Ø§Ù„Ù€ Pi</span>
            <b class="mono text-emerald-600">${Number(totalPi||0).toFixed(6)} Pi</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">Ø±Ø¨Ø­Ùƒ</span>
            <b class="mono text-emerald-600">${profitPi.toFixed(6)} Pi</b>
          </div>
          ${typeof rating === 'number' ? `<div class="tiny mt-1">ØªÙ‚ÙŠÙŠÙ…Ùƒ: <b>${rating}</b> â­</div>` : ``}
          <div class="tiny mt-1">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
        </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('delHistory').innerHTML = `<div class="tiny" style="color:#fca5a5">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¯Ù„ÙŠÙØ±ÙŠ</div>`;
  }
}

/* ================== UI ================== */
function toggleRole(){
  setRole(ACTIVE_ROLE === 'customer' ? 'delivery' : 'customer');
}

function setRole(role){
  ACTIVE_ROLE = role;
  updateRoleUI();
}

function setMainTab(tab){
  ACTIVE_MAIN_TAB = tab;
  updateMainTabUI();
}

function updateRoleUI(){
  const isCustomer = ACTIVE_ROLE === 'customer';
  document.getElementById('roleToggle').innerText = isCustomer ? 'User' : 'Delivery';
  document.getElementById('customerHome').classList.toggle('hidden', !isCustomer);
  document.getElementById('deliveryHome').classList.toggle('hidden', isCustomer);
  document.getElementById('customerTrackTab').classList.toggle('hidden', !isCustomer);
  document.getElementById('deliveryTrackTab').classList.toggle('hidden', isCustomer);

  if(isCustomer){
    loadCustomerHistory();
  } else {
    loadOrders();
    loadWalletPi();
    loadWithdrawHistory();
    loadDeliveryHistory();
  }
}

function setTabVisibility(id, show){
  const el = document.getElementById(id);
  if (show) {
    el.classList.remove('hidden');
    el.classList.add('active','fadeIn');
    setTimeout(() => el.classList.remove('fadeIn'), 300);
  } else {
    el.classList.remove('active');
    el.classList.add('hidden');
  }
}

function updateMainTabUI(){
  const isHome = ACTIVE_MAIN_TAB === 'home';
  const isTrack = ACTIVE_MAIN_TAB === 'track';
  const isDiscover = ACTIVE_MAIN_TAB === 'discover';

  setTabVisibility('homeTab', isHome);
  setTabVisibility('trackTab', isTrack);
  setTabVisibility('discoverTab', isDiscover);

  document.getElementById('navHome').classList.toggle('active', isHome);
  document.getElementById('navTrack').classList.toggle('active', isTrack);
  document.getElementById('navDiscover').classList.toggle('active', isDiscover);

  document.getElementById('headerSearch').classList.toggle('hidden', !isHome);
  const showBack = (!isHome || ACTIVE_ORDER);
  document.getElementById('headerBack').classList.toggle('hidden', !showBack);
}

/* ================== HELPERS ================== */
function escapeHtml(str){
  return String(str ?? '').replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}
function safeDom(id){
  return document.getElementById(id) || null;
}
function normalizeStatus(status){
  return String(status || '').trim().toLowerCase();
}
  </script>
</body>
</html>
