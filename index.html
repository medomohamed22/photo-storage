<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø·Ù„Ø¨Ø§Øª Ø¨Ø±Ùˆ | Pi Delivery</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<style>
body{font-family:Tajawal,system-ui;background:#f3f4f6}
.msg{max-width:75%;padding:8px 12px;border-radius:16px;font-size:13px}
.c{background:#f97316;color:white;align-self:flex-start}
.d{background:#e5e7eb;align-self:flex-end}
</style>
</head>
<body class="pb-24">

<header class="bg-orange-600 text-white p-4 text-center font-bold">Ø·Ù„Ø¨Ø§Øª Ø¨Ø±Ùˆ ğŸš€</header>

<div class="max-w-lg mx-auto p-3 space-y-4">

<!-- LOGIN -->
<div id="loginBox" class="bg-white p-4 rounded-xl shadow text-center">
<button onclick="piLogin()" class="bg-purple-600 text-white p-3 rounded-xl w-full">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Pi</button>
</div>

<!-- TABS -->
<div id="tabs" class="hidden flex bg-orange-100 rounded-xl overflow-hidden">
<button onclick="showTab('customer')" class="flex-1 p-3 font-bold bg-white" id="btnC">Ø¹Ù…ÙŠÙ„</button>
<button onclick="showTab('delivery')" class="flex-1 p-3 font-bold" id="btnD">Ø¯Ù„ÙŠÙØ±ÙŠ</button>
</div>

<!-- ================= CUSTOMER ================= -->
<div id="customer" class="hidden space-y-3">

<div class="bg-white p-4 rounded-xl shadow space-y-2">
<input id="prod" class="w-full p-2 border rounded" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
<input id="price" type="number" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡" oninput="calcPi()">
<div class="text-sm text-gray-600">â‰ˆ <b id="piVal">0</b> Pi</div>
<button onclick="payAndCreate()" class="bg-orange-500 text-white w-full p-3 rounded-xl">Ø§Ø¯ÙØ¹ ÙˆØ§Ø·Ù„Ø¨ ğŸš€</button>
</div>

<div id="custTrack" class="hidden bg-white p-4 rounded-xl shadow space-y-2">
<b id="custStatus">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„...</b>
<div id="otpBox" class="hidden">ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…: <b id="otp"></b></div>
</div>

<div id="custChat" class="hidden bg-white p-3 rounded-xl shadow space-y-2">
<div id="chatC" class="flex flex-col gap-2 h-48 overflow-y-auto"></div>
<div class="flex gap-1">
<input id="msgC" class="flex-1 border rounded p-2">
<input type="file" id="imgC" accept="image/*">
<button onclick="sendMsg('customer')" class="bg-orange-500 text-white px-4 rounded">â¤</button>
</div>
</div>

</div>

<!-- ================= DELIVERY ================= -->
<div id="delivery" class="hidden space-y-3">

<div id="ordersBox" class="space-y-2"></div>

<div id="delChat" class="hidden bg-white p-3 rounded-xl shadow space-y-2">
<b>Ø´Ø§Øª Ø§Ù„Ø·Ù„Ø¨</b>
<div id="chatD" class="flex flex-col gap-2 h-48 overflow-y-auto"></div>
<div class="flex gap-1">
<input id="msgD" class="flex-1 border rounded p-2">
<input type="file" id="imgD" accept="image/*">
<button onclick="sendMsg('delivery')" class="bg-blue-600 text-white px-4 rounded">â¤</button>
</div>

<div class="grid grid-cols-2 gap-2">
<button onclick="setStatus('arrived')" class="bg-orange-500 text-white p-2 rounded">ÙˆØµÙ„Øª</button>
<button onclick="finishWithOtp()" class="bg-green-600 text-white p-2 rounded">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
</div>
</div>

<div class="bg-white p-3 rounded-xl shadow">
<b>Ù…Ø­ÙØ¸ØªÙŠ</b>
<div>Ø§Ù„Ø±ØµÙŠØ¯: <b id="wallet">0</b> Ø¬Ù†ÙŠÙ‡</div>
<input id="wdAmount" class="border p-2 rounded w-full" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨">
<button onclick="withdraw()" class="bg-purple-600 text-white p-2 rounded w-full mt-2">Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>
</div>

</div>

</div>

<script>
Pi.init({version:"2.0",sandbox:false});

const supabase = supabasejs.createClient(
'https://axjkwrssmofzavaoqutq.supabase.co',
'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci'
);

let PI_USER=null, ACTIVE_ORDER=null, PI_RATE=1;

// ===== PI LOGIN =====
async function piLogin(){
const scopes=['username','payments'];
PI_USER=await Pi.authenticate(scopes,()=>{});
loginBox.classList.add('hidden');
tabs.classList.remove('hidden');
showTab('customer');
loadOrders();
loadWallet();
fetchRate();
setInterval(fetchRate,30000);
}

// ===== PRICE =====
async function fetchRate(){
try{
const r=await fetch("https://www.okx.com/api/v5/market/ticker?instId=PI-USDT");
const j=await r.json();
PI_RATE=parseFloat(j.data[0].last);
calcPi();
}catch{}
}

function calcPi(){
piVal.innerText=((+price.value||0)/PI_RATE).toFixed(3);
}

// ===== PAYMENT + ORDER =====
async function payAndCreate(){
const amountPi=(+price.value/PI_RATE).toFixed(3);

const payment=await Pi.createPayment({
amount:amountPi,
memo:"Delivery Order",
metadata:{price:price.value}
},async pid=>{
await fetch('/api/pi/approve',{method:'POST',body:JSON.stringify({paymentId:pid})});
},async pid=>{
await fetch('/api/pi/complete',{method:'POST',body:JSON.stringify({paymentId:pid})});
});

const otp=Math.floor(1000+Math.random()*9000).toString();

const {data}=await supabase.from('orders').insert([{
product_name:prod.value,
price:+price.value,
total_price:+price.value,
status:'pending',
otp_code:otp,
customer_pi_username:PI_USER.user.username
}]).select();

ACTIVE_ORDER=data[0].id;
custTrack.classList.remove('hidden');
custChat.classList.remove('hidden');
otp.innerText=otp;
listenStatus();
startChat();
}

// ===== DELIVERY ORDERS =====
async function loadOrders(){
const {data}=await supabase.from('orders').select('*').eq('status','pending');
ordersBox.innerHTML=data.map(o=>`
<div class="bg-white p-3 rounded shadow">
<b>${o.product_name}</b>
<button onclick="accept('${o.id}')" class="bg-green-600 text-white p-2 rounded w-full mt-2">Ù‚Ø¨ÙˆÙ„</button>
</div>`).join('');
}

async function accept(id){
const {data,error}=await supabase.rpc('accept_order_once',{
p_order_id:id,
p_delivery_id:PI_USER.user.username
});
if(error) return alert(error.message);
ACTIVE_ORDER=id;
delChat.classList.remove('hidden');
startChat();
}

// ===== CHAT =====
function startChat(){
supabase.channel('chat')
.on('postgres_changes',{event:'INSERT',table:'chat_messages',filter:`order_id=eq.${ACTIVE_ORDER}`},p=>{
append(p.new);
})
.subscribe();
}

async function sendMsg(role){
const txt=(role==='customer'?msgC:msgD).value;
const img=(role==='customer'?imgC:imgD).files[0];

let url=null;
if(img){
const path=`chat/${Date.now()}_${img.name}`;
await supabase.storage.from('chat').upload(path,img);
url=supabase.storage.from('chat').getPublicUrl(path).data.publicUrl;
}

await supabase.from('chat_messages').insert([{
order_id:ACTIVE_ORDER,
sender:role,
message_text:txt,
image_url:url
}]);

(role==='customer'?msgC:msgD).value='';
}

function append(m){
const box=m.sender==='customer'?chatC:chatD;
box.innerHTML+=`
<div class="msg ${m.sender==='customer'?'c':'d'}">
${m.message_text||''}
${m.image_url?`<img src="${m.image_url}" class="mt-1 rounded">`:''}
</div>`;
box.scrollTop=box.scrollHeight;
}

// ===== STATUS =====
function listenStatus(){
supabase.channel('status')
.on('postgres_changes',{event:'UPDATE',table:'orders',filter:`id=eq.${ACTIVE_ORDER}`},p=>{
custStatus.innerText=p.new.status;
if(p.new.status==='delivered') alert('ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…');
})
.subscribe();
}

async function setStatus(s){
await supabase.from('orders').update({status:s}).eq('id',ACTIVE_ORDER);
}

async function finishWithOtp(){
const code=prompt("Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„");
const {error}=await supabase.rpc('complete_delivery',{
p_order_id:ACTIVE_ORDER,
p_otp:code,
p_delivery_id:PI_USER.user.username
});
if(error) alert(error.message);
}

// ===== WALLET =====
async function loadWallet(){
const {data}=await supabase.from('delivery_wallet').select('*').eq('delivery_id',PI_USER.user.username).single();
wallet.innerText=data?.balance||0;
}

async function withdraw(){
await supabase.from('withdraw_requests').insert([{
delivery_id:PI_USER.user.username,
amount:+wdAmount.value
}]);
alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨');
}

// ===== UI =====
function showTab(t){
customer.classList.add('hidden');
delivery.classList.add('hidden');
btnC.classList.remove('bg-white');
btnD.classList.remove('bg-white');

if(t==='customer'){customer.classList.remove('hidden');btnC.classList.add('bg-white');}
else{delivery.classList.remove('hidden');btnD.classList.add('bg-white');}
}
</script>

</body>
</html>
