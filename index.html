<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø·Ù„Ø¨Ø§Øª Ø¨Ø±Ùˆ | Ù†Ø³Ø®Ø© Pi (ØªÙØ§ØµÙŠÙ„ + ØªØ³Ø¹ÙŠØ±)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <style>
    body{font-family:Tajawal,system-ui;background:#f3f4f6}
    .msg{max-width:78%;padding:8px 12px;border-radius:16px;font-size:13px;word-break:break-word}
    .c{background:#f97316;color:#fff;align-self:flex-start}
    .d{background:#e5e7eb;color:#111827;align-self:flex-end}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .row{display:flex;justify-content:space-between;gap:10px}
  </style>
</head>

<body class="pb-24">
  <header class="bg-orange-600 text-white p-4 text-center font-bold">Ø·Ù„Ø¨Ø§Øª Ø¨Ø±Ùˆ ğŸš€</header>

  <div class="max-w-lg mx-auto p-3 space-y-3">

    <!-- Ø­Ø§Ù„Ø© Pi + Ø§Ù„ØªØ³Ø¹ÙŠØ± -->
    <div class="bg-white p-3 rounded-xl shadow space-y-2">
      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-700">
          <b>Ø­Ø§Ù„Ø© Pi:</b> <span id="piStateText" class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span>
        </div>
        <span id="piTag" class="chip">â€¦</span>
      </div>

      <div class="grid grid-cols-2 gap-2 text-xs">
        <div class="bg-gray-50 p-2 rounded-lg border">
          <div class="text-gray-500">Ø³Ø¹Ø± Pi (USDT)</div>
          <div class="font-bold mono"><span id="piUsdt">â€”</span></div>
          <div class="text-[10px] text-gray-400">Ù…ØµØ¯Ø±: OKX</div>
        </div>
        <div class="bg-gray-50 p-2 rounded-lg border">
          <div class="text-gray-500">Ø³Ø¹Ø± USD (EGP)</div>
          <div class="font-bold mono"><span id="usdEgp">â€”</span></div>
          <div class="text-[10px] text-gray-400">Ù…ØµØ¯Ø±: open.er-api.com</div>
        </div>
      </div>

      <div class="text-xs text-gray-500">
        Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§: Pi ÙƒÙ„ <b>30 Ø«Ø§Ù†ÙŠØ©</b> â€” ØªØ­ÙˆÙŠÙ„ USD/EGP ÙƒÙ„ <b>60 Ø«Ø§Ù†ÙŠØ©</b>.
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginBox" class="bg-white p-4 rounded-xl shadow text-center space-y-3">
      <div class="text-gray-700 text-sm">
        Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø­Ø³Ø§Ø¨ Pi Ø¹Ø´Ø§Ù† ØªÙ‚Ø¯Ø± ØªØ·Ù„Ø¨/ØªØ´ØªØºÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ.
      </div>
      <button id="loginBtn" onclick="piLogin()" class="bg-purple-600 text-white p-3 rounded-xl w-full font-bold">
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Pi
      </button>

      <button onclick="devLogin()" class="text-xs text-gray-500 underline">
        Ø¯Ø®ÙˆÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ (Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø§Ø±Ø¬ Pi Browser)
      </button>
    </div>

    <!-- TABS -->
    <div id="tabs" class="hidden flex bg-orange-100 rounded-xl overflow-hidden shadow">
      <button onclick="showTab('customer')" class="flex-1 p-3 font-bold bg-white" id="btnC">Ø¹Ù…ÙŠÙ„</button>
      <button onclick="showTab('delivery')" class="flex-1 p-3 font-bold" id="btnD">Ø¯Ù„ÙŠÙØ±ÙŠ</button>
    </div>

    <!-- ================= CUSTOMER ================= -->
    <div id="customer" class="hidden space-y-3">

      <div class="bg-white p-4 rounded-xl shadow space-y-3">
        <div class="text-sm text-gray-700">
          Ø£Ù‡Ù„Ù‹Ø§ <b id="custName">â€”</b>
        </div>

        <select id="orderType" class="w-full p-3 border rounded-xl">
          <option value="any">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: Ø£ÙŠ Ø­Ø§Ø¬Ø©</option>
          <option value="market">Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>
          <option value="pharmacy">ØµÙŠØ¯Ù„ÙŠØ©</option>
          <option value="restaurant">Ù…Ø·Ø¹Ù…</option>
        </select>

        <input id="prod" class="w-full p-3 border rounded-xl" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
        <input id="price" type="number" class="w-full p-3 border rounded-xl" placeholder="Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙŠ" oninput="recalcInvoice()" />

        <textarea id="notes" class="w-full p-3 border rounded-xl" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª/Ø¨Ø¯Ø§Ø¦Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>

        <div class="bg-gray-50 border rounded-xl p-3 space-y-2">
          <div class="flex items-center justify-between">
            <b class="text-sm">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</b>
            <span class="chip">ØªÙˆØµÙŠÙ„: <b>20</b>Ø¬ | Ù…ÙˆÙ‚Ø¹: <b>10</b>Ø¬</span>
          </div>

          <div class="text-sm space-y-1">
            <div class="row"><span class="text-gray-600">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</span><b><span id="invProdEgp">0</span> Ø¬</b></div>
            <div class="row"><span class="text-gray-600">Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</span><b><span id="invDelFeeEgp">20</span> Ø¬</b></div>
            <div class="row"><span class="text-gray-600">Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ÙˆÙ‚Ø¹</span><b><span id="invPlatFeeEgp">10</span> Ø¬</b></div>
            <div class="border-t pt-2 row">
              <span class="text-gray-700 font-bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
              <b class="text-green-700"><span id="invTotalEgp">0</span> Ø¬</b>
            </div>

            <div class="bg-white border rounded-lg p-2 mt-2">
              <div class="text-xs text-gray-500">Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Pi (ØªÙ‚Ø±ÙŠØ¨ÙŠ):</div>
              <div class="row text-sm">
                <span class="text-gray-600">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ù€ Pi</span>
                <b class="mono text-purple-700"><span id="invTotalPi">0</span> Pi</b>
              </div>
              <div class="text-[11px] text-gray-400 mt-1">
                1 Pi â‰ˆ <span class="mono" id="piEgpOne">â€”</span> Ø¬ (Ø­Ø³Ø¨ OKX + USD/EGP)
              </div>
            </div>
          </div>
        </div>

        <button onclick="payAndCreate()" class="bg-orange-500 text-white w-full p-3 rounded-xl font-bold">
          Ø§Ø¯ÙØ¹ Ø¨Ù€ Pi ÙˆØ§Ø·Ù„Ø¨ ğŸš€
        </button>
      </div>

      <div id="custTrack" class="hidden bg-white p-4 rounded-xl shadow space-y-2">
        <b>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:</b> <b id="custStatus" class="text-orange-600">pending</b>
        <div id="otpBox" class="hidden text-sm">
          ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…: <b id="otp" class="text-orange-600 text-lg"></b>
        </div>
      </div>

      <div id="custChat" class="hidden bg-white p-3 rounded-xl shadow space-y-2">
        <div class="flex items-center justify-between">
          <b class="text-sm">Ø§Ù„Ø´Ø§Øª</b>
          <div class="flex gap-2">
            <button class="chip" onclick="quick('customer','Ø£Ù†Ø§ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ØŸ')">ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ØŸ</button>
            <button class="chip" onclick="quick('customer','Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¨Ø¯ÙŠÙ„ØŸ')">Ø¨Ø¯ÙŠÙ„ØŸ</button>
          </div>
        </div>

        <div id="chatC" class="flex flex-col gap-2 h-52 overflow-y-auto"></div>

        <div class="flex gap-1 items-center">
          <input id="msgC" class="flex-1 border rounded-xl p-2" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
          <input type="file" id="imgC" accept="image/*" class="text-xs w-28" />
          <button onclick="sendMsg('customer')" class="bg-orange-500 text-white px-4 py-2 rounded-xl">â¤</button>
        </div>
      </div>

    </div>

    <!-- ================= DELIVERY ================= -->
    <div id="delivery" class="hidden space-y-3">

      <div class="bg-white p-4 rounded-xl shadow">
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-700">Ø§Ù„ÙƒØ§Ø¨ØªÙ†: <b id="delName">â€”</b></div>
          <button onclick="loadOrders()" class="chip">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        </div>
      </div>

      <div id="ordersBox" class="space-y-2"></div>

      <div id="delChat" class="hidden bg-white p-3 rounded-xl shadow space-y-2">
        <div class="flex items-center justify-between">
          <b class="text-sm">Ø´Ø§Øª Ø§Ù„Ø·Ù„Ø¨</b>
          <div class="flex gap-2">
            <button class="chip" onclick="quick('delivery','Ø£Ù†Ø§ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ ğŸ›µ')">ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</button>
            <button class="chip" onclick="quick('delivery','Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ø¨Ø¯ÙŠÙ„ØŸ')">ØºÙŠØ± Ù…ØªÙˆÙØ±</button>
          </div>
        </div>

        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¯Ù„ÙŠÙØ±ÙŠ -->
        <div id="delOrderDetails" class="bg-gray-50 border rounded-xl p-3 text-sm space-y-1">
          <div class="row"><span class="text-gray-600">Ø§Ù„Ù…Ù†ØªØ¬</span><b id="dProd">â€”</b></div>
          <div class="row"><span class="text-gray-600">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</span><b id="dType">â€”</b></div>
          <div class="row"><span class="text-gray-600">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</span><b><span id="dProdEgp">â€”</span> Ø¬</b></div>
          <div class="row"><span class="text-gray-600">ØªÙˆØµÙŠÙ„</span><b><span id="dDelFeeEgp">20</span> Ø¬</b></div>
          <div class="row"><span class="text-gray-600">Ø±Ø³ÙˆÙ… Ù…ÙˆÙ‚Ø¹</span><b><span id="dPlatFeeEgp">10</span> Ø¬</b></div>
          <div class="border-t pt-2 row"><span class="font-bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><b class="text-green-700"><span id="dTotalEgp">â€”</span> Ø¬</b></div>
          <div class="row"><span class="text-gray-600">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ù€ Pi</span><b class="mono text-purple-700"><span id="dTotalPi">â€”</span> Pi</b></div>
          <div class="text-[11px] text-gray-400">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: <span id="dNotes">â€”</span></div>
        </div>

        <div id="chatD" class="flex flex-col gap-2 h-52 overflow-y-auto"></div>

        <div class="flex gap-1 items-center">
          <input id="msgD" class="flex-1 border rounded-xl p-2" placeholder="Ø±Ø³Ø§Ù„Ø©..." />
          <input type="file" id="imgD" accept="image/*" class="text-xs w-28" />
          <button onclick="sendMsg('delivery')" class="bg-blue-600 text-white px-4 py-2 rounded-xl">â¤</button>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button onclick="setOrderStatus('arrived')" class="bg-orange-500 text-white p-3 rounded-xl font-bold">ÙˆØµÙ„Øª</button>
          <button onclick="finishWithOtp()" class="bg-green-600 text-white p-3 rounded-xl font-bold">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
        </div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow space-y-2">
        <b class="text-sm">Ù…Ø­ÙØ¸ØªÙŠ</b>
        <div class="text-sm">Ø§Ù„Ø±ØµÙŠØ¯: <b id="wallet">0</b> Ø¬Ù†ÙŠÙ‡</div>
        <input id="wdAmount" type="number" class="border p-3 rounded-xl w-full" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨" />
        <button onclick="withdraw()" class="bg-purple-600 text-white p-3 rounded-xl w-full font-bold">Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>
      </div>

    </div>

  </div>

<script>
/* ================== CONFIG ================== */
Pi.init({ version: "2.0", sandbox: false });

const SUPABASE_URL = 'https://axjkwrssmofzavaoqutq.supabase.co';
const SUPABASE_KEY = 'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================== FEES ================== */
const DELIVERY_FEE_EGP = 20;
const PLATFORM_FEE_EGP = 10;

/* ================== GLOBALS ================== */
let PI_USER = null;
let PI_USERNAME = null;
let ACTIVE_ORDER = null;

// rates
let PI_USDT = 0;     // 1 PI in USDT
let USD_EGP = 0;     // 1 USD in EGP

/* ================== DETECT ================== */
function detectPi() {
  const hasPi = typeof window.Pi !== 'undefined';
  const ua = (navigator.userAgent || '').toLowerCase();
  const isPiBrowser = ua.includes('pibrowser') || hasPi;
  document.getElementById('piStateText').innerText = hasPi ? 'SDK Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ¬Ø§Ù‡Ø²' : 'SDK ØºÙŠØ± Ù…ØªØ§Ø­';
  document.getElementById('piTag').innerText = isPiBrowser ? 'Pi Browser' : 'Web';
}

document.addEventListener('DOMContentLoaded', () => {
  detectPi();
  // Ø§Ø¨Ø¯Ø£ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø­ØªÙ‰ Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  refreshRates();
  setInterval(fetchPiFromOKX, 30000);
  setInterval(fetchUsdEgp, 60000);
});

/* ================== RATES ================== */
async function refreshRates(){
  await Promise.allSettled([fetchPiFromOKX(), fetchUsdEgp()]);
  recalcInvoice();
}

async function fetchPiFromOKX(){
  try{
    const r = await fetch("https://www.okx.com/api/v5/market/ticker?instId=PI-USDT", { cache: "no-store" });
    const j = await r.json();
    const last = parseFloat(j?.data?.[0]?.last || "0");
    if(last > 0) PI_USDT = last;

    document.getElementById('piUsdt').innerText = PI_USDT ? PI_USDT.toFixed(6) : 'â€”';
    updatePiEgpOne();
  }catch(e){
    console.warn('OKX PI ticker failed:', e);
  }
}

/**
 * âœ… FIX: Ø¬Ù„Ø¨ USD->EGP Ù…Ù† open.er-api.com (Ø¨Ø¯ÙˆÙ† API key)
 * Ø¨ÙŠØ±Ø¬Ø¹: { rates: { EGP: ... } }
 */
async function fetchUsdEgp(){
  try{
    const r = await fetch("https://open.er-api.com/v6/latest/USD", { cache: "no-store" });
    const j = await r.json();

    // Ø¨Ø¹Ø¶ Ø§Ù„Ø±Ø¯ÙˆØ¯ ÙÙŠÙ‡Ø§ result = "success"
    const rate = parseFloat(j?.rates?.EGP || "0");
    if(rate > 0) USD_EGP = rate;

    document.getElementById('usdEgp').innerText = USD_EGP ? USD_EGP.toFixed(4) : 'â€”';
    updatePiEgpOne();
  }catch(e){
    console.warn('USD/EGP failed:', e);
    // Ù„Ùˆ ÙØ´Ù„ØŒ Ù†Ø®Ù„ÙŠÙ‡Ø§ ÙˆØ§Ø¶Ø­Ø© Ø¨Ø¯Ù„ Ù…Ø§ ØªÙØ¶Ù„ â€”
    document.getElementById('usdEgp').innerText = 'ÙØ´Ù„';
  }
}

function updatePiEgpOne(){
  const piEgp = (PI_USDT && USD_EGP) ? (PI_USDT * USD_EGP) : 0;
  document.getElementById('piEgpOne').innerText = piEgp ? piEgp.toFixed(3) : 'â€”';
}

function egpToPi(egp){
  const piEgp = PI_USDT * USD_EGP;
  if(!piEgp || piEgp <= 0) return 0;
  return egp / piEgp;
}

/* ================== LOGIN ================== */
async function piLogin() {
  try {
    if (!window.Pi || !Pi.authenticate) {
      return Swal.fire({ icon: 'warning', title: 'Pi SDK ØºÙŠØ± Ù…ØªØ§Ø­', text: 'Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Pi Browser.' });
    }

    const ua = (navigator.userAgent || '').toLowerCase();
    if (!ua.includes('pibrowser')) {
      const r = await Swal.fire({
        icon: 'info',
        title: 'Ù…Ù„Ø§Ø­Ø¸Ø©',
        text: 'Ø§Ù„Ø£ÙØ¶Ù„ ØªÙØªØ­ Ø¯Ø§Ø®Ù„ Pi Browser Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯ÙØ¹ ÙŠØ´ØªØºÙ„ 100%.',
        showCancelButton: true,
        confirmButtonText: 'ÙƒÙ…Ù‘Ù„',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
      });
      if (!r.isConfirmed) return;
    }

    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    const scopes = ['username', 'payments'];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);

    const username = auth?.user?.username || auth?.username || null;
    if (!username) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… username Ù…Ù† Pi');

    PI_USER = auth;
    PI_USERNAME = username;

    document.getElementById('custName').innerText = PI_USERNAME;
    document.getElementById('delName').innerText = PI_USERNAME;

    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('tabs').classList.remove('hidden');
    showTab('customer');

    Swal.close();

    // Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„: ØªØ£ÙƒØ¯ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
    await refreshRates();
    loadOrders();
    loadWallet();

  } catch (e) {
    console.error('piLogin error:', e);
    Swal.fire({ icon: 'error', title: 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

function devLogin(){
  PI_USERNAME = 'dev_user_' + Math.floor(Math.random()*9999);
  document.getElementById('custName').innerText = PI_USERNAME;
  document.getElementById('delName').innerText = PI_USERNAME;
  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('tabs').classList.remove('hidden');
  showTab('customer');
  refreshRates();
  loadOrders();
  loadWallet();
}

function onIncompletePaymentFound(payment) {
  console.log('incomplete payment found:', payment);
}

/* ================== INVOICE UI ================== */
function recalcInvoice(){
  const prodEgp = parseFloat(document.getElementById('price').value || "0") || 0;

  const totalEgp = prodEgp + DELIVERY_FEE_EGP + PLATFORM_FEE_EGP;
  const totalPi = egpToPi(totalEgp);

  document.getElementById('invProdEgp').innerText = prodEgp.toFixed(2);
  document.getElementById('invDelFeeEgp').innerText = DELIVERY_FEE_EGP.toFixed(2);
  document.getElementById('invPlatFeeEgp').innerText = PLATFORM_FEE_EGP.toFixed(2);
  document.getElementById('invTotalEgp').innerText = totalEgp.toFixed(2);
  document.getElementById('invTotalPi').innerText = totalPi ? totalPi.toFixed(3) : '0.000';
}

/* ================== CUSTOMER: PAY + CREATE ORDER ================== */
async function payAndCreate() {
  try {
    if (!PI_USERNAME) return Swal.fire('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„');

    const product = document.getElementById('prod').value.trim();
    const orderType = document.getElementById('orderType').value;
    const notes = document.getElementById('notes').value.trim();
    const prodEgp = parseFloat(document.getElementById('price').value || "0") || 0;

    if (!product || prodEgp <= 0) return Swal.fire('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ³Ø¹Ø± ØµØ­ÙŠØ­');

    // Ù„Ø§Ø²Ù… ÙŠØ¨Ù‚Ù‰ Ø¹Ù†Ø¯Ù†Ø§ rates
    if (!(PI_USDT > 0 && USD_EGP > 0)) {
      await refreshRates();
      if (!(PI_USDT > 0 && USD_EGP > 0)) return Swal.fire('Ù…Ù‚Ø¯Ø±Ù†Ø§Ø´ Ù†Ø¬ÙŠØ¨ USD/EGP Ø¯Ù„ÙˆÙ‚ØªÙŠØŒ Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ');
    }

    const totalEgp = prodEgp + DELIVERY_FEE_EGP + PLATFORM_FEE_EGP;
    const totalPi = egpToPi(totalEgp);
    const amountPi = totalPi.toFixed(3);

    const otp = String(Math.floor(1000 + Math.random() * 9000));

    const confirm = await Swal.fire({
      title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹',
      html: `
        <div style="text-align:right">
          <div>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬: <b>${prodEgp.toFixed(2)} Ø¬</b></div>
          <div>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„: <b>${DELIVERY_FEE_EGP.toFixed(2)} Ø¬</b></div>
          <div>Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ÙˆÙ‚Ø¹: <b>${PLATFORM_FEE_EGP.toFixed(2)} Ø¬</b></div>
          <hr/>
          <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b style="color:#16a34a">${totalEgp.toFixed(2)} Ø¬</b></div>
          <div>ÙŠØ¹Ø§Ø¯Ù„ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§: <b style="color:#7c3aed">${amountPi} Pi</b></div>
          <div style="font-size:12px;color:#6b7280;margin-top:6px">
            (1 Pi â‰ˆ ${(PI_USDT*USD_EGP).toFixed(3)} Ø¬)
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Ø§Ø¯ÙØ¹',
      cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    if (!confirm.isConfirmed) return;

    if (!window.Pi || !Pi.createPayment) {
      return Swal.fire('Pi Payment ØºÙŠØ± Ù…ØªØ§Ø­.. Ø§ÙØªØ­ Ø¯Ø§Ø®Ù„ Pi Browser');
    }

    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯ÙØ¹...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    await Pi.createPayment({
      amount: amountPi,
      memo: `Talabat Pro | ${product} | Total ${totalEgp.toFixed(2)} EGP`,
      metadata: {
        product,
        orderType,
        prodEgp,
        deliveryFee: DELIVERY_FEE_EGP,
        platformFee: PLATFORM_FEE_EGP,
        totalEgp,
        pi_usdt: PI_USDT,
        usd_egp: USD_EGP
      }
    }, {
      onReadyForServerApproval: async (paymentId) => {
        await fetch('/api/pi/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paymentId })
        });
      },
      onReadyForServerCompletion: async (paymentId, txid) => {
        await fetch('/api/pi/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paymentId, txid })
        });
      },
      onCancel: (paymentId) => console.log('payment canceled:', paymentId),
      onError: (err, p) => console.error('payment error:', err, p)
    });

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ DB Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹
    const { data, error } = await db.from('orders').insert([{
      product_name: product,
      order_type: orderType,
      notes: notes || null,

      price: prodEgp,
      delivery_fee: DELIVERY_FEE_EGP,
      platform_fee: PLATFORM_FEE_EGP,

      total_price: totalEgp,
      status: 'pending',
      otp_code: otp,
      customer_pi_username: PI_USERNAME,
      can_modify_until: new Date(Date.now() + 60_000).toISOString(),

      pricing_snapshot: {
        pi_usdt: PI_USDT,
        usd_egp: USD_EGP,
        pi_egp: (PI_USDT * USD_EGP),
        total_pi: parseFloat(amountPi)
      }
    }]).select();

    if (error) throw error;

    ACTIVE_ORDER = data?.[0]?.id;

    document.getElementById('custTrack').classList.remove('hidden');
    document.getElementById('custChat').classList.remove('hidden');
    document.getElementById('custStatus').innerText = 'pending';
    document.getElementById('otp').innerText = otp;
    document.getElementById('otpBox').classList.remove('hidden');

    Swal.close();

    listenStatus();
    startChat();
    loadOrders();

  } catch (e) {
    console.error(e);
    Swal.fire({ icon: 'error', title: 'ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

/* ================== DELIVERY: LOAD + ACCEPT (RPC Lock) ================== */
async function loadOrders(){
  try{
    const box = document.getElementById('ordersBox');
    box.innerHTML = `<div class="text-center text-gray-500 py-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,status,created_at,pricing_snapshot')
      .eq('status','pending')
      .order('created_at',{ascending:false});

    if (error) throw error;

    if (!data?.length) {
      box.innerHTML = `<div class="bg-white p-4 rounded-xl shadow text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
      return;
    }

    box.innerHTML = data.map(o => {
      const delFee = (o.delivery_fee ?? DELIVERY_FEE_EGP);
      const platFee = (o.platform_fee ?? PLATFORM_FEE_EGP);
      const totalEgp = (o.total_price ?? ((o.price||0)+delFee+platFee));
      const totalPi = egpToPi(totalEgp);

      return `
      <div class="bg-white p-4 rounded-xl shadow space-y-2">
        <div class="flex justify-between items-start">
          <div>
            <b class="text-gray-800">${escapeHtml(o.product_name)}</b>
            <div class="text-xs text-gray-400 mt-1">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
            <div class="text-xs text-gray-500 mt-1">Ù†ÙˆØ¹: <b>${escapeHtml(o.order_type || 'any')}</b></div>
          </div>
          <div class="text-sm font-bold text-green-600">${Number(totalEgp).toFixed(2)} Ø¬</div>
        </div>

        <div class="bg-gray-50 border rounded-xl p-3 text-sm space-y-1">
          <div class="row"><span class="text-gray-600">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</span><b>${Number(o.price||0).toFixed(2)} Ø¬</b></div>
          <div class="row"><span class="text-gray-600">ØªÙˆØµÙŠÙ„</span><b>${Number(delFee).toFixed(2)} Ø¬</b></div>
          <div class="row"><span class="text-gray-600">Ø±Ø³ÙˆÙ… Ù…ÙˆÙ‚Ø¹</span><b>${Number(platFee).toFixed(2)} Ø¬</b></div>
          <div class="border-t pt-2 row"><span class="font-bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><b class="text-green-700">${Number(totalEgp).toFixed(2)} Ø¬</b></div>
          <div class="row"><span class="text-gray-600">ÙŠØ¹Ø§Ø¯Ù„ Ø¨Ù€ Pi</span><b class="mono text-purple-700">${totalPi ? totalPi.toFixed(3) : 'â€”'} Pi</b></div>
        </div>

        <button onclick="acceptOrder('${o.id}')" class="w-full bg-green-600 text-white p-3 rounded-xl font-bold">
          Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
        </button>
      </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('ordersBox').innerHTML =
      `<div class="bg-white p-4 rounded-xl shadow text-center text-red-600">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>`;
  }
}

async function acceptOrder(id){
  try{
    if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ ÙƒØ§Ø¨ØªÙ† Ø§Ù„Ø£ÙˆÙ„');

    Swal.fire({ title:'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø¨ÙˆÙ„...', didOpen:()=>Swal.showLoading(), allowOutsideClick:false });

    const { error } = await db.rpc('accept_order_once', {
      p_order_id: id,
      p_delivery_id: PI_USERNAME
    });

    if (error) throw error;

    ACTIVE_ORDER = id;
    await loadOrderDetailsForDelivery(id);

    document.getElementById('delChat').classList.remove('hidden');
    Swal.close();

    startChat();
    markSeen('delivery');

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

async function loadOrderDetailsForDelivery(orderId){
  const { data, error } = await db.from('orders')
    .select('product_name,order_type,notes,price,delivery_fee,platform_fee,total_price')
    .eq('id', orderId)
    .single();

  if(error){ console.warn(error); return; }

  const delFee = (data.delivery_fee ?? DELIVERY_FEE_EGP);
  const platFee = (data.platform_fee ?? PLATFORM_FEE_EGP);
  const totalEgp = (data.total_price ?? ((data.price||0)+delFee+platFee));
  const totalPi = egpToPi(totalEgp);

  document.getElementById('dProd').innerText = data.product_name || 'â€”';
  document.getElementById('dType').innerText = data.order_type || 'any';
  document.getElementById('dProdEgp').innerText = Number(data.price||0).toFixed(2);
  document.getElementById('dDelFeeEgp').innerText = Number(delFee).toFixed(2);
  document.getElementById('dPlatFeeEgp').innerText = Number(platFee).toFixed(2);
  document.getElementById('dTotalEgp').innerText = Number(totalEgp).toFixed(2);
  document.getElementById('dTotalPi').innerText = totalPi ? totalPi.toFixed(3) : 'â€”';
  document.getElementById('dNotes').innerText = data.notes ? data.notes : 'â€”';
}

/* ================== CHAT: text + image + seen ================== */
let chatChannel = null;

function startChat(){
  if(!ACTIVE_ORDER) return;

  if (chatChannel) {
    try { db.removeChannel(chatChannel); } catch {}
    chatChannel = null;
  }

  loadMessages();

  chatChannel = db.channel('chat-room-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'chat_messages',
      filter: `order_id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      appendMsg(payload.new);
      markSeen(currentRole());
    })
    .subscribe();
}

async function loadMessages(){
  const { data, error } = await db.from('chat_messages')
    .select('*')
    .eq('order_id', ACTIVE_ORDER)
    .order('created_at', { ascending: true });

  if(error){ console.error(error); return; }

  document.getElementById('chatC').innerHTML = '';
  document.getElementById('chatD').innerHTML = '';
  (data||[]).forEach(appendMsg);

  markSeen(currentRole());
}

function currentRole(){
  return (!document.getElementById('delivery').classList.contains('hidden')) ? 'delivery' : 'customer';
}

async function uploadChatImage(file){
  const path = `chat/${ACTIVE_ORDER}/${Date.now()}_${file.name}`;
  const up = await db.storage.from('chat').upload(path, file, { upsert: false });
  if (up.error) throw up.error;
  return db.storage.from('chat').getPublicUrl(path).data.publicUrl;
}

async function sendMsg(sender){
  try{
    if(!ACTIVE_ORDER) return Swal.fire('Ù…ÙÙŠØ´ Ø·Ù„Ø¨ Ù†Ø´Ø·');

    const input = sender === 'customer' ? document.getElementById('msgC') : document.getElementById('msgD');
    const fileEl = sender === 'customer' ? document.getElementById('imgC') : document.getElementById('imgD');

    const text = (input.value || '').trim();
    const file = fileEl.files?.[0];

    if(!text && !file) return;

    let image_url = null;
    if(file) image_url = await uploadChatImage(file);

    const { error } = await db.from('chat_messages').insert([{
      order_id: ACTIVE_ORDER,
      sender,
      message_text: text || null,
      image_url,
      seen_at: null
    }]);
    if(error) throw error;

    input.value = '';
    fileEl.value = '';

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

function quick(role, txt){
  if(role==='customer') document.getElementById('msgC').value = txt;
  else document.getElementById('msgD').value = txt;
}

function appendMsg(m){
  const bubble = `
    <div class="msg ${m.sender==='customer'?'c':'d'}">
      ${m.message_text ? escapeHtml(m.message_text) : ''}
      ${m.image_url ? `<img src="${m.image_url}" class="mt-2 rounded-xl border" />` : ''}
      ${m.seen_at ? `<div class="mt-1 text-[10px] opacity-70">âœ…âœ…</div>` : `<div class="mt-1 text-[10px] opacity-50">âœ…</div>`}
    </div>
  `;
  document.getElementById('chatC').insertAdjacentHTML('beforeend', bubble);
  document.getElementById('chatD').insertAdjacentHTML('beforeend', bubble);

  document.getElementById('chatC').scrollTop = document.getElementById('chatC').scrollHeight;
  document.getElementById('chatD').scrollTop = document.getElementById('chatD').scrollHeight;
}

async function markSeen(viewerRole){
  try{
    if(!ACTIVE_ORDER) return;
    await db.from('chat_messages')
      .update({ seen_at: new Date().toISOString() })
      .eq('order_id', ACTIVE_ORDER)
      .neq('sender', viewerRole)
      .is('seen_at', null);
  }catch(e){
    console.warn('markSeen failed:', e);
  }
}

/* ================== STATUS ================== */
let statusChannel = null;

function listenStatus(){
  if(!ACTIVE_ORDER) return;

  if (statusChannel) {
    try { db.removeChannel(statusChannel); } catch {}
    statusChannel = null;
  }

  statusChannel = db.channel('order-status-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'UPDATE', schema:'public', table:'orders',
      filter: `id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      const s = payload.new.status;
      document.getElementById('custStatus').innerText = s;

      if(['accepted','shipping','arrived','delivered'].includes(s)){
        document.getElementById('custChat').classList.remove('hidden');
      }

      if(s === 'delivered'){
        Swal.fire({ icon:'success', title:'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…', text:'Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ù„Ø¨Ø§Øª Ø¨Ø±Ùˆ' });
      }
    }).subscribe();
}

/* ================== DELIVERY STATUS + OTP ================== */
async function setOrderStatus(st){
  if(!ACTIVE_ORDER) return Swal.fire('Ø§Ø®ØªØ± Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
  await db.from('orders').update({ status: st }).eq('id', ACTIVE_ORDER);
}

async function finishWithOtp(){
  try{
    if(!ACTIVE_ORDER) return;
    if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„');

    const { value: code } = await Swal.fire({
      title: 'ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…',
      input: 'text',
      inputPlaceholder: 'Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„',
      showCancelButton: true,
      confirmButtonText: 'ØªØ£ÙƒÙŠØ¯',
      cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    if(!code) return;

    const { error } = await db.rpc('complete_delivery', {
      p_order_id: ACTIVE_ORDER,
      p_otp: String(code).trim(),
      p_delivery_id: PI_USERNAME
    });

    if(error) throw error;

    Swal.fire({ icon:'success', title:'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…' });
    loadWallet();

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ…', text: e?.message || 'OTP ØºÙ„Ø· Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­' });
  }
}

/* ================== WALLET + WITHDRAW ================== */
async function loadWallet(){
  try{
    if(!PI_USERNAME) return;
    const { data } = await db.from('delivery_wallet')
      .select('*')
      .eq('delivery_id', PI_USERNAME)
      .maybeSingle();

    document.getElementById('wallet').innerText = (data?.balance ?? 0);
  }catch(e){
    console.warn(e);
  }
}

async function withdraw(){
  try{
    if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„');
    const amount = parseFloat(document.getElementById('wdAmount').value || "0");
    if(!amount || amount <= 0) return Swal.fire('Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');

    const { error } = await db.from('withdraw_requests').insert([{
      delivery_id: PI_USERNAME,
      amount,
      status: 'pending'
    }]);
    if(error) throw error;

    Swal.fire({ icon:'success', title:'ØªÙ…', text:'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨' });
    document.getElementById('wdAmount').value = '';
  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

/* ================== UI ================== */
function showTab(t){
  document.getElementById('customer').classList.add('hidden');
  document.getElementById('delivery').classList.add('hidden');
  document.getElementById('btnC').classList.remove('bg-white');
  document.getElementById('btnD').classList.remove('bg-white');

  if(t==='customer'){
    document.getElementById('customer').classList.remove('hidden');
    document.getElementById('btnC').classList.add('bg-white');
  } else {
    document.getElementById('delivery').classList.remove('hidden');
    document.getElementById('btnD').classList.add('bg-white');
    loadOrders();
  }
}

/* ================== HELPERS ================== */
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}
</script>
</body>
</html>
