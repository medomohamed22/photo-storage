<!DOCTYPE html>
<!--
CHANGELOG (Top 10 UI/UX Updates)
1) تصميم هيدر احترافي مع زر رجوع ديناميكي وشريط بحث صغير في الهوم.
2) تحسين شارات حالة Pi (Browser/Web + SDK) بشكل واضح داخل الهيدر والهوم.
3) تحويل إنشاء الطلب إلى Stepper واضح بـ 4 خطوات مع بطاقة ملخص أجمل.
4) إضافة Timeline للحالة في تتبع العميل + تحسين العناوين والهيكل.
5) تحديث صفحة الدليفري: تفاصيل الطلب Sticky داخل الشات + أزرار وصول/تسليم مؤمنة.
6) تصميم قائمة الطلبات القريبة كبطاقات منظمة مع زر قبول وزر فتح الخريطة.
7) تحويل تبويب Discover إلى “More” حقيقي بأقسام وأيقونات وسهم + Debug checklist.
8) تحديث Bottom Nav إلى شكل iOS pill مع مؤشر نشط وتأثيرات لمس.
9) إضافة Skeleton loaders وLogs دفاعية لتفادي تعليق الواجهة عند delivered.
10) إصلاح منطق delivery completion مع قفل/تحقق/تحديث احتياطي.
-->
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>QuickCart | واجهة Pi (Talabat-style)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase + SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap');

    :root{
      --bg0:#f5f7f8;
      --bg1:#ffffff;
      --bg2:#eef7f2;
      --card:#ffffff;
      --card2:#f6fbf7;
      --stroke:rgba(16,185,129,.15);

      --txt:#0f172a;
      --muted:rgba(15,23,42,.62);
      --p:#10b981;
      --p2:#22c55e;
      --p3:#34d399;

      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#d97706;
      --info:#2563eb;

      --shadow: 0 18px 60px rgba(16,185,129,.12);
      --shadow2: 0 12px 30px rgba(16,185,129,.1);
      --r1:22px;
      --r2:16px;
    }

    *{box-sizing:border-box}
    body{
      font-family:Tajawal,system-ui;
      color:var(--txt);
      min-height:100vh;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(16,185,129,.18), transparent 60%),
        radial-gradient(900px 520px at 95% 0%, rgba(34,197,94,.16), transparent 60%),
        radial-gradient(900px 520px at 70% 110%, rgba(52,211,153,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, var(--bg2));
    }

    /* Safe area bottom for iOS */
    .safeBottom{ padding-bottom: calc(96px + env(safe-area-inset-bottom)); }

    /* Glass / Cards */
    .glass{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      box-shadow: var(--shadow);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .glass:hover{
      transform: translateY(-2px);
      box-shadow: 0 20px 60px rgba(16,185,129,.16);
    }
    .soft{
      background: var(--card2);
      border: 1px solid rgba(16,185,129,.12);
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .soft:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(16,185,129,.14);
    }

    .miniCard, .soft, .glass { overflow: hidden; }

    /* Talabat-like top bar */
    .topBar{
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(16,185,129,.12);
    }

    /* Brand badge */
    .brandBadge{
      width: 44px; height: 44px;
      border-radius: 16px;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(18px 18px at 30% 30%, rgba(16,185,129,.35), rgba(34,197,94,.2));
      border:1px solid rgba(16,185,129,.35);
      box-shadow: 0 16px 40px rgba(16,185,129,.2);
    }

    .headerBack{
      width:40px; height:40px;
      border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(16,185,129,.2);
      background: rgba(255,255,255,.9);
      transition:.2s;
    }
    .headerBack:active{transform:scale(.98)}

    .headerSearch{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(16,185,129,.18);
      background: rgba(255,255,255,.9);
    }
    .headerSearch input{
      border:none !important;
      background: transparent !important;
      padding:0 !important;
      font-size:12px;
    }

    /* Chips */
    .chip{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(16,185,129,.18);
      background: rgba(16,185,129,.08);
      color:var(--txt);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .chip:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(16,185,129,.12); }
    .chipP{ background: rgba(16,185,129,.18); border-color: rgba(16,185,129,.4); }
    .chipB{ background: rgba(15,23,42,.08); border-color: rgba(15,23,42,.14); }
    .chipG{ background: rgba(34,197,94,.15); border-color: rgba(34,197,94,.35); }
    .chipS{ background: rgba(255,255,255,.7); }
    .chipW{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.25); color:#92400e; }

    /* Buttons */
    .btn{
      border-radius:18px;
      padding:12px 14px;
      font-weight:900;
      transition:.15s;
      user-select:none;
      border:1px solid rgba(16,185,129,.2);
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 22px rgba(16,185,129,.18); }
    .btn:active{transform:scale(.98)}
    .btnA{
      background: linear-gradient(135deg, rgba(16,185,129,.95), rgba(34,197,94,.85));
      border-color: rgba(16,185,129,.4);
      color:#fff;
      box-shadow: 0 16px 45px rgba(16,185,129,.25);
    }
    .btnP{
      background: linear-gradient(135deg, rgba(22,163,74,.92), rgba(16,185,129,.85));
      border-color: rgba(22,163,74,.4);
      color:#fff;
      box-shadow: 0 16px 45px rgba(16,185,129,.2);
    }
    .btnG{
      background: linear-gradient(135deg, rgba(34,197,94,.92), rgba(22,163,74,.75));
      border-color: rgba(34,197,94,.35);
      color:#fff;
    }
    .btnB{
      background: linear-gradient(135deg, rgba(96,165,250,.92), rgba(37,99,235,.75));
      border-color: rgba(96,165,250,.35);
      color:#fff;
    }
    .btnS{
      background: rgba(255,255,255,.85);
      border-color: rgba(16,185,129,.2);
      color: var(--txt);
    }

    /* Inputs */
    input,textarea,select{
      width: 100%;
      background: rgba(255,255,255,.9) !important;
      border: 1px solid rgba(16,185,129,.18) !important;
      color: var(--txt) !important;
      border-radius: 16px !important;
      outline: none !important;
      transition: .15s;
      padding: 14px 14px !important;
    }
    input::placeholder, textarea::placeholder{
      color: rgba(15,23,42,.35);
    }
    input:focus,textarea:focus,select:focus{
      border-color: rgba(16,185,129,.6) !important;
      box-shadow: 0 0 0 4px rgba(16,185,129,.15);
    }
    textarea{min-height:96px}

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .tiny{font-size:11px;color:rgba(0,0,0,.55)}
    .muted{color:rgba(0,0,0,.6)}
    .truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

    /* Section Title */
    .secTitle{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .secTitle b{
      font-size:14px;
      letter-spacing:.2px;
    }
    .sectionHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .sectionHeader h3{
      font-size:15px;
      font-weight:800;
    }
    .sectionSub{
      font-size:12px;
      color:var(--muted);
    }
    .pageShell{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .pageSection{
      padding:16px;
    }
    .statsGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .statCard{
      padding:12px;
      border-radius:16px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(16,185,129,.12);
      text-align:center;
    }
    .statCard b{
      display:block;
      font-size:16px;
    }
    .featureGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    .infoCard{
      padding:14px;
      border-radius:16px;
      background: rgba(255,255,255,.9);
      border:1px dashed rgba(16,185,129,.2);
    }
    .listCard{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(16,185,129,.12);
      background: rgba(255,255,255,.9);
    }
    .listIcon{
      width:36px;
      height:36px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(16,185,129,.08);
      border:1px solid rgba(16,185,129,.18);
    }
    .listIcon i{
      color: var(--p);
    }
    .ratingStars{
      display:flex;
      gap:8px;
      justify-content:center;
    }
    .ratingStar{
      width:40px;
      height:40px;
      border-radius:14px;
      border:1px solid rgba(16,185,129,.2);
      background: #fff;
      color: rgba(16,185,129,.6);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .ratingStar:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(16,185,129,.12);
    }
    .ratingStar.active{
      background: rgba(16,185,129,.12);
      color: rgba(16,185,129,1);
      border-color: rgba(16,185,129,.35);
    }

    /* Talabat-like feature cards */
    .miniCard{
      background: var(--card2);
      border: 1px solid rgba(16,185,129,.15);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 25px rgba(16,185,129,.12);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .miniCard:hover{
      transform: translateY(-2px);
      box-shadow: 0 18px 35px rgba(16,185,129,.18);
    }
    .miniIcon{
      width: 40px; height: 40px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(16,185,129,.1);
      border:1px solid rgba(16,185,129,.18);
      box-shadow: 0 12px 28px rgba(16,185,129,.18);
    }
    .miniIcon i{
      color: var(--p);
    }
    .featureGrid .miniCard{
      padding: 16px;
    }
    .featureGrid .miniCard > div{
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    /* Stepper */
    .stepper{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:8px;
    }
    .step{
      border-radius:14px;
      padding:10px;
      border:1px solid rgba(16,185,129,.18);
      background: rgba(255,255,255,.9);
      text-align:center;
      font-size:11px;
      font-weight:700;
    }
    .step .num{
      width:22px;height:22px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      background: rgba(16,185,129,.18);
      color:#065f46;
      margin-bottom:4px;
      font-weight:900;
    }

    /* Timeline */
    .timeline{
      position:relative;
      padding-right:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .timeline::before{
      content:'';
      position:absolute;
      right:6px;
      top:6px;
      bottom:6px;
      width:2px;
      background: rgba(16,185,129,.15);
    }
    .timelineItem{
      display:flex;
      gap:10px;
      align-items:center;
      position:relative;
    }
    .timelineDot{
      width:12px;height:12px;border-radius:999px;
      background: rgba(16,185,129,.2);
      border:2px solid rgba(16,185,129,.3);
      position:relative;
      z-index:1;
    }
    .timelineItem.active .timelineDot{
      background: rgba(16,185,129,.8);
      border-color: rgba(16,185,129,.9);
      box-shadow: 0 0 0 6px rgba(16,185,129,.15);
    }

    /* Chat bubbles */
    .msg{
      max-width:78%;
      padding:10px 12px;
      border-radius:18px;
      font-size:13px;
      word-break:break-word;
      border:1px solid rgba(16,185,129,.15);
      animation: pop .2s ease-in-out;
    }
    @keyframes pop{
      from{transform:scale(.96);opacity:.5}
      to{transform:scale(1);opacity:1}
    }
    .c{ background: rgba(16,185,129,.18); color: var(--txt); align-self:flex-start; }
    .d{ background: rgba(255,255,255,.9); color: var(--txt); align-self:flex-end; }
    .chatImage{
      width:100%;
      max-height:220px;
      object-fit:cover;
      border-radius:14px;
      border:1px solid rgba(16,185,129,.2);
    }
    .chatLayout{
      display:flex;
      flex-direction:column;
      gap:10px;
      height: calc(100vh - 220px);
      flex:1 1 auto;
      min-height:0;
    }
    .chatScroll{
      flex:1;
      min-height:180px;
      overflow-y:auto;
      overscroll-behavior: contain;
    }
    .chatStickyHeader{
      position: sticky;
      top: 0;
      z-index: 5;
      background: rgba(255,255,255,.96);
      border-bottom:1px solid rgba(16,185,129,.12);
      padding-bottom:8px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .orderCard{
    }
    .orderCardHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding-bottom:8px;
      margin-bottom:10px;
      border-bottom:1px solid rgba(16,185,129,.12);
    }
    .chatCard{
      display:flex;
      flex-direction:column;
      gap:10px;
      height: 56vh;
      overflow: hidden;
    }
    .chatCardHeader{
      font-weight:900;
      font-size:13px;
      padding-bottom:8px;
      border-bottom:1px solid rgba(16,185,129,.12);
    }
    .chatScrollArea{
      flex:1 1 auto;
      overflow-y:auto;
      padding:10px;
      border-radius:14px;
      background: rgba(255,255,255,.75);
      border:1px solid rgba(16,185,129,.10);
    }
    .chatComposerBar{
      position: sticky;
      bottom: 0;
      background: rgba(255,255,255,.95);
      border-top:1px solid rgba(16,185,129,.12);
      padding-top:8px;
      backdrop-filter: blur(8px);
    }
    #delChat{
      padding-bottom: calc(110px + env(safe-area-inset-bottom));
    }

    /* Bottom nav - app style */
    .bottomNav{
      position: fixed;
      left: 0; right: 0;
      bottom: calc(12px + env(safe-area-inset-bottom));
      z-index: 50;
      padding: 0 14px;
    }
    .bottomNav .wrap{
      max-width: 480px;
      margin: 0 auto;
      padding: 8px;
      border-radius: 26px;
      background: rgba(255,255,255,.95);
      border:1px solid rgba(16,185,129,.12);
      box-shadow: 0 18px 40px rgba(16,185,129,.18);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:flex;
      gap:6px;
    }
    .navItem{
      flex:1;
      padding:10px 8px;
      border-radius:20px;
      border:1px solid transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-size:12px;
      font-weight:800;
      color:#0f172a;
      background: transparent;
      transition:.2s;
    }
    .navItem.active{
      background: rgba(16,185,129,.12);
      border-color: rgba(16,185,129,.3);
      color:#065f46;
      box-shadow: 0 12px 24px rgba(16,185,129,.16);
    }
    .navItem:active{transform:scale(.98)}

    /* Tabs animation */
    .tabPane{opacity:0; transform: translateY(8px);}
    .tabPane.active{opacity:1; transform: translateY(0); transition: .25s ease;}
    .fadeIn{animation: fadeSlide .25s ease;}
    @keyframes fadeSlide{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

    /* Small tweaks */
    .divider{
      height:1px;
      background: rgba(16,185,129,.12);
      margin: 10px 0;
    }
    a.linkP{ color: rgba(16,185,129,1); text-decoration: underline; }

    .row{display:flex;justify-content:space-between;gap:10px;align-items:center;}

    /* Withdraw row */
    .wdRow{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      min-width:0;
    }
    .wdLabel{flex:0 0 auto;white-space:nowrap;opacity:.85;}
    .wdValue{
      flex:1 1 auto;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      padding:6px 10px;
      border:1px solid rgba(16,185,129,.15);
      border-radius:12px;
      background: rgba(255,255,255,.9);
    }

    /* Skeleton */
    .skeletonCard{
      padding:14px;
      border-radius:16px;
      background: rgba(255,255,255,.8);
      border:1px dashed rgba(16,185,129,.2);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .skeletonLine{
      height:10px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(16,185,129,.08), rgba(16,185,129,.18), rgba(16,185,129,.08));
      background-size:200% 100%;
      animation: shimmer 1.2s infinite;
    }
    .skeletonLine.short{width:40%}
    .skeletonLine.mid{width:70%}
    @keyframes shimmer{
      0%{background-position:200% 0}
      100%{background-position:-200% 0}
    }
    .skeletonBadge{
      width:90px;height:18px;border-radius:999px;
      background: linear-gradient(90deg, rgba(16,185,129,.08), rgba(16,185,129,.2), rgba(16,185,129,.08));
      background-size:200% 100%;
      animation: shimmer 1.2s infinite;
    }

    /* Empty state */
    .emptyState{
      text-align:center;
      padding:18px;
      border-radius:16px;
      border:1px dashed rgba(16,185,129,.2);
      background: rgba(255,255,255,.85);
    }

    /* Sticky actions */
    .stickyActions{
      position: sticky;
      bottom: calc(90px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.95);
      border:1px solid rgba(16,185,129,.12);
      border-radius:16px;
      padding:10px;
      box-shadow: 0 16px 30px rgba(16,185,129,.12);
    }

    /* SweetAlert */
    .swal2-popup{
      background: #ffffff !important;
      color: var(--txt) !important;
      border: 1px solid rgba(16,185,129,.18) !important;
      border-radius: 20px !important;
      box-shadow: 0 18px 40px rgba(16,185,129,.18) !important;
    }
    .swal2-title{color: var(--txt) !important;}
    .swal2-html-container{color: var(--muted) !important;}
    .swal2-styled.swal2-confirm{
      background: linear-gradient(135deg, rgba(16,185,129,.95), rgba(34,197,94,.85)) !important;
      border: none !important;
      border-radius: 14px !important;
      box-shadow: 0 12px 25px rgba(16,185,129,.2) !important;
    }
    .swal2-styled.swal2-cancel{
      background: rgba(255,255,255,.9) !important;
      color: var(--txt) !important;
      border: 1px solid rgba(16,185,129,.2) !important;
      border-radius: 14px !important;
      box-shadow: 0 10px 20px rgba(16,185,129,.12) !important;
    }
  </style>
</head>

<body class="safeBottom">
  <!-- HEADER -->
  <header class="sticky top-0 z-50 topBar">
    <div class="px-3 pt-3 pb-3">
      <div class="max-w-lg mx-auto flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <button id="headerBack" class="headerBack hidden" onclick="handleHeaderBack()">
            <i class="fa-solid fa-arrow-right"></i>
          </button>
          <div class="brandBadge">
            <i class="fa-solid fa-basket-shopping text-white"></i>
          </div>
          <div class="leading-tight">
            <div class="font-black text-base">QuickCart</div>
            <div class="tiny -mt-0.5">طلب سريع • دليفري قريب منك</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <div id="headerSearch" class="headerSearch hidden">
            <i class="fa-solid fa-magnifying-glass text-emerald-500"></i>
            <input id="homeSearch" placeholder="ابحث عن مطعم أو منتج" />
          </div>
          <button id="roleToggle" onclick="toggleRole()" class="chip chipS hidden">
            <i class="fa-solid fa-user"></i> User
          </button>
          <a id="adminLink" href="./admin.html" class="chip chipP hidden">
            <i class="fa-solid fa-shield-halved"></i> Admin
          </a>
          <span id="piTag" class="chip chipB">
            <i class="fa-brands fa-pied-piper-alt"></i> …
          </span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-lg mx-auto p-3 space-y-3">
    <!-- LOGIN -->
    <div id="loginBox" class="glass p-4 text-center space-y-3">
      <div class="flex items-center justify-center gap-2">
        <span class="miniIcon"><i class="fa-solid fa-right-to-bracket"></i></span>
        <div class="text-right">
          <div class="font-extrabold">تسجيل الدخول</div>
          <div class="tiny muted">افتح داخل Pi Browser عشان الدفع يشتغل 100%</div>
        </div>
      </div>

      <button id="loginBtn" onclick="piLogin()" class="btn btnP w-full">
        <i class="fa-brands fa-pied-piper-alt"></i>
        تسجيل الدخول بـ Pi
      </button>

      <button onclick="devLogin()" class="text-xs underline muted">
        دخول تجريبي (اختبار خارج Pi Browser)
      </button>
    </div>

<!-- ================= HOME TAB ================= -->
<div id="homeTab" class="pageShell tabPane">

      <!-- STATUS + RATES -->
  <section class="glass pageSection space-y-3">
        <div class="secTitle">
          <b><i class="fa-solid fa-signal mr-1"></i> الحالة والأسعار</b>
          <span class="chip chipS"><i class="fa-regular fa-clock"></i> تحديث تلقائي</span>
        </div>

        <div class="miniCard space-y-2">
          <div class="flex items-center justify-between gap-2">
            <div class="text-sm">
              <span class="muted">حالة Pi:</span>
              <b id="piStateText" class="mr-1">جاري التحقق...</b>
            </div>
            <div class="flex gap-2">
              <span class="chip chipB"><i class="fa-solid fa-globe"></i> <span id="piTag2">Auto</span></span>
              <span id="piSdkBadge" class="chip chipG"><i class="fa-solid fa-bolt"></i> SDK</span>
            </div>
          </div>
          <div class="tiny muted">
            Pi كل <b>30 ثانية</b> — USD/EGP كل <b>60 ثانية</b>. | 1 Pi ≈ <span class="mono" id="piEgpOne">—</span> ج
          </div>
          <div id="rateHint" class="tiny hidden" style="color:#b45309">تعذر جلب الأسعار حاليًا. جرّب تحديث الصفحة أو الاتصال بالإنترنت.</div>
          <div id="piHint" class="tiny hidden" style="color:#b45309">يفضل استخدام Pi Browser لإكمال الدفع.</div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="miniCard">
            <div class="flex items-center gap-2">
              <span class="miniIcon"><i class="fa-solid fa-coins"></i></span>
              <div>
                <div class="tiny muted">سعر Pi (USDT)</div>
                <div class="font-black mono text-base"><span id="piUsdt">—</span></div>
                <div class="tiny muted">مصدر: OKX</div>
              </div>
            </div>
          </div>

          <div class="miniCard">
            <div class="flex items-center gap-2">
              <span class="miniIcon"><i class="fa-solid fa-money-bill-wave"></i></span>
              <div>
                <div class="tiny muted">سعر USD (EGP)</div>
                <div class="font-black mono text-base"><span id="usdEgp">—</span></div>
                <div class="tiny muted">مصدر: open.er-api.com</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ================= CUSTOMER (HOME) ================= -->
      <div id="customerHome" class="hidden space-y-3">
    <section class="glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-bag-shopping mr-1"></i> طلب جديد</b>
            <span class="chip chipP"><i class="fa-solid fa-credit-card"></i> Pi Pay</span>
          </div>

          <div class="miniCard space-y-3">
            <div class="flex items-center justify-between">
              <div class="text-sm">
                أهلًا <b id="custName">—</b>
                <div class="tiny muted">نرتّب لك الطلب خطوة بخطوة</div>
              </div>
              <span class="miniIcon"><i class="fa-solid fa-location-dot"></i></span>
            </div>

            <div class="stepper">
              <div class="step"><div class="num">1</div>نوع الطلب</div>
              <div class="step"><div class="num">2</div>بيانات المنتج</div>
              <div class="step"><div class="num">3</div>العنوان</div>
              <div class="step"><div class="num">4</div>الملخص والدفع</div>
            </div>

            <div class="divider"></div>

            <div class="space-y-2">
              <label class="tiny muted">1) اختيار نوع الطلب</label>
              <select id="orderType">
                <option value="any">نوع الطلب: أي حاجة</option>
                <option value="market">سوبر ماركت</option>
                <option value="pharmacy">صيدلية</option>
                <option value="restaurant">مطعم</option>
              </select>
            </div>

            <div class="space-y-2">
              <label class="tiny muted">2) بيانات المنتج + السعر</label>
              <input id="prod" placeholder="اسم المنتج" />
              <input id="price" type="number" placeholder="سعر المنتج بالجنيه المصري" oninput="recalcInvoice()" />
            </div>

            <div class="space-y-2">
              <label class="tiny muted">3) العنوان والموقع</label>
              <input id="custAddress" placeholder="العنوان بالتفصيل" />
              <div class="soft p-3 space-y-2">
                <div class="flex items-center justify-between">
                  <div class="text-sm"><span class="muted">موقعك الحالي</span></div>
                  <button class="chip chipG" onclick="setCustomerLocation()">
                    <i class="fa-solid fa-crosshairs"></i> تحديد
                  </button>
                </div>
                <div id="custLocStatus" class="tiny muted">لم يتم تحديد الموقع بعد.</div>
                <div id="custLocHint" class="tiny hidden" style="color:#b45309">لو واجهت مشكلة، فعّل GPS واسمح للموقع.</div>
                <a id="custMapLink" class="tiny linkP hidden" target="_blank" rel="noopener noreferrer" onclick="return openMapUrl(this.href)">
                  فتح الموقع على Google Maps
                </a>
              </div>
            </div>

            <div class="space-y-2">
              <label class="tiny muted">ملاحظات إضافية</label>
              <textarea id="notes" class="mt-2" placeholder="ملاحظات/بدائل (اختياري)"></textarea>
            </div>
          </div>

          <!-- INVOICE -->
          <div class="miniCard space-y-3">
            <div class="secTitle">
              <b><i class="fa-solid fa-receipt mr-1"></i> تفاصيل الحساب</b>
              <span class="chip chipS">
                <i class="fa-solid fa-truck-fast"></i> توصيل: <b>20</b>ج
                <span class="mx-1">•</span>
                <i class="fa-solid fa-store"></i> موقع: <b>10</b>ج
              </span>
            </div>

            <div class="text-sm space-y-2">
              <div class="flex items-center justify-between"><span class="muted">سعر المنتج</span><b><span id="invProdEgp">0</span> ج</b></div>
              <div class="flex items-center justify-between"><span class="muted">رسوم التوصيل</span><b><span id="invDelFeeEgp">20</span> ج</b></div>
              <div class="flex items-center justify-between"><span class="muted">رسوم الموقع</span><b><span id="invPlatFeeEgp">10</span> ج</b></div>

              <div class="divider"></div>

              <div class="flex items-center justify-between">
                <span class="font-black">الإجمالي</span>
                <b class="text-emerald-500"><span id="invTotalEgp">0</span> ج</b>
              </div>

              <div class="soft p-3 space-y-1">
                <div class="flex items-center justify-between">
                  <span class="muted text-sm">الإجمالي بـ Pi (تقريبي)</span>
                  <span id="invPreviewBadge" class="chip chipG hidden">Pi جاهز</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="muted text-sm">Pi الإجمالي</span>
                  <b class="mono text-emerald-600 text-sm" id="invTotalPi">0.000000</b>
                </div>
                <div id="invSkeleton" class="skeletonBadge hidden"></div>
              </div>
            </div>
          </div>

          <button onclick="payAndCreate()" class="btn btnA w-full">
            <i class="fa-solid fa-bolt"></i>
            ادفع بـ Pi واطلب
          </button>
          <div class="tiny muted text-center">
            بالضغط على “ادفع” أنت توافق على إنشاء الطلب والبدء في التنفيذ.
          </div>
        </section>

        <section class="glass pageSection space-y-3">
          <div class="sectionHeader">
            <div>
              <h3>خدمات QuickCart</h3>
              <div class="sectionSub">اختصر وقتك مع أقسام مخصصة لكل احتياج.</div>
            </div>
            <span class="chip chipS"><i class="fa-solid fa-layer-group"></i> أقسام</span>
          </div>
          <div class="featureGrid">
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-burger"></i></span>
                <div>
                  <div class="text-sm font-bold">مطاعم قريبة</div>
                  <div class="tiny muted">اختيارات سريعة لعشاء اليوم</div>
                </div>
              </div>
            </div>
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-pills"></i></span>
                <div>
                  <div class="text-sm font-bold">صيدليات</div>
                  <div class="tiny muted">أدوية عاجلة وتوصيل آمن</div>
                </div>
              </div>
            </div>
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-cart-shopping"></i></span>
                <div>
                  <div class="text-sm font-bold">سوبر ماركت</div>
                  <div class="tiny muted">طلبات البيت في دقائق</div>
                </div>
              </div>
            </div>
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-bolt"></i></span>
                <div>
                  <div class="text-sm font-bold">طلبات فورية</div>
                  <div class="tiny muted">توصيل سريع مع كابتن قريب</div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ================= DELIVERY (HOME) ================= -->
      <div id="deliveryHome" class="hidden space-y-3">
    <section class="glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-motorcycle mr-1"></i> لوحة الدليفري</b>
            <button onclick="loadOrders()" class="chip chipS">
              <i class="fa-solid fa-rotate"></i> تحديث
            </button>
          </div>

          <div class="miniCard">
            <div class="flex items-center justify-between">
              <div class="text-sm">الكابتن: <b id="delName">—</b></div>
              <span class="miniIcon"><i class="fa-solid fa-helmet-safety"></i></span>
            </div>

            <div class="soft p-3 mt-3 space-y-2">
              <div class="flex items-center justify-between">
                <span class="muted text-sm">موقع الكابتن</span>
                <button class="chip chipG" onclick="setDeliveryLocation()">
                  <i class="fa-solid fa-crosshairs"></i> تحديد موقعي
                </button>
              </div>
              <div id="delLocStatus" class="tiny muted">لم يتم تحديد الموقع بعد.</div>
              <div id="delLocHint" class="tiny hidden" style="color:#b45309">فعّل GPS واسمح للتطبيق بالوصول للموقع.</div>
              <div class="tiny muted">سيظهر لك الطلبات على بعد 5 كم فقط.</div>
            </div>
          </div>
        </section>

        <div id="ordersBox" class="space-y-2"></div>
        <div class="glass pageSection space-y-3">
          <div class="sectionHeader">
            <div>
              <h3>مستوى الأداء</h3>
              <div class="sectionSub">إحصائيات سريعة للكابتن.</div>
            </div>
            <span class="chip chipS"><i class="fa-solid fa-chart-line"></i> اليوم</span>
          </div>
          <div class="statsGrid">
            <div class="statCard">
              <b id="statOrders">0</b>
              <span class="tiny muted">طلبات مكتملة</span>
            </div>
            <div class="statCard">
              <b id="statRating">4.9</b>
              <span class="tiny muted">تقييم متوسط</span>
            </div>
            <div class="statCard">
              <b id="statZone">5km</b>
              <span class="tiny muted">نطاق التوصيل</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= TRACK TAB ================= -->
    <div id="trackTab" class="hidden pageShell tabPane">

      <!-- ================= CUSTOMER (TRACK) ================= -->
      <div id="customerTrackTab" class="hidden space-y-3">
        <!-- TRACK -->
        <section id="custTrack" class="hidden glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-route mr-1"></i> متابعة الطلب</b>
            <div class="flex items-center gap-2">
              <button class="chip chipS" onclick="refreshCustomerStatus()">
                <i class="fa-solid fa-rotate"></i> تحديث
              </button>
              <span class="chip chipP"><i class="fa-solid fa-circle-info"></i> Live</span>
            </div>
          </div>

          <div class="miniCard space-y-2">
            <div class="flex items-center justify-between">
              <span class="muted text-sm">حالة الطلب</span>
              <b id="custStatus" class="text-emerald-500">pending</b>
            </div>

            <div class="flex items-center justify-between text-sm">
              <span class="muted">العنوان</span>
              <b id="custAddressView" class="truncate">—</b>
            </div>

            <div class="flex items-center justify-between text-sm">
              <span class="muted">الموقع</span>
              <a id="custTrackMapLink" class="linkP hidden" target="_blank" rel="noopener noreferrer" onclick="return openMapUrl(this.href)">
                فتح على الخريطة
              </a>
            </div>

            <div id="otpBox" class="hidden text-sm">
              <span class="muted">كود التسليم</span>:
              <b id="otp" class="text-emerald-500 text-lg mono"></b>
              <div class="tiny muted mt-1">قدّم الكود للكابتن عند الوصول.</div>
            </div>
          </div>

          <div class="miniCard">
            <div class="text-sm font-bold mb-2">تسلسل الحالة</div>
            <div id="custTimeline" class="timeline">
              <div class="timelineItem" data-status="pending">
                <span class="timelineDot"></span>
                <div class="text-sm">بانتظار قبول الطلب</div>
              </div>
              <div class="timelineItem" data-status="accepted">
                <span class="timelineDot"></span>
                <div class="text-sm">تم قبول الطلب</div>
              </div>
              <div class="timelineItem" data-status="shipping">
                <span class="timelineDot"></span>
                <div class="text-sm">الكابتن في الطريق</div>
              </div>
              <div class="timelineItem" data-status="arrived">
                <span class="timelineDot"></span>
                <div class="text-sm">الكابتن وصل للموقع</div>
              </div>
              <div class="timelineItem" data-status="delivered">
                <span class="timelineDot"></span>
                <div class="text-sm">تم التسليم</div>
              </div>
            </div>
          </div>
        </section>

        <!-- RATING -->
        <section id="custRating" class="hidden glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-star mr-1"></i> تقييم الكابتن</b>
            <span class="chip chipS">بعد التسليم</span>
          </div>
          <div class="miniCard space-y-3 text-center">
            <div class="text-sm">قيّم تجربة التوصيل من 1 إلى 5 نجوم.</div>
            <div class="ratingStars" id="ratingStars">
              <button type="button" class="ratingStar" data-rating="1"><i class="fa-solid fa-star"></i></button>
              <button type="button" class="ratingStar" data-rating="2"><i class="fa-solid fa-star"></i></button>
              <button type="button" class="ratingStar" data-rating="3"><i class="fa-solid fa-star"></i></button>
              <button type="button" class="ratingStar" data-rating="4"><i class="fa-solid fa-star"></i></button>
              <button type="button" class="ratingStar" data-rating="5"><i class="fa-solid fa-star"></i></button>
            </div>
            <div id="ratingValue" class="tiny muted">اختر تقييمك.</div>
            <textarea id="ratingNote" placeholder="ملاحظة اختيارية للدليفري"></textarea>
            <button id="ratingSubmit" class="btn btnA w-full" onclick="submitRating()">
              إرسال التقييم
            </button>
            <button class="btn btnS w-full" onclick="rejectCaptain()">
              رفض الكابتن
            </button>
            <div id="ratingThanks" class="tiny muted hidden">تم إرسال التقييم، شكرًا لك.</div>
          </div>
        </section>

        <!-- CHAT -->
        <section id="custChat" class="hidden glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-comments mr-1"></i> الشات (لحظي)</b>
            <div class="flex gap-2">
              <button class="chip chipS" onclick="quick('customer','أنا في الطريق؟')">
                <i class="fa-solid fa-paper-plane"></i> في الطريق؟
              </button>
              <button class="chip chipS" onclick="quick('customer','لو مش موجود، بديل؟')">
                <i class="fa-solid fa-repeat"></i> بديل؟
              </button>
            </div>
          </div>

          <div id="chatC" class="flex flex-col gap-2 h-52 overflow-y-auto soft p-3"></div>

          <div class="flex gap-2 items-center">
            <input id="msgC" class="flex-1" placeholder="اكتب رسالة..." />
            <label class="chip chipS cursor-pointer">
              <i class="fa-regular fa-image"></i>
              <input type="file" id="imgC" accept="image/*" class="hidden" />
              صورة
            </label>
            <button onclick="sendMsg('customer')" class="btn btnA" style="padding:12px 14px">
              <i class="fa-solid fa-arrow-up"></i>
            </button>
          </div>
          <div class="tiny muted">✅ = اتبعت | ✅✅ = اتقريت</div>
        </section>

        <!-- CUSTOMER HISTORY -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-clock-rotate-left mr-1"></i> سجل طلباتي</b>
            <button class="chip chipS" onclick="loadCustomerHistory()">
              <i class="fa-solid fa-rotate"></i> تحديث
            </button>
          </div>
          <div id="custHistory" class="space-y-2 text-sm"></div>
        </section>
      </div>

      <!-- ================= DELIVERY (TRACK) ================= -->
      <div id="deliveryTrackTab" class="hidden space-y-3">

        <!-- DELIVERY CHAT -->
        <section id="delChat" class="hidden glass pageSection space-y-3">
          <div class="miniCard orderCard">
            <div class="orderCardHeader">
              <b><i class="fa-solid fa-clipboard-list mr-1"></i> تفاصيل الطلب</b>
              <span class="chip chipS"><i class="fa-solid fa-location-crosshairs"></i> مباشر</span>
            </div>
            <div class="space-y-1" id="delOrderDetails">
              <div class="flex items-center justify-between"><span class="muted">الحالة</span><b id="dStatus">—</b></div>
              <div class="flex items-center justify-between"><span class="muted">المنتج</span><b id="dProd" class="truncate">—</b></div>
              <div class="flex items-center justify-between"><span class="muted">نوع الطلب</span><b id="dType">—</b></div>
              <div class="flex items-center justify-between"><span class="muted">سعر المنتج</span><b><span id="dProdEgp">—</span> ج</b></div>
              <div class="flex items-center justify-between"><span class="muted">العنوان</span><b id="dAddress" class="truncate">—</b></div>
              <div class="flex items-center justify-between">
                <span class="muted">الموقع</span>
                <a id="dMapLink" class="linkP hidden" target="_blank" rel="noopener noreferrer" onclick="return openMapUrl(this.href)">فتح على الخريطة</a>
              </div>
              <div class="divider"></div>
              <div class="flex items-center justify-between"><span class="muted">توصيل</span><b><span id="dDelFeeEgp">20</span> ج</b></div>
              <div class="flex items-center justify-between"><span class="muted">رسوم موقع</span><b><span id="dPlatFeeEgp">10</span> ج</b></div>
              <div class="divider"></div>
              <div class="flex items-center justify-between"><span class="font-black">الإجمالي</span><b class="text-emerald-500"><span id="dTotalEgp">—</span> ج</b></div>
              <div class="flex items-center justify-between"><span class="muted">الإجمالي بـ Pi</span><b class="mono text-emerald-600"><span id="dTotalPi">—</span> Pi</b></div>
              <div class="tiny muted">ملاحظات: <span id="dNotes">—</span></div>
            </div>
          </div>

          <div class="miniCard chatCard">
            <div class="chatCardHeader">الشات مع العميل</div>
            <div id="chatD" class="chatScrollArea"></div>
            <div class="chatComposerBar">
              <div class="flex gap-2 items-center">
                <input id="msgD" class="flex-1" placeholder="رسالة..." />
                <label class="chip chipS cursor-pointer">
                  <i class="fa-regular fa-image"></i>
                  <input type="file" id="imgD" accept="image/*" class="hidden" />
                  صورة
                </label>
                <button onclick="sendMsg('delivery')" class="btn btnB" style="padding:12px 14px">
                  <i class="fa-solid fa-arrow-up"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="miniCard actionsCard">
            <div class="secTitle">
              <b><i class="fa-solid fa-headset mr-1"></i> إجراءات الطلب</b>
            </div>
            <div class="stickyActions grid grid-cols-2 gap-2 mt-3">
              <button id="arrivedBtn" onclick="setOrderStatus('arrived')" class="btn btnA">
                <i class="fa-solid fa-location-crosshairs"></i> وصلت
              </button>
              <button id="finishBtn" onclick="finishWithOtp()" class="btn btnG">
                <i class="fa-solid fa-check"></i> تم التسليم
              </button>
            </div>
          </div>
        </section>

        <!-- WALLET + WITHDRAW -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-wallet mr-1"></i> أرباحي المتاحة</b>
            <span class="chip chipP"><i class="fa-brands fa-pied-piper-alt"></i> Pi</span>
          </div>

          <div class="miniCard">
            <div class="text-sm">
              الأرباح المتاحة:
              <b class="mono text-emerald-500"><span id="walletPi">0.000000</span> Pi</b>
            </div>
            <div class="tiny muted mt-1">السحب يتم مباشرة إلى محفظتك بعد التأكيد.</div>
          </div>

          <input id="wdAmountPi" type="number" step="0.000001" placeholder="كم Pi هتسحب؟" />

          <div class="space-y-2">
            <input id="wdWallet" placeholder="عنوان محفظة Pi" />
            <div class="grid grid-cols-2 gap-2">
              <button class="btn btnS" onclick="copyWalletAddress()">
                <i class="fa-regular fa-copy"></i> نسخ العنوان
              </button>
              <button class="btn btnS" onclick="pasteWalletAddress()">
                <i class="fa-solid fa-paste"></i> لصق العنوان
              </button>
            </div>
          </div>

          <button onclick="withdrawPi()" class="btn btnP w-full">
            <i class="fa-solid fa-hand-holding-dollar"></i>
            طلب سحب Pi
          </button>
          <div class="tiny muted">تأكد من صحة العنوان قبل الإرسال.</div>
        </section>

        <!-- WITHDRAW HISTORY -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-list mr-1"></i> سجل السحب</b>
            <button class="chip chipS" onclick="loadWithdrawHistory()">
              <i class="fa-solid fa-rotate"></i> تحديث
            </button>
          </div>
          <div id="wdHistory" class="space-y-2 text-sm"></div>
        </section>

        <!-- DELIVERY HISTORY -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-clock-rotate-left mr-1"></i> سجل طلباتي كدليفري</b>
            <button class="chip chipS" onclick="loadDeliveryHistory()">
              <i class="fa-solid fa-rotate"></i> تحديث
            </button>
          </div>
          <div id="delHistory" class="space-y-2 text-sm"></div>
        </section>
      </div>
    </div>

    <!-- ================= DISCOVER TAB ================= -->
    <div id="discoverTab" class="hidden pageShell tabPane">
      <section class="glass pageSection space-y-3">
        <div class="sectionHeader">
          <div>
            <h3>المزيد</h3>
            <div class="sectionSub">كل ما تحتاجه في مكان واحد.</div>
          </div>
          <span class="chip chipP"><i class="fa-solid fa-ellipsis"></i> More</span>
        </div>
        <div class="space-y-2">
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-headset"></i></span>
            <div class="flex-1">
              <div class="text-sm font-bold">الدعم</div>
              <div class="tiny muted">تواصل سريع مع خدمة العملاء.</div>
            </div>
            <i class="fa-solid fa-chevron-left text-emerald-500"></i>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-file-contract"></i></span>
            <div class="flex-1">
              <div class="text-sm font-bold">الشروط والأحكام</div>
              <div class="tiny muted">تعرف على سياسات الاستخدام.</div>
            </div>
            <i class="fa-solid fa-chevron-left text-emerald-500"></i>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-circle-question"></i></span>
            <div class="flex-1">
              <div class="text-sm font-bold">الأسئلة الشائعة</div>
              <div class="tiny muted">إجابات لأكثر الاستفسارات.</div>
            </div>
            <i class="fa-solid fa-chevron-left text-emerald-500"></i>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-circle-info"></i></span>
            <div class="flex-1">
              <div class="text-sm font-bold">عن التطبيق</div>
              <div class="tiny muted">نسخة QuickCart ورؤيتنا.</div>
            </div>
            <i class="fa-solid fa-chevron-left text-emerald-500"></i>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-share-nodes"></i></span>
            <div class="flex-1">
              <div class="text-sm font-bold">مشاركة التطبيق</div>
              <div class="tiny muted">شارك التطبيق مع أصدقائك.</div>
            </div>
            <i class="fa-solid fa-chevron-left text-emerald-500"></i>
          </div>
        </div>
      </section>

      <section class="glass pageSection space-y-3">
        <div class="sectionHeader">
          <div>
            <h3>لماذا QuickCart؟</h3>
            <div class="sectionSub">واجهة مرتبة لكل احتياجاتك اليومية.</div>
          </div>
          <span class="chip chipP"><i class="fa-solid fa-star"></i> مميز</span>
        </div>
        <div class="infoCard">
          <div class="text-sm">تجربة طلب سلسة مع متابعة لحظية، شات مباشر، ودفع آمن بـ Pi.</div>
        </div>
        <div class="featureGrid">
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-shield-halved"></i></span>
            <div>
              <div class="text-sm font-bold">حماية الطلب</div>
              <div class="tiny muted">كود تسليم سري لضمان الأمان.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-comments"></i></span>
            <div>
              <div class="text-sm font-bold">تواصل فوري</div>
              <div class="tiny muted">شات نصي وصور مع الكابتن.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-location-dot"></i></span>
            <div>
              <div class="text-sm font-bold">تتبع مباشر</div>
              <div class="tiny muted">عرض موقع الطلب على الخريطة.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-wallet"></i></span>
            <div>
              <div class="text-sm font-bold">سحب مباشر</div>
              <div class="tiny muted">تحويل أرباحك سريعًا لمحفظتك.</div>
            </div>
          </div>
        </div>
      </section>

      <section class="glass pageSection space-y-3">
        <div class="sectionHeader">
          <div>
            <h3>الدعم والمساعدة</h3>
            <div class="sectionSub">جاهزين نساعدك في أي وقت.</div>
          </div>
          <span class="chip chipB"><i class="fa-solid fa-headset"></i> دعم</span>
        </div>
        <div class="miniCard space-y-2">
          <div class="text-sm">تواصل معنا عبر البريد أو من خلال الشات داخل الطلب.</div>
          <div class="flex flex-wrap gap-2">
            <span class="chip chipS"><i class="fa-solid fa-envelope"></i> support@quickcart.app</span>
            <span class="chip chipS"><i class="fa-solid fa-phone"></i> 15777</span>
          </div>
        </div>
      </section>

      <section class="glass pageSection space-y-3">
        <div class="sectionHeader">
          <div>
            <h3>Debug checklist</h3>
            <div class="sectionSub">خطوات سريعة للتأكد من حالة التسليم والتقييم.</div>
          </div>
          <span class="chip chipS"><i class="fa-solid fa-bug"></i> Debug</span>
        </div>
        <div class="miniCard space-y-2 text-sm">
          <div>✅ تحقق أن status أصبح <b>delivered</b> عبر سجل الطلبات أو صفحة المتابعة.</div>
          <div>✅ راقب القنوات realtime من خلال Console logs أثناء تغيير الحالة.</div>
          <div>✅ تأكد أن قسم تقييم الكابتن ظهر وتم عمل scroll إليه تلقائيًا.</div>
        </div>
      </section>
    </div>
  </main>

  <!-- BOTTOM NAV -->
  <div id="bottomNav" class="bottomNav hidden">
    <div class="wrap">
      <button id="navHome" onclick="setMainTab('home')" class="navItem">
        <i class="fa-solid fa-plus"></i>
        <span>طلب جديد</span>
      </button>
      <button id="navTrack" onclick="setMainTab('track')" class="navItem">
        <i class="fa-solid fa-route"></i>
        <span>متابعة</span>
      </button>
      <button id="navDiscover" onclick="setMainTab('discover')" class="navItem">
        <i class="fa-solid fa-compass"></i>
        <span>المزيد</span>
      </button>
    </div>
  </div>

  <script>
/* ================== CONFIG ================== */
Pi.init({ version: "2.0", sandbox: false });

const SUPABASE_URL = 'https://axjkwrssmofzavaoqutq.supabase.co';
const SUPABASE_KEY = 'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================== FEES ================== */
const DELIVERY_FEE_EGP = 20;
const PLATFORM_FEE_EGP = 10;

/* ================== GLOBALS ================== */
let PI_USER = null;
let PI_USERNAME = null;
let PI_UID = null;
let ACTIVE_ORDER = null;
let CUSTOMER_LOCATION = null;
let DELIVERY_LOCATION = null;
let HAS_LOCATION_COLUMNS = true;
let ACTIVE_ROLE = 'customer';
let ACTIVE_MAIN_TAB = 'home';
let ACTIVE_RATING = 0;
let FINISH_LOCK = false;
let LAST_DELIVERED_ORDER_ID = null;

/* ================== RATES ================== */
let PI_USDT = 0;     // 1 PI in USDT
let USD_EGP = 0;     // 1 USD in EGP

/* ================== UI: DETECT + INIT ================== */
function detectPi() {
  const hasPi = typeof window.Pi !== 'undefined';
  const ua = (navigator.userAgent || '').toLowerCase();
  const isPiBrowser = ua.includes('pibrowser') || hasPi;

  document.getElementById('piStateText').innerText = hasPi ? 'SDK موجود وجاهز' : 'SDK غير متاح';
  document.getElementById('piTag').innerText = isPiBrowser ? 'Pi Browser' : 'Web';
  document.getElementById('piTag2').innerText = isPiBrowser ? 'Pi Browser' : 'Web';
  document.getElementById('piSdkBadge').classList.toggle('chipW', !hasPi);
  document.getElementById('piHint').classList.toggle('hidden', isPiBrowser);
}

function handleHeaderBack(){
  if (ACTIVE_MAIN_TAB !== 'home') {
    setMainTab('home');
  } else if (ACTIVE_ORDER) {
    setMainTab('track');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  detectPi();
  initRatingStars();
  refreshRates();
  setInterval(fetchPiFromOKX, 30000);
  setInterval(fetchUsdEgp, 60000);
});

/* ================== DATA: RATES ================== */
async function refreshRates(){
  await Promise.allSettled([fetchPiFromOKX(), fetchUsdEgp()]);
  recalcInvoice();
}

function setRateHint(show){
  document.getElementById('rateHint').classList.toggle('hidden', !show);
}

async function fetchPiFromOKX(){
  try{
    const r = await fetch("https://www.okx.com/api/v5/market/ticker?instId=PI-USDT", { cache: "no-store" });
    const j = await r.json();
    const last = parseFloat(j?.data?.[0]?.last || "0");
    if(last > 0) PI_USDT = last;

    document.getElementById('piUsdt').innerText = PI_USDT ? PI_USDT.toFixed(6) : '—';
    updatePiEgpOne();
    setRateHint(!(PI_USDT > 0 && USD_EGP > 0));
  }catch(e){
    console.warn('OKX PI ticker failed:', e);
    setRateHint(true);
  }
}

async function fetchUsdEgp(){
  try{
    const r = await fetch("https://open.er-api.com/v6/latest/USD", { cache: "no-store" });
    const j = await r.json();
    const rate = parseFloat(j?.rates?.EGP || "0");
    if(rate > 0) USD_EGP = rate;

    document.getElementById('usdEgp').innerText = USD_EGP ? USD_EGP.toFixed(4) : '—';
    updatePiEgpOne();
    setRateHint(!(PI_USDT > 0 && USD_EGP > 0));
  }catch(e){
    console.warn('USD/EGP failed:', e);
    document.getElementById('usdEgp').innerText = 'فشل';
    setRateHint(true);
  }
}

function updatePiEgpOne(){
  const piEgp = (PI_USDT && USD_EGP) ? (PI_USDT * USD_EGP) : 0;
  document.getElementById('piEgpOne').innerText = piEgp ? piEgp.toFixed(3) : '—';
}

function egpToPi(egp){
  const piEgp = PI_USDT * USD_EGP;
  if(!piEgp || piEgp <= 0) return 0;
  return egp / piEgp;
}

/* ================== HELPERS: LOCATION ================== */
function getCurrentLocation(){
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('المتصفح لا يدعم تحديد الموقع'));
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
      (err) => reject(err),
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  });
}

function buildMapUrl(lat, lng){
  return `https://www.google.com/maps?q=${encodeURIComponent(lat)},${encodeURIComponent(lng)}`;
}

function openMapUrl(url){
  if (!url || url === '#') return false;
  if (window.Pi && typeof Pi.openUrlInSystemBrowser === 'function') {
    Pi.openUrlInSystemBrowser(url);
    return false;
  }
  window.open(url, '_blank', 'noopener,noreferrer');
  return false;
}

async function setCustomerLocation(){
  try{
    const loc = await getCurrentLocation();
    CUSTOMER_LOCATION = loc;
    const status = `تم تحديد الموقع: ${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}`;
    document.getElementById('custLocStatus').innerText = status;
    document.getElementById('custLocHint').classList.add('hidden');
    const link = document.getElementById('custMapLink');
    link.href = buildMapUrl(loc.lat, loc.lng);
    link.classList.remove('hidden');
    link.onclick = () => openMapUrl(link.href);
  }catch(e){
    document.getElementById('custLocHint').classList.remove('hidden');
    Swal.fire({ icon:'error', title:'فشل تحديد الموقع', text: e?.message || 'حصل خطأ أثناء تحديد موقعك' });
  }
}

async function setDeliveryLocation(){
  try{
    const loc = await getCurrentLocation();
    DELIVERY_LOCATION = loc;
    const status = `تم تحديد الموقع: ${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}`;
    document.getElementById('delLocStatus').innerText = status;
    document.getElementById('delLocHint').classList.add('hidden');
    await loadOrders();
  }catch(e){
    document.getElementById('delLocHint').classList.remove('hidden');
    Swal.fire({ icon:'error', title:'فشل تحديد الموقع', text: e?.message || 'حصل خطأ أثناء تحديد موقعك' });
  }
}

function distanceKm(a, b){
  if(!a || !b) return null;
  const R = 6371;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const lat1 = a.lat * Math.PI / 180;
  const lat2 = b.lat * Math.PI / 180;
  const sinDLat = Math.sin(dLat / 2);
  const sinDLng = Math.sin(dLng / 2);
  const h = sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLng * sinDLng;
  return 2 * R * Math.asin(Math.sqrt(h));
}

function hasMissingLocationColumn(error){
  const msg = String(error?.message || '').toLowerCase();
  return msg.includes('customer_lat') || msg.includes('customer_lng') || msg.includes('customer_address');
}

/* ================== AUTH ================== */
async function piLogin() {
  try {
    if (!window.Pi || !Pi.authenticate) {
      return Swal.fire({ icon: 'warning', title: 'Pi SDK غير متاح', text: 'افتح الموقع داخل Pi Browser لإتمام الدفع.' });
    }

    const ua = (navigator.userAgent || '').toLowerCase();
    if (!ua.includes('pibrowser')) {
      const r = await Swal.fire({
        icon: 'info',
        title: 'ملاحظة مهمة',
        text: 'الأفضل تفتح داخل Pi Browser عشان الدفع يشتغل 100%.',
        showCancelButton: true,
        confirmButtonText: 'كمّل',
        cancelButtonText: 'إلغاء'
      });
      if (!r.isConfirmed) return;
    }

    Swal.fire({ title: 'جاري تسجيل الدخول...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    const scopes = ['username', 'payments'];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);

    const username = auth?.user?.username || auth?.username || null;
    const uid = auth?.user?.uid || auth?.user?.id || auth?.uid || null;
    if (!username) throw new Error('لم يتم استلام username من Pi');

    PI_USER = auth;
    PI_USERNAME = username;
    PI_UID = uid || username;

    document.getElementById('custName').innerText = PI_USERNAME;
    document.getElementById('delName').innerText = PI_USERNAME;

    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('bottomNav').classList.remove('hidden');
    document.getElementById('roleToggle').classList.remove('hidden');

    // زر Admin يظهر فقط للأدمن
    if (PI_USERNAME === 'medomohamed22') {
      document.getElementById('adminLink').classList.remove('hidden');
    } else {
      document.getElementById('adminLink').classList.add('hidden');
    }

    setMainTab('home');
    setRole('customer');

    await refreshRates();
    await restoreActiveOrder();
    loadOrders();
    loadWalletPi();
    loadCustomerHistory();
    loadDeliveryHistory();
    loadWithdrawHistory();

    Swal.close();

  } catch (e) {
    console.error('piLogin error:', e);
    Swal.fire({ icon: 'error', title: 'فشل تسجيل الدخول', text: e?.message || 'حصل خطأ' });
  }
}

function devLogin(){
  PI_USERNAME = 'dev_user_' + Math.floor(Math.random()*9999);
  PI_UID = PI_USERNAME;

  document.getElementById('custName').innerText = PI_USERNAME;
  document.getElementById('delName').innerText = PI_USERNAME;

  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('bottomNav').classList.remove('hidden');
  document.getElementById('roleToggle').classList.remove('hidden');

  document.getElementById('adminLink').classList.add('hidden');

  setMainTab('home');
  setRole('customer');

  restoreActiveOrder();
  refreshRates();
  loadOrders();
  loadWalletPi();
  loadCustomerHistory();
  loadDeliveryHistory();
  loadWithdrawHistory();
}

function onIncompletePaymentFound(payment) {
  console.log('incomplete payment found:', payment);
}

/* ================== RESTORE ACTIVE ORDER ================== */
function activeOrderStorageKey(){
  return PI_USERNAME ? `qc_active_order_${PI_USERNAME}` : 'qc_active_order';
}

function setActiveOrderId(orderId){
  ACTIVE_ORDER = orderId;
  if (orderId) {
    localStorage.setItem(activeOrderStorageKey(), orderId);
  } else {
    localStorage.removeItem(activeOrderStorageKey());
  }
}

async function restoreActiveOrder(){
  if(!PI_USERNAME) return;

  const storedId = localStorage.getItem(activeOrderStorageKey());

  const customerOrder = await findActiveOrderForCustomer(storedId);
  if (customerOrder) {
    setActiveOrderId(customerOrder.id);
    setRole('customer');
    setMainTab('track');
    await applyCustomerOrderState(customerOrder);
    listenStatus();
    startChat();
    return;
  }

  const deliveryOrder = await findActiveOrderForDelivery(storedId);
  if (deliveryOrder) {
    setActiveOrderId(deliveryOrder.id);
    setRole('delivery');
    setMainTab('track');
    await loadOrderDetailsForDelivery(deliveryOrder.id);
    document.getElementById('delChat').classList.remove('hidden');
    startChat();
    markSeen('delivery');
    listenDeliveryStatus();
    return;
  }

  setActiveOrderId(null);
  setRole('customer');
  setMainTab('home');
}

async function findActiveOrderForCustomer(orderId){
  const activeStatuses = ['pending', 'accepted', 'shipping', 'arrived', 'delivered'];

  if (orderId) {
    const { data } = await db.from('orders')
      .select('id,product_name,status,customer_address,customer_lat,customer_lng,otp_code')
      .eq('id', orderId)
      .eq('customer_pi_username', PI_USERNAME)
      .single();
    if (data && activeStatuses.includes(data.status)) return data;
  }

  const { data } = await db.from('orders')
    .select('id,product_name,status,customer_address,customer_lat,customer_lng,otp_code')
    .eq('customer_pi_username', PI_USERNAME)
    .in('status', activeStatuses)
    .order('created_at', { ascending: false })
    .limit(1);

  return data?.[0] || null;
}

async function findActiveOrderForDelivery(orderId){
  const activeStatuses = ['accepted', 'shipping', 'arrived'];

  if (orderId) {
    const { data } = await db.from('orders')
      .select('id,status')
      .eq('id', orderId)
      .eq('delivery_id', PI_USERNAME)
      .single();
    if (data && activeStatuses.includes(data.status)) return data;
  }

  const { data } = await db.from('orders')
    .select('id,status')
    .eq('delivery_id', PI_USERNAME)
    .in('status', activeStatuses)
    .order('created_at', { ascending: false })
    .limit(1);

  return data?.[0] || null;
}

function updateCustomerTimeline(status){
  const steps = ['pending','accepted','shipping','arrived','delivered'];
  const currentIndex = steps.indexOf(status);
  document.querySelectorAll('#custTimeline .timelineItem').forEach((item) => {
    const itemStatus = item.getAttribute('data-status');
    const index = steps.indexOf(itemStatus);
    item.classList.toggle('active', index !== -1 && index <= currentIndex);
  });
}

async function finalizeCustomerDeliveredUI(order){
  safeDom('custTrack')?.classList.add('hidden');
  safeDom('custChat')?.classList.add('hidden');
  setMainTab('track');
  const rating = safeDom('custRating');
  rating?.classList.remove('hidden');
  rating?.scrollIntoView({ behavior: 'smooth', block: 'start' });

  LAST_DELIVERED_ORDER_ID = order?.id || LAST_DELIVERED_ORDER_ID;
  setActiveOrderId(null);

  if (statusPollTimer) clearInterval(statusPollTimer);
  if (chatPollTimer) clearInterval(chatPollTimer);
  if (statusChannel) {
    try { db.removeChannel(statusChannel); } catch {}
    statusChannel = null;
  }
  if (chatChannel) {
    try { db.removeChannel(chatChannel); } catch {}
    chatChannel = null;
  }

  await loadRatingState(order);
}

async function applyCustomerOrderState(order){
  const status = normalizeStatus(order.status || 'pending');
  if (['delivered','completed'].includes(status)) {
    await finalizeCustomerDeliveredUI(order);
    return;
  }
  safeDom('custTrack')?.classList.remove('hidden');
  safeDom('custChat')?.classList.remove('hidden');
  if (safeDom('custStatus')) safeDom('custStatus').innerText = status || 'pending';
  updateCustomerTimeline(status || 'pending');
  if (safeDom('otp')) safeDom('otp').innerText = order.otp_code || '';
  safeDom('otpBox')?.classList.toggle('hidden', !order.otp_code);
  if (safeDom('custAddressView')) safeDom('custAddressView').innerText = order.customer_address || '—';
  hideRating();
  const trackLink = safeDom('custTrackMapLink');
  if (trackLink && typeof order.customer_lat === 'number' && typeof order.customer_lng === 'number') {
    trackLink.href = buildMapUrl(order.customer_lat, order.customer_lng);
    trackLink.classList.remove('hidden');
    trackLink.onclick = () => openMapUrl(trackLink.href);
  } else {
    trackLink?.classList.add('hidden');
  }
}

function hideRating(){
  document.getElementById('custRating').classList.add('hidden');
  document.getElementById('ratingThanks').classList.add('hidden');
  document.getElementById('ratingSubmit').disabled = false;
  document.getElementById('ratingSubmit').classList.remove('btnS');
  document.getElementById('ratingSubmit').classList.add('btnA');
  document.getElementById('ratingNote').value = '';
  document.getElementById('ratingValue').innerText = 'اختر تقييمك.';
  setRating(0);
}

async function refreshCustomerStatus(){
  try{
    if (!ACTIVE_ORDER && LAST_DELIVERED_ORDER_ID) return;
    if (!PI_USERNAME || !ACTIVE_ORDER) return;
    const { data, error } = await db.from('orders')
      .select('id,product_name,status,customer_address,customer_lat,customer_lng,otp_code,delivery_id')
      .eq('id', ACTIVE_ORDER)
      .eq('customer_pi_username', PI_USERNAME)
      .single();
    if (error) throw error;
    if (data) {
      await applyCustomerOrderState(data);
    }
  }catch(e){
    console.warn('refreshCustomerStatus failed', e);
  }
}

function setRating(value){
  ACTIVE_RATING = value;
  const stars = document.querySelectorAll('#ratingStars .ratingStar');
  stars.forEach((star) => {
    const rating = Number(star.dataset.rating);
    star.classList.toggle('active', rating <= value);
  });
  const label = value ? `تقييمك الحالي: ${value} نجوم` : 'اختر تقييمك.';
  document.getElementById('ratingValue').innerText = label;
}

function initRatingStars(){
  const stars = document.querySelectorAll('#ratingStars .ratingStar');
  stars.forEach((star) => {
    star.addEventListener('click', () => {
      const rating = Number(star.dataset.rating);
      setRating(rating);
    });
  });
}

async function loadRatingState(order){
  if (!order?.id || !order?.delivery_id) return;
  try {
    const { data, error } = await db.from('delivery_ratings')
      .select('id,rating')
      .eq('order_id', order.id)
      .eq('customer_pi_username', PI_USERNAME)
      .limit(1);
    if (error) throw error;
    if (data && data.length) {
      setRating(Number(data[0].rating) || 0);
      document.getElementById('ratingThanks').classList.remove('hidden');
      const submit = document.getElementById('ratingSubmit');
      submit.disabled = true;
      submit.classList.remove('btnA');
      submit.classList.add('btnS');
    } else {
      document.getElementById('ratingThanks').classList.add('hidden');
      document.getElementById('ratingSubmit').disabled = false;
    }
  } catch (e) {
    console.warn('loadRatingState failed', e);
  }
}

async function submitRating(){
  try{
    const orderId = ACTIVE_ORDER || LAST_DELIVERED_ORDER_ID;
    if (!orderId) return;
    if (!PI_USERNAME) return Swal.fire('سجّل دخول أولاً');
    if (ACTIVE_RATING < 1) return Swal.fire('اختار تقييم من 1 إلى 5');

    const note = document.getElementById('ratingNote').value.trim();
    const { data: order, error: orderErr } = await db.from('orders')
      .select('delivery_id')
      .eq('id', orderId)
      .single();
    if (orderErr) throw orderErr;

    const { error } = await db.from('delivery_ratings').insert([{
      order_id: orderId,
      delivery_id: order?.delivery_id || null,
      customer_pi_username: PI_USERNAME,
      rating: ACTIVE_RATING,
      comment: note || null
    }]);
    if (error) throw error;

    document.getElementById('ratingThanks').classList.remove('hidden');
    document.getElementById('ratingSubmit').disabled = true;
    document.getElementById('ratingSubmit').classList.remove('btnA');
    document.getElementById('ratingSubmit').classList.add('btnS');
    Swal.fire({ icon:'success', title:'تم التقييم ✅' });
  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'فشل إرسال التقييم', text: e?.message || 'حصل خطأ' });
  }
}

async function rejectCaptain(){
  setRating(1);
  document.getElementById('ratingNote').value = 'رفض الكابتن';
  await submitRating();
}

/* ================== UI: INVOICE ================== */
function recalcInvoice(){
  const prodEgp = parseFloat(document.getElementById('price').value || "0") || 0;
  const totalEgp = prodEgp + DELIVERY_FEE_EGP + PLATFORM_FEE_EGP;
  const totalPi = egpToPi(totalEgp);

  document.getElementById('invProdEgp').innerText = prodEgp.toFixed(2);
  document.getElementById('invDelFeeEgp').innerText = DELIVERY_FEE_EGP.toFixed(2);
  document.getElementById('invPlatFeeEgp').innerText = PLATFORM_FEE_EGP.toFixed(2);
  document.getElementById('invTotalEgp').innerText = totalEgp.toFixed(2);
  document.getElementById('invTotalPi').innerText = totalPi ? totalPi.toFixed(6) : '0.000000';

  const hasRates = PI_USDT > 0 && USD_EGP > 0;
  document.getElementById('invSkeleton').classList.toggle('hidden', prodEgp > 0 && hasRates);
  document.getElementById('invPreviewBadge').classList.toggle('hidden', !hasRates);
}

/* ================== CUSTOMER: PAY + CREATE ORDER ================== */
async function payAndCreate() {
  try {
    if (!PI_USERNAME) return Swal.fire('لازم تسجل دخول الأول');

    const product = document.getElementById('prod').value.trim();
    const orderType = document.getElementById('orderType').value;
    const notes = document.getElementById('notes').value.trim();
    const address = document.getElementById('custAddress').value.trim();
    const prodEgp = parseFloat(document.getElementById('price').value || "0") || 0;

    if (!product || prodEgp <= 0) return Swal.fire('اكتب اسم المنتج وسعر صحيح');
    if (!address) return Swal.fire('اكتب العنوان بالتفصيل');
    if (!CUSTOMER_LOCATION) return Swal.fire('من فضلك حدّد موقعك أولاً');

    if (!(PI_USDT > 0 && USD_EGP > 0)) {
      await refreshRates();
      if (!(PI_USDT > 0 && USD_EGP > 0)) return Swal.fire('مقدرناش نجيب USD/EGP دلوقتي، جرّب تاني');
    }

    const totalEgp = prodEgp + DELIVERY_FEE_EGP + PLATFORM_FEE_EGP;
    const totalPi = egpToPi(totalEgp);
    const amountPi = Number(totalPi || 0).toFixed(6);

    const otp = String(Math.floor(1000 + Math.random() * 9000));

    const confirm = await Swal.fire({
      title: 'تأكيد الدفع',
      html: `
        <div style="text-align:right">
          <div>سعر المنتج: <b>${prodEgp.toFixed(2)} ج</b></div>
          <div>رسوم التوصيل: <b>${DELIVERY_FEE_EGP.toFixed(2)} ج</b></div>
          <div>رسوم الموقع: <b>${PLATFORM_FEE_EGP.toFixed(2)} ج</b></div>
          <hr/>
          <div>الإجمالي: <b style="color:#16a34a">${totalEgp.toFixed(2)} ج</b></div>
          <div>يعادل تقريبًا: <b style="color:#7c3aed">${amountPi} Pi</b></div>
          <div style="font-size:12px;opacity:.75;margin-top:6px">
            (1 Pi ≈ ${(PI_USDT*USD_EGP).toFixed(3)} ج)
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'ادفع',
      cancelButtonText: 'إلغاء'
    });
    if (!confirm.isConfirmed) return;

    if (!window.Pi || !Pi.createPayment) {
      return Swal.fire('Pi Payment غير متاح.. افتح داخل Pi Browser');
    }

    Swal.fire({ title: 'جاري الدفع...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    const paymentResult = await new Promise((resolve, reject) => {
      Pi.createPayment({
        amount: amountPi,
        memo: `QuickCart | ${product} | Total ${totalEgp.toFixed(2)} EGP`,
        metadata: {
          product, orderType, prodEgp,
          deliveryFee: DELIVERY_FEE_EGP,
          platformFee: PLATFORM_FEE_EGP,
          totalEgp,
          pi_usdt: PI_USDT,
          usd_egp: USD_EGP
        }
      }, {
        onReadyForServerApproval: async (paymentId) => {
          await fetch('/api/pi/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId })
          });
        },
        onReadyForServerCompletion: async (paymentId, txid) => {
          await fetch('/api/pi/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId, txid })
          });
          resolve({ paymentId, txid });
        },
        onCancel: (paymentId) => reject(new Error('تم إلغاء الدفع')),
        onError: (err) => reject(err || new Error('فشل الدفع'))
      });
    });

    // بعد نجاح الدفع: نكتب الطلب في DB
    const deliveryFeePi = egpToPi(DELIVERY_FEE_EGP);
    const platformFeePi = egpToPi(PLATFORM_FEE_EGP);

    const basePayload = {
      product_name: product,
      order_type: orderType,
      notes: notes || null,

      price: prodEgp,
      delivery_fee: DELIVERY_FEE_EGP,
      platform_fee: PLATFORM_FEE_EGP,

      total_price: totalEgp,
      status: 'pending',
      otp_code: otp,
      customer_pi_username: PI_USERNAME,
      can_modify_until: new Date(Date.now() + 60_000).toISOString(),

      pricing_snapshot: {
        pi_usdt: PI_USDT,
        usd_egp: USD_EGP,
        pi_egp: (PI_USDT * USD_EGP),
        total_pi: Number(amountPi),

        delivery_fee_pi: deliveryFeePi ? Number(deliveryFeePi.toFixed(6)) : 0,
        platform_fee_pi: platformFeePi ? Number(platformFeePi.toFixed(6)) : 0
      },
      payment_id: paymentResult?.paymentId || null,
      payment_txid: paymentResult?.txid || null
    };

    const payloadWithLocation = {
      ...basePayload,
      customer_address: address,
      customer_lat: CUSTOMER_LOCATION?.lat ?? null,
      customer_lng: CUSTOMER_LOCATION?.lng ?? null
    };

    let insertResult = await db.from('orders').insert([payloadWithLocation]).select();
    if (insertResult.error && hasMissingLocationColumn(insertResult.error)) {
      HAS_LOCATION_COLUMNS = false;
      basePayload.pricing_snapshot = {
        ...basePayload.pricing_snapshot,
        customer_location: {
          address,
          lat: CUSTOMER_LOCATION?.lat ?? null,
          lng: CUSTOMER_LOCATION?.lng ?? null
        }
      };
      insertResult = await db.from('orders').insert([basePayload]).select();
    }

    const { data, error } = insertResult;

    if (error) throw error;

    setActiveOrderId(data?.[0]?.id || null);
    setMainTab('track');

    document.getElementById('custTrack').classList.remove('hidden');
    document.getElementById('custChat').classList.remove('hidden');
    document.getElementById('custStatus').innerText = 'pending';
    updateCustomerTimeline('pending');
    document.getElementById('otp').innerText = otp;
    document.getElementById('otpBox').classList.remove('hidden');
    document.getElementById('custAddressView').innerText = address;
    const trackLink = document.getElementById('custTrackMapLink');
    trackLink.href = buildMapUrl(CUSTOMER_LOCATION.lat, CUSTOMER_LOCATION.lng);
    trackLink.classList.remove('hidden');
    trackLink.onclick = () => openMapUrl(trackLink.href);

    Swal.close();

    listenStatus();
    startChat();
    loadCustomerHistory();

  } catch (e) {
    console.error(e);
    Swal.fire({ icon: 'error', title: 'فشل العملية', text: e?.message || 'حصل خطأ' });
  }
}

/* ================== DELIVERY: LOAD + ACCEPT (RPC Lock) ================== */
function ordersSkeleton(){
  return `
    <div class="skeletonCard">
      <div class="skeletonLine mid"></div>
      <div class="skeletonLine"></div>
      <div class="skeletonLine short"></div>
    </div>
    <div class="skeletonCard">
      <div class="skeletonLine mid"></div>
      <div class="skeletonLine"></div>
      <div class="skeletonLine short"></div>
    </div>
  `;
}

async function loadOrders(){
  try{
    const box = document.getElementById('ordersBox');
    box.innerHTML = ordersSkeleton();

    let result = await db.from('orders')
      .select('id,product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,status,created_at,pricing_snapshot,customer_lat,customer_lng,customer_address')
      .eq('status','pending')
      .order('created_at',{ascending:false});

    if (result.error && hasMissingLocationColumn(result.error)) {
      HAS_LOCATION_COLUMNS = false;
      result = await db.from('orders')
        .select('id,product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,status,created_at,pricing_snapshot')
        .eq('status','pending')
        .order('created_at',{ascending:false});
    }

    const { data, error } = result;
    if (error) throw error;

    if (!data?.length) {
      box.innerHTML = `<div class="emptyState">لا توجد طلبات حالياً</div>`;
      return;
    }

    if (!DELIVERY_LOCATION && HAS_LOCATION_COLUMNS) {
      box.innerHTML = `
        <div class="emptyState space-y-2">
          <div class="text-sm font-bold">حدد موقعك أولاً</div>
          <div class="tiny muted">سنظهر لك الطلبات القريبة ضمن 5 كم.</div>
          <button class="btn btnA" onclick="setDeliveryLocation()">
            <i class="fa-solid fa-crosshairs"></i> تحديد موقعي
          </button>
        </div>
      `;
      return;
    }

    const filtered = HAS_LOCATION_COLUMNS
      ? data.filter(o => {
          if (typeof o.customer_lat !== 'number' || typeof o.customer_lng !== 'number') return false;
          const dist = distanceKm(
            DELIVERY_LOCATION,
            { lat: o.customer_lat, lng: o.customer_lng }
          );
          return dist !== null && dist <= 5;
        })
      : data;

    if (!filtered.length) {
      box.innerHTML = `<div class="emptyState">لا توجد طلبات قريبة ضمن 5 كم الآن.</div>`;
      return;
    }

    box.innerHTML = filtered.map(o => {
      const delFee = (o.delivery_fee ?? DELIVERY_FEE_EGP);
      const platFee = (o.platform_fee ?? PLATFORM_FEE_EGP);
      const totalEgp = (o.total_price ?? ((o.price||0)+delFee+platFee));
      const totalPi = egpToPi(totalEgp);
      const dist = HAS_LOCATION_COLUMNS
        ? distanceKm(
            DELIVERY_LOCATION,
            { lat: o.customer_lat, lng: o.customer_lng }
          )
        : null;
      const mapUrl = (HAS_LOCATION_COLUMNS && typeof o.customer_lat === 'number' && typeof o.customer_lng === 'number')
        ? buildMapUrl(o.customer_lat, o.customer_lng)
        : '#';

      return `
      <div class="glass p-4 space-y-2">
        <div class="row">
          <div class="min-w-0">
            <b class="text-base truncate">${escapeHtml(o.product_name)}</b>
            <div class="tiny">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
            <div class="tiny">نوع: <b>${escapeHtml(o.order_type || 'any')}</b></div>
            ${HAS_LOCATION_COLUMNS ? `<div class="tiny">المسافة: <b>${dist ? dist.toFixed(2) : '—'} كم</b></div>` : ``}
          </div>
          <div class="text-sm font-extrabold text-emerald-500">${Number(totalEgp).toFixed(2)} ج</div>
        </div>

        <div class="soft p-3 text-sm space-y-1">
          <div class="row"><span class="muted">سعر المنتج</span><b>${Number(o.price||0).toFixed(2)} ج</b></div>
          ${HAS_LOCATION_COLUMNS ? `<div class="row"><span class="muted">العنوان</span><b class="truncate">${escapeHtml(o.customer_address || '—')}</b></div>` : ``}
          <div class="row"><span class="muted">توصيل</span><b>${Number(delFee).toFixed(2)} ج</b></div>
          <div class="row"><span class="muted">رسوم موقع</span><b>${Number(platFee).toFixed(2)} ج</b></div>
          <div class="border-t border-emerald-100 pt-2 row"><span class="font-extrabold">الإجمالي</span><b class="text-emerald-500">${Number(totalEgp).toFixed(2)} ج</b></div>
          <div class="row"><span class="muted">يعادل بـ Pi</span><b class="mono text-emerald-600">${totalPi ? totalPi.toFixed(6) : '—'} Pi</b></div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button onclick="acceptOrder('${o.id}')" class="btn btnG">قبول الطلب</button>
          <button onclick="return openMapUrl('${mapUrl}')" class="btn btnS">
            <i class="fa-solid fa-map"></i> فتح الخريطة
          </button>
        </div>
      </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('ordersBox').innerHTML =
      `<div class="glass p-4 text-center" style="color:#fca5a5">خطأ في جلب الطلبات: ${escapeHtml(e?.message||'')}</div>`;
  }
}

async function acceptOrder(id){
  try{
    if(!PI_USERNAME) return Swal.fire('سجّل دخول كابتن الأول');

    const ok = await Swal.fire({
      icon: 'question',
      title: 'تأكيد القبول',
      text: 'هل أنت متأكد من قبول الطلب الآن؟',
      showCancelButton: true,
      confirmButtonText: 'نعم، قبول',
      cancelButtonText: 'إلغاء'
    });
    if (!ok.isConfirmed) return;

    Swal.fire({ title:'جاري القبول...', didOpen:()=>Swal.showLoading(), allowOutsideClick:false });

    const { error } = await db.rpc('accept_order_once', {
      p_order_id: id,
      p_delivery_id: PI_USERNAME
    });

    if (error) throw error;

    setActiveOrderId(id);
    setMainTab('track');
    await loadOrderDetailsForDelivery(id);

    document.getElementById('delChat').classList.remove('hidden');
    Swal.close();

    startChat();
    markSeen('delivery');
    listenDeliveryStatus();
    loadDeliveryHistory();

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'فشل القبول', text: e?.message || 'حصل خطأ' });
  }
}

async function loadOrderDetailsForDelivery(orderId){
  let result = await db.from('orders')
    .select('product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,customer_address,customer_lat,customer_lng,status')
    .eq('id', orderId)
    .single();

  if(result.error && hasMissingLocationColumn(result.error)) {
    HAS_LOCATION_COLUMNS = false;
    result = await db.from('orders')
      .select('product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,status')
      .eq('id', orderId)
      .single();
  }

  const { data, error } = result;
  if(error){ console.warn(error); return; }

  const delFee = (data.delivery_fee ?? DELIVERY_FEE_EGP);
  const platFee = (data.platform_fee ?? PLATFORM_FEE_EGP);
  const totalEgp = (data.total_price ?? ((data.price||0)+delFee+platFee));
  const totalPi = egpToPi(totalEgp);

  document.getElementById('dStatus').innerText = data.status || 'pending';
  document.getElementById('dProd').innerText = data.product_name || '—';
  document.getElementById('dType').innerText = data.order_type || 'any';
  document.getElementById('dProdEgp').innerText = Number(data.price||0).toFixed(2);
  const mapLink = document.getElementById('dMapLink');
  if (HAS_LOCATION_COLUMNS && data.customer_address) {
    document.getElementById('dAddress').innerText = data.customer_address;
  } else {
    document.getElementById('dAddress').innerText = '—';
  }
  if (HAS_LOCATION_COLUMNS && typeof data.customer_lat === 'number' && typeof data.customer_lng === 'number') {
    mapLink.href = buildMapUrl(data.customer_lat, data.customer_lng);
    mapLink.classList.remove('hidden');
    mapLink.onclick = () => openMapUrl(mapLink.href);
  } else {
    mapLink.href = '#';
    mapLink.classList.add('hidden');
  }
  document.getElementById('dDelFeeEgp').innerText = Number(delFee).toFixed(2);
  document.getElementById('dPlatFeeEgp').innerText = Number(platFee).toFixed(2);
  document.getElementById('dTotalEgp').innerText = Number(totalEgp).toFixed(2);
  document.getElementById('dTotalPi').innerText = totalPi ? totalPi.toFixed(6) : '—';
  document.getElementById('dNotes').innerText = data.notes ? data.notes : '—';
}

/* ================== REALTIME: CHAT ================== */
let chatChannel = null;
let chatPollTimer = null;

function startChat(){
  if(!ACTIVE_ORDER) return;

  if (chatChannel) {
    try { db.removeChannel(chatChannel); } catch {}
    chatChannel = null;
  }

  loadMessages();
  if (chatPollTimer) clearInterval(chatPollTimer);
  chatPollTimer = setInterval(loadMessages, 8000);

  chatChannel = db.channel('chat-room-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'chat_messages',
      filter: `order_id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      if (payload.new?.order_id !== ACTIVE_ORDER) return;
      appendMsg(payload.new, ACTIVE_ROLE);
      scrollChatToBottom();
      markSeen(currentRole());
    })
    .subscribe();
}

async function loadMessages(){
  const { data, error } = await db.from('chat_messages')
    .select('*')
    .eq('order_id', ACTIVE_ORDER)
    .order('created_at', { ascending: true });

  if(error){ console.error(error); return; }

  if (ACTIVE_ROLE === 'customer') {
    safeDom('chatC') && (safeDom('chatC').innerHTML = '');
  } else {
    safeDom('chatD') && (safeDom('chatD').innerHTML = '');
  }
  (data||[]).forEach((msg) => appendMsg(msg, ACTIVE_ROLE));
  scrollChatToBottom();

  markSeen(currentRole());
}

function currentRole(){
  return ACTIVE_ROLE;
}

async function uploadChatImage(file){
  // Bucket: chat
  const path = `chat/${ACTIVE_ORDER}/${Date.now()}_${file.name}`;
  const up = await db.storage.from('chat').upload(path, file, { upsert: false });
  if (up.error) throw up.error;
  return db.storage.from('chat').getPublicUrl(path).data.publicUrl;
}

async function sendMsg(sender){
  try{
    if(!ACTIVE_ORDER) return Swal.fire('مفيش طلب نشط');

    const input = sender === 'customer' ? document.getElementById('msgC') : document.getElementById('msgD');
    const fileEl = sender === 'customer' ? document.getElementById('imgC') : document.getElementById('imgD');

    const text = (input.value || '').trim();
    const file = fileEl.files?.[0];

    if(!text && !file) return;

    let image_url = null;
    if(file){
      try{
        image_url = await uploadChatImage(file);
      }catch(e){
        console.warn("Image upload failed:", e);
        image_url = null; // fallback بدون فشل
      }
    }

    const { error } = await db.from('chat_messages').insert([{
      order_id: ACTIVE_ORDER,
      sender,
      message_text: text || null,
      image_url,
      seen_at: null
    }]);
    if(error) throw error;

    input.value = '';
    fileEl.value = '';

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'فشل إرسال الرسالة', text: e?.message || 'حصل خطأ' });
  }
}

function quick(role, txt){
  if(role==='customer') document.getElementById('msgC').value = txt;
  else document.getElementById('msgD').value = txt;
}

function appendMsg(m, targetRole){
  const bubble = `
    <div class="msg ${m.sender==='customer'?'c':'d'}">
      ${m.message_text ? escapeHtml(m.message_text) : ''}
      ${m.image_url ? `<img loading="lazy" src="${m.image_url}" class="mt-2 chatImage" />` : ''}
      <div class="mt-1 tiny">${m.seen_at ? '✅✅' : '✅'}</div>
    </div>
  `;
  if (targetRole === 'customer') {
    safeDom('chatC')?.insertAdjacentHTML('beforeend', bubble);
  } else {
    safeDom('chatD')?.insertAdjacentHTML('beforeend', bubble);
  }
  scrollChatToBottom();
}

function scrollChatToBottom(){
  const el = document.getElementById('chatD');
  if (!el) return;
  requestAnimationFrame(() => {
    el.scrollTop = el.scrollHeight;
  });
}

async function markSeen(viewerRole){
  try{
    if(!ACTIVE_ORDER) return;
    if (!['customer','delivery'].includes(viewerRole)) return;
    await db.from('chat_messages')
      .update({ seen_at: new Date().toISOString() })
      .eq('order_id', ACTIVE_ORDER)
      .neq('sender', viewerRole)
      .is('seen_at', null);
  }catch(e){
    console.warn('markSeen failed:', e);
  }
}

/* ================== REALTIME: STATUS ================== */
let statusChannel = null;
let deliveryStatusChannel = null;
let statusPollTimer = null;

function listenStatus(){
  if(!ACTIVE_ORDER) return;

  if (statusChannel) {
    try { db.removeChannel(statusChannel); } catch {}
    statusChannel = null;
  }

  if (statusPollTimer) clearInterval(statusPollTimer);
  refreshCustomerStatus();
  statusPollTimer = setInterval(refreshCustomerStatus, 15000);

  const orderId = ACTIVE_ORDER;
  statusChannel = db.channel('order-status-' + orderId)
    .on('postgres_changes', {
      event: 'UPDATE', schema:'public', table:'orders',
      filter: `id=eq.${orderId}`
    }, (payload) => {
      try{
        if (!ACTIVE_ORDER && LAST_DELIVERED_ORDER_ID) return;
        if (ACTIVE_ORDER !== orderId) {
          console.log('[listenStatus] ignore stale order', orderId, ACTIVE_ORDER);
          return;
        }
        const s = normalizeStatus(payload.new.status);
        if(['delivered','completed'].includes(s)){
          console.log('[listenStatus] delivered detected', payload.new.id);
          finalizeCustomerDeliveredUI(payload.new);
          return;
        }
        safeDom('custStatus') && (safeDom('custStatus').innerText = s);
        updateCustomerTimeline(s);

        if(['accepted','shipping','arrived','delivered','completed'].includes(s)){
          safeDom('custChat')?.classList.remove('hidden');
        }
      } catch (err){
        console.error('[listenStatus] UI update failed', err);
      }
    }).subscribe();
}

function listenDeliveryStatus(){
  if(!ACTIVE_ORDER) return;

  if (deliveryStatusChannel) {
    try { db.removeChannel(deliveryStatusChannel); } catch {}
    deliveryStatusChannel = null;
  }

  const orderId = ACTIVE_ORDER;
  deliveryStatusChannel = db.channel('delivery-status-' + orderId)
    .on('postgres_changes', {
      event: 'UPDATE', schema:'public', table:'orders',
      filter: `id=eq.${orderId}`
    }, (payload) => {
      try{
        if (ACTIVE_ORDER !== orderId) {
          console.log('[listenDeliveryStatus] ignore stale order', orderId, ACTIVE_ORDER);
          return;
        }
        const s = normalizeStatus(payload.new.status || 'pending');
        const statusEl = safeDom('dStatus');
        if (statusEl) statusEl.innerText = s;

        if (['delivered','completed'].includes(s)) {
          console.log('[listenDeliveryStatus] delivered detected', payload.new.id);
          safeDom('delChat')?.classList.add('hidden');
          setActiveOrderId(null);
          loadOrders();
          loadWalletPi();
          loadDeliveryHistory();
          if (deliveryStatusChannel) {
            try { db.removeChannel(deliveryStatusChannel); } catch {}
            deliveryStatusChannel = null;
          }
          if (chatChannel) {
            try { db.removeChannel(chatChannel); } catch {}
            chatChannel = null;
          }
          if (chatPollTimer) clearInterval(chatPollTimer);
        }
      }catch(err){
        console.error('[listenDeliveryStatus] UI update failed', err);
      }
    }).subscribe();
}

/* ================== DELIVERY STATUS + OTP ================== */
async function setOrderStatus(st){
  if(!ACTIVE_ORDER) return Swal.fire('اختر طلب أولاً');
  const ok = await Swal.fire({
    icon: 'question',
    title: 'تأكيد الوصول',
    text: 'هل وصلت لموقع العميل بالفعل؟',
    showCancelButton: true,
    confirmButtonText: 'نعم، وصلت',
    cancelButtonText: 'إلغاء'
  });
  if (!ok.isConfirmed) return;
  await db.from('orders').update({ status: st }).eq('id', ACTIVE_ORDER);
}

async function verifyDeliveredStatus(orderId){
  for (let i = 0; i < 3; i += 1) {
    const { data, error } = await db.from('orders')
      .select('status')
      .eq('id', orderId)
      .single();
    if (error) {
      console.warn('[verifyDeliveredStatus] query failed', error);
    } else {
      const normalized = normalizeStatus(data?.status);
      console.log('[verifyDeliveredStatus] attempt', i + 1, normalized);
      if (['delivered','completed'].includes(normalized)) {
        return true;
      }
    }
    await new Promise(resolve => setTimeout(resolve, 700));
  }
  return false;
}

async function finishWithOtp(){
  try{
    if(FINISH_LOCK) return;
    if(!ACTIVE_ORDER) return;
    if(!PI_USERNAME) return Swal.fire('سجّل دخول');

    const confirm = await Swal.fire({
      icon: 'warning',
      title: 'تأكيد التسليم',
      text: 'هل أنت متأكد أنك سلمت الطلب للعميل؟',
      showCancelButton: true,
      confirmButtonText: 'متأكد',
      cancelButtonText: 'إلغاء'
    });
    if (!confirm.isConfirmed) return;

    const { value: code } = await Swal.fire({
      title: 'كود التسليم',
      input: 'text',
      inputPlaceholder: 'اكتب كود العميل',
      showCancelButton: true,
      confirmButtonText: 'تأكيد',
      cancelButtonText: 'إلغاء'
    });
    if(!code) return;

    FINISH_LOCK = true;
    safeDom('finishBtn')?.setAttribute('disabled', 'true');
    Swal.fire({ title: 'جاري تأكيد التسليم...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    const rpcPromise = db.rpc('complete_delivery', {
      p_order_id: ACTIVE_ORDER,
      p_otp: String(code).trim(),
      p_delivery_id: PI_USERNAME
    });
    const timeoutPromise = new Promise((_, reject) => {
      setTimeout(() => reject(new Error('timeout')), 8000);
    });

    const { error } = await Promise.race([rpcPromise, timeoutPromise]);
    if(error) throw error;

    const deliveredOk = await verifyDeliveredStatus(ACTIVE_ORDER);
    if (!deliveredOk) {
      const { data: current, error: readErr } = await db.from('orders')
        .select('status')
        .eq('id', ACTIVE_ORDER)
        .single();
      if (readErr) throw readErr;
      const normalized = normalizeStatus(current?.status);
      if (['arrived','shipping'].includes(normalized)) {
        await db.from('orders')
          .update({ status: 'delivered' })
          .eq('id', ACTIVE_ORDER)
          .eq('delivery_id', PI_USERNAME)
          .in('status', ['arrived','shipping']);
      }
      await verifyDeliveredStatus(ACTIVE_ORDER);
    }

    Swal.fire({ icon:'success', title:'تم التسليم ✅' });
    await loadWalletPi();
    await loadDeliveryHistory();
    await loadOrders();
    safeDom('delChat')?.classList.add('hidden');
    setActiveOrderId(null);
    if (chatChannel) {
      try { db.removeChannel(chatChannel); } catch {}
      chatChannel = null;
    }
    if (chatPollTimer) clearInterval(chatPollTimer);
    if (statusPollTimer) clearInterval(statusPollTimer);
    if (deliveryStatusChannel) {
      try { db.removeChannel(deliveryStatusChannel); } catch {}
      deliveryStatusChannel = null;
    }

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'فشل التسليم', text: e?.message || 'OTP غلط أو غير مسموح' });
  } finally {
    FINISH_LOCK = false;
    safeDom('finishBtn')?.removeAttribute('disabled');
  }
}

/* ================== WALLET (Pi) ================== */
/**
 * ✅ أولاً: delivery_wallet.balance_pi
 * ✅ خصم المسحوبات: withdrawals
 * ✅ fallback: حساب أرباح الدليفري من orders delivered (total_pi - platform_fee_pi)
 */
function toNum(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

function calcDeliveryEarningsPi(order) {
  const snap = order?.pricing_snapshot || {};
  const totalPi = toNum(snap.total_pi);
  const platformFeePi = toNum(snap.platform_fee_pi);
  
  // الأفضل: snapshot موجود
  if (totalPi > 0) return Math.max(0, totalPi - platformFeePi);
  
  // fallback (لو snapshot ناقص)
  const priceEgp = toNum(order?.price);
  const deliveryFeeEgp = toNum(order?.delivery_fee);
  const totalPriceEgp = toNum(order?.total_price);
  const platformFeeEgp = toNum(order?.platform_fee);
  
  const baseEgp = (priceEgp || deliveryFeeEgp) ?
    (priceEgp + deliveryFeeEgp) :
    Math.max(0, totalPriceEgp - platformFeeEgp);
  
  const piEgp = toNum(snap.pi_egp);
  if (baseEgp > 0 && piEgp > 0) return baseEgp / piEgp;
  
  return 0;
}

async function getWithdrawnSum() {
  if (!PI_UID) return 0;
  const { data, error } = await db.from('withdrawals')
    .select('amount')
    .eq('pi_user_id', PI_UID)
    .limit(1000);
  
  if (error) throw error;
  
  let sum = 0;
  (data || []).forEach(w => {
    sum += toNum(w.amount);
  });
  return sum;
}

async function loadWalletPi() {
  try {
    if (!PI_USERNAME) return;
    
    // 1) خصم المسحوبات
    const withdrawnSum = await getWithdrawnSum();
    
    // 2) محاولة من delivery_wallet
    try {
      const { data, error } = await db.from('delivery_wallet')
        .select('balance_pi')
        .eq('delivery_id', PI_USERNAME)
        .maybeSingle();
      
      if (!error && data && typeof data.balance_pi !== 'undefined') {
        const available = Math.max(0, toNum(data.balance_pi) - withdrawnSum);
        document.getElementById('walletPi').innerText = available.toFixed(6);
        return;
      }
    } catch (_) {
      // تجاهل وكمّل fallback
    }
    
    // 3) fallback: من orders delivered
    const { data: orders, error: e2 } = await db.from('orders')
      .select('pricing_snapshot,status,delivery_id,price,delivery_fee,total_price,platform_fee')
      .eq('delivery_id', PI_USERNAME)
      .eq('status', 'delivered')
      .limit(1000);
    
    if (e2) throw e2;
    
    let earned = 0;
    (orders || []).forEach(o => {
      earned += calcDeliveryEarningsPi(o);
    });
    
    const available = Math.max(0, earned - withdrawnSum);
    document.getElementById('walletPi').innerText = available.toFixed(6);
    
  } catch (e) {
    console.warn(e);
    document.getElementById('walletPi').innerText = '0.000000';
  }
}

/* ================== WITHDRAW ================== */
/**
 * ✅ Flow الصحيح:
 * 1) Call /api/withdraw -> Netlify function (withdraw.js)
 * 2) لو نجح: يظهر TX مباشرة
 */
async function withdrawPi() {
  try {
    if (!PI_USERNAME) return Swal.fire('سجّل دخول');
    if (!PI_UID) return Swal.fire('تعذر قراءة هوة Pi، جرّب تسجيل الدخول مرة أخرى');
    const accessToken = PI_USER?.accessToken || PI_USER?.access_token || PI_USER?.token;
    if (!accessToken) return Swal.fire('تعذر قراءة رمز المصادقة، جرّب تسجيل الدخول مرة أخرى');
    
    const amount = parseFloat(document.getElementById('wdAmountPi').value || "0");
    const walletAddress = (document.getElementById('wdWallet').value || '').trim();
    
    if (!amount || amount <= 0) return Swal.fire('اكتب كمية Pi صحيحة');
    if (!walletAddress || walletAddress.length < 10) return Swal.fire('اكتب عنوان محفظة Pi صحيح');
    
    const available = parseFloat(document.getElementById('walletPi').innerText || "0") || 0;
    if (amount > available) return Swal.fire('المبلغ أكبر من الرصيد المتاح');
    
    const ok = await Swal.fire({
      icon: 'question',
      title: 'تأكيد السحب',
      html: `
        <div style="text-align:right">
          <div>هتسحب: <b class="mono">${amount.toFixed(6)} Pi</b></div>
          <div style="margin-top:6px">
            إلى:
            <span class="mono" style="font-size:12px;opacity:.85;display:block;word-break:break-all">
              ${escapeHtml(walletAddress)}
            </span>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'سحب الآن',
      cancelButtonText: 'إلغاء'
    });
    if (!ok.isConfirmed) return;
    
    Swal.fire({ title: 'جاري تنفيذ التحويل على الشبكة...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
      
    // Call server function (Netlify redirect -> /.netlify/functions/withdraw)
    const res = await fetch('/api/withdraw', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${accessToken}`,
      },
      body: JSON.stringify({
        amount,
        walletAddress
      })
    });
      
    const out = await res.json().catch(() => ({}));
    if (!res.ok || !out?.success) {
      const msg = out?.error || out?.details || 'فشل السحب';
      throw new Error(msg);
    }
      
    Swal.fire({ icon: 'success', title: 'تم السحب ✅', text: `TX: ${out.txid}` });
    
    document.getElementById('wdAmountPi').value = '';
    document.getElementById('wdWallet').value = '';
    
    await loadWalletPi();
    await loadWithdrawHistory();
    
  } catch (e) {
    console.error(e);
    Swal.fire({ icon: 'error', title: 'فشل طلب السحب', text: e?.message || 'حصل خطأ' });
  }
}

async function copyWalletAddress(){
  const walletInput = document.getElementById('wdWallet');
  const val = walletInput.value.trim();
  if (!val) return Swal.fire('لا يوجد عنوان للنسخ');
  try{
    await navigator.clipboard.writeText(val);
    Swal.fire({ icon: 'success', title: 'تم النسخ ✅', timer: 1200, showConfirmButton: false });
  }catch(e){
    walletInput.select();
    document.execCommand('copy');
    Swal.fire({ icon: 'success', title: 'تم النسخ ✅', timer: 1200, showConfirmButton: false });
  }
}

async function pasteWalletAddress(){
  try{
    const text = await navigator.clipboard.readText();
    if (!text) return Swal.fire('لا يوجد محتوى في الحافظة');
    document.getElementById('wdWallet').value = text.trim();
  }catch(e){
    Swal.fire('تعذر لصق العنوان. الصقه يدويًا.');
  }
}

/* ================== WITHDRAW HISTORY ================== */
async function loadWithdrawHistory() {
  try {
    if (!PI_USERNAME) return;
    if (!PI_UID) return;
      
    const box = document.getElementById('wdHistory');
    if (!box) return;
      
    box.innerHTML = `
      <div class="skeletonCard">
        <div class="skeletonLine mid"></div>
        <div class="skeletonLine"></div>
      </div>
    `;
      
    const { data, error } = await db.from('withdrawals')
      .select('id,amount,wallet_address,created_at,txid')
      .eq('pi_user_id', PI_UID)
      .order('created_at', { ascending: false })
      .limit(50);
    
    if (error) throw error;
    
    if (!data || !data.length) {
      box.innerHTML = `<div class="tiny muted">لا يوجد طلبات سحب.</div>`;
      return;
    }
    
    box.innerHTML = data.map(w => `
      <div class="soft p-3 space-y-1">
        <div class="row">
          <b class="mono text-emerald-500">${Number(w.amount||0).toFixed(6)} Pi</b>
          <span class="chip chipG">مكتمل</span>
        </div>

        <div class="tiny muted break-all">
          <b>العنوان:</b>
          <span class="mono">${escapeHtml(w.wallet_address || '-')}</span>
        </div>

        ${w.txid ? `
          <div class="tiny muted break-all">
            <b>TX:</b>
            <span class="mono">${escapeHtml(w.txid)}</span>
          </div>` : ``}
      </div>
    `).join('');
    
  } catch (e) {
    console.error(e);
    const box = document.getElementById('wdHistory');
    if (box) {
      box.innerHTML = `<div class="tiny" style="color:#fca5a5">فشل تحميل سجل السحب</div>`;
    }
  }
}
/* ================== HISTORY: CUSTOMER + DELIVERY ================== */
async function loadCustomerHistory(){
  try{
    if(!PI_USERNAME) return;
    const box = document.getElementById('custHistory');
    box.innerHTML = ordersSkeleton();

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,total_price,status,created_at,pricing_snapshot,delivery_id')
      .eq('customer_pi_username', PI_USERNAME)
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data?.length){
      box.innerHTML = `<div class="tiny">لا يوجد طلبات بعد.</div>`;
      return;
    }

    const orderIds = data.map(o => o.id);
    let ratingMap = {};
    if (orderIds.length) {
      const { data: ratings } = await db.from('delivery_ratings')
        .select('order_id,rating')
        .in('order_id', orderIds);
      (ratings || []).forEach(r => {
        ratingMap[r.order_id] = r.rating;
      });
    }

    box.innerHTML = data.map(o => {
      const totalEgp = Number(o.total_price||0);
      const totalPi = Number(o?.pricing_snapshot?.total_pi || (egpToPi(totalEgp) || 0));
      const s = o.status || 'pending';
      const rating = ratingMap[o.id];

      const color =
        s==='delivered' ? 'text-emerald-500' :
        s==='canceled' ? 'text-red-400' :
        'text-emerald-600';

      return `
        <div class="soft p-3">
          <div class="row">
            <b class="truncate">${escapeHtml(o.product_name)}</b>
            <span class="chip ${color}">${escapeHtml(s)}</span>
          </div>
          <div class="tiny mt-1">نوع: <b>${escapeHtml(o.order_type||'any')}</b>${o.delivery_id ? ` | كابتن: <b>${escapeHtml(o.delivery_id)}</b>` : ``}</div>
          <div class="row mt-1">
            <span class="tiny">الإجمالي</span>
            <b class="text-emerald-500">${totalEgp.toFixed(2)} ج</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">بالـ Pi</span>
            <b class="mono text-emerald-600">${Number(totalPi||0).toFixed(6)} Pi</b>
          </div>
          ${typeof rating === 'number' ? `<div class="tiny mt-1">تقييم الكابتن: <b>${rating}</b> ⭐</div>` : ``}
          <div class="tiny mt-1">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
        </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('custHistory').innerHTML = `<div class="tiny" style="color:#fca5a5">فشل تحميل سجل الطلبات</div>`;
  }
}

async function loadDeliveryHistory(){
  try{
    if(!PI_USERNAME) return;
    const box = document.getElementById('delHistory');
    box.innerHTML = ordersSkeleton();

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,total_price,status,created_at,pricing_snapshot,customer_pi_username')
      .eq('delivery_id', PI_USERNAME)
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data?.length){
      box.innerHTML = `<div class="tiny">لا يوجد طلبات مسجلة عليك بعد.</div>`;
      const statOrders = document.getElementById('statOrders');
      if (statOrders) statOrders.innerText = '0';
      return;
    }

    const statOrders = document.getElementById('statOrders');
    if (statOrders) statOrders.innerText = String(data.length);

    const orderIds = data.map(o => o.id);
    let ratingMap = {};
    if (orderIds.length) {
      const { data: ratings } = await db.from('delivery_ratings')
        .select('order_id,rating')
        .in('order_id', orderIds);
      (ratings || []).forEach(r => {
        ratingMap[r.order_id] = r.rating;
      });
    }

    const ratingValues = Object.values(ratingMap).filter(v => typeof v === 'number');
    const statRating = document.getElementById('statRating');
    if (statRating) {
      if (ratingValues.length) {
        const avg = ratingValues.reduce((sum, v) => sum + v, 0) / ratingValues.length;
        statRating.innerText = avg.toFixed(1);
      } else {
        statRating.innerText = '—';
      }
    }

    box.innerHTML = data.map(o => {
      const totalEgp = Number(o.total_price||0);
      const totalPi = Number(o?.pricing_snapshot?.total_pi || (egpToPi(totalEgp) || 0));
      const profitPi = Number(o?.pricing_snapshot?.delivery_fee_pi || 0);
      const s = o.status || 'pending';
      const rating = ratingMap[o.id];

      return `
        <div class="soft p-3">
          <div class="row">
            <b class="truncate">${escapeHtml(o.product_name)}</b>
            <span class="chip">${escapeHtml(s)}</span>
          </div>
          <div class="tiny mt-1">عميل: <b>${escapeHtml(o.customer_pi_username||'—')}</b></div>
          <div class="row mt-1">
            <span class="tiny">الإجمالي</span>
            <b class="text-emerald-500">${totalEgp.toFixed(2)} ج</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">بالـ Pi</span>
            <b class="mono text-emerald-600">${Number(totalPi||0).toFixed(6)} Pi</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">ربحك</span>
            <b class="mono text-emerald-600">${profitPi.toFixed(6)} Pi</b>
          </div>
          ${typeof rating === 'number' ? `<div class="tiny mt-1">تقييمك: <b>${rating}</b> ⭐</div>` : ``}
          <div class="tiny mt-1">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
        </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('delHistory').innerHTML = `<div class="tiny" style="color:#fca5a5">فشل تحميل سجل الدليفري</div>`;
  }
}

/* ================== UI ================== */
function toggleRole(){
  setRole(ACTIVE_ROLE === 'customer' ? 'delivery' : 'customer');
}

function setRole(role){
  ACTIVE_ROLE = role;
  updateRoleUI();
}

function setMainTab(tab){
  ACTIVE_MAIN_TAB = tab;
  updateMainTabUI();
}

function updateRoleUI(){
  const isCustomer = ACTIVE_ROLE === 'customer';
  document.getElementById('roleToggle').innerText = isCustomer ? 'User' : 'Delivery';
  document.getElementById('customerHome').classList.toggle('hidden', !isCustomer);
  document.getElementById('deliveryHome').classList.toggle('hidden', isCustomer);
  document.getElementById('customerTrackTab').classList.toggle('hidden', !isCustomer);
  document.getElementById('deliveryTrackTab').classList.toggle('hidden', isCustomer);

  if(isCustomer){
    loadCustomerHistory();
  } else {
    loadOrders();
    loadWalletPi();
    loadWithdrawHistory();
    loadDeliveryHistory();
  }
}

function setTabVisibility(id, show){
  const el = document.getElementById(id);
  if (show) {
    el.classList.remove('hidden');
    el.classList.add('active','fadeIn');
    setTimeout(() => el.classList.remove('fadeIn'), 300);
  } else {
    el.classList.remove('active');
    el.classList.add('hidden');
  }
}

function updateMainTabUI(){
  const isHome = ACTIVE_MAIN_TAB === 'home';
  const isTrack = ACTIVE_MAIN_TAB === 'track';
  const isDiscover = ACTIVE_MAIN_TAB === 'discover';

  setTabVisibility('homeTab', isHome);
  setTabVisibility('trackTab', isTrack);
  setTabVisibility('discoverTab', isDiscover);

  document.getElementById('navHome').classList.toggle('active', isHome);
  document.getElementById('navTrack').classList.toggle('active', isTrack);
  document.getElementById('navDiscover').classList.toggle('active', isDiscover);

  document.getElementById('headerSearch').classList.toggle('hidden', !isHome);
  const showBack = (!isHome || ACTIVE_ORDER);
  document.getElementById('headerBack').classList.toggle('hidden', !showBack);
}

/* ================== HELPERS ================== */
function escapeHtml(str){
  return String(str ?? '').replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}
function safeDom(id){
  return document.getElementById(id) || null;
}
function normalizeStatus(status){
  return String(status || '').trim().toLowerCase();
}
  </script>
</body>
</html>
