<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Ù…Ù†ØµØ© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© - Pi</title>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --p:#7f5cff;
  --bg:#0f0f1a;
  --card:rgba(255,255,255,.08);
  --muted:rgba(255,255,255,.65);
  --stroke:rgba(255,255,255,.12);
}
*{box-sizing:border-box;font-family:Tajawal,system-ui}
body{margin:0;background:var(--bg);color:#fff}
header{padding:15px;text-align:center;font-size:20px;background:#141428;position:sticky;top:0;z-index:5}
.container{padding:12px;max-width:520px;margin:0 auto}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
  border:1px solid var(--stroke);
  padding:12px;border-radius:14px;margin-bottom:10px;
  backdrop-filter: blur(10px);
}
.row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.btn{
  background:var(--p);border:none;color:#fff;padding:10px 14px;border-radius:10px;
  cursor:pointer;transition:.2s transform,.2s opacity;min-width:140px
}
.btn:active{transform:scale(.98)}
.btn.secondary{background:transparent;border:1px solid var(--stroke)}
.btn:disabled{opacity:.6;cursor:not-allowed}
input,textarea{
  width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);
  background:rgba(0,0,0,.2);color:#fff;outline:none
}
small{color:var(--muted)}
.badge{background:gold;color:#000;padding:3px 8px;border-radius:8px;font-size:12px}
.chat{height:220px;overflow:auto;background:rgba(0,0,0,.25);border:1px solid var(--stroke);border-radius:12px;padding:10px}
.msg{margin:6px 0;line-height:1.4}
.me{color:#cbb6ff}
.hr{height:1px;background:var(--stroke);margin:10px 0}
.toast{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:18px;background:rgba(0,0,0,.55);border:1px solid var(--stroke);
  padding:10px 12px;border-radius:12px;backdrop-filter:blur(10px);
  max-width:92vw;display:none
}
.toast.show{display:block}
</style>
</head>

<body>

<header>ğŸ”§ Ø®Ø¯Ù…Ø§Øª Ù…Ù†Ø²Ù„ÙŠØ© Ø¨Ø¹Ù…Ù„Ø© Pi</header>

<div class="container">

  <div class="card" id="loginBox">
    <div class="row">
      <div>
        <div style="font-size:16px;font-weight:700">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
        <small>Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø­Ø³Ø§Ø¨ Pi Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ù‚Ø¯Ù…ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©</small>
      </div>
      <button class="btn" id="loginBtn" onclick="piLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi</button>
    </div>
    <div class="hr"></div>
    <small id="sdkState">Ø¬Ø§Ø±Ù ØªÙ‡ÙŠØ¦Ø© Pi SDKâ€¦</small>
  </div>

  <div class="card" id="userBox" style="display:none">
    <div class="row">
      <div>
        ğŸ‘¤ <span id="uName" style="font-weight:800"></span><br/>
        <small id="uMeta"></small>
      </div>
      <button class="btn secondary" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div id="ads" class="ads"></div>

  <div class="card" id="chatBox" style="display:none">
    <h4 style="margin:0 0 10px">ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h4>
    <div class="chat" id="chat"></div>
    <div style="height:10px"></div>
    <input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©" />
    <div style="height:10px"></div>
    <button class="btn" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
/** =======================
 *  Config
 *  ======================= */
const SUPABASE_URL = "https://axjkwrssmofzavaoqutq.supabase.co";
const SUPABASE_KEY = "sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let user = null;
let accessToken = null;
let currentAd = null;

/** =======================
 *  Helpers
 *  ======================= */
const $ = (id) => document.getElementById(id);
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 3200);
}

function setLoadingLogin(isLoading){
  const btn = $("loginBtn");
  btn.disabled = isLoading;
  btn.textContent = isLoading ? "Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„..." : "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi";
}

/** =======================
 *  Pi SDK Init (sandbox = false Ø¯Ø§Ø¦Ù…Ø§Ù‹)
 *  Ù„Ø§Ø²Ù… ØªØªÙ†ÙØ° Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù‚Ø¨Ù„ authenticate
 *  ======================= */
(function initPi(){
  try{
    if(!window.Pi){
      $("sdkState").textContent = "Pi SDK ØºÙŠØ± Ù…ØªØ§Ø­. ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ ÙØ§ØªØ­ Ø¯Ø§Ø®Ù„ Pi Browser.";
      $("loginBtn").disabled = true;
      return;
    }

    // Ù…Ù‡Ù…: sandbox false
    Pi.init({ version: "2.0", sandbox: false });

    $("sdkState").textContent = "Pi SDK Ø¬Ø§Ù‡Ø² âœ… (sandbox: false)";
  }catch(e){
    $("sdkState").textContent = "Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ‡ÙŠØ¦Ø© Pi SDK.";
    $("loginBtn").disabled = true;
    console.error(e);
  }
})();

/** =======================
 *  Login / Logout
 *  ======================= */
async function piLogin(){
  try{
    if(!window.Pi){
      toast("Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø¯Ø§Ø®Ù„ Pi Browser Ø¹Ø´Ø§Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØ´ØªØºÙ„.");
      return;
    }

    setLoadingLogin(true);

    // scopes: username + payments (Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯ÙØ¹)
    const scopes = ["username", "payments"];

    // callback Ù„Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (Ù…Ù‡Ù… ÙˆØ¬ÙˆØ¯Ù‡ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ø§Ù„Ø§Øª)
    const onIncompletePaymentFound = async (payment) => {
      // Ù„Ùˆ Ø­ØµÙ„ Ø¯ÙØ¹ Ø³Ø§Ø¨Ù‚ ÙˆÙ„Ù… ÙŠÙƒØªÙ…Ù„ØŒ ØªÙ‚Ø¯Ø± ØªÙƒÙ…Ù„Ù‡ Ù‡Ù†Ø§ Ø¨Ø³ÙŠØ±ÙØ±Ùƒ
      console.log("Incomplete payment found:", payment);
      toast("ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø¯ÙØ¹ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©. Ù„Ùˆ Ù…Ø­ØªØ§Ø¬ Ù†ÙƒÙ…Ù„Ù‡Ø§ Ù‡Ù†ÙƒÙ…Ù„Ù‡Ø§ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.");
    };

    const res = await Pi.authenticate(scopes, onIncompletePaymentFound);

    // Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ¦Ø§Øª Ø¨ØªØ³Ù…ÙŠÙ‡ accessToken / access_tokenØŒ ÙØ¨Ù†Ø¤Ù…Ù‘Ù†Ù‡Ø§
    accessToken = res.accessToken || res.access_token || null;
    user = res.user || null;

    if(!user || !accessToken){
      throw new Error("Missing user or accessToken from Pi.authenticate()");
    }

    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    localStorage.setItem("pi_user", JSON.stringify(user));
    localStorage.setItem("pi_access_token", accessToken);

    $("loginBox").style.display = "none";
    $("userBox").style.display = "block";
    $("uName").innerText = user.username || "Pi User";
    $("uMeta").innerText = `pi_uid: ${user.uid || "N/A"}`;

    toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…");
    await loadAds();

  }catch(err){
    console.error(err);
    toast("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ Ø¯Ø§Ø®Ù„ Pi Browser ÙˆØ±Ø§Ø¬Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ·Ø¨ÙŠÙ‚Ùƒ.");
  }finally{
    setLoadingLogin(false);
  }
}

function logout(){
  user = null;
  accessToken = null;
  localStorage.removeItem("pi_user");
  localStorage.removeItem("pi_access_token");

  $("loginBox").style.display = "block";
  $("userBox").style.display = "none";
  $("ads").innerHTML = "";
  $("chatBox").style.display = "none";
  toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
}

/** =======================
 *  Ads
 *  ======================= */
async function loadAds(){
  $("ads").innerHTML = `<div class="card"><small>Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øªâ€¦</small></div>`;

  const { data, error } = await sb
    .from("ads")
    .select(`id,title,description,is_featured,is_active, provider_profiles(display_name)`)
    .eq("is_active", true)
    .order("is_featured", { ascending: false });

  if(error){
    console.error(error);
    $("ads").innerHTML = `<div class="card"><small>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.</small></div>`;
    return;
  }

  $("ads").innerHTML = "";
  (data || []).forEach(a=>{
    const providerName = a.provider_profiles?.display_name || "Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø©";
    $("ads").innerHTML += `
      <div class="card">
        <div class="row">
          <div style="display:flex;gap:8px;align-items:center">
            ${a.is_featured ? `<span class="badge">Ù…Ù…ÙŠØ²</span>` : ``}
            <div style="font-weight:800">${escapeHtml(a.title)}</div>
          </div>
          <small>ğŸ‘¨â€ğŸ”§ ${escapeHtml(providerName)}</small>
        </div>
        <div style="height:8px"></div>
        <small>${escapeHtml(a.description || "")}</small>
        <div class="hr"></div>
        <div class="row">
          <button class="btn secondary" onclick="openChat('${a.id}')">ØªÙˆØ§ØµÙ„</button>
          <button class="btn" onclick="boost('${a.id}')">ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
        </div>
      </div>
    `;
  });

  if(!data || data.length === 0){
    $("ads").innerHTML = `<div class="card"><small>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</small></div>`;
  }
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[s]));
}

/** =======================
 *  Chat (UI Ø¨Ø³ÙŠØ·)
 *  ======================= */
async function openChat(adId){
  if(!user || !accessToken){
    toast("Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„.");
    return;
  }
  currentAd = adId;
  $("chatBox").style.display = "block";
  $("chat").innerHTML = `<small>Ø¨Ø¯Ø£Øª Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©â€¦ (MVP)</small>`;
}

async function sendMsg(){
  if(!$("msg").value.trim()) return;
  $("chat").innerHTML += `<div class="msg me">Ø£Ù†Ø§: ${escapeHtml($("msg").value)}</div>`;
  $("msg").value = "";
  $("chat").scrollTop = $("chat").scrollHeight;
}

/** =======================
 *  Boost Payment
 *  ======================= */
async function boost(adId){
  try{
    if(!user || !accessToken){
      toast("Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„.");
      return;
    }
    if(!window.Pi){
      toast("Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø¯Ø§Ø®Ù„ Pi Browser Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯ÙØ¹ ÙŠØ´ØªØºÙ„.");
      return;
    }

    toast("Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹â€¦");

    await Pi.createPayment(
      {
        amount: 1,
        memo: "Boost Ad",
        metadata: { adId }
      },
      {
        onReadyForServerApproval: async (paymentId) => {
          // Ù†Ø±Ø³Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ± ÙŠÙˆØ§ÙÙ‚ (approve)
          const r = await fetch("/api/pi/approve",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              paymentId,
              adId,
              boostPlanId: null,
              piAccessToken: accessToken
            })
          });

          if(!r.ok){
            const t = await r.text();
            console.error("approve error:", t);
            throw new Error("approve failed");
          }
        },

        onReadyForServerCompletion: async (paymentId) => {
          // Ù†Ø±Ø³Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ± ÙŠÙƒÙ…Ù„ (complete)
          const r = await fetch("/api/pi/complete",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              paymentId,
              piAccessToken: accessToken
            })
          });

          if(!r.ok){
            const t = await r.text();
            console.error("complete error:", t);
            throw new Error("complete failed");
          }

          toast("ØªÙ… ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† âœ…");
          await loadAds();
        },

        onCancel: () => toast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹"),
        onError: (e) => {
          console.error(e);
          toast("Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹");
        }
      }
    );

  }catch(err){
    console.error(err);
    toast("ÙØ´Ù„ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†. Ø±Ø§Ø¬Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Pi API ÙˆØ§Ù„Ø³ÙŠØ±ÙØ±.");
  }
}

/** =======================
 *  Auto-restore session (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
 *  ======================= */
(function restore(){
  try{
    const u = localStorage.getItem("pi_user");
    const t = localStorage.getItem("pi_access_token");
    if(u && t){
      user = JSON.parse(u);
      accessToken = t;

      $("loginBox").style.display = "none";
      $("userBox").style.display = "block";
      $("uName").innerText = user.username || "Pi User";
      $("uMeta").innerText = `pi_uid: ${user.uid || "N/A"}`;

      loadAds();
    }
  }catch(e){}
})();
</script>
</body>
</html>
