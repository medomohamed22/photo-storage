<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>QuickCart | ÙˆØ§Ø¬Ù‡Ø© Pi (Talabat-style)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase + SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap');

    :root{
      --bg0:#f6f4ff;
      --bg1:#ffffff;
      --bg2:#f1ecff;
      --card:#ffffff;
      --card2:#f7f2ff;
      --stroke:rgba(109,40,217,.15);

      --txt:#2b1f3c;
      --muted:rgba(43,31,60,.65);
      --p:#7c3aed;
      --p2:#8b5cf6;
      --p3:#a78bfa;

      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#d97706;
      --info:#2563eb;

      --shadow: 0 18px 60px rgba(124,58,237,.15);
      --shadow2: 0 12px 30px rgba(124,58,237,.12);
      --r1:22px;
      --r2:18px;
    }

    *{box-sizing:border-box}
    body{
      font-family:Tajawal,system-ui;
      color:var(--txt);
      min-height:100vh;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 520px at 95% 0%, rgba(139,92,246,.16), transparent 60%),
        radial-gradient(900px 520px at 70% 110%, rgba(167,139,250,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, var(--bg2));
    }

    /* Safe area bottom for iOS */
    .safeBottom{ padding-bottom: calc(92px + env(safe-area-inset-bottom)); }

    /* Glass / Cards */
    .glass{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      box-shadow: var(--shadow);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .glass:hover{
      transform: translateY(-2px);
      box-shadow: 0 20px 60px rgba(124,58,237,.18);
    }
    .soft{
      background: var(--card2);
      border: 1px solid rgba(124,58,237,.12);
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .soft:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(124,58,237,.14);
    }

    /* Talabat-like top bar */
    .topBar{
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(124,58,237,.12);
    }

    /* Brand badge */
    .brandBadge{
      width: 44px; height: 44px;
      border-radius: 18px;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(16px 16px at 30% 30%, rgba(124,58,237,.3), rgba(139,92,246,.2));
      border:1px solid rgba(124,58,237,.35);
      box-shadow: 0 16px 40px rgba(124,58,237,.25);
    }

    /* Chips */
    .chip{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(124,58,237,.18);
      background: rgba(124,58,237,.08);
      color:var(--txt);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .chip:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(124,58,237,.12); }
    .chipP{ background: rgba(124,58,237,.15); border-color: rgba(124,58,237,.35); }
    .chipB{ background: rgba(139,92,246,.16); border-color: rgba(139,92,246,.35); }
    .chipG{ background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.35); }
    .chipS{ background: rgba(255,255,255,.7); }

    /* Buttons */
    .btn{
      border-radius:18px;
      padding:12px 14px;
      font-weight:900;
      transition:.15s;
      user-select:none;
      border:1px solid rgba(124,58,237,.2);
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 22px rgba(124,58,237,.18); }
    .btn:active{transform:scale(.98)}
    .btnA{
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(139,92,246,.85));
      border-color: rgba(124,58,237,.4);
      color:#fff;
      box-shadow: 0 16px 45px rgba(124,58,237,.25);
    }
    .btnP{
      background: linear-gradient(135deg, rgba(139,92,246,.95), rgba(124,58,237,.85));
      border-color: rgba(139,92,246,.4);
      color:#fff;
      box-shadow: 0 16px 45px rgba(139,92,246,.2);
    }
    .btnG{
      background: linear-gradient(135deg, rgba(34,197,94,.92), rgba(22,163,74,.75));
      border-color: rgba(34,197,94,.35);
      color:#fff;
    }
    .btnB{
      background: linear-gradient(135deg, rgba(96,165,250,.92), rgba(37,99,235,.75));
      border-color: rgba(96,165,250,.35);
      color:#fff;
    }
    .btnS{
      background: rgba(255,255,255,.85);
      border-color: rgba(124,58,237,.2);
      color: var(--txt);
    }

    /* Inputs */
    input,textarea,select{
      width: 100%;
      background: rgba(255,255,255,.9) !important;
      border: 1px solid rgba(124,58,237,.18) !important;
      color: var(--txt) !important;
      border-radius: 16px !important;
      outline: none !important;
      transition: .15s;
      padding: 14px 14px !important;
    }
    input::placeholder, textarea::placeholder{
      color: rgba(243,244,246,.55);
    }
    input:focus,textarea:focus,select:focus{
      border-color: rgba(124,58,237,.6) !important;
      box-shadow: 0 0 0 4px rgba(124,58,237,.15);
    }
    textarea{min-height:96px}

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .tiny{font-size:11px;color:rgba(0,0,0,.55)}
    .muted{color:rgba(0,0,0,.6)}

    /* Section Title */
    .secTitle{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .secTitle b{
      font-size:14px;
      letter-spacing:.2px;
    }
    .sectionHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .sectionHeader h3{
      font-size:15px;
      font-weight:800;
    }
    .sectionSub{
      font-size:12px;
      color:var(--muted);
    }
    .pageShell{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .pageSection{
      padding:16px;
    }
    .statsGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .statCard{
      padding:12px;
      border-radius:16px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(124,58,237,.12);
      text-align:center;
    }
    .statCard b{
      display:block;
      font-size:16px;
    }
    .featureGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    .infoCard{
      padding:14px;
      border-radius:16px;
      background: rgba(255,255,255,.9);
      border:1px dashed rgba(124,58,237,.2);
    }
    .listCard{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(124,58,237,.12);
      background: rgba(255,255,255,.9);
    }
    .listIcon{
      width:36px;
      height:36px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(124,58,237,.08);
      border:1px solid rgba(124,58,237,.18);
    }
    .ratingStars{
      display:flex;
      gap:8px;
      justify-content:center;
    }
    .ratingStar{
      width:40px;
      height:40px;
      border-radius:14px;
      border:1px solid rgba(124,58,237,.2);
      background: #fff;
      color: rgba(124,58,237,.6);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .ratingStar:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(124,58,237,.12);
    }
    .ratingStar.active{
      background: rgba(124,58,237,.12);
      color: rgba(124,58,237,1);
      border-color: rgba(124,58,237,.35);
    }

    /* Talabat-like feature cards */
    .miniCard{
      background: var(--card2);
      border: 1px solid rgba(124,58,237,.15);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 25px rgba(124,58,237,.12);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .miniCard:hover{
      transform: translateY(-2px);
      box-shadow: 0 18px 35px rgba(124,58,237,.18);
    }
    .miniIcon{
      width: 40px; height: 40px;
      border-radius: 16px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(124,58,237,.1);
      border:1px solid rgba(124,58,237,.18);
      box-shadow: 0 12px 28px rgba(124,58,237,.18);
    }

    /* Chat bubbles */
    .msg{
      max-width:78%;
      padding:10px 12px;
      border-radius:18px;
      font-size:13px;
      word-break:break-word;
      border:1px solid rgba(124,58,237,.15);
      animation: pop .2s ease-in-out;
    }
    @keyframes pop{
      from{transform:scale(.96);opacity:.5}
      to{transform:scale(1);opacity:1}
    }
    .c{ background: rgba(124,58,237,.18); color: var(--txt); align-self:flex-start; }
    .d{ background: rgba(255,255,255,.9); color: var(--txt); align-self:flex-end; }

    /* Bottom nav - app style */
    .bottomNav{
      position: fixed;
      left: 0; right: 0;
      bottom: calc(12px + env(safe-area-inset-bottom));
      z-index: 50;
      padding: 0 14px;
    }
    .bottomNav .wrap{
      max-width: 480px;
      margin: 0 auto;
      padding: 10px;
      border-radius: 24px;
      background: rgba(255,255,255,.95);
      border:1px solid rgba(124,58,237,.12);
      box-shadow: 0 18px 40px rgba(124,58,237,.18);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:flex;
      gap:10px;
    }

    /* Small tweaks */
    .divider{
      height:1px;
      background: rgba(124,58,237,.12);
      margin: 10px 0;
    }
    a.linkP{ color: rgba(124,58,237,1); text-decoration: underline; }
    /* âœ… ÙŠÙ…Ù†Ø¹ Ø£ÙŠ Ø¹Ù†ØµØ± ÙŠØ·Ù„Ø¹ Ø¨Ø±Ù‘Ù‡ Ø§Ù„ÙƒØ§Ø±Øª */
.miniCard, .soft, .glass { overflow: hidden; }

/* âœ… ØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¯Ø§Ø®Ù„ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø­Ø¨ */
.wdRow{
  display:flex;
  align-items:center;
  gap:10px;
  width:100%;
  min-width:0;           /* Ù…Ù‡Ù… Ù„Ù‚Øµ Ø§Ù„Ù†Øµ */
}

.wdLabel{
  flex:0 0 auto;
  white-space:nowrap;
  opacity:.85;
}

.wdValue{
  flex:1 1 auto;
  min-width:0;           /* Ù…Ù‡Ù… */
  overflow:hidden;
  text-overflow:ellipsis;/* â€¦ */
  white-space:nowrap;    /* Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ */
  padding:6px 10px;
  border:1px solid rgba(124,58,237,.15);
  border-radius:12px;
  background: rgba(255,255,255,.9);
}

    /* SweetAlert */
    .swal2-popup{
      background: #ffffff !important;
      color: var(--txt) !important;
      border: 1px solid rgba(124,58,237,.18) !important;
      border-radius: 20px !important;
      box-shadow: 0 18px 40px rgba(124,58,237,.18) !important;
    }
    .swal2-title{
      color: var(--txt) !important;
    }
    .swal2-html-container{
      color: var(--muted) !important;
    }
    .swal2-styled.swal2-confirm{
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(139,92,246,.85)) !important;
      border: none !important;
      border-radius: 14px !important;
      box-shadow: 0 12px 25px rgba(124,58,237,.2) !important;
    }
    .swal2-styled.swal2-cancel{
      background: rgba(255,255,255,.9) !important;
      color: var(--txt) !important;
      border: 1px solid rgba(124,58,237,.2) !important;
      border-radius: 14px !important;
      box-shadow: 0 10px 20px rgba(124,58,237,.12) !important;
    }
  </style>
</head>

<body class="safeBottom">
  <!-- HEADER -->
  <header class="sticky top-0 z-50 topBar">
    <div class="px-3 pt-3 pb-3">
      <div class="max-w-lg mx-auto flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="brandBadge">
            <i class="fa-solid fa-basket-shopping text-white"></i>
          </div>
          <div class="leading-tight">
            <div class="font-black text-base">QuickCart</div>
            <div class="tiny -mt-0.5">Ø·Ù„Ø¨ Ø³Ø±ÙŠØ¹ â€¢ Ø¯Ù„ÙŠÙØ±ÙŠ Ù‚Ø±ÙŠØ¨ Ù…Ù†Ùƒ</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="roleToggle" onclick="toggleRole()" class="chip chipS hidden">
            <i class="fa-solid fa-user"></i> User
          </button>
          <a id="adminLink" href="./admin.html" class="chip chipP hidden">
            <i class="fa-solid fa-shield-halved"></i> Admin
          </a>
          <span id="piTag" class="chip chipB">
            <i class="fa-brands fa-pied-piper-alt"></i> â€¦
          </span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-lg mx-auto p-3 space-y-3">
    <!-- LOGIN -->
    <div id="loginBox" class="glass p-4 text-center space-y-3">
      <div class="flex items-center justify-center gap-2">
        <span class="miniIcon"><i class="fa-solid fa-right-to-bracket"></i></span>
        <div class="text-right">
          <div class="font-extrabold">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
          <div class="tiny muted">Ø§ÙØªØ­ Ø¯Ø§Ø®Ù„ Pi Browser Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯ÙØ¹ ÙŠØ´ØªØºÙ„ 100%</div>
        </div>
      </div>

      <button id="loginBtn" onclick="piLogin()" class="btn btnP w-full">
        <i class="fa-brands fa-pied-piper-alt"></i>
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Pi
      </button>

      <button onclick="devLogin()" class="text-xs underline muted">
        Ø¯Ø®ÙˆÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ (Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø§Ø±Ø¬ Pi Browser)
      </button>
    </div>

<!-- ================= HOME TAB ================= -->
<div id="homeTab" class="pageShell">

      <!-- STATUS + RATES -->
  <section class="glass pageSection space-y-3">
        <div class="secTitle">
          <b><i class="fa-solid fa-signal mr-1"></i> Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±</b>
          <span class="chip chipS"><i class="fa-regular fa-clock"></i> ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
        </div>

        <div class="miniCard">
          <div class="flex items-center justify-between gap-2">
            <div class="text-sm">
              <span class="muted">Ø­Ø§Ù„Ø© Pi:</span>
              <b id="piStateText" class="mr-1">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</b>
            </div>
            <span class="chip chipB"><i class="fa-solid fa-globe"></i> <span id="piTag2">Auto</span></span>
          </div>
          <div class="tiny muted mt-2">
            Pi ÙƒÙ„ <b>30 Ø«Ø§Ù†ÙŠØ©</b> â€” USD/EGP ÙƒÙ„ <b>60 Ø«Ø§Ù†ÙŠØ©</b>. | 1 Pi â‰ˆ <span class="mono" id="piEgpOne">â€”</span> Ø¬
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="miniCard">
            <div class="flex items-center gap-2">
              <span class="miniIcon"><i class="fa-solid fa-coins"></i></span>
              <div>
                <div class="tiny muted">Ø³Ø¹Ø± Pi (USDT)</div>
                <div class="font-black mono text-base"><span id="piUsdt">â€”</span></div>
                <div class="tiny muted">Ù…ØµØ¯Ø±: OKX</div>
              </div>
            </div>
          </div>

          <div class="miniCard">
            <div class="flex items-center gap-2">
              <span class="miniIcon"><i class="fa-solid fa-money-bill-wave"></i></span>
              <div>
                <div class="tiny muted">Ø³Ø¹Ø± USD (EGP)</div>
                <div class="font-black mono text-base"><span id="usdEgp">â€”</span></div>
                <div class="tiny muted">Ù…ØµØ¯Ø±: open.er-api.com</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ================= CUSTOMER (HOME) ================= -->
      <div id="customerHome" class="hidden space-y-3">
    <section class="glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-bag-shopping mr-1"></i> Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</b>
            <span class="chip chipP"><i class="fa-solid fa-credit-card"></i> Pi Pay</span>
          </div>

          <div class="miniCard">
            <div class="flex items-center justify-between">
              <div class="text-sm">
                Ø£Ù‡Ù„Ù‹Ø§ <b id="custName">â€”</b>
                <div class="tiny muted">Ø§Ø®ØªØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù…Ù„Ø£ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬</div>
              </div>
              <span class="miniIcon"><i class="fa-solid fa-location-dot"></i></span>
            </div>

            <div class="divider"></div>

            <select id="orderType">
              <option value="any">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: Ø£ÙŠ Ø­Ø§Ø¬Ø©</option>
              <option value="market">Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>
              <option value="pharmacy">ØµÙŠØ¯Ù„ÙŠØ©</option>
              <option value="restaurant">Ù…Ø·Ø¹Ù…</option>
            </select>

            <div class="grid grid-cols-1 gap-2 mt-2">
              <input id="prod" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
              <input id="price" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙŠ" oninput="recalcInvoice()" />
              <input id="custAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„" />
            </div>

            <div class="soft p-3 mt-2 space-y-2">
              <div class="flex items-center justify-between">
                <div class="text-sm"><span class="muted">Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</span></div>
                <button class="chip chipG" onclick="setCustomerLocation()">
                  <i class="fa-solid fa-crosshairs"></i> ØªØ­Ø¯ÙŠØ¯
                </button>
              </div>
              <div id="custLocStatus" class="tiny muted">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯.</div>
              <a id="custMapLink" class="tiny linkP hidden" target="_blank" rel="noopener noreferrer" onclick="return openMapUrl(this.href)">
                ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Google Maps
              </a>
            </div>

            <textarea id="notes" class="mt-2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª/Ø¨Ø¯Ø§Ø¦Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
          </div>

          <!-- INVOICE -->
          <div class="miniCard space-y-2">
            <div class="secTitle">
              <b><i class="fa-solid fa-receipt mr-1"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</b>
              <span class="chip chipS">
                <i class="fa-solid fa-truck-fast"></i> ØªÙˆØµÙŠÙ„: <b>20</b>Ø¬
                <span class="mx-1">â€¢</span>
                <i class="fa-solid fa-store"></i> Ù…ÙˆÙ‚Ø¹: <b>10</b>Ø¬
              </span>
            </div>

            <div class="text-sm space-y-2">
              <div class="flex items-center justify-between"><span class="muted">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</span><b><span id="invProdEgp">0</span> Ø¬</b></div>
              <div class="flex items-center justify-between"><span class="muted">Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</span><b><span id="invDelFeeEgp">20</span> Ø¬</b></div>
              <div class="flex items-center justify-between"><span class="muted">Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ÙˆÙ‚Ø¹</span><b><span id="invPlatFeeEgp">10</span> Ø¬</b></div>

              <div class="divider"></div>

              <div class="flex items-center justify-between">
                <span class="font-black">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                <b class="text-emerald-400"><span id="invTotalEgp">0</span> Ø¬</b>
              </div>

              <div class="soft p-3 mt-2">
                <div class="tiny muted">Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Pi (ØªÙ‚Ø±ÙŠØ¨ÙŠ):</div>
                <div class="flex items-center justify-between mt-1">
                  <span class="muted text-sm">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ù€ Pi</span>
                  <b class="mono text-purple-300 text-sm"><span id="invTotalPi">0</span> Pi</b>
                </div>
              </div>
            </div>
          </div>

          <button onclick="payAndCreate()" class="btn btnA w-full">
            <i class="fa-solid fa-bolt"></i>
            Ø§Ø¯ÙØ¹ Ø¨Ù€ Pi ÙˆØ§Ø·Ù„Ø¨
          </button>
          <div class="tiny muted text-center">
            Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ â€œØ§Ø¯ÙØ¹â€ Ø£Ù†Øª ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°.
          </div>
        </section>

        <section class="glass pageSection space-y-3">
          <div class="sectionHeader">
            <div>
              <h3>Ø®Ø¯Ù…Ø§Øª QuickCart</h3>
              <div class="sectionSub">Ø§Ø®ØªØµØ± ÙˆÙ‚ØªÙƒ Ù…Ø¹ Ø£Ù‚Ø³Ø§Ù… Ù…Ø®ØµØµØ© Ù„ÙƒÙ„ Ø§Ø­ØªÙŠØ§Ø¬.</div>
            </div>
            <span class="chip chipS"><i class="fa-solid fa-layer-group"></i> Ø£Ù‚Ø³Ø§Ù…</span>
          </div>
          <div class="featureGrid">
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-burger"></i></span>
                <div>
                  <div class="text-sm font-bold">Ù…Ø·Ø§Ø¹Ù… Ù‚Ø±ÙŠØ¨Ø©</div>
                  <div class="tiny muted">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù„Ø¹Ø´Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
              </div>
            </div>
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-pills"></i></span>
                <div>
                  <div class="text-sm font-bold">ØµÙŠØ¯Ù„ÙŠØ§Øª</div>
                  <div class="tiny muted">Ø£Ø¯ÙˆÙŠØ© Ø¹Ø§Ø¬Ù„Ø© ÙˆØªÙˆØµÙŠÙ„ Ø¢Ù…Ù†</div>
                </div>
              </div>
            </div>
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-cart-shopping"></i></span>
                <div>
                  <div class="text-sm font-bold">Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</div>
                  <div class="tiny muted">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨ÙŠØª ÙÙŠ Ø¯Ù‚Ø§Ø¦Ù‚</div>
                </div>
              </div>
            </div>
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-bolt"></i></span>
                <div>
                  <div class="text-sm font-bold">Ø·Ù„Ø¨Ø§Øª ÙÙˆØ±ÙŠØ©</div>
                  <div class="tiny muted">ØªÙˆØµÙŠÙ„ Ø³Ø±ÙŠØ¹ Ù…Ø¹ ÙƒØ§Ø¨ØªÙ† Ù‚Ø±ÙŠØ¨</div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ================= DELIVERY (HOME) ================= -->
      <div id="deliveryHome" class="hidden space-y-3">
    <section class="glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-motorcycle mr-1"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø¯Ù„ÙŠÙØ±ÙŠ</b>
            <button onclick="loadOrders()" class="chip chipS">
              <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
            </button>
          </div>

          <div class="miniCard">
            <div class="flex items-center justify-between">
              <div class="text-sm">Ø§Ù„ÙƒØ§Ø¨ØªÙ†: <b id="delName">â€”</b></div>
              <span class="miniIcon"><i class="fa-solid fa-helmet-safety"></i></span>
            </div>

            <div class="soft p-3 mt-3 space-y-2">
              <div class="flex items-center justify-between">
                <span class="muted text-sm">Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙƒØ§Ø¨ØªÙ†</span>
                <button class="chip chipG" onclick="setDeliveryLocation()">
                  <i class="fa-solid fa-crosshairs"></i> ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ
                </button>
              </div>
              <div id="delLocStatus" class="tiny muted">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯.</div>
              <div class="tiny muted">Ø³ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ 5 ÙƒÙ… ÙÙ‚Ø·.</div>
            </div>
          </div>
        </section>

        <div id="ordersBox" class="space-y-2"></div>
        <div class="glass pageSection space-y-3">
          <div class="sectionHeader">
            <div>
              <h3>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
              <div class="sectionSub">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© Ù„Ù„ÙƒØ§Ø¨ØªÙ†.</div>
            </div>
            <span class="chip chipS"><i class="fa-solid fa-chart-line"></i> Ø§Ù„ÙŠÙˆÙ…</span>
          </div>
          <div class="statsGrid">
            <div class="statCard">
              <b id="statOrders">0</b>
              <span class="tiny muted">Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</span>
            </div>
            <div class="statCard">
              <b id="statRating">4.9</b>
              <span class="tiny muted">ØªÙ‚ÙŠÙŠÙ… Ù…ØªÙˆØ³Ø·</span>
            </div>
            <div class="statCard">
              <b id="statZone">5km</b>
              <span class="tiny muted">Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙˆØµÙŠÙ„</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= TRACK TAB ================= -->
    <div id="trackTab" class="hidden pageShell">

      <!-- ================= CUSTOMER (TRACK) ================= -->
      <div id="customerTrackTab" class="hidden space-y-3">
        <!-- TRACK -->
        <section id="custTrack" class="hidden glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-route mr-1"></i> Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨</b>
            <div class="flex items-center gap-2">
              <button class="chip chipS" onclick="refreshCustomerStatus()">
                <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
              </button>
              <span class="chip chipP"><i class="fa-solid fa-circle-info"></i> Live</span>
            </div>
          </div>

          <div class="miniCard space-y-2">
            <div class="flex items-center justify-between">
              <span class="muted text-sm">Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</span>
              <b id="custStatus" class="text-purple-300">pending</b>
            </div>

            <div class="flex items-center justify-between text-sm">
              <span class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span>
              <b id="custAddressView">â€”</b>
            </div>

            <div class="flex items-center justify-between text-sm">
              <span class="muted">Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
              <a id="custTrackMapLink" class="linkP hidden" target="_blank" rel="noopener noreferrer" onclick="return openMapUrl(this.href)">
                ÙØªØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
              </a>
            </div>

            <div id="otpBox" class="hidden text-sm">
              <span class="muted">ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</span>:
              <b id="otp" class="text-purple-300 text-lg mono"></b>
              <div class="tiny muted mt-1">Ù‚Ø¯Ù‘Ù… Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„ÙƒØ§Ø¨ØªÙ† Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„.</div>
            </div>
          </div>
        </section>

        <!-- RATING -->
        <section id="custRating" class="hidden glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-star mr-1"></i> ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙƒØ§Ø¨ØªÙ†</b>
            <span class="chip chipS">Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</span>
          </div>
          <div class="miniCard space-y-3 text-center">
            <div class="text-sm">Ù‚ÙŠÙ‘Ù… ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ù† 1 Ø¥Ù„Ù‰ 5 Ù†Ø¬ÙˆÙ….</div>
            <div class="ratingStars" id="ratingStars">
              <button type="button" class="ratingStar" data-rating="1"><i class="fa-solid fa-star"></i></button>
              <button type="button" class="ratingStar" data-rating="2"><i class="fa-solid fa-star"></i></button>
              <button type="button" class="ratingStar" data-rating="3"><i class="fa-solid fa-star"></i></button>
              <button type="button" class="ratingStar" data-rating="4"><i class="fa-solid fa-star"></i></button>
              <button type="button" class="ratingStar" data-rating="5"><i class="fa-solid fa-star"></i></button>
            </div>
            <div id="ratingValue" class="tiny muted">Ø§Ø®ØªØ± ØªÙ‚ÙŠÙŠÙ…Ùƒ.</div>
            <textarea id="ratingNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù„Ù„Ø¯Ù„ÙŠÙØ±ÙŠ"></textarea>
            <button id="ratingSubmit" class="btn btnA w-full" onclick="submitRating()">
              Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
            </button>
            <button class="btn btnS w-full" onclick="rejectCaptain()">
              Ø±ÙØ¶ Ø§Ù„ÙƒØ§Ø¨ØªÙ†
            </button>
            <div id="ratingThanks" class="tiny muted hidden">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŒ Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ.</div>
          </div>
        </section>

        <!-- CHAT -->
        <section id="custChat" class="hidden glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-comments mr-1"></i> Ø§Ù„Ø´Ø§Øª (Ù„Ø­Ø¸ÙŠ)</b>
            <div class="flex gap-2">
              <button class="chip chipS" onclick="quick('customer','Ø£Ù†Ø§ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ØŸ')">
                <i class="fa-solid fa-paper-plane"></i> ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ØŸ
              </button>
              <button class="chip chipS" onclick="quick('customer','Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¨Ø¯ÙŠÙ„ØŸ')">
                <i class="fa-solid fa-repeat"></i> Ø¨Ø¯ÙŠÙ„ØŸ
              </button>
            </div>
          </div>

          <div id="chatC" class="flex flex-col gap-2 h-52 overflow-y-auto soft p-3"></div>

          <div class="flex gap-2 items-center">
            <input id="msgC" class="flex-1" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
            <label class="chip chipS cursor-pointer">
              <i class="fa-regular fa-image"></i>
              <input type="file" id="imgC" accept="image/*" class="hidden" />
              ØµÙˆØ±Ø©
            </label>
            <button onclick="sendMsg('customer')" class="btn btnA" style="padding:12px 14px">
              <i class="fa-solid fa-arrow-up"></i>
            </button>
          </div>
          <div class="tiny muted">âœ… = Ø§ØªØ¨Ø¹Øª | âœ…âœ… = Ø§ØªÙ‚Ø±ÙŠØª</div>
        </section>

        <!-- CUSTOMER HISTORY -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-clock-rotate-left mr-1"></i> Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ</b>
            <button class="chip chipS" onclick="loadCustomerHistory()">
              <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
            </button>
          </div>
          <div id="custHistory" class="space-y-2 text-sm"></div>
        </section>
      </div>

      <!-- ================= DELIVERY (TRACK) ================= -->
      <div id="deliveryTrackTab" class="hidden space-y-3">

        <!-- DELIVERY CHAT -->
    <section id="delChat" class="hidden glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-headset mr-1"></i> Ø´Ø§Øª Ø§Ù„Ø·Ù„Ø¨ (Ù„Ø­Ø¸ÙŠ)</b>
            <div class="flex gap-2">
              <button class="chip chipS" onclick="quick('delivery','Ø£Ù†Ø§ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ ğŸ›µ')">
                <i class="fa-solid fa-motorcycle"></i> ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚
              </button>
              <button class="chip chipS" onclick="quick('delivery','Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ø¨Ø¯ÙŠÙ„ØŸ')">
                <i class="fa-solid fa-ban"></i> ØºÙŠØ± Ù…ØªÙˆÙØ±
              </button>
            </div>
          </div>

          <div class="miniCard space-y-1" id="delOrderDetails">
            <div class="flex items-center justify-between"><span class="muted">Ø§Ù„Ø­Ø§Ù„Ø©</span><b id="dStatus">â€”</b></div>
            <div class="flex items-center justify-between"><span class="muted">Ø§Ù„Ù…Ù†ØªØ¬</span><b id="dProd">â€”</b></div>
            <div class="flex items-center justify-between"><span class="muted">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</span><b id="dType">â€”</b></div>
            <div class="flex items-center justify-between"><span class="muted">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</span><b><span id="dProdEgp">â€”</span> Ø¬</b></div>
            <div class="flex items-center justify-between"><span class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span><b id="dAddress">â€”</b></div>
            <div class="flex items-center justify-between">
              <span class="muted">Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
              <a id="dMapLink" class="linkP hidden" target="_blank" rel="noopener noreferrer" onclick="return openMapUrl(this.href)">ÙØªØ­ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a>
            </div>
            <div class="divider"></div>
            <div class="flex items-center justify-between"><span class="muted">ØªÙˆØµÙŠÙ„</span><b><span id="dDelFeeEgp">20</span> Ø¬</b></div>
            <div class="flex items-center justify-between"><span class="muted">Ø±Ø³ÙˆÙ… Ù…ÙˆÙ‚Ø¹</span><b><span id="dPlatFeeEgp">10</span> Ø¬</b></div>
            <div class="divider"></div>
            <div class="flex items-center justify-between"><span class="font-black">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><b class="text-emerald-400"><span id="dTotalEgp">â€”</span> Ø¬</b></div>
            <div class="flex items-center justify-between"><span class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ù€ Pi</span><b class="mono text-purple-300"><span id="dTotalPi">â€”</span> Pi</b></div>
            <div class="tiny muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: <span id="dNotes">â€”</span></div>
          </div>

          <div id="chatD" class="flex flex-col gap-2 h-52 overflow-y-auto soft p-3"></div>

          <div class="flex gap-2 items-center">
            <input id="msgD" class="flex-1" placeholder="Ø±Ø³Ø§Ù„Ø©..." />
            <label class="chip chipS cursor-pointer">
              <i class="fa-regular fa-image"></i>
              <input type="file" id="imgD" accept="image/*" class="hidden" />
              ØµÙˆØ±Ø©
            </label>
            <button onclick="sendMsg('delivery')" class="btn btnB" style="padding:12px 14px">
              <i class="fa-solid fa-arrow-up"></i>
            </button>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <button onclick="setOrderStatus('arrived')" class="btn btnA">
              <i class="fa-solid fa-location-crosshairs"></i> ÙˆØµÙ„Øª
            </button>
            <button onclick="finishWithOtp()" class="btn btnG">
              <i class="fa-solid fa-check"></i> ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…
            </button>
          </div>
        </section>

        <!-- WALLET + WITHDRAW -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-wallet mr-1"></i> Ø£Ø±Ø¨Ø§Ø­ÙŠ Ø§Ù„Ù…ØªØ§Ø­Ø©</b>
            <span class="chip chipP"><i class="fa-brands fa-pied-piper-alt"></i> Pi</span>
          </div>

          <div class="miniCard">
            <div class="text-sm">
              Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªØ§Ø­Ø©:
              <b class="mono text-purple-300"><span id="walletPi">0.000000</span> Pi</b>
            </div>
            <div class="tiny muted mt-1">Ø§Ù„Ø³Ø­Ø¨ ÙŠØªÙ… Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ù…Ø­ÙØ¸ØªÙƒ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯.</div>
          </div>

          <input id="wdAmountPi" type="number" step="0.000001" placeholder="ÙƒÙ… Pi Ù‡ØªØ³Ø­Ø¨ØŸ" />
          <input id="wdWallet" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© Pi" />

          <button onclick="withdrawPi()" class="btn btnP w-full">
            <i class="fa-solid fa-hand-holding-dollar"></i>
            Ø·Ù„Ø¨ Ø³Ø­Ø¨ Pi
          </button>
          <div class="tiny muted">ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.</div>
        </section>

        <!-- WITHDRAW HISTORY -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-list mr-1"></i> Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨</b>
            <button class="chip chipS" onclick="loadWithdrawHistory()">
              <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
            </button>
          </div>
          <div id="wdHistory" class="space-y-2 text-sm"></div>
        </section>

        <!-- DELIVERY HISTORY -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-clock-rotate-left mr-1"></i> Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ ÙƒØ¯Ù„ÙŠÙØ±ÙŠ</b>
            <button class="chip chipS" onclick="loadDeliveryHistory()">
              <i class="fa-solid fa-rotate"></i> ØªØ­Ø¯ÙŠØ«
            </button>
          </div>
          <div id="delHistory" class="space-y-2 text-sm"></div>
        </section>
      </div>
    </div>

    <!-- ================= DISCOVER TAB ================= -->
    <div id="discoverTab" class="hidden pageShell">
      <section class="glass pageSection space-y-3">
        <div class="sectionHeader">
          <div>
            <h3>Ù„Ù…Ø§Ø°Ø§ QuickCartØŸ</h3>
            <div class="sectionSub">ÙˆØ§Ø¬Ù‡Ø© Ù…Ø±ØªØ¨Ø© Ù„ÙƒÙ„ Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</div>
          </div>
          <span class="chip chipP"><i class="fa-solid fa-star"></i> Ù…Ù…ÙŠØ²</span>
        </div>
        <div class="infoCard">
          <div class="text-sm">ØªØ¬Ø±Ø¨Ø© Ø·Ù„Ø¨ Ø³Ù„Ø³Ø© Ù…Ø¹ Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ø­Ø¸ÙŠØ©ØŒ Ø´Ø§Øª Ù…Ø¨Ø§Ø´Ø±ØŒ ÙˆØ¯ÙØ¹ Ø¢Ù…Ù† Ø¨Ù€ Pi.</div>
        </div>
        <div class="featureGrid">
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-shield-halved"></i></span>
            <div>
              <div class="text-sm font-bold">Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø·Ù„Ø¨</div>
              <div class="tiny muted">ÙƒÙˆØ¯ ØªØ³Ù„ÙŠÙ… Ø³Ø±ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ù…Ø§Ù†.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-comments"></i></span>
            <div>
              <div class="text-sm font-bold">ØªÙˆØ§ØµÙ„ ÙÙˆØ±ÙŠ</div>
              <div class="tiny muted">Ø´Ø§Øª Ù†ØµÙŠ ÙˆØµÙˆØ± Ù…Ø¹ Ø§Ù„ÙƒØ§Ø¨ØªÙ†.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-location-dot"></i></span>
            <div>
              <div class="text-sm font-bold">ØªØªØ¨Ø¹ Ù…Ø¨Ø§Ø´Ø±</div>
              <div class="tiny muted">Ø¹Ø±Ø¶ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-wallet"></i></span>
            <div>
              <div class="text-sm font-bold">Ø³Ø­Ø¨ Ù…Ø¨Ø§Ø´Ø±</div>
              <div class="tiny muted">ØªØ­ÙˆÙŠÙ„ Ø£Ø±Ø¨Ø§Ø­Ùƒ Ø³Ø±ÙŠØ¹Ù‹Ø§ Ù„Ù…Ø­ÙØ¸ØªÙƒ.</div>
            </div>
          </div>
        </div>
      </section>

      <section class="glass pageSection space-y-3">
        <div class="sectionHeader">
          <div>
            <h3>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</h3>
            <div class="sectionSub">Ø«Ù„Ø§Ø« Ø®Ø·ÙˆØ§Øª Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø·Ù„Ø¨.</div>
          </div>
          <span class="chip chipS"><i class="fa-solid fa-route"></i> Ø¯Ù„ÙŠÙ„ Ø³Ø±ÙŠØ¹</span>
        </div>
        <div class="space-y-2">
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-user"></i></span>
            <div>
              <div class="text-sm font-bold">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
              <div class="tiny muted">Ø§Ø³ØªØ®Ø¯Ù… Pi Browser Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø¯ÙØ¹.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-bag-shopping"></i></span>
            <div>
              <div class="text-sm font-bold">Ø£Ù†Ø´Ø¦ Ø·Ù„Ø¨Ùƒ</div>
              <div class="tiny muted">Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-truck-fast"></i></span>
            <div>
              <div class="text-sm font-bold">ØªØ§Ø¨Ø¹ Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
              <div class="tiny muted">Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„ÙƒØ§Ø¨ØªÙ†.</div>
            </div>
          </div>
        </div>
      </section>

      <section class="glass pageSection space-y-3">
        <div class="sectionHeader">
          <div>
            <h3>Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</h3>
            <div class="sectionSub">Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù†Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.</div>
          </div>
          <span class="chip chipB"><i class="fa-solid fa-headset"></i> Ø¯Ø¹Ù…</span>
        </div>
        <div class="miniCard space-y-2">
          <div class="text-sm">ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø´Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ù„Ø¨.</div>
          <div class="flex flex-wrap gap-2">
            <span class="chip chipS"><i class="fa-solid fa-envelope"></i> support@quickcart.app</span>
            <span class="chip chipS"><i class="fa-solid fa-phone"></i> 15777</span>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- BOTTOM NAV -->
  <div id="bottomNav" class="bottomNav hidden">
    <div class="wrap">
      <button id="navHome" onclick="setMainTab('home')" class="btn btnA flex-1">
        <i class="fa-solid fa-plus"></i> Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
      </button>
      <button id="navTrack" onclick="setMainTab('track')" class="btn btnS flex-1">
        <i class="fa-solid fa-route"></i> Ù…ØªØ§Ø¨Ø¹Ø©
      </button>
      <button id="navDiscover" onclick="setMainTab('discover')" class="btn btnS flex-1">
        <i class="fa-solid fa-compass"></i> Ø§Ù„Ù…Ø²ÙŠØ¯
      </button>
    </div>
  </div>

  <script>
/* ================== CONFIG ================== */
Pi.init({ version: "2.0", sandbox: false });

const SUPABASE_URL = 'https://axjkwrssmofzavaoqutq.supabase.co';
const SUPABASE_KEY = 'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================== FEES ================== */
const DELIVERY_FEE_EGP = 20;
const PLATFORM_FEE_EGP = 10;

/* ================== GLOBALS ================== */
let PI_USER = null;
let PI_USERNAME = null;
let PI_UID = null;
let ACTIVE_ORDER = null;
let CUSTOMER_LOCATION = null;
let DELIVERY_LOCATION = null;
let HAS_LOCATION_COLUMNS = true;
let ACTIVE_ROLE = 'customer';
let ACTIVE_MAIN_TAB = 'home';
let ACTIVE_RATING = 0;

/* ================== RATES ================== */
let PI_USDT = 0;     // 1 PI in USDT
let USD_EGP = 0;     // 1 USD in EGP

/* ================== DETECT ================== */
function detectPi() {
  const hasPi = typeof window.Pi !== 'undefined';
  const ua = (navigator.userAgent || '').toLowerCase();
  const isPiBrowser = ua.includes('pibrowser') || hasPi;

  document.getElementById('piStateText').innerText = hasPi ? 'SDK Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ¬Ø§Ù‡Ø²' : 'SDK ØºÙŠØ± Ù…ØªØ§Ø­';
  document.getElementById('piTag').innerText = isPiBrowser ? 'Pi Browser' : 'Web';
}

document.addEventListener('DOMContentLoaded', () => {
  detectPi();
  initRatingStars();
  refreshRates();
  setInterval(fetchPiFromOKX, 30000);
  setInterval(fetchUsdEgp, 60000);
});

/* ================== RATES ================== */
async function refreshRates(){
  await Promise.allSettled([fetchPiFromOKX(), fetchUsdEgp()]);
  recalcInvoice();
}

async function fetchPiFromOKX(){
  try{
    const r = await fetch("https://www.okx.com/api/v5/market/ticker?instId=PI-USDT", { cache: "no-store" });
    const j = await r.json();
    const last = parseFloat(j?.data?.[0]?.last || "0");
    if(last > 0) PI_USDT = last;

    document.getElementById('piUsdt').innerText = PI_USDT ? PI_USDT.toFixed(6) : 'â€”';
    updatePiEgpOne();
  }catch(e){
    console.warn('OKX PI ticker failed:', e);
  }
}

async function fetchUsdEgp(){
  try{
    const r = await fetch("https://open.er-api.com/v6/latest/USD", { cache: "no-store" });
    const j = await r.json();
    const rate = parseFloat(j?.rates?.EGP || "0");
    if(rate > 0) USD_EGP = rate;

    document.getElementById('usdEgp').innerText = USD_EGP ? USD_EGP.toFixed(4) : 'â€”';
    updatePiEgpOne();
  }catch(e){
    console.warn('USD/EGP failed:', e);
    document.getElementById('usdEgp').innerText = 'ÙØ´Ù„';
  }
}

function updatePiEgpOne(){
  const piEgp = (PI_USDT && USD_EGP) ? (PI_USDT * USD_EGP) : 0;
  document.getElementById('piEgpOne').innerText = piEgp ? piEgp.toFixed(3) : 'â€”';
}

function egpToPi(egp){
  const piEgp = PI_USDT * USD_EGP;
  if(!piEgp || piEgp <= 0) return 0;
  return egp / piEgp;
}

/* ================== LOCATION ================== */
function getCurrentLocation(){
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'));
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
      (err) => reject(err),
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  });
}

function buildMapUrl(lat, lng){
  return `https://www.google.com/maps?q=${encodeURIComponent(lat)},${encodeURIComponent(lng)}`;
}

function openMapUrl(url){
  if (!url || url === '#') return false;
  if (window.Pi && typeof Pi.openUrlInSystemBrowser === 'function') {
    Pi.openUrlInSystemBrowser(url);
    return false;
  }
  window.open(url, '_blank', 'noopener,noreferrer');
  return false;
}

async function setCustomerLocation(){
  try{
    const loc = await getCurrentLocation();
    CUSTOMER_LOCATION = loc;
    const status = `ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}`;
    document.getElementById('custLocStatus').innerText = status;
    const link = document.getElementById('custMapLink');
    link.href = buildMapUrl(loc.lat, loc.lng);
    link.classList.remove('hidden');
    link.onclick = () => openMapUrl(link.href);
  }catch(e){
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

async function setDeliveryLocation(){
  try{
    const loc = await getCurrentLocation();
    DELIVERY_LOCATION = loc;
    const status = `ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}`;
    document.getElementById('delLocStatus').innerText = status;
    await loadOrders();
  }catch(e){
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

function distanceKm(a, b){
  if(!a || !b) return null;
  const R = 6371;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const lat1 = a.lat * Math.PI / 180;
  const lat2 = b.lat * Math.PI / 180;
  const sinDLat = Math.sin(dLat / 2);
  const sinDLng = Math.sin(dLng / 2);
  const h = sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLng * sinDLng;
  return 2 * R * Math.asin(Math.sqrt(h));
}

function hasMissingLocationColumn(error){
  const msg = String(error?.message || '').toLowerCase();
  return msg.includes('customer_lat') || msg.includes('customer_lng') || msg.includes('customer_address');
}

/* ================== LOGIN ================== */
async function piLogin() {
  try {
    if (!window.Pi || !Pi.authenticate) {
      return Swal.fire({ icon: 'warning', title: 'Pi SDK ØºÙŠØ± Ù…ØªØ§Ø­', text: 'Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Pi Browser.' });
    }

    const ua = (navigator.userAgent || '').toLowerCase();
    if (!ua.includes('pibrowser')) {
      const r = await Swal.fire({
        icon: 'info',
        title: 'Ù…Ù„Ø§Ø­Ø¸Ø©',
        text: 'Ø§Ù„Ø£ÙØ¶Ù„ ØªÙØªØ­ Ø¯Ø§Ø®Ù„ Pi Browser Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯ÙØ¹ ÙŠØ´ØªØºÙ„ 100%.',
        showCancelButton: true,
        confirmButtonText: 'ÙƒÙ…Ù‘Ù„',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
      });
      if (!r.isConfirmed) return;
    }

    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    const scopes = ['username', 'payments'];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);

    const username = auth?.user?.username || auth?.username || null;
    const uid = auth?.user?.uid || auth?.user?.id || auth?.uid || null;
    if (!username) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… username Ù…Ù† Pi');

    PI_USER = auth;
    PI_USERNAME = username;
    PI_UID = uid || username;

    document.getElementById('custName').innerText = PI_USERNAME;
    document.getElementById('delName').innerText = PI_USERNAME;

    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('bottomNav').classList.remove('hidden');
    document.getElementById('roleToggle').classList.remove('hidden');

    // Ø²Ø± Admin ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø£Ø¯Ù…Ù†
    if (PI_USERNAME === 'medomohamed22') {
      document.getElementById('adminLink').classList.remove('hidden');
    } else {
      document.getElementById('adminLink').classList.add('hidden');
    }

    setMainTab('home');
    setRole('customer');

    await refreshRates();
    await restoreActiveOrder();
    loadOrders();
    loadWalletPi();
    loadCustomerHistory();
    loadDeliveryHistory();
    loadWithdrawHistory();

    Swal.close();

  } catch (e) {
    console.error('piLogin error:', e);
    Swal.fire({ icon: 'error', title: 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

function devLogin(){
  PI_USERNAME = 'dev_user_' + Math.floor(Math.random()*9999);
  PI_UID = PI_USERNAME;

  document.getElementById('custName').innerText = PI_USERNAME;
  document.getElementById('delName').innerText = PI_USERNAME;

  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('bottomNav').classList.remove('hidden');
  document.getElementById('roleToggle').classList.remove('hidden');

  document.getElementById('adminLink').classList.add('hidden');

  setMainTab('home');
  setRole('customer');

  restoreActiveOrder();
  refreshRates();
  loadOrders();
  loadWalletPi();
  loadCustomerHistory();
  loadDeliveryHistory();
  loadWithdrawHistory();
}

function onIncompletePaymentFound(payment) {
  console.log('incomplete payment found:', payment);
}

/* ================== RESTORE ACTIVE ORDER ================== */
function activeOrderStorageKey(){
  return PI_USERNAME ? `qc_active_order_${PI_USERNAME}` : 'qc_active_order';
}

function setActiveOrderId(orderId){
  ACTIVE_ORDER = orderId;
  if (orderId) {
    localStorage.setItem(activeOrderStorageKey(), orderId);
  } else {
    localStorage.removeItem(activeOrderStorageKey());
  }
}

async function restoreActiveOrder(){
  if(!PI_USERNAME) return;

  const storedId = localStorage.getItem(activeOrderStorageKey());

  const customerOrder = await findActiveOrderForCustomer(storedId);
  if (customerOrder) {
    setActiveOrderId(customerOrder.id);
    setRole('customer');
    setMainTab('track');
    await applyCustomerOrderState(customerOrder);
    listenStatus();
    startChat();
    return;
  }

  const deliveryOrder = await findActiveOrderForDelivery(storedId);
  if (deliveryOrder) {
    setActiveOrderId(deliveryOrder.id);
    setRole('delivery');
    setMainTab('track');
    await loadOrderDetailsForDelivery(deliveryOrder.id);
    document.getElementById('delChat').classList.remove('hidden');
    startChat();
    markSeen('delivery');
    listenDeliveryStatus();
    return;
  }

  setActiveOrderId(null);
  setRole('customer');
  setMainTab('home');
}

async function findActiveOrderForCustomer(orderId){
  const activeStatuses = ['pending', 'accepted', 'shipping', 'arrived', 'delivered'];

  if (orderId) {
    const { data } = await db.from('orders')
      .select('id,product_name,status,customer_address,customer_lat,customer_lng,otp_code')
      .eq('id', orderId)
      .eq('customer_pi_username', PI_USERNAME)
      .single();
    if (data && activeStatuses.includes(data.status)) return data;
  }

  const { data } = await db.from('orders')
    .select('id,product_name,status,customer_address,customer_lat,customer_lng,otp_code')
    .eq('customer_pi_username', PI_USERNAME)
    .in('status', activeStatuses)
    .order('created_at', { ascending: false })
    .limit(1);

  return data?.[0] || null;
}

async function findActiveOrderForDelivery(orderId){
  const activeStatuses = ['accepted', 'shipping', 'arrived'];

  if (orderId) {
    const { data } = await db.from('orders')
      .select('id,status')
      .eq('id', orderId)
      .eq('delivery_id', PI_USERNAME)
      .single();
    if (data && activeStatuses.includes(data.status)) return data;
  }

  const { data } = await db.from('orders')
    .select('id,status')
    .eq('delivery_id', PI_USERNAME)
    .in('status', activeStatuses)
    .order('created_at', { ascending: false })
    .limit(1);

  return data?.[0] || null;
}

async function applyCustomerOrderState(order){
  document.getElementById('custTrack').classList.remove('hidden');
  document.getElementById('custChat').classList.remove('hidden');
  document.getElementById('custStatus').innerText = order.status || 'pending';
  document.getElementById('otp').innerText = order.otp_code || '';
  document.getElementById('otpBox').classList.toggle('hidden', !order.otp_code);
  document.getElementById('custAddressView').innerText = order.customer_address || 'â€”';
  if (order.status === 'delivered') {
    document.getElementById('custTrack').classList.add('hidden');
    document.getElementById('custChat').classList.add('hidden');
    document.getElementById('custRating').classList.remove('hidden');
    setActiveOrderId(null);
    if (statusPollTimer) clearInterval(statusPollTimer);
    await loadRatingState(order);
  } else {
    hideRating();
  }
  const trackLink = document.getElementById('custTrackMapLink');
  if (typeof order.customer_lat === 'number' && typeof order.customer_lng === 'number') {
    trackLink.href = buildMapUrl(order.customer_lat, order.customer_lng);
    trackLink.classList.remove('hidden');
    trackLink.onclick = () => openMapUrl(trackLink.href);
  } else {
    trackLink.classList.add('hidden');
  }
}

function hideRating(){
  document.getElementById('custRating').classList.add('hidden');
  document.getElementById('ratingThanks').classList.add('hidden');
  document.getElementById('ratingSubmit').disabled = false;
  document.getElementById('ratingSubmit').classList.remove('btnS');
  document.getElementById('ratingSubmit').classList.add('btnA');
  document.getElementById('ratingNote').value = '';
  document.getElementById('ratingValue').innerText = 'Ø§Ø®ØªØ± ØªÙ‚ÙŠÙŠÙ…Ùƒ.';
  setRating(0);
}

async function refreshCustomerStatus(){
  try{
    if (!PI_USERNAME || !ACTIVE_ORDER) return;
    const { data, error } = await db.from('orders')
      .select('id,product_name,status,customer_address,customer_lat,customer_lng,otp_code,delivery_id')
      .eq('id', ACTIVE_ORDER)
      .eq('customer_pi_username', PI_USERNAME)
      .single();
    if (error) throw error;
    if (data) {
      await applyCustomerOrderState(data);
    }
  }catch(e){
    console.warn('refreshCustomerStatus failed', e);
  }
}

function setRating(value){
  ACTIVE_RATING = value;
  const stars = document.querySelectorAll('#ratingStars .ratingStar');
  stars.forEach((star) => {
    const rating = Number(star.dataset.rating);
    star.classList.toggle('active', rating <= value);
  });
  const label = value ? `ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${value} Ù†Ø¬ÙˆÙ…` : 'Ø§Ø®ØªØ± ØªÙ‚ÙŠÙŠÙ…Ùƒ.';
  document.getElementById('ratingValue').innerText = label;
}

function initRatingStars(){
  const stars = document.querySelectorAll('#ratingStars .ratingStar');
  stars.forEach((star) => {
    star.addEventListener('click', () => {
      const rating = Number(star.dataset.rating);
      setRating(rating);
    });
  });
}

async function loadRatingState(order){
  if (!order?.id || !order?.delivery_id) return;
  document.getElementById('custRating').classList.remove('hidden');
  try {
    const { data, error } = await db.from('delivery_ratings')
      .select('id,rating')
      .eq('order_id', order.id)
      .eq('customer_pi_username', PI_USERNAME)
      .limit(1);
    if (error) throw error;
    if (data && data.length) {
      setRating(Number(data[0].rating) || 0);
      document.getElementById('ratingThanks').classList.remove('hidden');
      const submit = document.getElementById('ratingSubmit');
      submit.disabled = true;
      submit.classList.remove('btnA');
      submit.classList.add('btnS');
      document.getElementById('custTrack').classList.add('hidden');
      document.getElementById('custChat').classList.add('hidden');
      setActiveOrderId(null);
      document.getElementById('custRating').classList.add('hidden');
      if (chatPollTimer) clearInterval(chatPollTimer);
      if (statusPollTimer) clearInterval(statusPollTimer);
    } else {
      document.getElementById('ratingThanks').classList.add('hidden');
      document.getElementById('ratingSubmit').disabled = false;
    }
  } catch (e) {
    console.warn('loadRatingState failed', e);
  }
}

async function submitRating(){
  try{
    if (!ACTIVE_ORDER) return;
    if (!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    if (ACTIVE_RATING < 1) return Swal.fire('Ø§Ø®ØªØ§Ø± ØªÙ‚ÙŠÙŠÙ… Ù…Ù† 1 Ø¥Ù„Ù‰ 5');

    const note = document.getElementById('ratingNote').value.trim();
    const { data: order, error: orderErr } = await db.from('orders')
      .select('delivery_id')
      .eq('id', ACTIVE_ORDER)
      .single();
    if (orderErr) throw orderErr;

    const { error } = await db.from('delivery_ratings').insert([{
      order_id: ACTIVE_ORDER,
      delivery_id: order?.delivery_id || null,
      customer_pi_username: PI_USERNAME,
      rating: ACTIVE_RATING,
      comment: note || null
    }]);
    if (error) throw error;

    document.getElementById('ratingThanks').classList.remove('hidden');
    document.getElementById('ratingSubmit').disabled = true;
    document.getElementById('ratingSubmit').classList.remove('btnA');
    document.getElementById('ratingSubmit').classList.add('btnS');
    Swal.fire({ icon:'success', title:'ØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… âœ…' });
    document.getElementById('custTrack').classList.add('hidden');
    document.getElementById('custChat').classList.add('hidden');
    setActiveOrderId(null);
    document.getElementById('custRating').classList.add('hidden');
    if (chatPollTimer) clearInterval(chatPollTimer);
    if (statusPollTimer) clearInterval(statusPollTimer);
  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

async function rejectCaptain(){
  setRating(1);
  document.getElementById('ratingNote').value = 'Ø±ÙØ¶ Ø§Ù„ÙƒØ§Ø¨ØªÙ†';
  await submitRating();
}

/* ================== INVOICE UI ================== */
function recalcInvoice(){
  const prodEgp = parseFloat(document.getElementById('price').value || "0") || 0;
  const totalEgp = prodEgp + DELIVERY_FEE_EGP + PLATFORM_FEE_EGP;
  const totalPi = egpToPi(totalEgp);

  document.getElementById('invProdEgp').innerText = prodEgp.toFixed(2);
  document.getElementById('invDelFeeEgp').innerText = DELIVERY_FEE_EGP.toFixed(2);
  document.getElementById('invPlatFeeEgp').innerText = PLATFORM_FEE_EGP.toFixed(2);
  document.getElementById('invTotalEgp').innerText = totalEgp.toFixed(2);
  document.getElementById('invTotalPi').innerText = totalPi ? totalPi.toFixed(6) : '0.000000';
}

/* ================== CUSTOMER: PAY + CREATE ORDER ================== */
async function payAndCreate() {
  try {
    if (!PI_USERNAME) return Swal.fire('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„');

    const product = document.getElementById('prod').value.trim();
    const orderType = document.getElementById('orderType').value;
    const notes = document.getElementById('notes').value.trim();
    const address = document.getElementById('custAddress').value.trim();
    const prodEgp = parseFloat(document.getElementById('price').value || "0") || 0;

    if (!product || prodEgp <= 0) return Swal.fire('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ³Ø¹Ø± ØµØ­ÙŠØ­');
    if (!address) return Swal.fire('Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„');
    if (!CUSTOMER_LOCATION) return Swal.fire('Ù…Ù† ÙØ¶Ù„Ùƒ Ø­Ø¯Ù‘Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø£ÙˆÙ„Ø§Ù‹');

    if (!(PI_USDT > 0 && USD_EGP > 0)) {
      await refreshRates();
      if (!(PI_USDT > 0 && USD_EGP > 0)) return Swal.fire('Ù…Ù‚Ø¯Ø±Ù†Ø§Ø´ Ù†Ø¬ÙŠØ¨ USD/EGP Ø¯Ù„ÙˆÙ‚ØªÙŠØŒ Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ');
    }

    const totalEgp = prodEgp + DELIVERY_FEE_EGP + PLATFORM_FEE_EGP;
    const totalPi = egpToPi(totalEgp);
    const amountPi = Number(totalPi || 0).toFixed(6);

    const otp = String(Math.floor(1000 + Math.random() * 9000));

    const confirm = await Swal.fire({
      title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹',
      html: `
        <div style="text-align:right">
          <div>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬: <b>${prodEgp.toFixed(2)} Ø¬</b></div>
          <div>Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„: <b>${DELIVERY_FEE_EGP.toFixed(2)} Ø¬</b></div>
          <div>Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ÙˆÙ‚Ø¹: <b>${PLATFORM_FEE_EGP.toFixed(2)} Ø¬</b></div>
          <hr/>
          <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <b style="color:#16a34a">${totalEgp.toFixed(2)} Ø¬</b></div>
          <div>ÙŠØ¹Ø§Ø¯Ù„ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§: <b style="color:#7c3aed">${amountPi} Pi</b></div>
          <div style="font-size:12px;opacity:.75;margin-top:6px">
            (1 Pi â‰ˆ ${(PI_USDT*USD_EGP).toFixed(3)} Ø¬)
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Ø§Ø¯ÙØ¹',
      cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    if (!confirm.isConfirmed) return;

    if (!window.Pi || !Pi.createPayment) {
      return Swal.fire('Pi Payment ØºÙŠØ± Ù…ØªØ§Ø­.. Ø§ÙØªØ­ Ø¯Ø§Ø®Ù„ Pi Browser');
    }

    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯ÙØ¹...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    const paymentResult = await new Promise((resolve, reject) => {
      Pi.createPayment({
        amount: amountPi,
        memo: `QuickCart | ${product} | Total ${totalEgp.toFixed(2)} EGP`,
        metadata: {
          product, orderType, prodEgp,
          deliveryFee: DELIVERY_FEE_EGP,
          platformFee: PLATFORM_FEE_EGP,
          totalEgp,
          pi_usdt: PI_USDT,
          usd_egp: USD_EGP
        }
      }, {
        onReadyForServerApproval: async (paymentId) => {
          await fetch('/api/pi/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId })
          });
        },
        onReadyForServerCompletion: async (paymentId, txid) => {
          await fetch('/api/pi/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId, txid })
          });
          resolve({ paymentId, txid });
        },
        onCancel: (paymentId) => reject(new Error('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹')),
        onError: (err) => reject(err || new Error('ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹'))
      });
    });

    // Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¯ÙØ¹: Ù†ÙƒØªØ¨ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ DB
    const deliveryFeePi = egpToPi(DELIVERY_FEE_EGP);
    const platformFeePi = egpToPi(PLATFORM_FEE_EGP);

    const basePayload = {
      product_name: product,
      order_type: orderType,
      notes: notes || null,

      price: prodEgp,
      delivery_fee: DELIVERY_FEE_EGP,
      platform_fee: PLATFORM_FEE_EGP,

      total_price: totalEgp,
      status: 'pending',
      otp_code: otp,
      customer_pi_username: PI_USERNAME,
      can_modify_until: new Date(Date.now() + 60_000).toISOString(),

      pricing_snapshot: {
        pi_usdt: PI_USDT,
        usd_egp: USD_EGP,
        pi_egp: (PI_USDT * USD_EGP),
        total_pi: Number(amountPi),

        delivery_fee_pi: deliveryFeePi ? Number(deliveryFeePi.toFixed(6)) : 0,
        platform_fee_pi: platformFeePi ? Number(platformFeePi.toFixed(6)) : 0
      },
      payment_id: paymentResult?.paymentId || null,
      payment_txid: paymentResult?.txid || null
    };

    const payloadWithLocation = {
      ...basePayload,
      customer_address: address,
      customer_lat: CUSTOMER_LOCATION?.lat ?? null,
      customer_lng: CUSTOMER_LOCATION?.lng ?? null
    };

    let insertResult = await db.from('orders').insert([payloadWithLocation]).select();
    if (insertResult.error && hasMissingLocationColumn(insertResult.error)) {
      HAS_LOCATION_COLUMNS = false;
      basePayload.pricing_snapshot = {
        ...basePayload.pricing_snapshot,
        customer_location: {
          address,
          lat: CUSTOMER_LOCATION?.lat ?? null,
          lng: CUSTOMER_LOCATION?.lng ?? null
        }
      };
      insertResult = await db.from('orders').insert([basePayload]).select();
    }

    const { data, error } = insertResult;

    if (error) throw error;

    setActiveOrderId(data?.[0]?.id || null);
    setMainTab('track');

    document.getElementById('custTrack').classList.remove('hidden');
    document.getElementById('custChat').classList.remove('hidden');
    document.getElementById('custStatus').innerText = 'pending';
    document.getElementById('otp').innerText = otp;
    document.getElementById('otpBox').classList.remove('hidden');
    document.getElementById('custAddressView').innerText = address;
    const trackLink = document.getElementById('custTrackMapLink');
    trackLink.href = buildMapUrl(CUSTOMER_LOCATION.lat, CUSTOMER_LOCATION.lng);
    trackLink.classList.remove('hidden');
    trackLink.onclick = () => openMapUrl(trackLink.href);

    Swal.close();

    listenStatus();
    startChat();
    loadCustomerHistory();

  } catch (e) {
    console.error(e);
    Swal.fire({ icon: 'error', title: 'ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

/* ================== DELIVERY: LOAD + ACCEPT (RPC Lock) ================== */
async function loadOrders(){
  try{
    const box = document.getElementById('ordersBox');
    box.innerHTML = `<div class="glass p-4 text-center muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;

    let result = await db.from('orders')
      .select('id,product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,status,created_at,pricing_snapshot,customer_lat,customer_lng,customer_address')
      .eq('status','pending')
      .order('created_at',{ascending:false});

    if (result.error && hasMissingLocationColumn(result.error)) {
      HAS_LOCATION_COLUMNS = false;
      result = await db.from('orders')
        .select('id,product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,status,created_at,pricing_snapshot')
        .eq('status','pending')
        .order('created_at',{ascending:false});
    }

    const { data, error } = result;
    if (error) throw error;

    if (!data?.length) {
      box.innerHTML = `<div class="glass p-4 text-center muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
      return;
    }

    if (!DELIVERY_LOCATION && HAS_LOCATION_COLUMNS) {
      box.innerHTML = `<div class="glass p-4 text-center muted">Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© (5 ÙƒÙ…).</div>`;
      return;
    }

    const filtered = HAS_LOCATION_COLUMNS
      ? data.filter(o => {
          if (typeof o.customer_lat !== 'number' || typeof o.customer_lng !== 'number') return false;
          const dist = distanceKm(
            DELIVERY_LOCATION,
            { lat: o.customer_lat, lng: o.customer_lng }
          );
          return dist !== null && dist <= 5;
        })
      : data;

    if (!filtered.length) {
      box.innerHTML = `<div class="glass p-4 text-center muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù‚Ø±ÙŠØ¨Ø© Ø¶Ù…Ù† 5 ÙƒÙ… Ø§Ù„Ø¢Ù†.</div>`;
      return;
    }

    box.innerHTML = filtered.map(o => {
      const delFee = (o.delivery_fee ?? DELIVERY_FEE_EGP);
      const platFee = (o.platform_fee ?? PLATFORM_FEE_EGP);
      const totalEgp = (o.total_price ?? ((o.price||0)+delFee+platFee));
      const totalPi = egpToPi(totalEgp);
      const dist = HAS_LOCATION_COLUMNS
        ? distanceKm(
            DELIVERY_LOCATION,
            { lat: o.customer_lat, lng: o.customer_lng }
          )
        : null;
      const mapUrl = (HAS_LOCATION_COLUMNS && typeof o.customer_lat === 'number' && typeof o.customer_lng === 'number')
        ? buildMapUrl(o.customer_lat, o.customer_lng)
        : '#';

      return `
      <div class="glass p-4 space-y-2">
        <div class="row">
          <div>
            <b class="text-base">${escapeHtml(o.product_name)}</b>
            <div class="tiny">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
            <div class="tiny">Ù†ÙˆØ¹: <b>${escapeHtml(o.order_type || 'any')}</b></div>
            ${HAS_LOCATION_COLUMNS ? `<div class="tiny">Ø§Ù„Ù…Ø³Ø§ÙØ©: <b>${dist ? dist.toFixed(2) : 'â€”'} ÙƒÙ…</b></div>` : ``}
          </div>
          <div class="text-sm font-extrabold text-emerald-500">${Number(totalEgp).toFixed(2)} Ø¬</div>
        </div>

        <div class="soft p-3 text-sm space-y-1">
          <div class="row"><span class="muted">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</span><b>${Number(o.price||0).toFixed(2)} Ø¬</b></div>
          ${HAS_LOCATION_COLUMNS ? `<div class="row"><span class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</span><b>${escapeHtml(o.customer_address || 'â€”')}</b></div>` : ``}
          ${HAS_LOCATION_COLUMNS ? `<div class="row"><span class="muted">Ø§Ù„Ù…ÙˆÙ‚Ø¹</span><a class="text-purple-600 underline" target="_blank" rel="noopener noreferrer" href="${mapUrl}" onclick="return openMapUrl('${mapUrl}')">ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a></div>` : ``}
          <div class="row"><span class="muted">ØªÙˆØµÙŠÙ„</span><b>${Number(delFee).toFixed(2)} Ø¬</b></div>
          <div class="row"><span class="muted">Ø±Ø³ÙˆÙ… Ù…ÙˆÙ‚Ø¹</span><b>${Number(platFee).toFixed(2)} Ø¬</b></div>
          <div class="border-t border-purple-100 pt-2 row"><span class="font-extrabold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><b class="text-emerald-500">${Number(totalEgp).toFixed(2)} Ø¬</b></div>
          <div class="row"><span class="muted">ÙŠØ¹Ø§Ø¯Ù„ Ø¨Ù€ Pi</span><b class="mono text-purple-600">${totalPi ? totalPi.toFixed(6) : 'â€”'} Pi</b></div>
        </div>

        <button onclick="acceptOrder('${o.id}')" class="btn btnG w-full">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
      </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('ordersBox').innerHTML =
      `<div class="glass p-4 text-center" style="color:#fca5a5">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${escapeHtml(e?.message||'')}</div>`;
  }
}

async function acceptOrder(id){
  try{
    if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ ÙƒØ§Ø¨ØªÙ† Ø§Ù„Ø£ÙˆÙ„');

    Swal.fire({ title:'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø¨ÙˆÙ„...', didOpen:()=>Swal.showLoading(), allowOutsideClick:false });

    const { error } = await db.rpc('accept_order_once', {
      p_order_id: id,
      p_delivery_id: PI_USERNAME
    });

    if (error) throw error;

    setActiveOrderId(id);
    setMainTab('track');
    await loadOrderDetailsForDelivery(id);

    document.getElementById('delChat').classList.remove('hidden');
    Swal.close();

    startChat();
    markSeen('delivery');
    listenDeliveryStatus();
    loadDeliveryHistory();

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

async function loadOrderDetailsForDelivery(orderId){
  let result = await db.from('orders')
    .select('product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,customer_address,customer_lat,customer_lng,status')
    .eq('id', orderId)
    .single();

  if(result.error && hasMissingLocationColumn(result.error)) {
    HAS_LOCATION_COLUMNS = false;
    result = await db.from('orders')
      .select('product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,status')
      .eq('id', orderId)
      .single();
  }

  const { data, error } = result;
  if(error){ console.warn(error); return; }

  const delFee = (data.delivery_fee ?? DELIVERY_FEE_EGP);
  const platFee = (data.platform_fee ?? PLATFORM_FEE_EGP);
  const totalEgp = (data.total_price ?? ((data.price||0)+delFee+platFee));
  const totalPi = egpToPi(totalEgp);

  document.getElementById('dStatus').innerText = data.status || 'pending';
  document.getElementById('dProd').innerText = data.product_name || 'â€”';
  document.getElementById('dType').innerText = data.order_type || 'any';
  document.getElementById('dProdEgp').innerText = Number(data.price||0).toFixed(2);
  const mapLink = document.getElementById('dMapLink');
  if (HAS_LOCATION_COLUMNS && data.customer_address) {
    document.getElementById('dAddress').innerText = data.customer_address;
  } else {
    document.getElementById('dAddress').innerText = 'â€”';
  }
  if (HAS_LOCATION_COLUMNS && typeof data.customer_lat === 'number' && typeof data.customer_lng === 'number') {
    mapLink.href = buildMapUrl(data.customer_lat, data.customer_lng);
    mapLink.classList.remove('hidden');
    mapLink.onclick = () => openMapUrl(mapLink.href);
  } else {
    mapLink.href = '#';
    mapLink.classList.add('hidden');
  }
  document.getElementById('dDelFeeEgp').innerText = Number(delFee).toFixed(2);
  document.getElementById('dPlatFeeEgp').innerText = Number(platFee).toFixed(2);
  document.getElementById('dTotalEgp').innerText = Number(totalEgp).toFixed(2);
  document.getElementById('dTotalPi').innerText = totalPi ? totalPi.toFixed(6) : 'â€”';
  document.getElementById('dNotes').innerText = data.notes ? data.notes : 'â€”';
}

/* ================== CHAT: text + image + seen ================== */
let chatChannel = null;
let chatPollTimer = null;

function startChat(){
  if(!ACTIVE_ORDER) return;

  if (chatChannel) {
    try { db.removeChannel(chatChannel); } catch {}
    chatChannel = null;
  }

  loadMessages();
  if (chatPollTimer) clearInterval(chatPollTimer);
  chatPollTimer = setInterval(loadMessages, 8000);

  chatChannel = db.channel('chat-room-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'chat_messages',
      filter: `order_id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      appendMsg(payload.new);
      markSeen(currentRole());
    })
    .subscribe();
}

async function loadMessages(){
  const { data, error } = await db.from('chat_messages')
    .select('*')
    .eq('order_id', ACTIVE_ORDER)
    .order('created_at', { ascending: true });

  if(error){ console.error(error); return; }

  document.getElementById('chatC').innerHTML = '';
  document.getElementById('chatD').innerHTML = '';
  (data||[]).forEach(appendMsg);

  markSeen(currentRole());
}

function currentRole(){
  return ACTIVE_ROLE;
}

async function uploadChatImage(file){
  // Bucket: chat
  const path = `chat/${ACTIVE_ORDER}/${Date.now()}_${file.name}`;
  const up = await db.storage.from('chat').upload(path, file, { upsert: false });
  if (up.error) throw up.error;
  return db.storage.from('chat').getPublicUrl(path).data.publicUrl;
}

async function sendMsg(sender){
  try{
    if(!ACTIVE_ORDER) return Swal.fire('Ù…ÙÙŠØ´ Ø·Ù„Ø¨ Ù†Ø´Ø·');

    const input = sender === 'customer' ? document.getElementById('msgC') : document.getElementById('msgD');
    const fileEl = sender === 'customer' ? document.getElementById('imgC') : document.getElementById('imgD');

    const text = (input.value || '').trim();
    const file = fileEl.files?.[0];

    if(!text && !file) return;

    let image_url = null;
    if(file){
      try{
        image_url = await uploadChatImage(file);
      }catch(e){
        console.warn("Image upload failed:", e);
        image_url = null; // fallback Ø¨Ø¯ÙˆÙ† ÙØ´Ù„
      }
    }

    const { error } = await db.from('chat_messages').insert([{
      order_id: ACTIVE_ORDER,
      sender,
      message_text: text || null,
      image_url,
      seen_at: null
    }]);
    if(error) throw error;

    input.value = '';
    fileEl.value = '';

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

function quick(role, txt){
  if(role==='customer') document.getElementById('msgC').value = txt;
  else document.getElementById('msgD').value = txt;
}

function appendMsg(m){
  const bubble = `
    <div class="msg ${m.sender==='customer'?'c':'d'}">
      ${m.message_text ? escapeHtml(m.message_text) : ''}
      ${m.image_url ? `<img src="${m.image_url}" class="mt-2 rounded-xl border border-purple-100" />` : ''}
      <div class="mt-1 tiny">${m.seen_at ? 'âœ…âœ…' : 'âœ…'}</div>
    </div>
  `;
  document.getElementById('chatC').insertAdjacentHTML('beforeend', bubble);
  document.getElementById('chatD').insertAdjacentHTML('beforeend', bubble);

  document.getElementById('chatC').scrollTop = document.getElementById('chatC').scrollHeight;
  document.getElementById('chatD').scrollTop = document.getElementById('chatD').scrollHeight;
}

async function markSeen(viewerRole){
  try{
    if(!ACTIVE_ORDER) return;
    await db.from('chat_messages')
      .update({ seen_at: new Date().toISOString() })
      .eq('order_id', ACTIVE_ORDER)
      .neq('sender', viewerRole)
      .is('seen_at', null);
  }catch(e){
    console.warn('markSeen failed:', e);
  }
}

/* ================== STATUS ================== */
let statusChannel = null;
let deliveryStatusChannel = null;
let statusPollTimer = null;

function listenStatus(){
  if(!ACTIVE_ORDER) return;

  if (statusChannel) {
    try { db.removeChannel(statusChannel); } catch {}
    statusChannel = null;
  }

  if (statusPollTimer) clearInterval(statusPollTimer);
  refreshCustomerStatus();
  statusPollTimer = setInterval(refreshCustomerStatus, 1000);

  statusChannel = db.channel('order-status-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'UPDATE', schema:'public', table:'orders',
      filter: `id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      const s = payload.new.status;
      document.getElementById('custStatus').innerText = s;

      if(['accepted','shipping','arrived','delivered'].includes(s)){
        document.getElementById('custChat').classList.remove('hidden');
      }

      if(s === 'delivered'){
        Swal.fire({
          icon:'success',
          title:'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…',
          text:'Ù‚ÙŠÙ‘Ù… ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ù† 1 Ø¥Ù„Ù‰ 5 Ù†Ø¬ÙˆÙ….',
          confirmButtonText:'Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø¢Ù†'
        });
        loadCustomerHistory();
        document.getElementById('custChat').classList.add('hidden');
        document.getElementById('custTrack').classList.add('hidden');
        document.getElementById('custRating').classList.remove('hidden');
        setActiveOrderId(null);
        loadRatingState(payload.new);
        if (statusChannel) {
          try { db.removeChannel(statusChannel); } catch {}
          statusChannel = null;
        }
        if (chatChannel) {
          try { db.removeChannel(chatChannel); } catch {}
          chatChannel = null;
        }
        if (chatPollTimer) clearInterval(chatPollTimer);
        if (statusPollTimer) clearInterval(statusPollTimer);
      }
    }).subscribe();
}

function listenDeliveryStatus(){
  if(!ACTIVE_ORDER) return;

  if (deliveryStatusChannel) {
    try { db.removeChannel(deliveryStatusChannel); } catch {}
    deliveryStatusChannel = null;
  }

  deliveryStatusChannel = db.channel('delivery-status-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'UPDATE', schema:'public', table:'orders',
      filter: `id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      const s = payload.new.status || 'pending';
      const statusEl = document.getElementById('dStatus');
      if (statusEl) statusEl.innerText = s;

      if (s === 'delivered') {
        document.getElementById('delChat').classList.add('hidden');
        setActiveOrderId(null);
        loadOrders();
        loadWalletPi();
        loadDeliveryHistory();
        if (deliveryStatusChannel) {
          try { db.removeChannel(deliveryStatusChannel); } catch {}
          deliveryStatusChannel = null;
        }
        if (chatChannel) {
          try { db.removeChannel(chatChannel); } catch {}
          chatChannel = null;
        }
        if (chatPollTimer) clearInterval(chatPollTimer);
      }
    }).subscribe();
}

/* ================== DELIVERY STATUS + OTP ================== */
async function setOrderStatus(st){
  if(!ACTIVE_ORDER) return Swal.fire('Ø§Ø®ØªØ± Ø·Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹');
  await db.from('orders').update({ status: st }).eq('id', ACTIVE_ORDER);
}

async function finishWithOtp(){
  try{
    if(!ACTIVE_ORDER) return;
    if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„');

    const { value: code } = await Swal.fire({
      title: 'ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…',
      input: 'text',
      inputPlaceholder: 'Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„',
      showCancelButton: true,
      confirmButtonText: 'ØªØ£ÙƒÙŠØ¯',
      cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    if(!code) return;

    const { error } = await db.rpc('complete_delivery', {
      p_order_id: ACTIVE_ORDER,
      p_otp: String(code).trim(),
      p_delivery_id: PI_USERNAME
    });

    if(error) throw error;

    Swal.fire({ icon:'success', title:'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…' });
    await loadWalletPi();
    await loadDeliveryHistory();
    await loadOrders();
    document.getElementById('delChat').classList.add('hidden');
    setActiveOrderId(null);
    if (chatChannel) {
      try { db.removeChannel(chatChannel); } catch {}
      chatChannel = null;
    }
    if (chatPollTimer) clearInterval(chatPollTimer);
    if (statusPollTimer) clearInterval(statusPollTimer);
    if (deliveryStatusChannel) {
      try { db.removeChannel(deliveryStatusChannel); } catch {}
      deliveryStatusChannel = null;
    }

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ…', text: e?.message || 'OTP ØºÙ„Ø· Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­' });
  }
}

/* ================== WALLET (Pi) ================== */
/**
 * âœ… Ø£ÙˆÙ„Ø§Ù‹: delivery_wallet.balance_pi
 * âœ… Ø®ØµÙ… Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø§Øª: withdrawals
 * âœ… fallback: Ø­Ø³Ø§Ø¨ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø¯Ù„ÙŠÙØ±ÙŠ Ù…Ù† orders delivered (total_pi - platform_fee_pi)
 */
function toNum(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

function calcDeliveryEarningsPi(order) {
  const snap = order?.pricing_snapshot || {};
  const totalPi = toNum(snap.total_pi);
  const platformFeePi = toNum(snap.platform_fee_pi);
  
  // Ø§Ù„Ø£ÙØ¶Ù„: snapshot Ù…ÙˆØ¬ÙˆØ¯
  if (totalPi > 0) return Math.max(0, totalPi - platformFeePi);
  
  // fallback (Ù„Ùˆ snapshot Ù†Ø§Ù‚Øµ)
  const priceEgp = toNum(order?.price);
  const deliveryFeeEgp = toNum(order?.delivery_fee);
  const totalPriceEgp = toNum(order?.total_price);
  const platformFeeEgp = toNum(order?.platform_fee);
  
  const baseEgp = (priceEgp || deliveryFeeEgp) ?
    (priceEgp + deliveryFeeEgp) :
    Math.max(0, totalPriceEgp - platformFeeEgp);
  
  const piEgp = toNum(snap.pi_egp);
  if (baseEgp > 0 && piEgp > 0) return baseEgp / piEgp;
  
  return 0;
}

async function getWithdrawnSum() {
  if (!PI_UID) return 0;
  const { data, error } = await db.from('withdrawals')
    .select('amount')
    .eq('pi_user_id', PI_UID)
    .limit(1000);
  
  if (error) throw error;
  
  let sum = 0;
  (data || []).forEach(w => {
    sum += toNum(w.amount);
  });
  return sum;
}

async function loadWalletPi() {
  try {
    if (!PI_USERNAME) return;
    
    // 1) Ø®ØµÙ… Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø§Øª
    const withdrawnSum = await getWithdrawnSum();
    
    // 2) Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† delivery_wallet
    try {
      const { data, error } = await db.from('delivery_wallet')
        .select('balance_pi')
        .eq('delivery_id', PI_USERNAME)
        .maybeSingle();
      
      if (!error && data && typeof data.balance_pi !== 'undefined') {
        const available = Math.max(0, toNum(data.balance_pi) - withdrawnSum);
        document.getElementById('walletPi').innerText = available.toFixed(6);
        return;
      }
    } catch (_) {
      // ØªØ¬Ø§Ù‡Ù„ ÙˆÙƒÙ…Ù‘Ù„ fallback
    }
    
    // 3) fallback: Ù…Ù† orders delivered
    const { data: orders, error: e2 } = await db.from('orders')
      .select('pricing_snapshot,status,delivery_id,price,delivery_fee,total_price,platform_fee')
      .eq('delivery_id', PI_USERNAME)
      .eq('status', 'delivered')
      .limit(1000);
    
    if (e2) throw e2;
    
    let earned = 0;
    (orders || []).forEach(o => {
      earned += calcDeliveryEarningsPi(o);
    });
    
    const available = Math.max(0, earned - withdrawnSum);
    document.getElementById('walletPi').innerText = available.toFixed(6);
    
  } catch (e) {
    console.warn(e);
    document.getElementById('walletPi').innerText = '0.000000';
  }
}

/* ================== WITHDRAW ================== */
/**
 * âœ… Flow Ø§Ù„ØµØ­ÙŠØ­:
 * 1) Call /api/withdraw -> Netlify function (withdraw.js)
 * 2) Ù„Ùˆ Ù†Ø¬Ø­: ÙŠØ¸Ù‡Ø± TX Ù…Ø¨Ø§Ø´Ø±Ø©
 */
async function withdrawPi() {
  try {
    if (!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„');
    if (!PI_UID) return Swal.fire('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ù‡ÙˆÙŠØ© PiØŒ Ø¬Ø±Ù‘Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
    
    const amount = parseFloat(document.getElementById('wdAmountPi').value || "0");
    const walletAddress = (document.getElementById('wdWallet').value || '').trim();
    
    if (!amount || amount <= 0) return Swal.fire('Ø§ÙƒØªØ¨ ÙƒÙ…ÙŠØ© Pi ØµØ­ÙŠØ­Ø©');
    if (!walletAddress || walletAddress.length < 10) return Swal.fire('Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© Pi ØµØ­ÙŠØ­');
    
    const available = parseFloat(document.getElementById('walletPi').innerText || "0") || 0;
    if (amount > available) return Swal.fire('Ø§Ù„Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­');
    
    const ok = await Swal.fire({
      icon: 'question',
      title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨',
      html: `
        <div style="text-align:right">
          <div>Ù‡ØªØ³Ø­Ø¨: <b class="mono">${amount.toFixed(6)} Pi</b></div>
          <div style="margin-top:6px">
            Ø¥Ù„Ù‰:
            <span class="mono" style="font-size:12px;opacity:.85;display:block;word-break:break-all">
              ${escapeHtml(walletAddress)}
            </span>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Ø³Ø­Ø¨ Ø§Ù„Ø¢Ù†',
      cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    if (!ok.isConfirmed) return;
    
    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø¨ÙƒØ©...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
      
    // Call server function (Netlify redirect -> /.netlify/functions/withdraw)
    const res = await fetch('/api/withdraw', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        uid: PI_UID,
        username: PI_USERNAME,
        amount,
        walletAddress
      })
    });
      
    const out = await res.json().catch(() => ({}));
    if (!res.ok || !out?.success) {
      const msg = out?.error || out?.details || 'ÙØ´Ù„ Ø§Ù„Ø³Ø­Ø¨';
      throw new Error(msg);
    }
      
    Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„Ø³Ø­Ø¨ âœ…', text: `TX: ${out.txid}` });
    
    document.getElementById('wdAmountPi').value = '';
    document.getElementById('wdWallet').value = '';
    
    await loadWalletPi();
    await loadWithdrawHistory();
    
  } catch (e) {
    console.error(e);
    Swal.fire({ icon: 'error', title: 'ÙØ´Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

/* ================== WITHDRAW HISTORY ================== */
async function loadWithdrawHistory() {
  try {
    if (!PI_USERNAME) return;
    if (!PI_UID) return;
      
    const box = document.getElementById('wdHistory');
    if (!box) return;
      
    box.innerHTML = `<div class="tiny muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
      
    const { data, error } = await db.from('withdrawals')
      .select('id,amount,wallet_address,created_at,txid')
      .eq('pi_user_id', PI_UID)
      .order('created_at', { ascending: false })
      .limit(50);
    
    if (error) throw error;
    
    if (!data || !data.length) {
      box.innerHTML = `<div class="tiny muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨.</div>`;
      return;
    }
    
    box.innerHTML = data.map(w => `
      <div class="soft p-3 space-y-1">
        <div class="row">
          <b class="mono text-purple-300">${Number(w.amount||0).toFixed(6)} Pi</b>
          <span class="chip chipG">Ù…ÙƒØªÙ…Ù„</span>
        </div>

        <div class="tiny muted break-all">
          <b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b>
          <span class="mono">${escapeHtml(w.wallet_address || '-')}</span>
        </div>

        ${w.txid ? `
          <div class="tiny muted break-all">
            <b>TX:</b>
            <span class="mono">${escapeHtml(w.txid)}</span>
          </div>` : ``}
      </div>
    `).join('');
    
  } catch (e) {
    console.error(e);
    const box = document.getElementById('wdHistory');
    if (box) {
      box.innerHTML = `<div class="tiny" style="color:#fca5a5">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø¨</div>`;
    }
  }
}
/* ================== HISTORY: CUSTOMER + DELIVERY ================== */
async function loadCustomerHistory(){
  try{
    if(!PI_USERNAME) return;
    const box = document.getElementById('custHistory');
    box.innerHTML = `<div class="tiny">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,total_price,status,created_at,pricing_snapshot,delivery_id')
      .eq('customer_pi_username', PI_USERNAME)
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data?.length){
      box.innerHTML = `<div class="tiny">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯.</div>`;
      return;
    }

    const orderIds = data.map(o => o.id);
    let ratingMap = {};
    if (orderIds.length) {
      const { data: ratings } = await db.from('delivery_ratings')
        .select('order_id,rating')
        .in('order_id', orderIds);
      (ratings || []).forEach(r => {
        ratingMap[r.order_id] = r.rating;
      });
    }

    box.innerHTML = data.map(o => {
      const totalEgp = Number(o.total_price||0);
      const totalPi = Number(o?.pricing_snapshot?.total_pi || (egpToPi(totalEgp) || 0));
      const s = o.status || 'pending';
      const rating = ratingMap[o.id];

      const color =
        s==='delivered' ? 'text-emerald-500' :
        s==='canceled' ? 'text-red-400' :
        'text-purple-600';

      return `
        <div class="soft p-3">
          <div class="row">
            <b>${escapeHtml(o.product_name)}</b>
            <span class="chip ${color}">${escapeHtml(s)}</span>
          </div>
          <div class="tiny mt-1">Ù†ÙˆØ¹: <b>${escapeHtml(o.order_type||'any')}</b>${o.delivery_id ? ` | ÙƒØ§Ø¨ØªÙ†: <b>${escapeHtml(o.delivery_id)}</b>` : ``}</div>
          <div class="row mt-1">
            <span class="tiny">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
            <b class="text-emerald-500">${totalEgp.toFixed(2)} Ø¬</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">Ø¨Ø§Ù„Ù€ Pi</span>
            <b class="mono text-purple-600">${Number(totalPi||0).toFixed(6)} Pi</b>
          </div>
          ${typeof rating === 'number' ? `<div class="tiny mt-1">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙƒØ§Ø¨ØªÙ†: <b>${rating}</b> â­</div>` : ``}
          <div class="tiny mt-1">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
        </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('custHistory').innerHTML = `<div class="tiny" style="color:#fca5a5">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>`;
  }
}

async function loadDeliveryHistory(){
  try{
    if(!PI_USERNAME) return;
    const box = document.getElementById('delHistory');
    box.innerHTML = `<div class="tiny">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,total_price,status,created_at,pricing_snapshot,customer_pi_username')
      .eq('delivery_id', PI_USERNAME)
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data?.length){
      box.innerHTML = `<div class="tiny">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¹Ù„ÙŠÙƒ Ø¨Ø¹Ø¯.</div>`;
      const statOrders = document.getElementById('statOrders');
      if (statOrders) statOrders.innerText = '0';
      return;
    }

    const statOrders = document.getElementById('statOrders');
    if (statOrders) statOrders.innerText = String(data.length);

    const orderIds = data.map(o => o.id);
    let ratingMap = {};
    if (orderIds.length) {
      const { data: ratings } = await db.from('delivery_ratings')
        .select('order_id,rating')
        .in('order_id', orderIds);
      (ratings || []).forEach(r => {
        ratingMap[r.order_id] = r.rating;
      });
    }

    const ratingValues = Object.values(ratingMap).filter(v => typeof v === 'number');
    const statRating = document.getElementById('statRating');
    if (statRating) {
      if (ratingValues.length) {
        const avg = ratingValues.reduce((sum, v) => sum + v, 0) / ratingValues.length;
        statRating.innerText = avg.toFixed(1);
      } else {
        statRating.innerText = 'â€”';
      }
    }

    box.innerHTML = data.map(o => {
      const totalEgp = Number(o.total_price||0);
      const totalPi = Number(o?.pricing_snapshot?.total_pi || (egpToPi(totalEgp) || 0));
      const profitPi = Number(o?.pricing_snapshot?.delivery_fee_pi || 0);
      const s = o.status || 'pending';
      const rating = ratingMap[o.id];

      return `
        <div class="soft p-3">
          <div class="row">
            <b>${escapeHtml(o.product_name)}</b>
            <span class="chip">${escapeHtml(s)}</span>
          </div>
          <div class="tiny mt-1">Ø¹Ù…ÙŠÙ„: <b>${escapeHtml(o.customer_pi_username||'â€”')}</b></div>
          <div class="row mt-1">
            <span class="tiny">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
            <b class="text-emerald-500">${totalEgp.toFixed(2)} Ø¬</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">Ø¨Ø§Ù„Ù€ Pi</span>
            <b class="mono text-purple-600">${Number(totalPi||0).toFixed(6)} Pi</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">Ø±Ø¨Ø­Ùƒ</span>
            <b class="mono text-purple-600">${profitPi.toFixed(6)} Pi</b>
          </div>
          ${typeof rating === 'number' ? `<div class="tiny mt-1">ØªÙ‚ÙŠÙŠÙ…Ùƒ: <b>${rating}</b> â­</div>` : ``}
          <div class="tiny mt-1">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
        </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('delHistory').innerHTML = `<div class="tiny" style="color:#fca5a5">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¯Ù„ÙŠÙØ±ÙŠ</div>`;
  }
}

/* ================== UI ================== */
function toggleRole(){
  setRole(ACTIVE_ROLE === 'customer' ? 'delivery' : 'customer');
}

function setRole(role){
  ACTIVE_ROLE = role;
  updateRoleUI();
}

function setMainTab(tab){
  ACTIVE_MAIN_TAB = tab;
  updateMainTabUI();
}

function updateRoleUI(){
  const isCustomer = ACTIVE_ROLE === 'customer';
  document.getElementById('roleToggle').innerText = isCustomer ? 'User' : 'Delivery';
  document.getElementById('customerHome').classList.toggle('hidden', !isCustomer);
  document.getElementById('deliveryHome').classList.toggle('hidden', isCustomer);
  document.getElementById('customerTrackTab').classList.toggle('hidden', !isCustomer);
  document.getElementById('deliveryTrackTab').classList.toggle('hidden', isCustomer);

  if(isCustomer){
    loadCustomerHistory();
  } else {
    loadOrders();
    loadWalletPi();
    loadWithdrawHistory();
    loadDeliveryHistory();
  }
}

function updateMainTabUI(){
  const isHome = ACTIVE_MAIN_TAB === 'home';
  const isTrack = ACTIVE_MAIN_TAB === 'track';
  const isDiscover = ACTIVE_MAIN_TAB === 'discover';
  document.getElementById('homeTab').classList.toggle('hidden', !isHome);
  document.getElementById('trackTab').classList.toggle('hidden', !isTrack);
  document.getElementById('discoverTab').classList.toggle('hidden', !isDiscover);
  document.getElementById('navHome').classList.toggle('btnA', isHome);
  document.getElementById('navHome').classList.toggle('btnS', !isHome);
  document.getElementById('navTrack').classList.toggle('btnA', isTrack);
  document.getElementById('navTrack').classList.toggle('btnS', !isTrack);
  document.getElementById('navDiscover').classList.toggle('btnA', isDiscover);
  document.getElementById('navDiscover').classList.toggle('btnS', !isDiscover);
}

/* ================== HELPERS ================== */
function escapeHtml(str){
  return String(str ?? '').replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}
  </script>
</body>
</html>
