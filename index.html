<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø·Ù„Ø¨Ø§Øª Ø¨Ø±Ùˆ | Ù†Ø³Ø®Ø© Pi</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Pi SDK (Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ Ø£ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ù€ Pi) -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <style>
    body{font-family:Tajawal,system-ui;background:#f3f4f6}
    .msg{max-width:78%;padding:8px 12px;border-radius:16px;font-size:13px;word-break:break-word}
    .c{background:#f97316;color:#fff;align-self:flex-start}
    .d{background:#e5e7eb;color:#111827;align-self:flex-end}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
  </style>
</head>

<body class="pb-24">
  <header class="bg-orange-600 text-white p-4 text-center font-bold">Ø·Ù„Ø¨Ø§Øª Ø¨Ø±Ùˆ ğŸš€</header>

  <div class="max-w-lg mx-auto p-3 space-y-3">

    <!-- Ø­Ø§Ù„Ø© Pi -->
    <div id="piState" class="bg-white p-3 rounded-xl shadow text-sm text-gray-700">
      <div class="flex items-center justify-between">
        <div>
          <b>Ø­Ø§Ù„Ø© Pi:</b>
          <span id="piStateText" class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span>
        </div>
        <span id="piTag" class="chip">â€¦</span>
      </div>
      <div class="mt-2 text-xs text-gray-500">
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø¯ÙØ¹ ÙŠØ´ØªØºÙ„ÙˆØ§ Ø£ÙØ¶Ù„ Ø¯Ø§Ø®Ù„ <b>Pi Browser</b>.
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginBox" class="bg-white p-4 rounded-xl shadow text-center space-y-3">
      <div class="text-gray-700 text-sm">
        Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø­Ø³Ø§Ø¨ Pi Ø¹Ø´Ø§Ù† ØªÙ‚Ø¯Ø± ØªØ·Ù„Ø¨/ØªØ´ØªØºÙ„ Ø¯Ù„ÙŠÙØ±ÙŠ.
      </div>
      <button id="loginBtn" onclick="piLogin()" class="bg-purple-600 text-white p-3 rounded-xl w-full font-bold">
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Pi
      </button>

      <!-- Ø¨Ø¯ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
      <button onclick="devLogin()" class="text-xs text-gray-500 underline">
        Ø¯Ø®ÙˆÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø§Ø±Ø¬ Pi Browser)
      </button>
    </div>

    <!-- TABS -->
    <div id="tabs" class="hidden flex bg-orange-100 rounded-xl overflow-hidden shadow">
      <button onclick="showTab('customer')" class="flex-1 p-3 font-bold bg-white" id="btnC">Ø¹Ù…ÙŠÙ„</button>
      <button onclick="showTab('delivery')" class="flex-1 p-3 font-bold" id="btnD">Ø¯Ù„ÙŠÙØ±ÙŠ</button>
    </div>

    <!-- ================= CUSTOMER ================= -->
    <div id="customer" class="hidden space-y-3">

      <div class="bg-white p-4 rounded-xl shadow space-y-3">
        <div class="text-sm text-gray-700">
          Ø£Ù‡Ù„Ù‹Ø§ <b id="custName">â€”</b>
        </div>

        <input id="prod" class="w-full p-3 border rounded-xl" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
        <input id="price" type="number" class="w-full p-3 border rounded-xl" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡" oninput="calcPi()" />

        <div class="text-sm text-gray-600">
          ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø¯ÙØ¹: <b id="piVal">0</b> Pi
          <span class="text-xs text-gray-400">(Ø³Ø¹Ø± Pi ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡)</span>
        </div>

        <button onclick="payAndCreate()" class="bg-orange-500 text-white w-full p-3 rounded-xl font-bold">
          Ø§Ø¯ÙØ¹ ÙˆØ§Ø·Ù„Ø¨ ğŸš€
        </button>
      </div>

      <div id="custTrack" class="hidden bg-white p-4 rounded-xl shadow space-y-2">
        <b id="custStatus">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„...</b>
        <div id="otpBox" class="hidden text-sm">
          ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…: <b id="otp" class="text-orange-600 text-lg"></b>
        </div>
      </div>

      <div id="custChat" class="hidden bg-white p-3 rounded-xl shadow space-y-2">
        <div class="flex items-center justify-between">
          <b class="text-sm">Ø§Ù„Ø´Ø§Øª</b>
          <div class="flex gap-2">
            <button class="chip" onclick="quick('customer','Ø£Ù†Ø§ ÙÙŠÙ†ØŸ')">Ø£Ù†Ø§ ÙÙŠÙ†ØŸ</button>
            <button class="chip" onclick="quick('customer','Ø¨Ø¯ÙŠÙ„ Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ØŸ')">Ø¨Ø¯ÙŠÙ„ØŸ</button>
          </div>
        </div>

        <div id="chatC" class="flex flex-col gap-2 h-52 overflow-y-auto"></div>

        <div class="flex gap-1 items-center">
          <input id="msgC" class="flex-1 border rounded-xl p-2" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
          <input type="file" id="imgC" accept="image/*" class="text-xs w-28" />
          <button onclick="sendMsg('customer')" class="bg-orange-500 text-white px-4 py-2 rounded-xl">â¤</button>
        </div>
      </div>

    </div>

    <!-- ================= DELIVERY ================= -->
    <div id="delivery" class="hidden space-y-3">

      <div class="bg-white p-4 rounded-xl shadow">
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-700">Ø§Ù„ÙƒØ§Ø¨ØªÙ†: <b id="delName">â€”</b></div>
          <button onclick="loadOrders()" class="chip">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        </div>
      </div>

      <div id="ordersBox" class="space-y-2"></div>

      <div id="delChat" class="hidden bg-white p-3 rounded-xl shadow space-y-2">
        <div class="flex items-center justify-between">
          <b class="text-sm">Ø´Ø§Øª Ø§Ù„Ø·Ù„Ø¨</b>
          <div class="flex gap-2">
            <button class="chip" onclick="quick('delivery','Ø£Ù†Ø§ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚')">ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</button>
            <button class="chip" onclick="quick('delivery','Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ±ØŒ Ø¨Ø¯ÙŠÙ„ØŸ')">ØºÙŠØ± Ù…ØªÙˆÙØ±</button>
          </div>
        </div>

        <div id="chatD" class="flex flex-col gap-2 h-52 overflow-y-auto"></div>

        <div class="flex gap-1 items-center">
          <input id="msgD" class="flex-1 border rounded-xl p-2" placeholder="Ø±Ø³Ø§Ù„Ø©..." />
          <input type="file" id="imgD" accept="image/*" class="text-xs w-28" />
          <button onclick="sendMsg('delivery')" class="bg-blue-600 text-white px-4 py-2 rounded-xl">â¤</button>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button onclick="setStatus('arrived')" class="bg-orange-500 text-white p-3 rounded-xl font-bold">ÙˆØµÙ„Øª</button>
          <button onclick="finishWithOtp()" class="bg-green-600 text-white p-3 rounded-xl font-bold">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
        </div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow space-y-2">
        <b class="text-sm">Ù…Ø­ÙØ¸ØªÙŠ</b>
        <div class="text-sm">Ø§Ù„Ø±ØµÙŠØ¯: <b id="wallet">0</b> Ø¬Ù†ÙŠÙ‡</div>
        <input id="wdAmount" type="number" class="border p-3 rounded-xl w-full" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨" />
        <button onclick="withdraw()" class="bg-purple-600 text-white p-3 rounded-xl w-full font-bold">Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>
      </div>

    </div>

  </div>

<script>
/* ================== SUPABASE ================== */
const SUPABASE_URL = 'https://axjkwrssmofzavaoqutq.supabase.co';
const SUPABASE_KEY = 'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================== GLOBALS ================== */
let PI_USER = null;
let PI_USERNAME = null;
let ACTIVE_ORDER = null;
let PI_USDT = 1; // Ø³Ø¹Ø± Pi Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±/USDT (ØªÙ‚Ø¯ÙŠØ±ÙŠ)

/* ================== PI INIT (Ø¢Ù…Ù†) ================== */
function detectPi() {
  const hasPi = typeof window.Pi !== 'undefined';
  const isPiBrowser = !!(navigator.userAgent || '').toLowerCase().includes('pibrowser') || !!window.Pi;
  const txt = hasPi ? 'SDK Ù…ÙˆØ¬ÙˆØ¯' : 'SDK ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
  document.getElementById('piStateText').innerText = txt;
  document.getElementById('piTag').innerText = isPiBrowser ? 'Pi Browser' : 'Web';
}
document.addEventListener('DOMContentLoaded', () => {
  detectPi();

  // Ø­Ø§ÙˆÙ„ ØªÙ‡ÙŠØ¦Ø© Pi
  try {
    if (window.Pi && Pi.init) {
      // sandbox=false Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ
      Pi.init({ version: "2.0", sandbox: false });
      document.getElementById('piStateText').innerText = 'Ø¬Ø§Ù‡Ø² Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
    }
  } catch (e) {
    console.warn('Pi.init error:', e);
  }
});

/* ================== PI LOGIN (Ù…ÙØµØ­Ù‘Ø­) ================== */
async function piLogin() {
  try {
    if (!window.Pi || !Pi.authenticate) {
      return Swal.fire({
        icon: 'warning',
        title: 'Pi SDK ØºÙŠØ± Ù…ØªØ§Ø­',
        text: 'Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Pi Browser Ø£Ùˆ ØªØ£ÙƒØ¯ Ø¥Ù† sdk.minepi.com Ù…Ø­Ù…Ù‘Ù„.',
      });
    }

    // ØªØ­Ø°ÙŠØ± Ù„Ùˆ Ù…Ø´ Pi Browser
    const ua = (navigator.userAgent || '').toLowerCase();
    const notPiBrowser = !ua.includes('pibrowser');
    if (notPiBrowser) {
      const r = await Swal.fire({
        icon: 'info',
        title: 'Ù…Ø´ Pi Browser',
        text: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø¯ÙØ¹ Ù…Ù…ÙƒÙ† Ù…Ø§ ÙŠØ´ØªØºÙ„ÙˆØ´ ÙÙŠ Chrome. Ø¬Ø±Ù‘Ø¨ Pi Browser Ù„Ù„Ø£ÙØ¶Ù„.',
        showCancelButton: true,
        confirmButtonText: 'ÙƒÙ…Ù‘Ù„',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
      });
      if (!r.isConfirmed) return;
    }

    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    const scopes = ['username', 'payments'];

    // Ù…Ù‡Ù…: onIncompletePaymentFound Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† function
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);

    // Ø¨Ø¹Ø¶ Ø§Ù„Ù†Ø³Ø® Ø¨ØªØ±Ø¬Ø¹ { user: { username } } ÙˆØ¨Ø¹Ø¶Ù‡Ø§ { username }â€¦ ÙÙ‡Ù†Ø³Ù†Ø¯ Ø¨Ø°ÙƒØ§Ø¡
    const username =
      auth?.user?.username ||
      auth?.username ||
      auth?.user?.uid || // fallback (Ù…Ø´ Ø§Ù„Ø£ÙØ¶Ù„)
      null;

    if (!username) {
      console.log('Pi auth raw:', auth);
      throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… username Ù…Ù† Pi. Ø±Ø§Ø¬Ø¹ Console.');
    }

    PI_USER = auth;
    PI_USERNAME = username;

    // UI
    document.getElementById('custName').innerText = PI_USERNAME;
    document.getElementById('delName').innerText = PI_USERNAME;
    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('tabs').classList.remove('hidden');
    showTab('customer');

    Swal.close();

    // Ø¨Ø¯Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± + Ø§Ù„Ø·Ù„Ø¨Ø§Øª + Ø§Ù„Ù…Ø­ÙØ¸Ø©
    fetchRate();
    setInterval(fetchRate, 30000);
    loadOrders();
    loadWallet();

  } catch (e) {
    console.error('piLogin error:', e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

// Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø§Ø±Ø¬ Pi Browser (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
function devLogin(){
  PI_USERNAME = 'dev_user_' + Math.floor(Math.random()*9999);
  document.getElementById('custName').innerText = PI_USERNAME;
  document.getElementById('delName').innerText = PI_USERNAME;
  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('tabs').classList.remove('hidden');
  showTab('customer');
  fetchRate();
  setInterval(fetchRate, 30000);
  loadOrders();
  loadWallet();
}

function onIncompletePaymentFound(payment) {
  // Ù„Ùˆ Ù„Ù‚ÙŠ Ø¯ÙØ¹ Ù†Ø§Ù‚ØµØŒ ØªÙ‚Ø¯Ø± ØªÙƒÙ…Ù„/ØªØ¹Ø±Ø¶Ù‡ (Ù‡Ù†Ø§ Ø¨Ø³ Ù„ÙˆØ¬)
  console.log('incomplete payment found:', payment);
}

/* ================== PRICE (PI-USDT) ================== */
async function fetchRate() {
  try {
    // ØªØ­Ø¯ÙŠØ« Ø³Ø±ÙŠØ¹ - Ù„Ùˆ CORS Ø­ØµÙ„ØŒ Ø®Ù„ÙŠÙ‡ Ø¹Ø¨Ø± Netlify function proxy Ù„Ø§Ø­Ù‚Ù‹Ø§
    const r = await fetch("https://www.okx.com/api/v5/market/ticker?instId=PI-USDT");
    const j = await r.json();
    const last = parseFloat(j?.data?.[0]?.last || "0");
    if (last > 0) PI_USDT = last;
    calcPi();
  } catch (e) {
    // Ù‡Ù†Ø³ÙƒØª Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØ²Ø¹Ø¬Ø´ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    console.warn('fetchRate failed:', e);
  }
}

function calcPi(){
  const egp = parseFloat(document.getElementById('price').value || "0");
  // Ù‡Ù†Ø§ Ø§Ø­Ù†Ø§ Ø¨Ù†Ù‚Ø³Ù… Ø¬Ù†ÙŠÙ‡ Ø¹Ù„Ù‰ PI_USDT (Ø¯Ù‡ Ù…Ø´ ØªØ­ÙˆÙŠÙ„ Ø­Ù‚ÙŠÙ‚ÙŠ Ø¬Ù†ÙŠÙ‡->USDT)
  // Ø¹Ø´Ø§Ù† ÙŠØ¨Ù‚Ù‰ Ø¯Ù‚ÙŠÙ‚ Ù„Ø§Ø²Ù… ØªØ¬ÙŠØ¨ Ø³Ø¹Ø± USD/EGP Ø£Ùˆ USDT/EGP Ù…Ù† Ù…ØµØ¯Ø± ØªØ§Ù†ÙŠ.
  // Ù„ÙƒÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ: "ØªØ­ÙˆÙŠÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø³Ø¹Ø± Ø§Ù„Ø¨Ø§ÙŠ Ø§Ù„Ù„Ø­Ø¸ÙŠ" Ù‡Ù†Ø³ØªØ®Ø¯Ù… ØªÙ‚Ø¯ÙŠØ± Ø¨Ø³ÙŠØ·.
  const approxPi = PI_USDT > 0 ? (egp / PI_USDT) : 0;
  document.getElementById('piVal').innerText = approxPi.toFixed(3);
}

/* ================== CUSTOMER: PAY + CREATE ORDER ================== */
async function payAndCreate() {
  try {
    if (!PI_USERNAME) return Swal.fire('Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„');
    const product = document.getElementById('prod').value.trim();
    const egpPrice = parseFloat(document.getElementById('price').value || "0");
    if (!product || !egpPrice) return Swal.fire('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ø³Ø¹Ø±');

    // ØªÙ‚Ø¯ÙŠØ± pi
    const amountPi = (PI_USDT > 0 ? (egpPrice / PI_USDT) : 0).toFixed(3);
    if (!window.Pi || !Pi.createPayment) {
      return Swal.fire('Pi Payment ØºÙŠØ± Ù…ØªØ§Ø­.. Ø§ÙØªØ­ Ø¯Ø§Ø®Ù„ Pi Browser');
    }

    // Ø¥Ù†Ø´Ø§Ø¡ OTP
    const otp = String(Math.floor(1000 + Math.random() * 9000));

    Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯ÙØ¹...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    // Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Pi SDK
    const payment = await Pi.createPayment({
      amount: amountPi,
      memo: "Talabat Pro Order",
      metadata: { egp: egpPrice, product }
    }, {
      onReadyForServerApproval: async (paymentId) => {
        await fetch('/api/pi/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paymentId })
        });
      },
      onReadyForServerCompletion: async (paymentId, txid) => {
        await fetch('/api/pi/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paymentId, txid })
        });
      },
      onCancel: (paymentId) => {
        console.log('payment canceled:', paymentId);
      },
      onError: (err, payment) => {
        console.error('payment error:', err, payment);
      }
    });

    console.log('payment result:', payment);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ DB Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ¯ÙÙ‚ (Ù…Ù…ÙƒÙ† ØªØ­Ø· Ø´Ø±Ø· success Ø­Ø³Ø¨ Ø±Ø¬ÙˆØ¹Ùƒ)
    const { data, error } = await db.from('orders').insert([{
      product_name: product,
      price: egpPrice,
      total_price: egpPrice,
      status: 'pending',
      otp_code: otp,
      customer_pi_username: PI_USERNAME,
      can_modify_until: new Date(Date.now() + 60_000).toISOString()
    }]).select();

    if (error) throw error;

    ACTIVE_ORDER = data?.[0]?.id;
    document.getElementById('custTrack').classList.remove('hidden');
    document.getElementById('custChat').classList.remove('hidden');
    document.getElementById('custStatus').innerText = 'pending';
    document.getElementById('otp').innerText = otp;
    document.getElementById('otpBox').classList.remove('hidden');

    Swal.close();

    listenStatus();
    startChat();

  } catch (e) {
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

/* ================== DELIVERY: LOAD + ACCEPT (RPC Lock) ================== */
async function loadOrders(){
  try{
    const box = document.getElementById('ordersBox');
    box.innerHTML = `<div class="text-center text-gray-500 py-4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
    const { data, error } = await db.from('orders')
      .select('id,product_name,total_price,created_at,status')
      .eq('status','pending')
      .order('created_at',{ascending:false});

    if (error) throw error;

    if (!data?.length) {
      box.innerHTML = `<div class="bg-white p-4 rounded-xl shadow text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
      return;
    }

    box.innerHTML = data.map(o => `
      <div class="bg-white p-4 rounded-xl shadow">
        <div class="flex justify-between items-start">
          <div>
            <b class="text-gray-800">${escapeHtml(o.product_name)}</b>
            <div class="text-xs text-gray-400 mt-1">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
          </div>
          <div class="text-sm font-bold text-green-600">${o.total_price || ''} Ø¬</div>
        </div>
        <button onclick="acceptOrder('${o.id}')" class="mt-3 w-full bg-green-600 text-white p-3 rounded-xl font-bold">
          Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
        </button>
      </div>
    `).join('');

  }catch(e){
    console.error(e);
    document.getElementById('ordersBox').innerHTML =
      `<div class="bg-white p-4 rounded-xl shadow text-center text-red-600">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>`;
  }
}

async function acceptOrder(id){
  try{
    if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ ÙƒØ§Ø¨ØªÙ† Ø§Ù„Ø£ÙˆÙ„');

    Swal.fire({ title:'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø¨ÙˆÙ„...', didOpen:()=>Swal.showLoading(), allowOutsideClick:false });

    // Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯Ùƒ RPC: accept_order_once(p_order_id uuid, p_delivery_id text)
    const { data, error } = await db.rpc('accept_order_once', {
      p_order_id: id,
      p_delivery_id: PI_USERNAME
    });

    if (error) throw error;

    ACTIVE_ORDER = id;
    document.getElementById('delChat').classList.remove('hidden');
    Swal.close();

    startChat();
    markSeen('delivery');
    // Ù…Ù…ÙƒÙ† ØªØ­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„Ø© Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

/* ================== CHAT: text + image + seen ================== */
let chatChannel = null;

function startChat(){
  if(!ACTIVE_ORDER) return;

  // Ø§Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù‚Ù†ÙˆØ§Øª
  if (chatChannel) {
    try { db.removeChannel(chatChannel); } catch {}
    chatChannel = null;
  }

  // Ø­Ù…Ù‘Ù„ Ø§Ù„Ø´Ø§Øª
  loadMessages();

  // Ø§Ø´ØªØ±Ø§Ùƒ realtime
  chatChannel = db.channel('chat-room-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'chat_messages',
      filter: `order_id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      appendMsg(payload.new);
      // Seen: Ù„Ùˆ Ø§Ù„Ø·Ø±Ù Ø§Ù„ØªØ§Ù†ÙŠ ÙØ§ØªØ­ Ø§Ù„ØµÙØ­Ø©
      markSeen(currentRole());
    })
    .subscribe();
}

async function loadMessages(){
  const { data, error } = await db.from('chat_messages')
    .select('*')
    .eq('order_id', ACTIVE_ORDER)
    .order('created_at', { ascending: true });

  if(error){ console.error(error); return; }

  // Ø§Ù…Ø³Ø­ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚
  document.getElementById('chatC').innerHTML = '';
  document.getElementById('chatD').innerHTML = '';

  (data||[]).forEach(appendMsg);

  // Ø§Ø¹Ù…Ù„ seen
  markSeen(currentRole());
}

function currentRole(){
  // Ù„Ùˆ Ø§Ù„ØªØ§Ø¨ Ø¯Ù„ÙŠÙØ±ÙŠ Ø¸Ø§Ù‡Ø± ÙŠØ¨Ù‚Ù‰ delivery
  return (!document.getElementById('delivery').classList.contains('hidden')) ? 'delivery' : 'customer';
}

async function uploadChatImage(file){
  // Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯Ùƒ bucket Ø§Ø³Ù…Ù‡ chat ÙˆØ¨ÙˆÙ„ÙŠØ³ØªÙŠ ØªØ³Ù…Ø­ upload
  const path = `chat/${ACTIVE_ORDER}/${Date.now()}_${file.name}`;
  const up = await db.storage.from('chat').upload(path, file, { upsert: false });
  if (up.error) throw up.error;
  return db.storage.from('chat').getPublicUrl(path).data.publicUrl;
}

async function sendMsg(sender){
  try{
    if(!ACTIVE_ORDER) return Swal.fire('Ù…ÙÙŠØ´ Ø·Ù„Ø¨ Ù†Ø´Ø·');
    const input = sender === 'customer' ? document.getElementById('msgC') : document.getElementById('msgD');
    const fileEl = sender === 'customer' ? document.getElementById('imgC') : document.getElementById('imgD');
    const text = (input.value || '').trim();
    const file = fileEl.files?.[0];

    if(!text && !file) return;

    let image_url = null;
    if(file) image_url = await uploadChatImage(file);

    const { error } = await db.from('chat_messages').insert([{
      order_id: ACTIVE_ORDER,
      sender,
      message_text: text || null,
      image_url,
      seen_at: null
    }]);

    if(error) throw error;

    input.value = '';
    fileEl.value = '';

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

function quick(role, txt){
  if(role==='customer') document.getElementById('msgC').value = txt;
  else document.getElementById('msgD').value = txt;
}

function appendMsg(m){
  const bubble = `
    <div class="msg ${m.sender==='customer'?'c':'d'}">
      ${m.message_text ? escapeHtml(m.message_text) : ''}
      ${m.image_url ? `<img src="${m.image_url}" class="mt-2 rounded-xl border" />` : ''}
      ${m.seen_at ? `<div class="mt-1 text-[10px] opacity-70">âœ…âœ…</div>` : `<div class="mt-1 text-[10px] opacity-50">âœ…</div>`}
    </div>
  `;

  document.getElementById('chatC').insertAdjacentHTML('beforeend', bubble);
  document.getElementById('chatD').insertAdjacentHTML('beforeend', bubble);

  document.getElementById('chatC').scrollTop = document.getElementById('chatC').scrollHeight;
  document.getElementById('chatD').scrollTop = document.getElementById('chatD').scrollHeight;
}

async function markSeen(viewerRole){
  try{
    if(!ACTIVE_ORDER) return;
    // Ø§Ø¹ØªØ¨Ø±: Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù„ÙŠ sender != viewerRole Ùˆ seen_at null -> seen_at now
    await db.from('chat_messages')
      .update({ seen_at: new Date().toISOString() })
      .eq('order_id', ACTIVE_ORDER)
      .neq('sender', viewerRole)
      .is('seen_at', null);
  }catch(e){
    console.warn('markSeen failed:', e);
  }
}

/* ================== STATUS: arrived + delivered via RPC OTP ================== */
let statusChannel = null;

function listenStatus(){
  if(!ACTIVE_ORDER) return;

  if (statusChannel) {
    try { db.removeChannel(statusChannel); } catch {}
    statusChannel = null;
  }

  statusChannel = db.channel('order-status-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'UPDATE', schema:'public', table:'orders',
      filter: `id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      const s = payload.new.status;
      document.getElementById('custStatus').innerText = s;

      if(s === 'accepted' || s === 'shipping' || s === 'arrived'){
        document.getElementById('custChat').classList.remove('hidden');
      }
      if(s === 'delivered'){
        Swal.fire({ icon:'success', title:'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…', text:'Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ù„Ø¨Ø§Øª Ø¨Ø±Ùˆ' });
      }
    }).subscribe();
}

async function setStatus(st){
  if(!ACTIVE_ORDER) return;
  await db.from('orders').update({ status: st }).eq('id', ACTIVE_ORDER);
}

async function finishWithOtp(){
  try{
    if(!ACTIVE_ORDER) return;
    if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„');

    const { value: code } = await Swal.fire({
      title: 'ÙƒÙˆØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…',
      input: 'text',
      inputPlaceholder: 'Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„',
      showCancelButton: true,
      confirmButtonText: 'ØªØ£ÙƒÙŠØ¯',
      cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
    });
    if(!code) return;

    // RPC Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Ø¹Ù†Ø¯Ùƒ: complete_delivery(p_order_id, p_otp, p_delivery_id)
    const { error } = await db.rpc('complete_delivery', {
      p_order_id: ACTIVE_ORDER,
      p_otp: String(code).trim(),
      p_delivery_id: PI_USERNAME
    });

    if(error) throw error;

    Swal.fire({ icon:'success', title:'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…' });
    loadWallet();

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ…', text: e?.message || 'OTP ØºÙ„Ø· Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­' });
  }
}

/* ================== WALLET + WITHDRAW ================== */
async function loadWallet(){
  try{
    if(!PI_USERNAME) return;
    const { data } = await db.from('delivery_wallet')
      .select('*')
      .eq('delivery_id', PI_USERNAME)
      .maybeSingle();

    document.getElementById('wallet').innerText = (data?.balance ?? 0);
  }catch(e){
    console.warn(e);
  }
}

async function withdraw(){
  try{
    if(!PI_USERNAME) return Swal.fire('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„');
    const amount = parseFloat(document.getElementById('wdAmount').value || "0");
    if(!amount || amount <= 0) return Swal.fire('Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');

    const { error } = await db.from('withdraw_requests').insert([{
      delivery_id: PI_USERNAME,
      amount,
      status: 'pending'
    }]);

    if(error) throw error;
    Swal.fire({ icon:'success', title:'ØªÙ…', text:'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨' });
    document.getElementById('wdAmount').value = '';
  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ÙØ´Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨', text: e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£' });
  }
}

/* ================== UI ================== */
function showTab(t){
  document.getElementById('customer').classList.add('hidden');
  document.getElementById('delivery').classList.add('hidden');
  document.getElementById('btnC').classList.remove('bg-white');
  document.getElementById('btnD').classList.remove('bg-white');

  if(t==='customer'){
    document.getElementById('customer').classList.remove('hidden');
    document.getElementById('btnC').classList.add('bg-white');
  } else {
    document.getElementById('delivery').classList.remove('hidden');
    document.getElementById('btnD').classList.add('bg-white');
    loadOrders();
  }
}

/* ================== HELPERS ================== */
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}
</script>
</body>
</html>
