<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  <title>QuickCart | Pi App</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-main: #07051a;
      --bg-sec: #0f0a24;
      --primary: #6d28d9;
      --primary-light: #8b5cf6;
      --accent: #22c55e;
      --text: #f3f4f6;
      --text-muted: #9ca3af;
      --card-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.08);
      --nav-height: 70px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--bg-main);
      color: var(--text);
      margin: 0;
      padding-bottom: calc(var(--nav-height) + 20px + env(safe-area-inset-bottom));
      min-height: 100vh;
      overflow-x: hidden;
    }

    .bg-gradient-mesh {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -1;
      background: 
        radial-gradient(circle at 15% 50%, rgba(109, 40, 217, 0.15), transparent 25%),
        radial-gradient(circle at 85% 30%, rgba(34, 197, 94, 0.08), transparent 25%);
    }

    .glass {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
    }

    .glass-header {
      background: rgba(7, 5, 26, 0.85);
      backdrop-filter: blur(15px);
      border-bottom: 1px solid var(--glass-border);
    }

    .btn {
      transition: transform 0.1s, box-shadow 0.2s;
      border-radius: 16px;
      font-weight: 700;
    }
    .btn:active { transform: scale(0.97); }
    
    .input-box {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid var(--glass-border);
      color: white;
      border-radius: 14px;
      padding: 12px 16px;
      width: 100%;
      outline: none;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: rgba(15, 10, 36, 0.95);
      backdrop-filter: blur(15px);
      border-top: 1px solid var(--glass-border);
      height: calc(var(--nav-height) + env(safe-area-inset-bottom));
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-muted);
      font-size: 11px;
      transition: 0.3s;
    }
    .nav-item.active { color: var(--primary-light); }

    .view-section { display: none; opacity: 0; }
    .view-section.active { display: block; opacity: 1; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <div class="bg-gradient-mesh"></div>

  <div id="loginOverlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#07051a] p-6 text-center">
    <h1 class="text-3xl font-black mb-1">QuickCart</h1>
    <p class="text-gray-400 text-sm mb-8">Ø§Ø·Ù„Ø¨ØŒ Ø§Ø¯ÙØ¹ Ø¨Ù€ PiØŒ ÙˆØ§Ø³ØªÙ„Ù….</p>
    <div id="loadingSpinner" class="hidden mb-4 animate-spin w-10 h-10 border-4 border-purple-600 border-t-transparent rounded-full"></div>
    <div id="loginBtns" class="w-full max-w-xs">
      <button onclick="piLogin()" class="btn w-full py-4 bg-gradient-to-r from-purple-700 to-indigo-700 text-white shadow-lg">
        ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Pi
      </button>
    </div>
  </div>

  <header class="fixed top-0 left-0 right-0 h-[60px] glass-header z-40 flex items-center justify-between px-4">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-purple-600 flex items-center justify-center text-white"><i class="fa-solid fa-basket-shopping text-xs"></i></div>
      <div>
        <h1 class="text-sm font-bold leading-tight">QuickCart</h1>
        <div id="headerRate" class="text-[10px] text-emerald-400">1 Pi â‰ˆ Ø¬Ø§Ø±Ù Ø§Ù„Ø­Ø³Ø§Ø¨...</div>
      </div>
    </div>
    <button onclick="switchMode()" id="modeSwitchBtn" class="glass px-3 py-1.5 text-xs font-bold text-purple-300">
      <i class="fa-solid fa-repeat"></i> <span id="modeText">ØªÙˆØµÙŠÙ„</span>
    </button>
  </header>

  <main class="pt-[75px] px-4 pb-4 max-w-md mx-auto relative">
    
    <div id="view-c-home" class="view-section active">
      <div class="glass p-5 mb-5 bg-gradient-to-r from-purple-900/40 to-blue-900/40 border-purple-500/30">
        <h2 class="text-xl font-bold mb-1">Ø£Ù‡Ù„Ø§Ù‹ <span id="cName" class="text-purple-300">...</span> ğŸ‘‹</h2>
        <div class="bg-black/30 px-3 py-1 rounded-lg text-xs w-max mt-2"><i class="fa-solid fa-wallet text-yellow-500 mr-1"></i> <span id="piBalanceDisplay">-- Pi</span></div>
      </div>

      <div class="space-y-4">
        <div class="glass p-4 space-y-3">
          <select id="orderType" class="input-box bg-[#0f0a24]">
            <option value="market">ğŸ›’ Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</option>
            <option value="restaurant">ğŸ” Ù…Ø·Ø¹Ù…</option>
          </select>
          <input id="prod" type="text" placeholder="Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªØ·Ù„Ø¨ØŸ" class="input-box" />
          <div class="flex gap-2">
            <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ù…)" class="input-box w-2/3" oninput="recalcInvoice()" />
            <div class="input-box w-1/3 flex items-center justify-center text-xs text-gray-400" id="livePiPrice">0 Pi</div>
          </div>
          <input id="custAddress" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ø§Ù„ØªÙØµÙŠÙ„" class="input-box" />
          <textarea id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..." class="input-box h-20"></textarea>
        </div>

        <div class="glass p-4 bg-white/5 border border-dashed border-gray-600/50">
          <div class="flex justify-between text-xs mb-1"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¬.Ù…)</span> <span id="invTotalEgp">0</span></div>
          <div class="flex justify-between font-bold text-purple-400"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Pi)</span> <span id="invTotalPi">0.00</span></div>
        </div>

        <button onclick="payAndCreate()" class="btn w-full py-4 bg-emerald-600 text-white shadow-lg">ØªØ£ÙƒÙŠØ¯ ÙˆØ¯ÙØ¹ Ø¹Ø¨Ø± Pi</button>
      </div>
    </div>

    <div id="view-c-orders" class="view-section">
      <h3 class="font-bold text-lg mb-4">Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ù†Ø´Ø·Ø©</h3>
      <div id="activeOrderContainer" class="hidden mb-6 glass p-4 border-l-4 border-yellow-500">
          <h4 class="font-bold" id="trackProdName">--</h4>
          <p class="text-xs text-gray-400" id="trackStatus">Status</p>
          <p class="text-sm font-mono text-purple-400 mt-2" id="trackOtp">OTP: ****</p>
      </div>
      <div id="custHistoryList" class="space-y-3"></div>
    </div>

    <div id="view-d-home" class="view-section">
      <h2 class="font-bold text-xl mb-4">Ø·Ù„Ø¨Ø§Øª Ù…ØªØ§Ø­Ø©</h2>
      <div id="ordersBox" class="space-y-3"></div>
    </div>

    <div id="view-d-wallet" class="view-section">
        <div class="glass p-6 text-center mb-6">
            <div class="text-sm text-gray-400">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù…ØªØ§Ø­</div>
            <div class="text-3xl font-black font-mono text-white"><span id="walletPi">0.00</span> Pi</div>
        </div>
        <div class="glass p-5 space-y-4">
            <input id="wdAmountPi" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Pi)" class="input-box" />
            <input id="wdWallet" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸ØªÙƒ (G...)" class="input-box text-xs" />
            <button onclick="withdrawPi()" class="btn w-full py-3 bg-purple-600 text-white">Ø³Ø­Ø¨ Ø§Ù„Ø¢Ù†</button>
        </div>
    </div>

  </main>

  <nav class="bottom-nav">
    <div id="nav-c-home" class="nav-item active" onclick="switchView('view-c-home')"><i class="fa-solid fa-utensils"></i><span>Ø§Ø·Ù„Ø¨</span></div>
    <div id="nav-c-orders" class="nav-item" onclick="switchView('view-c-orders')"><i class="fa-solid fa-list-check"></i><span>Ø·Ù„Ø¨Ø§ØªÙŠ</span></div>
    <div id="nav-d-home" class="nav-item hidden" onclick="switchView('view-d-home')"><i class="fa-solid fa-basket-shopping"></i><span>Ø§Ù„Ø³ÙˆÙ‚</span></div>
    <div id="nav-d-wallet" class="nav-item hidden" onclick="switchView('view-d-wallet')"><i class="fa-solid fa-wallet"></i><span>Ù…Ø­ÙØ¸ØªÙŠ</span></div>
  </nav>

  <script>
    /* ================== CONFIG ================== */
    Pi.init({ version: "2.0", sandbox: false });
    const SUPABASE_URL = 'https://axjkwrssmofzavaoqutq.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci'; // Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let PI_USER = null;
    let ACTIVE_ROLE = 'customer';
    let PI_USDT = 0, USD_EGP = 0;
    const DELIVERY_FEE = 20, PLATFORM_FEE = 10;

    /* ================== AUTH ================== */
    async function piLogin() {
      try {
        document.getElementById('loadingSpinner').classList.remove('hidden');
        const auth = await Pi.authenticate(['username', 'payments'], onIncompletePayment);
        PI_USER = auth.user;
        document.getElementById('loginOverlay').classList.add('hidden');
        document.getElementById('cName').innerText = PI_USER.username;
        refreshRates();
      } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }

    function onIncompletePayment(payment) { /* Pi Network logic */ }

    /* ================== CORE LOGIC ================== */
    async function refreshRates() {
      try {
        const r1 = await fetch("https://open.er-api.com/v6/latest/USD").then(r=>r.json());
        USD_EGP = r1.rates.EGP;
        const r2 = await fetch("https://www.okx.com/api/v5/market/ticker?instId=PI-USDT").then(r=>r.json());
        PI_USDT = parseFloat(r2.data[0].last);
        const rate = PI_USDT * USD_EGP;
        document.getElementById('headerRate').innerText = `1 Pi â‰ˆ ${rate.toFixed(2)} EGP`;
      } catch(e) {}
    }

    function egpToPi(egp) { return egp / (PI_USDT * USD_EGP || 1); }

    function recalcInvoice() {
      const price = parseFloat(document.getElementById('price').value || 0);
      const total = price + DELIVERY_FEE + PLATFORM_FEE;
      const piVal = egpToPi(total);
      document.getElementById('invTotalEgp').innerText = total.toFixed(2);
      document.getElementById('invTotalPi').innerText = piVal.toFixed(6);
      document.getElementById('livePiPrice').innerText = egpToPi(price).toFixed(4) + ' Pi';
    }

    /* ================== PAYMENT (MAIN UPDATE) ================== */
    async function payAndCreate() {
      const prod = document.getElementById('prod').value;
      const price = parseFloat(document.getElementById('price').value);
      const addr = document.getElementById('custAddress').value;
      if(!prod || !price || !addr) return Swal.fire('Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', '', 'warning');

      const totalEgp = price + DELIVERY_FEE + PLATFORM_FEE;
      const totalPi = egpToPi(totalEgp);

      try {
        await Pi.createPayment({
          amount: parseFloat(totalPi.toFixed(6)),
          memo: `QuickCart: ${prod}`,
          metadata: { 
            username: PI_USER.username, 
            product_name: prod, 
            total_egp: totalEgp,
            address: addr,
            notes: document.getElementById('notes').value,
            lat: 0, lng: 0 // ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ù€ GPS
          },
        }, {
          onReadyForServerApproval: (paymentId) => {
            return fetch('/api/pi/approve', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ paymentId })
            }).then(res => res.json());
          },
          onReadyForServerCompletion: (paymentId, txid) => {
            return fetch('/api/pi/complete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ paymentId, txid })
            }).then(res => res.json());
          },
          onCancel: (pId) => { console.log("Cancelled", pId); },
          onError: (err) => { Swal.fire('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹', err.message, 'error'); }
        });

        Swal.fire('ØªÙ… Ø§Ù„Ø¯ÙØ¹!', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        switchView('view-c-orders');
        loadCustomerActivity();
      } catch (err) { console.error(err); }
    }

    /* ================== UI HELPERS ================== */
    function switchView(viewId) {
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      const navEl = document.getElementById(viewId.replace('view-', 'nav-'));
      if(navEl) navEl.classList.add('active');
    }

    function switchMode() {
      ACTIVE_ROLE = (ACTIVE_ROLE === 'customer') ? 'delivery' : 'customer';
      document.getElementById('modeText').innerText = (ACTIVE_ROLE === 'customer') ? 'ØªÙˆØµÙŠÙ„' : 'Ø¹Ù…ÙŠÙ„';
      
      const cItems = ['nav-c-home', 'nav-c-orders'];
      const dItems = ['nav-d-home', 'nav-d-wallet'];
      cItems.forEach(id => document.getElementById(id).classList.toggle('hidden', ACTIVE_ROLE !== 'customer'));
      dItems.forEach(id => document.getElementById(id).classList.toggle('hidden', ACTIVE_ROLE !== 'delivery'));
      
      switchView(ACTIVE_ROLE === 'customer' ? 'view-c-home' : 'view-d-home');
    }

    async function loadCustomerActivity() {
      const { data } = await db.from('orders').select('*')
        .eq('customer_pi_username', PI_USER.username).order('created_at', {ascending: false});
      
      const box = document.getElementById('custHistoryList');
      box.innerHTML = data.map(o => `
        <div class="glass p-3 flex justify-between items-center opacity-80">
          <div><div class="font-bold text-sm">${o.product_name}</div><div class="text-[10px] text-gray-500">${o.status}</div></div>
          <div class="text-xs font-bold text-emerald-400">${o.total_price} Ø¬</div>
        </div>
      `).join('');
    }

    // Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ù„ÙƒØ§Ø¨ØªÙ†
    async function withdrawPi() {
        const amount = document.getElementById('wdAmountPi').value;
        const wallet = document.getElementById('wdWallet').value;
        if(!amount || !wallet) return;

        const res = await fetch('/.netlify/functions/withdraw', {
            method: 'POST',
            body: JSON.stringify({ uid: PI_USER.username, walletAddress: wallet, amount: amount })
        }).then(r => r.json());

        if(res.success) Swal.fire('Ù†Ø¬Ø§Ø­', 'ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù…Ø­ÙØ¸ØªÙƒ', 'success');
        else Swal.fire('ÙØ´Ù„', res.details, 'error');
    }
  </script>
</body>
</html>
