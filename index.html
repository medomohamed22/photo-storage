<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>QuickCart | ูุงุฌูุฉ Pi (Talabat-style)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase + SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap');

    :root{
      --bg0:#f5f7f8;
      --bg1:#ffffff;
      --bg2:#eef7f2;
      --card:#ffffff;
      --card2:#f6fbf7;
      --stroke:rgba(16,185,129,.15);

      --txt:#0f172a;
      --muted:rgba(15,23,42,.62);
      --p:#10b981;
      --p2:#22c55e;
      --p3:#34d399;

      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#d97706;
      --info:#2563eb;

      --shadow: 0 18px 60px rgba(16,185,129,.12);
      --shadow2: 0 12px 30px rgba(16,185,129,.1);
      --r1:20px;
      --r2:16px;
    }

    *{box-sizing:border-box}
    body{
      font-family:Tajawal,system-ui;
      color:var(--txt);
      min-height:100vh;
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(16,185,129,.18), transparent 60%),
        radial-gradient(900px 520px at 95% 0%, rgba(34,197,94,.16), transparent 60%),
        radial-gradient(900px 520px at 70% 110%, rgba(52,211,153,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 45%, var(--bg2));
    }

    /* Safe area bottom for iOS */
    .safeBottom{ padding-bottom: calc(92px + env(safe-area-inset-bottom)); }

    /* Glass / Cards */
    .glass{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r1);
      box-shadow: var(--shadow);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .glass:hover{
      transform: translateY(-2px);
      box-shadow: 0 20px 60px rgba(16,185,129,.16);
    }
    .soft{
      background: var(--card2);
      border: 1px solid rgba(16,185,129,.12);
      border-radius: var(--r2);
      box-shadow: var(--shadow2);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .soft:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(16,185,129,.14);
    }

    /* Talabat-like top bar */
    .topBar{
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(16,185,129,.12);
    }

    /* Brand badge */
    .brandBadge{
      width: 44px; height: 44px;
      border-radius: 16px;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(18px 18px at 30% 30%, rgba(16,185,129,.35), rgba(34,197,94,.2));
      border:1px solid rgba(16,185,129,.35);
      box-shadow: 0 16px 40px rgba(16,185,129,.2);
    }

    /* Chips */
    .chip{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(16,185,129,.18);
      background: rgba(16,185,129,.08);
      color:var(--txt);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .chip:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(16,185,129,.12); }
    .chipP{ background: rgba(16,185,129,.18); border-color: rgba(16,185,129,.4); }
    .chipB{ background: rgba(15,23,42,.08); border-color: rgba(15,23,42,.14); }
    .chipG{ background: rgba(34,197,94,.15); border-color: rgba(34,197,94,.35); }
    .chipS{ background: rgba(255,255,255,.7); }

    /* Buttons */
    .btn{
      border-radius:18px;
      padding:12px 14px;
      font-weight:900;
      transition:.15s;
      user-select:none;
      border:1px solid rgba(16,185,129,.2);
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 22px rgba(16,185,129,.18); }
    .btn:active{transform:scale(.98)}
    .btnA{
      background: linear-gradient(135deg, rgba(16,185,129,.95), rgba(34,197,94,.85));
      border-color: rgba(16,185,129,.4);
      color:#fff;
      box-shadow: 0 16px 45px rgba(16,185,129,.25);
    }
    .btnP{
      background: linear-gradient(135deg, rgba(22,163,74,.92), rgba(16,185,129,.85));
      border-color: rgba(22,163,74,.4);
      color:#fff;
      box-shadow: 0 16px 45px rgba(16,185,129,.2);
    }
    .btnG{
      background: linear-gradient(135deg, rgba(34,197,94,.92), rgba(22,163,74,.75));
      border-color: rgba(34,197,94,.35);
      color:#fff;
    }
    .btnB{
      background: linear-gradient(135deg, rgba(96,165,250,.92), rgba(37,99,235,.75));
      border-color: rgba(96,165,250,.35);
      color:#fff;
    }
    .btnS{
      background: rgba(255,255,255,.85);
      border-color: rgba(16,185,129,.2);
      color: var(--txt);
    }

    /* Inputs */
    input,textarea,select{
      width: 100%;
      background: rgba(255,255,255,.9) !important;
      border: 1px solid rgba(16,185,129,.18) !important;
      color: var(--txt) !important;
      border-radius: 16px !important;
      outline: none !important;
      transition: .15s;
      padding: 14px 14px !important;
    }
    input::placeholder, textarea::placeholder{
      color: rgba(243,244,246,.55);
    }
    input:focus,textarea:focus,select:focus{
      border-color: rgba(16,185,129,.6) !important;
      box-shadow: 0 0 0 4px rgba(16,185,129,.15);
    }
    textarea{min-height:96px}

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .tiny{font-size:11px;color:rgba(0,0,0,.55)}
    .muted{color:rgba(0,0,0,.6)}

    /* Section Title */
    .secTitle{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .secTitle b{
      font-size:14px;
      letter-spacing:.2px;
    }
    .sectionHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .sectionHeader h3{
      font-size:15px;
      font-weight:800;
    }
    .sectionSub{
      font-size:12px;
      color:var(--muted);
    }
    .pageShell{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .pageSection{
      padding:16px;
    }
    .statsGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .statCard{
      padding:12px;
      border-radius:16px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(16,185,129,.12);
      text-align:center;
    }
    .statCard b{
      display:block;
      font-size:16px;
    }
    .featureGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    .infoCard{
      padding:14px;
      border-radius:16px;
      background: rgba(255,255,255,.9);
      border:1px dashed rgba(16,185,129,.2);
    }
    .listCard{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(16,185,129,.12);
      background: rgba(255,255,255,.9);
    }
    .listIcon{
      width:36px;
      height:36px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(16,185,129,.08);
      border:1px solid rgba(16,185,129,.18);
    }
    .listIcon i{
      color: var(--p);
    }
    .ratingStars{
      display:flex;
      gap:8px;
      justify-content:center;
    }
    .ratingStar{
      width:40px;
      height:40px;
      border-radius:14px;
      border:1px solid rgba(16,185,129,.2);
      background: #fff;
      color: rgba(16,185,129,.6);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .ratingStar:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(16,185,129,.12);
    }
    .ratingStar.active{
      background: rgba(16,185,129,.12);
      color: rgba(16,185,129,1);
      border-color: rgba(16,185,129,.35);
    }

    /* Talabat-like feature cards */
    .miniCard{
      background: var(--card2);
      border: 1px solid rgba(16,185,129,.15);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 25px rgba(16,185,129,.12);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .miniCard:hover{
      transform: translateY(-2px);
      box-shadow: 0 18px 35px rgba(16,185,129,.18);
    }
    .miniIcon{
      width: 40px; height: 40px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(16,185,129,.1);
      border:1px solid rgba(16,185,129,.18);
      box-shadow: 0 12px 28px rgba(16,185,129,.18);
    }
    .miniIcon i{
      color: var(--p);
    }
    .featureGrid .miniCard{
      padding: 16px;
    }
    .featureGrid .miniCard > div{
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    /* Chat bubbles */
    .msg{
      max-width:78%;
      padding:10px 12px;
      border-radius:18px;
      font-size:13px;
      word-break:break-word;
      border:1px solid rgba(16,185,129,.15);
      animation: pop .2s ease-in-out;
    }
    @keyframes pop{
      from{transform:scale(.96);opacity:.5}
      to{transform:scale(1);opacity:1}
    }
    .c{ background: rgba(16,185,129,.18); color: var(--txt); align-self:flex-start; }
    .d{ background: rgba(255,255,255,.9); color: var(--txt); align-self:flex-end; }

    /* Bottom nav - app style */
    .bottomNav{
      position: fixed;
      left: 0; right: 0;
      bottom: calc(12px + env(safe-area-inset-bottom));
      z-index: 50;
      padding: 0 14px;
    }
    .bottomNav .wrap{
      max-width: 480px;
      margin: 0 auto;
      padding: 10px;
      border-radius: 24px;
      background: rgba(255,255,255,.95);
      border:1px solid rgba(16,185,129,.12);
      box-shadow: 0 18px 40px rgba(16,185,129,.18);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:flex;
      gap:10px;
    }

    /* Small tweaks */
    .divider{
      height:1px;
      background: rgba(16,185,129,.12);
      margin: 10px 0;
    }
    a.linkP{ color: rgba(16,185,129,1); text-decoration: underline; }
    /* โ ูููุน ุฃู ุนูุตุฑ ูุทูุน ุจุฑูู ุงููุงุฑุช */
.miniCard, .soft, .glass { overflow: hidden; }

/* โ ุตู ุงูุนููุงู ุฏุงุฎู ุจุทุงูุฉ ุงูุณุญุจ */
.wdRow{
  display:flex;
  align-items:center;
  gap:10px;
  width:100%;
  min-width:0;           /* ููู ููุต ุงููุต */
}

.wdLabel{
  flex:0 0 auto;
  white-space:nowrap;
  opacity:.85;
}

.wdValue{
  flex:1 1 auto;
  min-width:0;           /* ููู */
  overflow:hidden;
  text-overflow:ellipsis;/* โฆ */
  white-space:nowrap;    /* ุณุทุฑ ูุงุญุฏ */
  padding:6px 10px;
  border:1px solid rgba(16,185,129,.15);
  border-radius:12px;
  background: rgba(255,255,255,.9);
}

    /* SweetAlert */
    .swal2-popup{
      background: #ffffff !important;
      color: var(--txt) !important;
      border: 1px solid rgba(16,185,129,.18) !important;
      border-radius: 20px !important;
      box-shadow: 0 18px 40px rgba(16,185,129,.18) !important;
    }
    .swal2-title{
      color: var(--txt) !important;
    }
    .swal2-html-container{
      color: var(--muted) !important;
    }
    .swal2-styled.swal2-confirm{
      background: linear-gradient(135deg, rgba(16,185,129,.95), rgba(34,197,94,.85)) !important;
      border: none !important;
      border-radius: 14px !important;
      box-shadow: 0 12px 25px rgba(16,185,129,.2) !important;
    }
    .swal2-styled.swal2-cancel{
      background: rgba(255,255,255,.9) !important;
      color: var(--txt) !important;
      border: 1px solid rgba(16,185,129,.2) !important;
      border-radius: 14px !important;
      box-shadow: 0 10px 20px rgba(16,185,129,.12) !important;
    }
  </style>
</head>

<body class="safeBottom">
  <!-- HEADER -->
  <header class="sticky top-0 z-50 topBar">
    <div class="px-3 pt-3 pb-3">
      <div class="max-w-lg mx-auto flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="brandBadge">
            <i class="fa-solid fa-basket-shopping text-white"></i>
          </div>
          <div class="leading-tight">
            <div class="font-black text-base">QuickCart</div>
            <div class="tiny -mt-0.5">ุทูุจ ุณุฑูุน โข ุฏูููุฑู ูุฑูุจ ููู</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="roleToggle" onclick="toggleRole()" class="chip chipS hidden">
            <i class="fa-solid fa-user"></i> User
          </button>
          <a id="adminLink" href="./admin.html" class="chip chipP hidden">
            <i class="fa-solid fa-shield-halved"></i> Admin
          </a>
          <span id="piTag" class="chip chipB">
            <i class="fa-brands fa-pied-piper-alt"></i> โฆ
          </span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-lg mx-auto p-3 space-y-3">
    <!-- LOGIN -->
    <div id="loginBox" class="glass p-4 text-center space-y-3">
      <div class="flex items-center justify-center gap-2">
        <span class="miniIcon"><i class="fa-solid fa-right-to-bracket"></i></span>
        <div class="text-right">
          <div class="font-extrabold">ุชุณุฌูู ุงูุฏุฎูู</div>
          <div class="tiny muted">ุงูุชุญ ุฏุงุฎู Pi Browser ุนุดุงู ุงูุฏูุน ูุดุชุบู 100%</div>
        </div>
      </div>

      <button id="loginBtn" onclick="piLogin()" class="btn btnP w-full">
        <i class="fa-brands fa-pied-piper-alt"></i>
        ุชุณุฌูู ุงูุฏุฎูู ุจู Pi
      </button>

      <button onclick="devLogin()" class="text-xs underline muted">
        ุฏุฎูู ุชุฌุฑูุจู (ุงุฎุชุจุงุฑ ุฎุงุฑุฌ Pi Browser)
      </button>
    </div>

<!-- ================= HOME TAB ================= -->
<div id="homeTab" class="pageShell">

      <!-- STATUS + RATES -->
  <section class="glass pageSection space-y-3">
        <div class="secTitle">
          <b><i class="fa-solid fa-signal mr-1"></i> ุงูุญุงูุฉ ูุงูุฃุณุนุงุฑ</b>
          <span class="chip chipS"><i class="fa-regular fa-clock"></i> ุชุญุฏูุซ ุชููุงุฆู</span>
        </div>

        <div class="miniCard">
          <div class="flex items-center justify-between gap-2">
            <div class="text-sm">
              <span class="muted">ุญุงูุฉ Pi:</span>
              <b id="piStateText" class="mr-1">ุฌุงุฑู ุงูุชุญูู...</b>
            </div>
            <span class="chip chipB"><i class="fa-solid fa-globe"></i> <span id="piTag2">Auto</span></span>
          </div>
          <div class="tiny muted mt-2">
            Pi ูู <b>30 ุซุงููุฉ</b> โ USD/EGP ูู <b>60 ุซุงููุฉ</b>. | 1 Pi โ <span class="mono" id="piEgpOne">โ</span> ุฌ
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="miniCard">
            <div class="flex items-center gap-2">
              <span class="miniIcon"><i class="fa-solid fa-coins"></i></span>
              <div>
                <div class="tiny muted">ุณุนุฑ Pi (USDT)</div>
                <div class="font-black mono text-base"><span id="piUsdt">โ</span></div>
                <div class="tiny muted">ูุตุฏุฑ: OKX</div>
              </div>
            </div>
          </div>

          <div class="miniCard">
            <div class="flex items-center gap-2">
              <span class="miniIcon"><i class="fa-solid fa-money-bill-wave"></i></span>
              <div>
                <div class="tiny muted">ุณุนุฑ USD (EGP)</div>
                <div class="font-black mono text-base"><span id="usdEgp">โ</span></div>
                <div class="tiny muted">ูุตุฏุฑ: open.er-api.com</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ================= CUSTOMER (HOME) ================= -->
      <div id="customerHome" class="hidden space-y-3">
    <section class="glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-bag-shopping mr-1"></i> ุทูุจ ุฌุฏูุฏ</b>
            <span class="chip chipP"><i class="fa-solid fa-credit-card"></i> Pi Pay</span>
          </div>

          <div class="miniCard">
            <div class="flex items-center justify-between">
              <div class="text-sm">
                ุฃูููุง <b id="custName">โ</b>
                <div class="tiny muted">ุงุฎุชุงุฑ ููุน ุงูุทูุจ ูุงููุฃ ุจูุงูุงุช ุงูููุชุฌ</div>
              </div>
              <span class="miniIcon"><i class="fa-solid fa-location-dot"></i></span>
            </div>

            <div class="divider"></div>

            <select id="orderType">
              <option value="any">ููุน ุงูุทูุจ: ุฃู ุญุงุฌุฉ</option>
              <option value="market">ุณูุจุฑ ูุงุฑูุช</option>
              <option value="pharmacy">ุตูุฏููุฉ</option>
              <option value="restaurant">ูุทุนู</option>
            </select>

            <div class="grid grid-cols-1 gap-2 mt-2">
              <input id="prod" placeholder="ุงุณู ุงูููุชุฌ" />
              <input id="price" type="number" placeholder="ุณุนุฑ ุงูููุชุฌ ุจุงูุฌููู ุงููุตุฑู" oninput="recalcInvoice()" />
              <input id="custAddress" placeholder="ุงูุนููุงู ุจุงูุชูุตูู" />
            </div>

            <div class="soft p-3 mt-2 space-y-2">
              <div class="flex items-center justify-between">
                <div class="text-sm"><span class="muted">ูููุนู ุงูุญุงูู</span></div>
                <button class="chip chipG" onclick="setCustomerLocation()">
                  <i class="fa-solid fa-crosshairs"></i> ุชุญุฏูุฏ
                </button>
              </div>
              <div id="custLocStatus" class="tiny muted">ูู ูุชู ุชุญุฏูุฏ ุงููููุน ุจุนุฏ.</div>
              <a id="custMapLink" class="tiny linkP hidden" target="_blank" rel="noopener noreferrer" onclick="return openMapUrl(this.href)">
                ูุชุญ ุงููููุน ุนูู Google Maps
              </a>
            </div>

            <textarea id="notes" class="mt-2" placeholder="ููุงุญุธุงุช/ุจุฏุงุฆู (ุงุฎุชูุงุฑู)"></textarea>
          </div>

          <!-- INVOICE -->
          <div class="miniCard space-y-2">
            <div class="secTitle">
              <b><i class="fa-solid fa-receipt mr-1"></i> ุชูุงุตูู ุงูุญุณุงุจ</b>
              <span class="chip chipS">
                <i class="fa-solid fa-truck-fast"></i> ุชูุตูู: <b>20</b>ุฌ
                <span class="mx-1">โข</span>
                <i class="fa-solid fa-store"></i> ูููุน: <b>10</b>ุฌ
              </span>
            </div>

            <div class="text-sm space-y-2">
              <div class="flex items-center justify-between"><span class="muted">ุณุนุฑ ุงูููุชุฌ</span><b><span id="invProdEgp">0</span> ุฌ</b></div>
              <div class="flex items-center justify-between"><span class="muted">ุฑุณูู ุงูุชูุตูู</span><b><span id="invDelFeeEgp">20</span> ุฌ</b></div>
              <div class="flex items-center justify-between"><span class="muted">ุฑุณูู ุงููููุน</span><b><span id="invPlatFeeEgp">10</span> ุฌ</b></div>

              <div class="divider"></div>

              <div class="flex items-center justify-between">
                <span class="font-black">ุงูุฅุฌูุงูู</span>
                <b class="text-emerald-400"><span id="invTotalEgp">0</span> ุฌ</b>
              </div>

              <div class="soft p-3 mt-2">
                <div class="tiny muted">ุงูุชุญููู ุฅูู Pi (ุชูุฑูุจู):</div>
                <div class="flex items-center justify-between mt-1">
                  <span class="muted text-sm">ุงูุฅุฌูุงูู ุจู Pi</span>
                  <b class="mono text-emerald-500 text-sm"><span id="invTotalPi">0</span> Pi</b>
                </div>
              </div>
            </div>
          </div>

          <button onclick="payAndCreate()" class="btn btnA w-full">
            <i class="fa-solid fa-bolt"></i>
            ุงุฏูุน ุจู Pi ูุงุทูุจ
          </button>
          <div class="tiny muted text-center">
            ุจุงูุถุบุท ุนูู โุงุฏูุนโ ุฃูุช ุชูุงูู ุนูู ุฅูุดุงุก ุงูุทูุจ ูุงูุจุฏุก ูู ุงูุชูููุฐ.
          </div>
        </section>

        <section class="glass pageSection space-y-3">
          <div class="sectionHeader">
            <div>
              <h3>ุฎุฏูุงุช QuickCart</h3>
              <div class="sectionSub">ุงุฎุชุตุฑ ููุชู ูุน ุฃูุณุงู ูุฎุตุตุฉ ููู ุงุญุชูุงุฌ.</div>
            </div>
            <span class="chip chipS"><i class="fa-solid fa-layer-group"></i> ุฃูุณุงู</span>
          </div>
          <div class="featureGrid">
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-burger"></i></span>
                <div>
                  <div class="text-sm font-bold">ูุทุงุนู ูุฑูุจุฉ</div>
                  <div class="tiny muted">ุงุฎุชูุงุฑุงุช ุณุฑูุนุฉ ูุนุดุงุก ุงูููู</div>
                </div>
              </div>
            </div>
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-pills"></i></span>
                <div>
                  <div class="text-sm font-bold">ุตูุฏููุงุช</div>
                  <div class="tiny muted">ุฃุฏููุฉ ุนุงุฌูุฉ ูุชูุตูู ุขูู</div>
                </div>
              </div>
            </div>
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-cart-shopping"></i></span>
                <div>
                  <div class="text-sm font-bold">ุณูุจุฑ ูุงุฑูุช</div>
                  <div class="tiny muted">ุทูุจุงุช ุงูุจูุช ูู ุฏูุงุฆู</div>
                </div>
              </div>
            </div>
            <div class="miniCard">
              <div class="flex items-center gap-2">
                <span class="miniIcon"><i class="fa-solid fa-bolt"></i></span>
                <div>
                  <div class="text-sm font-bold">ุทูุจุงุช ููุฑูุฉ</div>
                  <div class="tiny muted">ุชูุตูู ุณุฑูุน ูุน ูุงุจุชู ูุฑูุจ</div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ================= DELIVERY (HOME) ================= -->
      <div id="deliveryHome" class="hidden space-y-3">
    <section class="glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-motorcycle mr-1"></i> ููุญุฉ ุงูุฏูููุฑู</b>
            <button onclick="loadOrders()" class="chip chipS">
              <i class="fa-solid fa-rotate"></i> ุชุญุฏูุซ
            </button>
          </div>

          <div class="miniCard">
            <div class="flex items-center justify-between">
              <div class="text-sm">ุงููุงุจุชู: <b id="delName">โ</b></div>
              <span class="miniIcon"><i class="fa-solid fa-helmet-safety"></i></span>
            </div>

            <div class="soft p-3 mt-3 space-y-2">
              <div class="flex items-center justify-between">
                <span class="muted text-sm">ูููุน ุงููุงุจุชู</span>
                <button class="chip chipG" onclick="setDeliveryLocation()">
                  <i class="fa-solid fa-crosshairs"></i> ุชุญุฏูุฏ ูููุนู
                </button>
              </div>
              <div id="delLocStatus" class="tiny muted">ูู ูุชู ุชุญุฏูุฏ ุงููููุน ุจุนุฏ.</div>
              <div class="tiny muted">ุณูุธูุฑ ูู ุงูุทูุจุงุช ุนูู ุจุนุฏ 5 ูู ููุท.</div>
            </div>
          </div>
        </section>

        <div id="ordersBox" class="space-y-2"></div>
        <div class="glass pageSection space-y-3">
          <div class="sectionHeader">
            <div>
              <h3>ูุณุชูู ุงูุฃุฏุงุก</h3>
              <div class="sectionSub">ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ ูููุงุจุชู.</div>
            </div>
            <span class="chip chipS"><i class="fa-solid fa-chart-line"></i> ุงูููู</span>
          </div>
          <div class="statsGrid">
            <div class="statCard">
              <b id="statOrders">0</b>
              <span class="tiny muted">ุทูุจุงุช ููุชููุฉ</span>
            </div>
            <div class="statCard">
              <b id="statRating">4.9</b>
              <span class="tiny muted">ุชูููู ูุชูุณุท</span>
            </div>
            <div class="statCard">
              <b id="statZone">5km</b>
              <span class="tiny muted">ูุทุงู ุงูุชูุตูู</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= TRACK TAB ================= -->
    <div id="trackTab" class="hidden pageShell">

      <!-- ================= CUSTOMER (TRACK) ================= -->
      <div id="customerTrackTab" class="hidden space-y-3">
        <!-- TRACK -->
        <section id="custTrack" class="hidden glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-route mr-1"></i> ูุชุงุจุนุฉ ุงูุทูุจ</b>
            <div class="flex items-center gap-2">
              <button class="chip chipS" onclick="refreshCustomerStatus()">
                <i class="fa-solid fa-rotate"></i> ุชุญุฏูุซ
              </button>
              <span class="chip chipP"><i class="fa-solid fa-circle-info"></i> Live</span>
            </div>
          </div>

          <div class="miniCard space-y-2">
            <div class="flex items-center justify-between">
              <span class="muted text-sm">ุญุงูุฉ ุงูุทูุจ</span>
              <b id="custStatus" class="text-emerald-500">pending</b>
            </div>

            <div class="flex items-center justify-between text-sm">
              <span class="muted">ุงูุนููุงู</span>
              <b id="custAddressView">โ</b>
            </div>

            <div class="flex items-center justify-between text-sm">
              <span class="muted">ุงููููุน</span>
              <a id="custTrackMapLink" class="linkP hidden" target="_blank" rel="noopener noreferrer" onclick="return openMapUrl(this.href)">
                ูุชุญ ุนูู ุงูุฎุฑูุทุฉ
              </a>
            </div>

            <div id="otpBox" class="hidden text-sm">
              <span class="muted">ููุฏ ุงูุชุณููู</span>:
              <b id="otp" class="text-emerald-500 text-lg mono"></b>
              <div class="tiny muted mt-1">ูุฏูู ุงูููุฏ ูููุงุจุชู ุนูุฏ ุงููุตูู.</div>
            </div>
          </div>
        </section>

        <!-- RATING -->
        <section id="custRating" class="hidden glass pageSection space-y-3">
          <div class="secTitle">
            <b><i class="fa-solid fa-star mr-1"></i> ุชูููู ุงููุงุจุชู</b>
            <span class="chip chipS">ุจุนุฏ ุงูุชุณููู</span>
          </div>
          <div class="miniCard space-y-3 text-center">
            <div class="text-sm">ูููู ุชุฌุฑุจุฉ ุงูุชูุตูู ูู 1 ุฅูู 5 ูุฌูู.</div>
            <div class="ratingStars" id="ratingStars">
              <button type="button" class="ratingStar" data-rating="1"><i class="fa-solid fa-star"></i></button>
              <button type="button" class="ratingStar" data-rating="2"><i class="fa-solid fa-star"></i></button>
              <button type="button" class="ratingStar" data-rating="3"><i class="fa-solid fa-star"></i></button>
              <button type="button" class="ratingStar" data-rating="4"><i class="fa-solid fa-star"></i></button>
              <button type="button" class="ratingStar" data-rating="5"><i class="fa-solid fa-star"></i></button>
            </div>
            <div id="ratingValue" class="tiny muted">ุงุฎุชุฑ ุชููููู.</div>
            <textarea id="ratingNote" placeholder="ููุงุญุธุฉ ุงุฎุชูุงุฑูุฉ ููุฏูููุฑู"></textarea>
            <button id="ratingSubmit" class="btn btnA w-full" onclick="submitRating()">
              ุฅุฑุณุงู ุงูุชูููู
            </button>
            <button class="btn btnS w-full" onclick="rejectCaptain()">
              ุฑูุถ ุงููุงุจุชู
            </button>
            <div id="ratingThanks" class="tiny muted hidden">ุชู ุฅุฑุณุงู ุงูุชููููุ ุดูุฑูุง ูู.</div>
          </div>
        </section>

        <!-- CHAT -->
        <section id="custChat" class="hidden glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-comments mr-1"></i> ุงูุดุงุช (ูุญุธู)</b>
            <div class="flex gap-2">
              <button class="chip chipS" onclick="quick('customer','ุฃูุง ูู ุงูุทุฑููุ')">
                <i class="fa-solid fa-paper-plane"></i> ูู ุงูุทุฑููุ
              </button>
              <button class="chip chipS" onclick="quick('customer','ูู ูุด ููุฌูุฏุ ุจุฏููุ')">
                <i class="fa-solid fa-repeat"></i> ุจุฏููุ
              </button>
            </div>
          </div>

          <div id="chatC" class="flex flex-col gap-2 h-52 overflow-y-auto soft p-3"></div>

          <div class="flex gap-2 items-center">
            <input id="msgC" class="flex-1" placeholder="ุงูุชุจ ุฑุณุงูุฉ..." />
            <label class="chip chipS cursor-pointer">
              <i class="fa-regular fa-image"></i>
              <input type="file" id="imgC" accept="image/*" class="hidden" />
              ุตูุฑุฉ
            </label>
            <button onclick="sendMsg('customer')" class="btn btnA" style="padding:12px 14px">
              <i class="fa-solid fa-arrow-up"></i>
            </button>
          </div>
          <div class="tiny muted">โ = ุงุชุจุนุช | โโ = ุงุชูุฑูุช</div>
        </section>

        <!-- CUSTOMER HISTORY -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-clock-rotate-left mr-1"></i> ุณุฌู ุทูุจุงุชู</b>
            <button class="chip chipS" onclick="loadCustomerHistory()">
              <i class="fa-solid fa-rotate"></i> ุชุญุฏูุซ
            </button>
          </div>
          <div id="custHistory" class="space-y-2 text-sm"></div>
        </section>
      </div>

      <!-- ================= DELIVERY (TRACK) ================= -->
      <div id="deliveryTrackTab" class="hidden space-y-3">

        <!-- DELIVERY CHAT -->
    <section id="delChat" class="hidden glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-headset mr-1"></i> ุดุงุช ุงูุทูุจ (ูุญุธู)</b>
            <div class="flex gap-2">
              <button class="chip chipS" onclick="quick('delivery','ุฃูุง ูู ุงูุทุฑูู ๐ต')">
                <i class="fa-solid fa-motorcycle"></i> ูู ุงูุทุฑูู
              </button>
              <button class="chip chipS" onclick="quick('delivery','ุงูููุชุฌ ุบูุฑ ูุชููุฑุ ุจุฏููุ')">
                <i class="fa-solid fa-ban"></i> ุบูุฑ ูุชููุฑ
              </button>
            </div>
          </div>

          <div class="miniCard space-y-1" id="delOrderDetails">
            <div class="flex items-center justify-between"><span class="muted">ุงูุญุงูุฉ</span><b id="dStatus">โ</b></div>
            <div class="flex items-center justify-between"><span class="muted">ุงูููุชุฌ</span><b id="dProd">โ</b></div>
            <div class="flex items-center justify-between"><span class="muted">ููุน ุงูุทูุจ</span><b id="dType">โ</b></div>
            <div class="flex items-center justify-between"><span class="muted">ุณุนุฑ ุงูููุชุฌ</span><b><span id="dProdEgp">โ</span> ุฌ</b></div>
            <div class="flex items-center justify-between"><span class="muted">ุงูุนููุงู</span><b id="dAddress">โ</b></div>
            <div class="flex items-center justify-between">
              <span class="muted">ุงููููุน</span>
              <a id="dMapLink" class="linkP hidden" target="_blank" rel="noopener noreferrer" onclick="return openMapUrl(this.href)">ูุชุญ ุนูู ุงูุฎุฑูุทุฉ</a>
            </div>
            <div class="divider"></div>
            <div class="flex items-center justify-between"><span class="muted">ุชูุตูู</span><b><span id="dDelFeeEgp">20</span> ุฌ</b></div>
            <div class="flex items-center justify-between"><span class="muted">ุฑุณูู ูููุน</span><b><span id="dPlatFeeEgp">10</span> ุฌ</b></div>
            <div class="divider"></div>
            <div class="flex items-center justify-between"><span class="font-black">ุงูุฅุฌูุงูู</span><b class="text-emerald-400"><span id="dTotalEgp">โ</span> ุฌ</b></div>
            <div class="flex items-center justify-between"><span class="muted">ุงูุฅุฌูุงูู ุจู Pi</span><b class="mono text-emerald-500"><span id="dTotalPi">โ</span> Pi</b></div>
            <div class="tiny muted">ููุงุญุธุงุช: <span id="dNotes">โ</span></div>
          </div>

          <div id="chatD" class="flex flex-col gap-2 h-52 overflow-y-auto soft p-3"></div>

          <div class="flex gap-2 items-center">
            <input id="msgD" class="flex-1" placeholder="ุฑุณุงูุฉ..." />
            <label class="chip chipS cursor-pointer">
              <i class="fa-regular fa-image"></i>
              <input type="file" id="imgD" accept="image/*" class="hidden" />
              ุตูุฑุฉ
            </label>
            <button onclick="sendMsg('delivery')" class="btn btnB" style="padding:12px 14px">
              <i class="fa-solid fa-arrow-up"></i>
            </button>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <button onclick="setOrderStatus('arrived')" class="btn btnA">
              <i class="fa-solid fa-location-crosshairs"></i> ูุตูุช
            </button>
            <button onclick="finishWithOtp()" class="btn btnG">
              <i class="fa-solid fa-check"></i> ุชู ุงูุชุณููู
            </button>
          </div>
        </section>

        <!-- WALLET + WITHDRAW -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-wallet mr-1"></i> ุฃุฑุจุงุญู ุงููุชุงุญุฉ</b>
            <span class="chip chipP"><i class="fa-brands fa-pied-piper-alt"></i> Pi</span>
          </div>

          <div class="miniCard">
            <div class="text-sm">
              ุงูุฃุฑุจุงุญ ุงููุชุงุญุฉ:
              <b class="mono text-emerald-500"><span id="walletPi">0.000000</span> Pi</b>
            </div>
            <div class="tiny muted mt-1">ุงูุณุญุจ ูุชู ูุจุงุดุฑุฉ ุฅูู ูุญูุธุชู ุจุนุฏ ุงูุชุฃููุฏ.</div>
          </div>

          <input id="wdAmountPi" type="number" step="0.000001" placeholder="ูู Pi ูุชุณุญุจุ" />
          <input id="wdWallet" placeholder="ุนููุงู ูุญูุธุฉ Pi" />

          <button onclick="withdrawPi()" class="btn btnP w-full">
            <i class="fa-solid fa-hand-holding-dollar"></i>
            ุทูุจ ุณุญุจ Pi
          </button>
          <div class="tiny muted">ุชุฃูุฏ ูู ุตุญุฉ ุงูุนููุงู ูุจู ุงูุฅุฑุณุงู.</div>
        </section>

        <!-- WITHDRAW HISTORY -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-list mr-1"></i> ุณุฌู ุงูุณุญุจ</b>
            <button class="chip chipS" onclick="loadWithdrawHistory()">
              <i class="fa-solid fa-rotate"></i> ุชุญุฏูุซ
            </button>
          </div>
          <div id="wdHistory" class="space-y-2 text-sm"></div>
        </section>

        <!-- DELIVERY HISTORY -->
    <section class="glass pageSection space-y-2">
          <div class="secTitle">
            <b><i class="fa-solid fa-clock-rotate-left mr-1"></i> ุณุฌู ุทูุจุงุชู ูุฏูููุฑู</b>
            <button class="chip chipS" onclick="loadDeliveryHistory()">
              <i class="fa-solid fa-rotate"></i> ุชุญุฏูุซ
            </button>
          </div>
          <div id="delHistory" class="space-y-2 text-sm"></div>
        </section>
      </div>
    </div>

    <!-- ================= DISCOVER TAB ================= -->
    <div id="discoverTab" class="hidden pageShell">
      <section class="glass pageSection space-y-3">
        <div class="sectionHeader">
          <div>
            <h3>ููุงุฐุง QuickCartุ</h3>
            <div class="sectionSub">ูุงุฌูุฉ ูุฑุชุจุฉ ููู ุงุญุชูุงุฌุงุชู ุงูููููุฉ.</div>
          </div>
          <span class="chip chipP"><i class="fa-solid fa-star"></i> ูููุฒ</span>
        </div>
        <div class="infoCard">
          <div class="text-sm">ุชุฌุฑุจุฉ ุทูุจ ุณูุณุฉ ูุน ูุชุงุจุนุฉ ูุญุธูุฉุ ุดุงุช ูุจุงุดุฑุ ูุฏูุน ุขูู ุจู Pi.</div>
        </div>
        <div class="featureGrid">
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-shield-halved"></i></span>
            <div>
              <div class="text-sm font-bold">ุญูุงูุฉ ุงูุทูุจ</div>
              <div class="tiny muted">ููุฏ ุชุณููู ุณุฑู ูุถูุงู ุงูุฃูุงู.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-comments"></i></span>
            <div>
              <div class="text-sm font-bold">ุชูุงุตู ููุฑู</div>
              <div class="tiny muted">ุดุงุช ูุตู ูุตูุฑ ูุน ุงููุงุจุชู.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-location-dot"></i></span>
            <div>
              <div class="text-sm font-bold">ุชุชุจุน ูุจุงุดุฑ</div>
              <div class="tiny muted">ุนุฑุถ ูููุน ุงูุทูุจ ุนูู ุงูุฎุฑูุทุฉ.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-wallet"></i></span>
            <div>
              <div class="text-sm font-bold">ุณุญุจ ูุจุงุดุฑ</div>
              <div class="tiny muted">ุชุญููู ุฃุฑุจุงุญู ุณุฑูุนูุง ููุญูุธุชู.</div>
            </div>
          </div>
        </div>
      </section>

      <section class="glass pageSection space-y-3">
        <div class="sectionHeader">
          <div>
            <h3>ุฎุทูุงุช ุงูุงุณุชุฎุฏุงู</h3>
            <div class="sectionSub">ุซูุงุซ ุฎุทูุงุช ุจุณูุทุฉ ููุทูุจ.</div>
          </div>
          <span class="chip chipS"><i class="fa-solid fa-route"></i> ุฏููู ุณุฑูุน</span>
        </div>
        <div class="space-y-2">
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-user"></i></span>
            <div>
              <div class="text-sm font-bold">ุณุฌูู ุงูุฏุฎูู</div>
              <div class="tiny muted">ุงุณุชุฎุฏู Pi Browser ูููุตูู ุงููุงูู ููุฏูุน.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-bag-shopping"></i></span>
            <div>
              <div class="text-sm font-bold">ุฃูุดุฆ ุทูุจู</div>
              <div class="tiny muted">ุงูุชุจ ุชูุงุตูู ุงูููุชุฌ ูุญุฏุฏ ูููุนู.</div>
            </div>
          </div>
          <div class="listCard">
            <span class="listIcon"><i class="fa-solid fa-truck-fast"></i></span>
            <div>
              <div class="text-sm font-bold">ุชุงุจุน ุงูุชุณููู</div>
              <div class="tiny muted">ุดุงูุฏ ุงูุญุงูุฉ ูุชูุงุตู ูุน ุงููุงุจุชู.</div>
            </div>
          </div>
        </div>
      </section>

      <section class="glass pageSection space-y-3">
        <div class="sectionHeader">
          <div>
            <h3>ุงูุฏุนู ูุงููุณุงุนุฏุฉ</h3>
            <div class="sectionSub">ุฌุงูุฒูู ูุณุงุนุฏู ูู ุฃู ููุช.</div>
          </div>
          <span class="chip chipB"><i class="fa-solid fa-headset"></i> ุฏุนู</span>
        </div>
        <div class="miniCard space-y-2">
          <div class="text-sm">ุชูุงุตู ูุนูุง ุนุจุฑ ุงูุจุฑูุฏ ุฃู ูู ุฎูุงู ุงูุดุงุช ุฏุงุฎู ุงูุทูุจ.</div>
          <div class="flex flex-wrap gap-2">
            <span class="chip chipS"><i class="fa-solid fa-envelope"></i> support@quickcart.app</span>
            <span class="chip chipS"><i class="fa-solid fa-phone"></i> 15777</span>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- BOTTOM NAV -->
  <div id="bottomNav" class="bottomNav hidden">
    <div class="wrap">
      <button id="navHome" onclick="setMainTab('home')" class="btn btnA flex-1">
        <i class="fa-solid fa-plus"></i> ุทูุจ ุฌุฏูุฏ
      </button>
      <button id="navTrack" onclick="setMainTab('track')" class="btn btnS flex-1">
        <i class="fa-solid fa-route"></i> ูุชุงุจุนุฉ
      </button>
      <button id="navDiscover" onclick="setMainTab('discover')" class="btn btnS flex-1">
        <i class="fa-solid fa-compass"></i> ุงููุฒูุฏ
      </button>
    </div>
  </div>

  <script>
/* ================== CONFIG ================== */
Pi.init({ version: "2.0", sandbox: false });

const SUPABASE_URL = 'https://axjkwrssmofzavaoqutq.supabase.co';
const SUPABASE_KEY = 'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================== FEES ================== */
const DELIVERY_FEE_EGP = 20;
const PLATFORM_FEE_EGP = 10;

/* ================== GLOBALS ================== */
let PI_USER = null;
let PI_USERNAME = null;
let PI_UID = null;
let ACTIVE_ORDER = null;
let CUSTOMER_LOCATION = null;
let DELIVERY_LOCATION = null;
let HAS_LOCATION_COLUMNS = true;
let ACTIVE_ROLE = 'customer';
let ACTIVE_MAIN_TAB = 'home';
let ACTIVE_RATING = 0;

/* ================== RATES ================== */
let PI_USDT = 0;     // 1 PI in USDT
let USD_EGP = 0;     // 1 USD in EGP

/* ================== DETECT ================== */
function detectPi() {
  const hasPi = typeof window.Pi !== 'undefined';
  const ua = (navigator.userAgent || '').toLowerCase();
  const isPiBrowser = ua.includes('pibrowser') || hasPi;

  document.getElementById('piStateText').innerText = hasPi ? 'SDK ููุฌูุฏ ูุฌุงูุฒ' : 'SDK ุบูุฑ ูุชุงุญ';
  document.getElementById('piTag').innerText = isPiBrowser ? 'Pi Browser' : 'Web';
}

document.addEventListener('DOMContentLoaded', () => {
  detectPi();
  initRatingStars();
  refreshRates();
  setInterval(fetchPiFromOKX, 30000);
  setInterval(fetchUsdEgp, 60000);
});

/* ================== RATES ================== */
async function refreshRates(){
  await Promise.allSettled([fetchPiFromOKX(), fetchUsdEgp()]);
  recalcInvoice();
}

async function fetchPiFromOKX(){
  try{
    const r = await fetch("https://www.okx.com/api/v5/market/ticker?instId=PI-USDT", { cache: "no-store" });
    const j = await r.json();
    const last = parseFloat(j?.data?.[0]?.last || "0");
    if(last > 0) PI_USDT = last;

    document.getElementById('piUsdt').innerText = PI_USDT ? PI_USDT.toFixed(6) : 'โ';
    updatePiEgpOne();
  }catch(e){
    console.warn('OKX PI ticker failed:', e);
  }
}

async function fetchUsdEgp(){
  try{
    const r = await fetch("https://open.er-api.com/v6/latest/USD", { cache: "no-store" });
    const j = await r.json();
    const rate = parseFloat(j?.rates?.EGP || "0");
    if(rate > 0) USD_EGP = rate;

    document.getElementById('usdEgp').innerText = USD_EGP ? USD_EGP.toFixed(4) : 'โ';
    updatePiEgpOne();
  }catch(e){
    console.warn('USD/EGP failed:', e);
    document.getElementById('usdEgp').innerText = 'ูุดู';
  }
}

function updatePiEgpOne(){
  const piEgp = (PI_USDT && USD_EGP) ? (PI_USDT * USD_EGP) : 0;
  document.getElementById('piEgpOne').innerText = piEgp ? piEgp.toFixed(3) : 'โ';
}

function egpToPi(egp){
  const piEgp = PI_USDT * USD_EGP;
  if(!piEgp || piEgp <= 0) return 0;
  return egp / piEgp;
}

/* ================== LOCATION ================== */
function getCurrentLocation(){
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('ุงููุชุตูุญ ูุง ูุฏุนู ุชุญุฏูุฏ ุงููููุน'));
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
      (err) => reject(err),
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  });
}

function buildMapUrl(lat, lng){
  return `https://www.google.com/maps?q=${encodeURIComponent(lat)},${encodeURIComponent(lng)}`;
}

function openMapUrl(url){
  if (!url || url === '#') return false;
  if (window.Pi && typeof Pi.openUrlInSystemBrowser === 'function') {
    Pi.openUrlInSystemBrowser(url);
    return false;
  }
  window.open(url, '_blank', 'noopener,noreferrer');
  return false;
}

async function setCustomerLocation(){
  try{
    const loc = await getCurrentLocation();
    CUSTOMER_LOCATION = loc;
    const status = `ุชู ุชุญุฏูุฏ ุงููููุน: ${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}`;
    document.getElementById('custLocStatus').innerText = status;
    const link = document.getElementById('custMapLink');
    link.href = buildMapUrl(loc.lat, loc.lng);
    link.classList.remove('hidden');
    link.onclick = () => openMapUrl(link.href);
  }catch(e){
    Swal.fire({ icon:'error', title:'ูุดู ุชุญุฏูุฏ ุงููููุน', text: e?.message || 'ุญุตู ุฎุทุฃ' });
  }
}

async function setDeliveryLocation(){
  try{
    const loc = await getCurrentLocation();
    DELIVERY_LOCATION = loc;
    const status = `ุชู ุชุญุฏูุฏ ุงููููุน: ${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}`;
    document.getElementById('delLocStatus').innerText = status;
    await loadOrders();
  }catch(e){
    Swal.fire({ icon:'error', title:'ูุดู ุชุญุฏูุฏ ุงููููุน', text: e?.message || 'ุญุตู ุฎุทุฃ' });
  }
}

function distanceKm(a, b){
  if(!a || !b) return null;
  const R = 6371;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLng = (b.lng - a.lng) * Math.PI / 180;
  const lat1 = a.lat * Math.PI / 180;
  const lat2 = b.lat * Math.PI / 180;
  const sinDLat = Math.sin(dLat / 2);
  const sinDLng = Math.sin(dLng / 2);
  const h = sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLng * sinDLng;
  return 2 * R * Math.asin(Math.sqrt(h));
}

function hasMissingLocationColumn(error){
  const msg = String(error?.message || '').toLowerCase();
  return msg.includes('customer_lat') || msg.includes('customer_lng') || msg.includes('customer_address');
}

/* ================== LOGIN ================== */
async function piLogin() {
  try {
    if (!window.Pi || !Pi.authenticate) {
      return Swal.fire({ icon: 'warning', title: 'Pi SDK ุบูุฑ ูุชุงุญ', text: 'ุงูุชุญ ุงููููุน ุฏุงุฎู Pi Browser.' });
    }

    const ua = (navigator.userAgent || '').toLowerCase();
    if (!ua.includes('pibrowser')) {
      const r = await Swal.fire({
        icon: 'info',
        title: 'ููุงุญุธุฉ',
        text: 'ุงูุฃูุถู ุชูุชุญ ุฏุงุฎู Pi Browser ุนุดุงู ุงูุฏูุน ูุดุชุบู 100%.',
        showCancelButton: true,
        confirmButtonText: 'ูููู',
        cancelButtonText: 'ุฅูุบุงุก'
      });
      if (!r.isConfirmed) return;
    }

    Swal.fire({ title: 'ุฌุงุฑู ุชุณุฌูู ุงูุฏุฎูู...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    const scopes = ['username', 'payments'];
    const auth = await Pi.authenticate(scopes, onIncompletePaymentFound);

    const username = auth?.user?.username || auth?.username || null;
    const uid = auth?.user?.uid || auth?.user?.id || auth?.uid || null;
    if (!username) throw new Error('ูู ูุชู ุงุณุชูุงู username ูู Pi');

    PI_USER = auth;
    PI_USERNAME = username;
    PI_UID = uid || username;

    document.getElementById('custName').innerText = PI_USERNAME;
    document.getElementById('delName').innerText = PI_USERNAME;

    document.getElementById('loginBox').classList.add('hidden');
    document.getElementById('bottomNav').classList.remove('hidden');
    document.getElementById('roleToggle').classList.remove('hidden');

    // ุฒุฑ Admin ูุธูุฑ ููุท ููุฃุฏูู
    if (PI_USERNAME === 'medomohamed22') {
      document.getElementById('adminLink').classList.remove('hidden');
    } else {
      document.getElementById('adminLink').classList.add('hidden');
    }

    setMainTab('home');
    setRole('customer');

    await refreshRates();
    await restoreActiveOrder();
    loadOrders();
    loadWalletPi();
    loadCustomerHistory();
    loadDeliveryHistory();
    loadWithdrawHistory();

    Swal.close();

  } catch (e) {
    console.error('piLogin error:', e);
    Swal.fire({ icon: 'error', title: 'ูุดู ุชุณุฌูู ุงูุฏุฎูู', text: e?.message || 'ุญุตู ุฎุทุฃ' });
  }
}

function devLogin(){
  PI_USERNAME = 'dev_user_' + Math.floor(Math.random()*9999);
  PI_UID = PI_USERNAME;

  document.getElementById('custName').innerText = PI_USERNAME;
  document.getElementById('delName').innerText = PI_USERNAME;

  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('bottomNav').classList.remove('hidden');
  document.getElementById('roleToggle').classList.remove('hidden');

  document.getElementById('adminLink').classList.add('hidden');

  setMainTab('home');
  setRole('customer');

  restoreActiveOrder();
  refreshRates();
  loadOrders();
  loadWalletPi();
  loadCustomerHistory();
  loadDeliveryHistory();
  loadWithdrawHistory();
}

function onIncompletePaymentFound(payment) {
  console.log('incomplete payment found:', payment);
}

/* ================== RESTORE ACTIVE ORDER ================== */
function activeOrderStorageKey(){
  return PI_USERNAME ? `qc_active_order_${PI_USERNAME}` : 'qc_active_order';
}

function setActiveOrderId(orderId){
  ACTIVE_ORDER = orderId;
  if (orderId) {
    localStorage.setItem(activeOrderStorageKey(), orderId);
  } else {
    localStorage.removeItem(activeOrderStorageKey());
  }
}

async function restoreActiveOrder(){
  if(!PI_USERNAME) return;

  const storedId = localStorage.getItem(activeOrderStorageKey());

  const customerOrder = await findActiveOrderForCustomer(storedId);
  if (customerOrder) {
    setActiveOrderId(customerOrder.id);
    setRole('customer');
    setMainTab('track');
    await applyCustomerOrderState(customerOrder);
    listenStatus();
    startChat();
    return;
  }

  const deliveryOrder = await findActiveOrderForDelivery(storedId);
  if (deliveryOrder) {
    setActiveOrderId(deliveryOrder.id);
    setRole('delivery');
    setMainTab('track');
    await loadOrderDetailsForDelivery(deliveryOrder.id);
    document.getElementById('delChat').classList.remove('hidden');
    startChat();
    markSeen('delivery');
    listenDeliveryStatus();
    return;
  }

  setActiveOrderId(null);
  setRole('customer');
  setMainTab('home');
}

async function findActiveOrderForCustomer(orderId){
  const activeStatuses = ['pending', 'accepted', 'shipping', 'arrived', 'delivered'];

  if (orderId) {
    const { data } = await db.from('orders')
      .select('id,product_name,status,customer_address,customer_lat,customer_lng,otp_code')
      .eq('id', orderId)
      .eq('customer_pi_username', PI_USERNAME)
      .single();
    if (data && activeStatuses.includes(data.status)) return data;
  }

  const { data } = await db.from('orders')
    .select('id,product_name,status,customer_address,customer_lat,customer_lng,otp_code')
    .eq('customer_pi_username', PI_USERNAME)
    .in('status', activeStatuses)
    .order('created_at', { ascending: false })
    .limit(1);

  return data?.[0] || null;
}

async function findActiveOrderForDelivery(orderId){
  const activeStatuses = ['accepted', 'shipping', 'arrived'];

  if (orderId) {
    const { data } = await db.from('orders')
      .select('id,status')
      .eq('id', orderId)
      .eq('delivery_id', PI_USERNAME)
      .single();
    if (data && activeStatuses.includes(data.status)) return data;
  }

  const { data } = await db.from('orders')
    .select('id,status')
    .eq('delivery_id', PI_USERNAME)
    .in('status', activeStatuses)
    .order('created_at', { ascending: false })
    .limit(1);

  return data?.[0] || null;
}

async function applyCustomerOrderState(order){
  document.getElementById('custTrack').classList.remove('hidden');
  document.getElementById('custChat').classList.remove('hidden');
  document.getElementById('custStatus').innerText = order.status || 'pending';
  document.getElementById('otp').innerText = order.otp_code || '';
  document.getElementById('otpBox').classList.toggle('hidden', !order.otp_code);
  document.getElementById('custAddressView').innerText = order.customer_address || 'โ';
  if (order.status === 'delivered') {
    document.getElementById('custTrack').classList.add('hidden');
    document.getElementById('custChat').classList.add('hidden');
    document.getElementById('custRating').classList.remove('hidden');
    setActiveOrderId(null);
    if (statusPollTimer) clearInterval(statusPollTimer);
    await loadRatingState(order);
  } else {
    hideRating();
  }
  const trackLink = document.getElementById('custTrackMapLink');
  if (typeof order.customer_lat === 'number' && typeof order.customer_lng === 'number') {
    trackLink.href = buildMapUrl(order.customer_lat, order.customer_lng);
    trackLink.classList.remove('hidden');
    trackLink.onclick = () => openMapUrl(trackLink.href);
  } else {
    trackLink.classList.add('hidden');
  }
}

function hideRating(){
  document.getElementById('custRating').classList.add('hidden');
  document.getElementById('ratingThanks').classList.add('hidden');
  document.getElementById('ratingSubmit').disabled = false;
  document.getElementById('ratingSubmit').classList.remove('btnS');
  document.getElementById('ratingSubmit').classList.add('btnA');
  document.getElementById('ratingNote').value = '';
  document.getElementById('ratingValue').innerText = 'ุงุฎุชุฑ ุชููููู.';
  setRating(0);
}

async function refreshCustomerStatus(){
  try{
    if (!PI_USERNAME || !ACTIVE_ORDER) return;
    const { data, error } = await db.from('orders')
      .select('id,product_name,status,customer_address,customer_lat,customer_lng,otp_code,delivery_id')
      .eq('id', ACTIVE_ORDER)
      .eq('customer_pi_username', PI_USERNAME)
      .single();
    if (error) throw error;
    if (data) {
      await applyCustomerOrderState(data);
    }
  }catch(e){
    console.warn('refreshCustomerStatus failed', e);
  }
}

function setRating(value){
  ACTIVE_RATING = value;
  const stars = document.querySelectorAll('#ratingStars .ratingStar');
  stars.forEach((star) => {
    const rating = Number(star.dataset.rating);
    star.classList.toggle('active', rating <= value);
  });
  const label = value ? `ุชููููู ุงูุญุงูู: ${value} ูุฌูู` : 'ุงุฎุชุฑ ุชููููู.';
  document.getElementById('ratingValue').innerText = label;
}

function initRatingStars(){
  const stars = document.querySelectorAll('#ratingStars .ratingStar');
  stars.forEach((star) => {
    star.addEventListener('click', () => {
      const rating = Number(star.dataset.rating);
      setRating(rating);
    });
  });
}

async function loadRatingState(order){
  if (!order?.id || !order?.delivery_id) return;
  document.getElementById('custRating').classList.remove('hidden');
  try {
    const { data, error } = await db.from('delivery_ratings')
      .select('id,rating')
      .eq('order_id', order.id)
      .eq('customer_pi_username', PI_USERNAME)
      .limit(1);
    if (error) throw error;
    if (data && data.length) {
      setRating(Number(data[0].rating) || 0);
      document.getElementById('ratingThanks').classList.remove('hidden');
      const submit = document.getElementById('ratingSubmit');
      submit.disabled = true;
      submit.classList.remove('btnA');
      submit.classList.add('btnS');
      document.getElementById('custTrack').classList.add('hidden');
      document.getElementById('custChat').classList.add('hidden');
      setActiveOrderId(null);
      document.getElementById('custRating').classList.add('hidden');
      if (chatPollTimer) clearInterval(chatPollTimer);
      if (statusPollTimer) clearInterval(statusPollTimer);
    } else {
      document.getElementById('ratingThanks').classList.add('hidden');
      document.getElementById('ratingSubmit').disabled = false;
    }
  } catch (e) {
    console.warn('loadRatingState failed', e);
  }
}

async function submitRating(){
  try{
    if (!ACTIVE_ORDER) return;
    if (!PI_USERNAME) return Swal.fire('ุณุฌูู ุฏุฎูู ุฃููุงู');
    if (ACTIVE_RATING < 1) return Swal.fire('ุงุฎุชุงุฑ ุชูููู ูู 1 ุฅูู 5');

    const note = document.getElementById('ratingNote').value.trim();
    const { data: order, error: orderErr } = await db.from('orders')
      .select('delivery_id')
      .eq('id', ACTIVE_ORDER)
      .single();
    if (orderErr) throw orderErr;

    const { error } = await db.from('delivery_ratings').insert([{
      order_id: ACTIVE_ORDER,
      delivery_id: order?.delivery_id || null,
      customer_pi_username: PI_USERNAME,
      rating: ACTIVE_RATING,
      comment: note || null
    }]);
    if (error) throw error;

    document.getElementById('ratingThanks').classList.remove('hidden');
    document.getElementById('ratingSubmit').disabled = true;
    document.getElementById('ratingSubmit').classList.remove('btnA');
    document.getElementById('ratingSubmit').classList.add('btnS');
    Swal.fire({ icon:'success', title:'ุชู ุงูุชูููู โ' });
    document.getElementById('custTrack').classList.add('hidden');
    document.getElementById('custChat').classList.add('hidden');
    setActiveOrderId(null);
    document.getElementById('custRating').classList.add('hidden');
    if (chatPollTimer) clearInterval(chatPollTimer);
    if (statusPollTimer) clearInterval(statusPollTimer);
  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ูุดู ุฅุฑุณุงู ุงูุชูููู', text: e?.message || 'ุญุตู ุฎุทุฃ' });
  }
}

async function rejectCaptain(){
  setRating(1);
  document.getElementById('ratingNote').value = 'ุฑูุถ ุงููุงุจุชู';
  await submitRating();
}

/* ================== INVOICE UI ================== */
function recalcInvoice(){
  const prodEgp = parseFloat(document.getElementById('price').value || "0") || 0;
  const totalEgp = prodEgp + DELIVERY_FEE_EGP + PLATFORM_FEE_EGP;
  const totalPi = egpToPi(totalEgp);

  document.getElementById('invProdEgp').innerText = prodEgp.toFixed(2);
  document.getElementById('invDelFeeEgp').innerText = DELIVERY_FEE_EGP.toFixed(2);
  document.getElementById('invPlatFeeEgp').innerText = PLATFORM_FEE_EGP.toFixed(2);
  document.getElementById('invTotalEgp').innerText = totalEgp.toFixed(2);
  document.getElementById('invTotalPi').innerText = totalPi ? totalPi.toFixed(6) : '0.000000';
}

/* ================== CUSTOMER: PAY + CREATE ORDER ================== */
async function payAndCreate() {
  try {
    if (!PI_USERNAME) return Swal.fire('ูุงุฒู ุชุณุฌู ุฏุฎูู ุงูุฃูู');

    const product = document.getElementById('prod').value.trim();
    const orderType = document.getElementById('orderType').value;
    const notes = document.getElementById('notes').value.trim();
    const address = document.getElementById('custAddress').value.trim();
    const prodEgp = parseFloat(document.getElementById('price').value || "0") || 0;

    if (!product || prodEgp <= 0) return Swal.fire('ุงูุชุจ ุงุณู ุงูููุชุฌ ูุณุนุฑ ุตุญูุญ');
    if (!address) return Swal.fire('ุงูุชุจ ุงูุนููุงู ุจุงูุชูุตูู');
    if (!CUSTOMER_LOCATION) return Swal.fire('ูู ูุถูู ุญุฏูุฏ ูููุนู ุฃููุงู');

    if (!(PI_USDT > 0 && USD_EGP > 0)) {
      await refreshRates();
      if (!(PI_USDT > 0 && USD_EGP > 0)) return Swal.fire('ููุฏุฑูุงุด ูุฌูุจ USD/EGP ุฏูููุชูุ ุฌุฑูุจ ุชุงูู');
    }

    const totalEgp = prodEgp + DELIVERY_FEE_EGP + PLATFORM_FEE_EGP;
    const totalPi = egpToPi(totalEgp);
    const amountPi = Number(totalPi || 0).toFixed(6);

    const otp = String(Math.floor(1000 + Math.random() * 9000));

    const confirm = await Swal.fire({
      title: 'ุชุฃููุฏ ุงูุฏูุน',
      html: `
        <div style="text-align:right">
          <div>ุณุนุฑ ุงูููุชุฌ: <b>${prodEgp.toFixed(2)} ุฌ</b></div>
          <div>ุฑุณูู ุงูุชูุตูู: <b>${DELIVERY_FEE_EGP.toFixed(2)} ุฌ</b></div>
          <div>ุฑุณูู ุงููููุน: <b>${PLATFORM_FEE_EGP.toFixed(2)} ุฌ</b></div>
          <hr/>
          <div>ุงูุฅุฌูุงูู: <b style="color:#16a34a">${totalEgp.toFixed(2)} ุฌ</b></div>
          <div>ูุนุงุฏู ุชูุฑูุจูุง: <b style="color:#7c3aed">${amountPi} Pi</b></div>
          <div style="font-size:12px;opacity:.75;margin-top:6px">
            (1 Pi โ ${(PI_USDT*USD_EGP).toFixed(3)} ุฌ)
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'ุงุฏูุน',
      cancelButtonText: 'ุฅูุบุงุก'
    });
    if (!confirm.isConfirmed) return;

    if (!window.Pi || !Pi.createPayment) {
      return Swal.fire('Pi Payment ุบูุฑ ูุชุงุญ.. ุงูุชุญ ุฏุงุฎู Pi Browser');
    }

    Swal.fire({ title: 'ุฌุงุฑู ุงูุฏูุน...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

    const paymentResult = await new Promise((resolve, reject) => {
      Pi.createPayment({
        amount: amountPi,
        memo: `QuickCart | ${product} | Total ${totalEgp.toFixed(2)} EGP`,
        metadata: {
          product, orderType, prodEgp,
          deliveryFee: DELIVERY_FEE_EGP,
          platformFee: PLATFORM_FEE_EGP,
          totalEgp,
          pi_usdt: PI_USDT,
          usd_egp: USD_EGP
        }
      }, {
        onReadyForServerApproval: async (paymentId) => {
          await fetch('/api/pi/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId })
          });
        },
        onReadyForServerCompletion: async (paymentId, txid) => {
          await fetch('/api/pi/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId, txid })
          });
          resolve({ paymentId, txid });
        },
        onCancel: (paymentId) => reject(new Error('ุชู ุฅูุบุงุก ุงูุฏูุน')),
        onError: (err) => reject(err || new Error('ูุดู ุงูุฏูุน'))
      });
    });

    // ุจุนุฏ ูุฌุงุญ ุงูุฏูุน: ููุชุจ ุงูุทูุจ ูู DB
    const deliveryFeePi = egpToPi(DELIVERY_FEE_EGP);
    const platformFeePi = egpToPi(PLATFORM_FEE_EGP);

    const basePayload = {
      product_name: product,
      order_type: orderType,
      notes: notes || null,

      price: prodEgp,
      delivery_fee: DELIVERY_FEE_EGP,
      platform_fee: PLATFORM_FEE_EGP,

      total_price: totalEgp,
      status: 'pending',
      otp_code: otp,
      customer_pi_username: PI_USERNAME,
      can_modify_until: new Date(Date.now() + 60_000).toISOString(),

      pricing_snapshot: {
        pi_usdt: PI_USDT,
        usd_egp: USD_EGP,
        pi_egp: (PI_USDT * USD_EGP),
        total_pi: Number(amountPi),

        delivery_fee_pi: deliveryFeePi ? Number(deliveryFeePi.toFixed(6)) : 0,
        platform_fee_pi: platformFeePi ? Number(platformFeePi.toFixed(6)) : 0
      },
      payment_id: paymentResult?.paymentId || null,
      payment_txid: paymentResult?.txid || null
    };

    const payloadWithLocation = {
      ...basePayload,
      customer_address: address,
      customer_lat: CUSTOMER_LOCATION?.lat ?? null,
      customer_lng: CUSTOMER_LOCATION?.lng ?? null
    };

    let insertResult = await db.from('orders').insert([payloadWithLocation]).select();
    if (insertResult.error && hasMissingLocationColumn(insertResult.error)) {
      HAS_LOCATION_COLUMNS = false;
      basePayload.pricing_snapshot = {
        ...basePayload.pricing_snapshot,
        customer_location: {
          address,
          lat: CUSTOMER_LOCATION?.lat ?? null,
          lng: CUSTOMER_LOCATION?.lng ?? null
        }
      };
      insertResult = await db.from('orders').insert([basePayload]).select();
    }

    const { data, error } = insertResult;

    if (error) throw error;

    setActiveOrderId(data?.[0]?.id || null);
    setMainTab('track');

    document.getElementById('custTrack').classList.remove('hidden');
    document.getElementById('custChat').classList.remove('hidden');
    document.getElementById('custStatus').innerText = 'pending';
    document.getElementById('otp').innerText = otp;
    document.getElementById('otpBox').classList.remove('hidden');
    document.getElementById('custAddressView').innerText = address;
    const trackLink = document.getElementById('custTrackMapLink');
    trackLink.href = buildMapUrl(CUSTOMER_LOCATION.lat, CUSTOMER_LOCATION.lng);
    trackLink.classList.remove('hidden');
    trackLink.onclick = () => openMapUrl(trackLink.href);

    Swal.close();

    listenStatus();
    startChat();
    loadCustomerHistory();

  } catch (e) {
    console.error(e);
    Swal.fire({ icon: 'error', title: 'ูุดู ุงูุนูููุฉ', text: e?.message || 'ุญุตู ุฎุทุฃ' });
  }
}

/* ================== DELIVERY: LOAD + ACCEPT (RPC Lock) ================== */
async function loadOrders(){
  try{
    const box = document.getElementById('ordersBox');
    box.innerHTML = `<div class="glass p-4 text-center muted">ุฌุงุฑู ุงูุชุญููู...</div>`;

    let result = await db.from('orders')
      .select('id,product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,status,created_at,pricing_snapshot,customer_lat,customer_lng,customer_address')
      .eq('status','pending')
      .order('created_at',{ascending:false});

    if (result.error && hasMissingLocationColumn(result.error)) {
      HAS_LOCATION_COLUMNS = false;
      result = await db.from('orders')
        .select('id,product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,status,created_at,pricing_snapshot')
        .eq('status','pending')
        .order('created_at',{ascending:false});
    }

    const { data, error } = result;
    if (error) throw error;

    if (!data?.length) {
      box.innerHTML = `<div class="glass p-4 text-center muted">ูุง ุชูุฌุฏ ุทูุจุงุช ุญุงููุงู</div>`;
      return;
    }

    if (!DELIVERY_LOCATION && HAS_LOCATION_COLUMNS) {
      box.innerHTML = `<div class="glass p-4 text-center muted">ุญุฏุฏ ูููุนู ุฃููุงู ูุนุฑุถ ุงูุทูุจุงุช ุงููุฑูุจุฉ (5 ูู).</div>`;
      return;
    }

    const filtered = HAS_LOCATION_COLUMNS
      ? data.filter(o => {
          if (typeof o.customer_lat !== 'number' || typeof o.customer_lng !== 'number') return false;
          const dist = distanceKm(
            DELIVERY_LOCATION,
            { lat: o.customer_lat, lng: o.customer_lng }
          );
          return dist !== null && dist <= 5;
        })
      : data;

    if (!filtered.length) {
      box.innerHTML = `<div class="glass p-4 text-center muted">ูุง ุชูุฌุฏ ุทูุจุงุช ูุฑูุจุฉ ุถูู 5 ูู ุงูุขู.</div>`;
      return;
    }

    box.innerHTML = filtered.map(o => {
      const delFee = (o.delivery_fee ?? DELIVERY_FEE_EGP);
      const platFee = (o.platform_fee ?? PLATFORM_FEE_EGP);
      const totalEgp = (o.total_price ?? ((o.price||0)+delFee+platFee));
      const totalPi = egpToPi(totalEgp);
      const dist = HAS_LOCATION_COLUMNS
        ? distanceKm(
            DELIVERY_LOCATION,
            { lat: o.customer_lat, lng: o.customer_lng }
          )
        : null;
      const mapUrl = (HAS_LOCATION_COLUMNS && typeof o.customer_lat === 'number' && typeof o.customer_lng === 'number')
        ? buildMapUrl(o.customer_lat, o.customer_lng)
        : '#';

      return `
      <div class="glass p-4 space-y-2">
        <div class="row">
          <div>
            <b class="text-base">${escapeHtml(o.product_name)}</b>
            <div class="tiny">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
            <div class="tiny">ููุน: <b>${escapeHtml(o.order_type || 'any')}</b></div>
            ${HAS_LOCATION_COLUMNS ? `<div class="tiny">ุงููุณุงูุฉ: <b>${dist ? dist.toFixed(2) : 'โ'} ูู</b></div>` : ``}
          </div>
          <div class="text-sm font-extrabold text-emerald-500">${Number(totalEgp).toFixed(2)} ุฌ</div>
        </div>

        <div class="soft p-3 text-sm space-y-1">
          <div class="row"><span class="muted">ุณุนุฑ ุงูููุชุฌ</span><b>${Number(o.price||0).toFixed(2)} ุฌ</b></div>
          ${HAS_LOCATION_COLUMNS ? `<div class="row"><span class="muted">ุงูุนููุงู</span><b>${escapeHtml(o.customer_address || 'โ')}</b></div>` : ``}
          ${HAS_LOCATION_COLUMNS ? `<div class="row"><span class="muted">ุงููููุน</span><a class="text-emerald-600 underline" target="_blank" rel="noopener noreferrer" href="${mapUrl}" onclick="return openMapUrl('${mapUrl}')">ูุชุญ ุงูุฎุฑูุทุฉ</a></div>` : ``}
          <div class="row"><span class="muted">ุชูุตูู</span><b>${Number(delFee).toFixed(2)} ุฌ</b></div>
          <div class="row"><span class="muted">ุฑุณูู ูููุน</span><b>${Number(platFee).toFixed(2)} ุฌ</b></div>
          <div class="border-t border-emerald-100 pt-2 row"><span class="font-extrabold">ุงูุฅุฌูุงูู</span><b class="text-emerald-500">${Number(totalEgp).toFixed(2)} ุฌ</b></div>
          <div class="row"><span class="muted">ูุนุงุฏู ุจู Pi</span><b class="mono text-emerald-600">${totalPi ? totalPi.toFixed(6) : 'โ'} Pi</b></div>
        </div>

        <button onclick="acceptOrder('${o.id}')" class="btn btnG w-full">ูุจูู ุงูุทูุจ</button>
      </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('ordersBox').innerHTML =
      `<div class="glass p-4 text-center" style="color:#fca5a5">ุฎุทุฃ ูู ุฌูุจ ุงูุทูุจุงุช: ${escapeHtml(e?.message||'')}</div>`;
  }
}

async function acceptOrder(id){
  try{
    if(!PI_USERNAME) return Swal.fire('ุณุฌูู ุฏุฎูู ูุงุจุชู ุงูุฃูู');

    Swal.fire({ title:'ุฌุงุฑู ุงููุจูู...', didOpen:()=>Swal.showLoading(), allowOutsideClick:false });

    const { error } = await db.rpc('accept_order_once', {
      p_order_id: id,
      p_delivery_id: PI_USERNAME
    });

    if (error) throw error;

    setActiveOrderId(id);
    setMainTab('track');
    await loadOrderDetailsForDelivery(id);

    document.getElementById('delChat').classList.remove('hidden');
    Swal.close();

    startChat();
    markSeen('delivery');
    listenDeliveryStatus();
    loadDeliveryHistory();

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ูุดู ุงููุจูู', text: e?.message || 'ุญุตู ุฎุทุฃ' });
  }
}

async function loadOrderDetailsForDelivery(orderId){
  let result = await db.from('orders')
    .select('product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,customer_address,customer_lat,customer_lng,status')
    .eq('id', orderId)
    .single();

  if(result.error && hasMissingLocationColumn(result.error)) {
    HAS_LOCATION_COLUMNS = false;
    result = await db.from('orders')
      .select('product_name,order_type,notes,price,delivery_fee,platform_fee,total_price,status')
      .eq('id', orderId)
      .single();
  }

  const { data, error } = result;
  if(error){ console.warn(error); return; }

  const delFee = (data.delivery_fee ?? DELIVERY_FEE_EGP);
  const platFee = (data.platform_fee ?? PLATFORM_FEE_EGP);
  const totalEgp = (data.total_price ?? ((data.price||0)+delFee+platFee));
  const totalPi = egpToPi(totalEgp);

  document.getElementById('dStatus').innerText = data.status || 'pending';
  document.getElementById('dProd').innerText = data.product_name || 'โ';
  document.getElementById('dType').innerText = data.order_type || 'any';
  document.getElementById('dProdEgp').innerText = Number(data.price||0).toFixed(2);
  const mapLink = document.getElementById('dMapLink');
  if (HAS_LOCATION_COLUMNS && data.customer_address) {
    document.getElementById('dAddress').innerText = data.customer_address;
  } else {
    document.getElementById('dAddress').innerText = 'โ';
  }
  if (HAS_LOCATION_COLUMNS && typeof data.customer_lat === 'number' && typeof data.customer_lng === 'number') {
    mapLink.href = buildMapUrl(data.customer_lat, data.customer_lng);
    mapLink.classList.remove('hidden');
    mapLink.onclick = () => openMapUrl(mapLink.href);
  } else {
    mapLink.href = '#';
    mapLink.classList.add('hidden');
  }
  document.getElementById('dDelFeeEgp').innerText = Number(delFee).toFixed(2);
  document.getElementById('dPlatFeeEgp').innerText = Number(platFee).toFixed(2);
  document.getElementById('dTotalEgp').innerText = Number(totalEgp).toFixed(2);
  document.getElementById('dTotalPi').innerText = totalPi ? totalPi.toFixed(6) : 'โ';
  document.getElementById('dNotes').innerText = data.notes ? data.notes : 'โ';
}

/* ================== CHAT: text + image + seen ================== */
let chatChannel = null;
let chatPollTimer = null;

function startChat(){
  if(!ACTIVE_ORDER) return;

  if (chatChannel) {
    try { db.removeChannel(chatChannel); } catch {}
    chatChannel = null;
  }

  loadMessages();
  if (chatPollTimer) clearInterval(chatPollTimer);
  chatPollTimer = setInterval(loadMessages, 8000);

  chatChannel = db.channel('chat-room-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'chat_messages',
      filter: `order_id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      appendMsg(payload.new);
      markSeen(currentRole());
    })
    .subscribe();
}

async function loadMessages(){
  const { data, error } = await db.from('chat_messages')
    .select('*')
    .eq('order_id', ACTIVE_ORDER)
    .order('created_at', { ascending: true });

  if(error){ console.error(error); return; }

  document.getElementById('chatC').innerHTML = '';
  document.getElementById('chatD').innerHTML = '';
  (data||[]).forEach(appendMsg);

  markSeen(currentRole());
}

function currentRole(){
  return ACTIVE_ROLE;
}

async function uploadChatImage(file){
  // Bucket: chat
  const path = `chat/${ACTIVE_ORDER}/${Date.now()}_${file.name}`;
  const up = await db.storage.from('chat').upload(path, file, { upsert: false });
  if (up.error) throw up.error;
  return db.storage.from('chat').getPublicUrl(path).data.publicUrl;
}

async function sendMsg(sender){
  try{
    if(!ACTIVE_ORDER) return Swal.fire('ูููุด ุทูุจ ูุดุท');

    const input = sender === 'customer' ? document.getElementById('msgC') : document.getElementById('msgD');
    const fileEl = sender === 'customer' ? document.getElementById('imgC') : document.getElementById('imgD');

    const text = (input.value || '').trim();
    const file = fileEl.files?.[0];

    if(!text && !file) return;

    let image_url = null;
    if(file){
      try{
        image_url = await uploadChatImage(file);
      }catch(e){
        console.warn("Image upload failed:", e);
        image_url = null; // fallback ุจุฏูู ูุดู
      }
    }

    const { error } = await db.from('chat_messages').insert([{
      order_id: ACTIVE_ORDER,
      sender,
      message_text: text || null,
      image_url,
      seen_at: null
    }]);
    if(error) throw error;

    input.value = '';
    fileEl.value = '';

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ูุดู ุฅุฑุณุงู ุงูุฑุณุงูุฉ', text: e?.message || 'ุญุตู ุฎุทุฃ' });
  }
}

function quick(role, txt){
  if(role==='customer') document.getElementById('msgC').value = txt;
  else document.getElementById('msgD').value = txt;
}

function appendMsg(m){
  const bubble = `
    <div class="msg ${m.sender==='customer'?'c':'d'}">
      ${m.message_text ? escapeHtml(m.message_text) : ''}
      ${m.image_url ? `<img src="${m.image_url}" class="mt-2 rounded-xl border border-emerald-100" />` : ''}
      <div class="mt-1 tiny">${m.seen_at ? 'โโ' : 'โ'}</div>
    </div>
  `;
  document.getElementById('chatC').insertAdjacentHTML('beforeend', bubble);
  document.getElementById('chatD').insertAdjacentHTML('beforeend', bubble);

  document.getElementById('chatC').scrollTop = document.getElementById('chatC').scrollHeight;
  document.getElementById('chatD').scrollTop = document.getElementById('chatD').scrollHeight;
}

async function markSeen(viewerRole){
  try{
    if(!ACTIVE_ORDER) return;
    await db.from('chat_messages')
      .update({ seen_at: new Date().toISOString() })
      .eq('order_id', ACTIVE_ORDER)
      .neq('sender', viewerRole)
      .is('seen_at', null);
  }catch(e){
    console.warn('markSeen failed:', e);
  }
}

/* ================== STATUS ================== */
let statusChannel = null;
let deliveryStatusChannel = null;
let statusPollTimer = null;

function listenStatus(){
  if(!ACTIVE_ORDER) return;

  if (statusChannel) {
    try { db.removeChannel(statusChannel); } catch {}
    statusChannel = null;
  }

  if (statusPollTimer) clearInterval(statusPollTimer);
  refreshCustomerStatus();
  statusPollTimer = setInterval(refreshCustomerStatus, 1000);
  statusPollTimer = setInterval(refreshCustomerStatus, 15000);

  statusChannel = db.channel('order-status-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'UPDATE', schema:'public', table:'orders',
      filter: `id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      const s = payload.new.status;
      document.getElementById('custStatus').innerText = s;

      if(['accepted','shipping','arrived','delivered'].includes(s)){
        document.getElementById('custChat').classList.remove('hidden');
      }

      if(s === 'delivered'){
        Swal.fire({
          icon:'success',
          title:'ุชู ุงูุชุณููู โ',
          text:'ูููู ุชุฌุฑุจุฉ ุงูุชูุตูู ูู 1 ุฅูู 5 ูุฌูู.',
          confirmButtonText:'ูููู ุงูุขู'
        });
        loadCustomerHistory();
        document.getElementById('custChat').classList.add('hidden');
        document.getElementById('custTrack').classList.add('hidden');
        document.getElementById('custRating').classList.remove('hidden');
        setActiveOrderId(null);
        loadRatingState(payload.new);
        if (statusChannel) {
          try { db.removeChannel(statusChannel); } catch {}
          statusChannel = null;
        }
        if (chatChannel) {
          try { db.removeChannel(chatChannel); } catch {}
          chatChannel = null;
        }
        if (chatPollTimer) clearInterval(chatPollTimer);
        if (statusPollTimer) clearInterval(statusPollTimer);
      }
    }).subscribe();
}

function listenDeliveryStatus(){
  if(!ACTIVE_ORDER) return;

  if (deliveryStatusChannel) {
    try { db.removeChannel(deliveryStatusChannel); } catch {}
    deliveryStatusChannel = null;
  }

  deliveryStatusChannel = db.channel('delivery-status-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'UPDATE', schema:'public', table:'orders',
      filter: `id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      const s = payload.new.status || 'pending';
      const statusEl = document.getElementById('dStatus');
      if (statusEl) statusEl.innerText = s;

      if (s === 'delivered') {
        document.getElementById('delChat').classList.add('hidden');
        setActiveOrderId(null);
        loadOrders();
        loadWalletPi();
        loadDeliveryHistory();
        if (deliveryStatusChannel) {
          try { db.removeChannel(deliveryStatusChannel); } catch {}
          deliveryStatusChannel = null;
        }
        if (chatChannel) {
          try { db.removeChannel(chatChannel); } catch {}
          chatChannel = null;
        }
        if (chatPollTimer) clearInterval(chatPollTimer);
      }
    }).subscribe();
}

function listenDeliveryStatus(){
  if(!ACTIVE_ORDER) return;

  if (deliveryStatusChannel) {
    try { db.removeChannel(deliveryStatusChannel); } catch {}
    deliveryStatusChannel = null;
  }

  deliveryStatusChannel = db.channel('delivery-status-' + ACTIVE_ORDER)
    .on('postgres_changes', {
      event: 'UPDATE', schema:'public', table:'orders',
      filter: `id=eq.${ACTIVE_ORDER}`
    }, (payload) => {
      const s = payload.new.status || 'pending';
      const statusEl = document.getElementById('dStatus');
      if (statusEl) statusEl.innerText = s;

      if (s === 'delivered') {
        document.getElementById('delChat').classList.add('hidden');
        setActiveOrderId(null);
        loadOrders();
        loadWalletPi();
        loadDeliveryHistory();
        if (deliveryStatusChannel) {
          try { db.removeChannel(deliveryStatusChannel); } catch {}
          deliveryStatusChannel = null;
        }
        if (chatChannel) {
          try { db.removeChannel(chatChannel); } catch {}
          chatChannel = null;
        }
      }
    }).subscribe();
}

/* ================== DELIVERY STATUS + OTP ================== */
async function setOrderStatus(st){
  if(!ACTIVE_ORDER) return Swal.fire('ุงุฎุชุฑ ุทูุจ ุฃููุงู');
  await db.from('orders').update({ status: st }).eq('id', ACTIVE_ORDER);
}

async function finishWithOtp(){
  try{
    if(!ACTIVE_ORDER) return;
    if(!PI_USERNAME) return Swal.fire('ุณุฌูู ุฏุฎูู');

    const { value: code } = await Swal.fire({
      title: 'ููุฏ ุงูุชุณููู',
      input: 'text',
      inputPlaceholder: 'ุงูุชุจ ููุฏ ุงูุนููู',
      showCancelButton: true,
      confirmButtonText: 'ุชุฃููุฏ',
      cancelButtonText: 'ุฅูุบุงุก'
    });
    if(!code) return;

    const { error } = await db.rpc('complete_delivery', {
      p_order_id: ACTIVE_ORDER,
      p_otp: String(code).trim(),
      p_delivery_id: PI_USERNAME
    });

    if(error) throw error;

    Swal.fire({ icon:'success', title:'ุชู ุงูุชุณููู โ' });
    await loadWalletPi();
    await loadDeliveryHistory();
    await loadOrders();
    document.getElementById('delChat').classList.add('hidden');
    setActiveOrderId(null);
    if (chatChannel) {
      try { db.removeChannel(chatChannel); } catch {}
      chatChannel = null;
    }
    if (chatPollTimer) clearInterval(chatPollTimer);
    if (statusPollTimer) clearInterval(statusPollTimer);
    if (deliveryStatusChannel) {
      try { db.removeChannel(deliveryStatusChannel); } catch {}
      deliveryStatusChannel = null;
    }

  }catch(e){
    console.error(e);
    Swal.fire({ icon:'error', title:'ูุดู ุงูุชุณููู', text: e?.message || 'OTP ุบูุท ุฃู ุบูุฑ ูุณููุญ' });
  }
}

/* ================== WALLET (Pi) ================== */
/**
 * โ ุฃููุงู: delivery_wallet.balance_pi
 * โ ุฎุตู ุงููุณุญูุจุงุช: withdrawals
 * โ fallback: ุญุณุงุจ ุฃุฑุจุงุญ ุงูุฏูููุฑู ูู orders delivered (total_pi - platform_fee_pi)
 */
function toNum(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

function calcDeliveryEarningsPi(order) {
  const snap = order?.pricing_snapshot || {};
  const totalPi = toNum(snap.total_pi);
  const platformFeePi = toNum(snap.platform_fee_pi);
  
  // ุงูุฃูุถู: snapshot ููุฌูุฏ
  if (totalPi > 0) return Math.max(0, totalPi - platformFeePi);
  
  // fallback (ูู snapshot ูุงูุต)
  const priceEgp = toNum(order?.price);
  const deliveryFeeEgp = toNum(order?.delivery_fee);
  const totalPriceEgp = toNum(order?.total_price);
  const platformFeeEgp = toNum(order?.platform_fee);
  
  const baseEgp = (priceEgp || deliveryFeeEgp) ?
    (priceEgp + deliveryFeeEgp) :
    Math.max(0, totalPriceEgp - platformFeeEgp);
  
  const piEgp = toNum(snap.pi_egp);
  if (baseEgp > 0 && piEgp > 0) return baseEgp / piEgp;
  
  return 0;
}

async function getWithdrawnSum() {
  if (!PI_UID) return 0;
  const { data, error } = await db.from('withdrawals')
    .select('amount')
    .eq('pi_user_id', PI_UID)
    .limit(1000);
  
  if (error) throw error;
  
  let sum = 0;
  (data || []).forEach(w => {
    sum += toNum(w.amount);
  });
  return sum;
}

async function loadWalletPi() {
  try {
    if (!PI_USERNAME) return;
    
    // 1) ุฎุตู ุงููุณุญูุจุงุช
    const withdrawnSum = await getWithdrawnSum();
    
    // 2) ูุญุงููุฉ ูู delivery_wallet
    try {
      const { data, error } = await db.from('delivery_wallet')
        .select('balance_pi')
        .eq('delivery_id', PI_USERNAME)
        .maybeSingle();
      
      if (!error && data && typeof data.balance_pi !== 'undefined') {
        const available = Math.max(0, toNum(data.balance_pi) - withdrawnSum);
        document.getElementById('walletPi').innerText = available.toFixed(6);
        return;
      }
    } catch (_) {
      // ุชุฌุงูู ููููู fallback
    }
    
    // 3) fallback: ูู orders delivered
    const { data: orders, error: e2 } = await db.from('orders')
      .select('pricing_snapshot,status,delivery_id,price,delivery_fee,total_price,platform_fee')
      .eq('delivery_id', PI_USERNAME)
      .eq('status', 'delivered')
      .limit(1000);
    
    if (e2) throw e2;
    
    let earned = 0;
    (orders || []).forEach(o => {
      earned += calcDeliveryEarningsPi(o);
    });
    
    const available = Math.max(0, earned - withdrawnSum);
    document.getElementById('walletPi').innerText = available.toFixed(6);
    
  } catch (e) {
    console.warn(e);
    document.getElementById('walletPi').innerText = '0.000000';
  }
}

/* ================== WITHDRAW ================== */
/**
 * โ Flow ุงูุตุญูุญ:
 * 1) Call /api/withdraw -> Netlify function (withdraw.js)
 * 2) ูู ูุฌุญ: ูุธูุฑ TX ูุจุงุดุฑุฉ
 */
async function withdrawPi() {
  try {
    if (!PI_USERNAME) return Swal.fire('ุณุฌูู ุฏุฎูู');
    if (!PI_UID) return Swal.fire('ุชุนุฐุฑ ูุฑุงุกุฉ ูููุฉ Piุ ุฌุฑูุจ ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู');
    
    const amount = parseFloat(document.getElementById('wdAmountPi').value || "0");
    const walletAddress = (document.getElementById('wdWallet').value || '').trim();
    
    if (!amount || amount <= 0) return Swal.fire('ุงูุชุจ ูููุฉ Pi ุตุญูุญุฉ');
    if (!walletAddress || walletAddress.length < 10) return Swal.fire('ุงูุชุจ ุนููุงู ูุญูุธุฉ Pi ุตุญูุญ');
    
    const available = parseFloat(document.getElementById('walletPi').innerText || "0") || 0;
    if (amount > available) return Swal.fire('ุงููุจูุบ ุฃูุจุฑ ูู ุงูุฑุตูุฏ ุงููุชุงุญ');
    
    const ok = await Swal.fire({
      icon: 'question',
      title: 'ุชุฃููุฏ ุงูุณุญุจ',
      html: `
        <div style="text-align:right">
          <div>ูุชุณุญุจ: <b class="mono">${amount.toFixed(6)} Pi</b></div>
          <div style="margin-top:6px">
            ุฅูู:
            <span class="mono" style="font-size:12px;opacity:.85;display:block;word-break:break-all">
              ${escapeHtml(walletAddress)}
            </span>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'ุณุญุจ ุงูุขู',
      cancelButtonText: 'ุฅูุบุงุก'
    });
    if (!ok.isConfirmed) return;
    
    Swal.fire({ title: 'ุฌุงุฑู ุชูููุฐ ุงูุชุญููู ุนูู ุงูุดุจูุฉ...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
      
    // Call server function (Netlify redirect -> /.netlify/functions/withdraw)
    const res = await fetch('/api/withdraw', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        uid: PI_UID,
        username: PI_USERNAME,
        amount,
        walletAddress
      })
    });
      
    const out = await res.json().catch(() => ({}));
    if (!res.ok || !out?.success) {
      const msg = out?.error || out?.details || 'ูุดู ุงูุณุญุจ';
      throw new Error(msg);
    }
      
    Swal.fire({ icon: 'success', title: 'ุชู ุงูุณุญุจ โ', text: `TX: ${out.txid}` });
    
    document.getElementById('wdAmountPi').value = '';
    document.getElementById('wdWallet').value = '';
    
    await loadWalletPi();
    await loadWithdrawHistory();
    
  } catch (e) {
    console.error(e);
    Swal.fire({ icon: 'error', title: 'ูุดู ุทูุจ ุงูุณุญุจ', text: e?.message || 'ุญุตู ุฎุทุฃ' });
  }
}

/* ================== WITHDRAW HISTORY ================== */
async function loadWithdrawHistory() {
  try {
    if (!PI_USERNAME) return;
    if (!PI_UID) return;
      
    const box = document.getElementById('wdHistory');
    if (!box) return;
      
    box.innerHTML = `<div class="tiny muted">ุฌุงุฑู ุงูุชุญููู...</div>`;
      
    const { data, error } = await db.from('withdrawals')
      .select('id,amount,wallet_address,created_at,txid')
      .eq('pi_user_id', PI_UID)
      .order('created_at', { ascending: false })
      .limit(50);
    
    if (error) throw error;
    
    if (!data || !data.length) {
      box.innerHTML = `<div class="tiny muted">ูุง ููุฌุฏ ุทูุจุงุช ุณุญุจ.</div>`;
      return;
    }
    
    box.innerHTML = data.map(w => `
      <div class="soft p-3 space-y-1">
        <div class="row">
          <b class="mono text-emerald-500">${Number(w.amount||0).toFixed(6)} Pi</b>
          <span class="chip chipG">ููุชูู</span>
        </div>

        <div class="tiny muted break-all">
          <b>ุงูุนููุงู:</b>
          <span class="mono">${escapeHtml(w.wallet_address || '-')}</span>
        </div>

        ${w.txid ? `
          <div class="tiny muted break-all">
            <b>TX:</b>
            <span class="mono">${escapeHtml(w.txid)}</span>
          </div>` : ``}
      </div>
    `).join('');
    
  } catch (e) {
    console.error(e);
    const box = document.getElementById('wdHistory');
    if (box) {
      box.innerHTML = `<div class="tiny" style="color:#fca5a5">ูุดู ุชุญููู ุณุฌู ุงูุณุญุจ</div>`;
    }
  }
}
/* ================== HISTORY: CUSTOMER + DELIVERY ================== */
async function loadCustomerHistory(){
  try{
    if(!PI_USERNAME) return;
    const box = document.getElementById('custHistory');
    box.innerHTML = `<div class="tiny">ุฌุงุฑู ุงูุชุญููู...</div>`;

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,total_price,status,created_at,pricing_snapshot,delivery_id')
      .eq('customer_pi_username', PI_USERNAME)
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data?.length){
      box.innerHTML = `<div class="tiny">ูุง ููุฌุฏ ุทูุจุงุช ุจุนุฏ.</div>`;
      return;
    }

    const orderIds = data.map(o => o.id);
    let ratingMap = {};
    if (orderIds.length) {
      const { data: ratings } = await db.from('delivery_ratings')
        .select('order_id,rating')
        .in('order_id', orderIds);
      (ratings || []).forEach(r => {
        ratingMap[r.order_id] = r.rating;
      });
    }

    box.innerHTML = data.map(o => {
      const totalEgp = Number(o.total_price||0);
      const totalPi = Number(o?.pricing_snapshot?.total_pi || (egpToPi(totalEgp) || 0));
      const s = o.status || 'pending';
      const rating = ratingMap[o.id];

      const color =
        s==='delivered' ? 'text-emerald-500' :
        s==='canceled' ? 'text-red-400' :
        'text-emerald-600';

      return `
        <div class="soft p-3">
          <div class="row">
            <b>${escapeHtml(o.product_name)}</b>
            <span class="chip ${color}">${escapeHtml(s)}</span>
          </div>
          <div class="tiny mt-1">ููุน: <b>${escapeHtml(o.order_type||'any')}</b>${o.delivery_id ? ` | ูุงุจุชู: <b>${escapeHtml(o.delivery_id)}</b>` : ``}</div>
          <div class="row mt-1">
            <span class="tiny">ุงูุฅุฌูุงูู</span>
            <b class="text-emerald-500">${totalEgp.toFixed(2)} ุฌ</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">ุจุงูู Pi</span>
            <b class="mono text-emerald-600">${Number(totalPi||0).toFixed(6)} Pi</b>
          </div>
          ${typeof rating === 'number' ? `<div class="tiny mt-1">ุชูููู ุงููุงุจุชู: <b>${rating}</b> โญ</div>` : ``}
          <div class="tiny mt-1">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
        </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('custHistory').innerHTML = `<div class="tiny" style="color:#fca5a5">ูุดู ุชุญููู ุณุฌู ุงูุทูุจุงุช</div>`;
  }
}

async function loadDeliveryHistory(){
  try{
    if(!PI_USERNAME) return;
    const box = document.getElementById('delHistory');
    box.innerHTML = `<div class="tiny">ุฌุงุฑู ุงูุชุญููู...</div>`;

    const { data, error } = await db.from('orders')
      .select('id,product_name,order_type,total_price,status,created_at,pricing_snapshot,customer_pi_username')
      .eq('delivery_id', PI_USERNAME)
      .order('created_at', { ascending:false })
      .limit(50);

    if(error) throw error;

    if(!data?.length){
      box.innerHTML = `<div class="tiny">ูุง ููุฌุฏ ุทูุจุงุช ูุณุฌูุฉ ุนููู ุจุนุฏ.</div>`;
      const statOrders = document.getElementById('statOrders');
      if (statOrders) statOrders.innerText = '0';
      return;
    }

    const statOrders = document.getElementById('statOrders');
    if (statOrders) statOrders.innerText = String(data.length);

    const orderIds = data.map(o => o.id);
    let ratingMap = {};
    if (orderIds.length) {
      const { data: ratings } = await db.from('delivery_ratings')
        .select('order_id,rating')
        .in('order_id', orderIds);
      (ratings || []).forEach(r => {
        ratingMap[r.order_id] = r.rating;
      });
    }

    const ratingValues = Object.values(ratingMap).filter(v => typeof v === 'number');
    const statRating = document.getElementById('statRating');
    if (statRating) {
      if (ratingValues.length) {
        const avg = ratingValues.reduce((sum, v) => sum + v, 0) / ratingValues.length;
        statRating.innerText = avg.toFixed(1);
      } else {
        statRating.innerText = 'โ';
      }
    }

    box.innerHTML = data.map(o => {
      const totalEgp = Number(o.total_price||0);
      const totalPi = Number(o?.pricing_snapshot?.total_pi || (egpToPi(totalEgp) || 0));
      const profitPi = Number(o?.pricing_snapshot?.delivery_fee_pi || 0);
      const s = o.status || 'pending';
      const rating = ratingMap[o.id];

      return `
        <div class="soft p-3">
          <div class="row">
            <b>${escapeHtml(o.product_name)}</b>
            <span class="chip">${escapeHtml(s)}</span>
          </div>
          <div class="tiny mt-1">ุนููู: <b>${escapeHtml(o.customer_pi_username||'โ')}</b></div>
          <div class="row mt-1">
            <span class="tiny">ุงูุฅุฌูุงูู</span>
            <b class="text-emerald-500">${totalEgp.toFixed(2)} ุฌ</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">ุจุงูู Pi</span>
            <b class="mono text-emerald-600">${Number(totalPi||0).toFixed(6)} Pi</b>
          </div>
          <div class="row mt-1">
            <span class="tiny">ุฑุจุญู</span>
            <b class="mono text-emerald-600">${profitPi.toFixed(6)} Pi</b>
          </div>
          ${typeof rating === 'number' ? `<div class="tiny mt-1">ุชููููู: <b>${rating}</b> โญ</div>` : ``}
          <div class="tiny mt-1">${new Date(o.created_at).toLocaleString('ar-EG')}</div>
        </div>
      `;
    }).join('');

  }catch(e){
    console.error(e);
    document.getElementById('delHistory').innerHTML = `<div class="tiny" style="color:#fca5a5">ูุดู ุชุญููู ุณุฌู ุงูุฏูููุฑู</div>`;
  }
}

/* ================== UI ================== */
function toggleRole(){
  setRole(ACTIVE_ROLE === 'customer' ? 'delivery' : 'customer');
}

function setRole(role){
  ACTIVE_ROLE = role;
  updateRoleUI();
}

function setMainTab(tab){
  ACTIVE_MAIN_TAB = tab;
  updateMainTabUI();
}

function updateRoleUI(){
  const isCustomer = ACTIVE_ROLE === 'customer';
  document.getElementById('roleToggle').innerText = isCustomer ? 'User' : 'Delivery';
  document.getElementById('customerHome').classList.toggle('hidden', !isCustomer);
  document.getElementById('deliveryHome').classList.toggle('hidden', isCustomer);
  document.getElementById('customerTrackTab').classList.toggle('hidden', !isCustomer);
  document.getElementById('deliveryTrackTab').classList.toggle('hidden', isCustomer);

  if(isCustomer){
    loadCustomerHistory();
  } else {
    loadOrders();
    loadWalletPi();
    loadWithdrawHistory();
    loadDeliveryHistory();
  }
}

function updateMainTabUI(){
  const isHome = ACTIVE_MAIN_TAB === 'home';
  const isTrack = ACTIVE_MAIN_TAB === 'track';
  const isDiscover = ACTIVE_MAIN_TAB === 'discover';
  document.getElementById('homeTab').classList.toggle('hidden', !isHome);
  document.getElementById('trackTab').classList.toggle('hidden', !isTrack);
  document.getElementById('discoverTab').classList.toggle('hidden', !isDiscover);
  document.getElementById('navHome').classList.toggle('btnA', isHome);
  document.getElementById('navHome').classList.toggle('btnS', !isHome);
  document.getElementById('navTrack').classList.toggle('btnA', isTrack);
  document.getElementById('navTrack').classList.toggle('btnS', !isTrack);
  document.getElementById('navDiscover').classList.toggle('btnA', isDiscover);
  document.getElementById('navDiscover').classList.toggle('btnS', !isDiscover);
}

/* ================== HELPERS ================== */
function escapeHtml(str){
  return String(str ?? '').replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}
  </script>
</body>
</html>
