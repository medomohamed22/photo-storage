<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† | Ø·Ù„Ø¨Ø§Øª Ø¨Ø±Ùˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
    body{font-family:Tajawal,system-ui;background:#f3f4f6}
    .card{background:#fff;border-radius:16px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New", monospace}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;display:inline-flex;gap:6px;align-items:center}
    .btn{padding:8px 10px;border-radius:10px;font-weight:700;font-size:12px}
    .btnG{background:#16a34a;color:#fff}
    .btnR{background:#dc2626;color:#fff}
    .btnB{background:#2563eb;color:#fff}
    .btnS{background:#111827;color:#fff}
    .btnW{background:#fff;border:1px solid #e5e7eb}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #e5e7eb;padding:8px;white-space:nowrap}
    th{background:#f9fafb;text-align:right}
    .input{border:1px solid #e5e7eb;border-radius:12px;padding:8px 10px;font-size:13px}
  </style>
</head>

<body class="pb-24">

<header class="bg-gray-900 text-white p-4">
  <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
    <div class="font-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” Ø·Ù„Ø¨Ø§Øª Ø¨Ø±Ùˆ</div>
    <div class="flex gap-2 flex-wrap">
      <button class="btn btnW" onclick="refreshAll()">ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ„</button>
      <button class="btn btnW" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
</header>

<div class="max-w-6xl mx-auto p-4 space-y-6">

  <!-- STATS -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
    <div class="card text-center">
      <div class="text-gray-500 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
      <div id="statOrders" class="text-2xl font-bold">â€”</div>
      <div class="text-[11px] text-gray-400 mt-1">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
    </div>

    <div class="card text-center">
      <div class="text-gray-500 text-sm">Pi Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
      <div id="statOrdersPi" class="text-2xl font-bold mono text-purple-700">â€”</div>
      <div class="text-[11px] text-gray-400 mt-1">pricing_snapshot.total_pi</div>
    </div>

    <div class="card text-center">
      <div class="text-gray-500 text-sm">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨</div>
      <div id="statWithdraws" class="text-2xl font-bold text-blue-600">â€”</div>
      <div class="text-[11px] text-gray-400 mt-1">pending/approved/paid</div>
    </div>

    <div class="card text-center">
      <div class="text-gray-500 text-sm">Pi Ù…Ø³Ø­ÙˆØ¨</div>
      <div id="statWithdrawPi" class="text-2xl font-bold mono text-orange-600">â€”</div>
      <div class="text-[11px] text-gray-400 mt-1">withdraw_requests.amount_pi</div>
    </div>
  </div>

  <!-- FILTER BAR -->
  <div class="card flex flex-col md:flex-row gap-2 md:items-center md:justify-between">
    <div class="flex gap-2 flex-wrap items-center">
      <span class="badge">ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
      <select id="ordersFilter" class="input" onchange="loadOrders()">
        <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
        <option value="pending">pending</option>
        <option value="accepted">accepted</option>
        <option value="shipping">shipping</option>
        <option value="arrived">arrived</option>
        <option value="delivered">delivered</option>
        <option value="canceled">canceled</option>
      </select>

      <input id="searchUser" class="input w-64"
        placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„ÙƒØ§Ø¨ØªÙ†..." oninput="loadOrders()"/>
    </div>

    <div class="flex gap-2 flex-wrap items-center">
      <span class="badge">ğŸ’¸ Ø§Ù„Ø³Ø­Ø¨</span>
      <select id="wdFilter" class="input" onchange="loadWithdraws()">
        <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
        <option value="pending">pending</option>
        <option value="approved">approved</option>
        <option value="paid">paid</option>
        <option value="rejected">rejected</option>
      </select>
    </div>
  </div>

  <!-- ORDERS -->
  <div class="card">
    <div class="flex items-center justify-between mb-3 gap-2">
      <b>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</b>
      <div class="flex gap-2 flex-wrap">
        <button class="btn btnW" onclick="loadOrders()">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>

    <div class="overflow-auto">
      <table class="text-sm">
        <thead>
          <tr>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
            <th>Ø§Ù„ÙƒØ§Ø¨ØªÙ†</th>
            <th>EGP</th>
            <th>Pi</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="ordersTable"></tbody>
      </table>
    </div>
  </div>

  <!-- WITHDRAWS -->
  <div class="card">
    <div class="flex items-center justify-between mb-3 gap-2">
      <b>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ (Pi)</b>
      <div class="flex gap-2 flex-wrap">
        <button class="btn btnW" onclick="loadWithdraws()">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>

    <div class="overflow-auto">
      <table class="text-sm">
        <thead>
          <tr>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„ÙƒØ§Ø¨ØªÙ†</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº (Pi)</th>
            <th>Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© Pi</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="withdrawTable"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
/* ========== CONFIG ========== */
const SUPABASE_URL = 'https://axjkwrssmofzavaoqutq.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_tiuMncgWhf1YRWoD-uYQ3Q_ziI8OKci';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ========== AUTH GUARD (ADMIN ONLY) ========== */
async function guardAdmin(){
  try{
    const { data, error } = await db.auth.getSession();
    if(error) throw error;

    const session = data?.session;
    if(!session){
      location.href = './login.html';
      return;
    }

    const uid = session.user.id;

    // Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ admins
    const { data: adminRow, error: e2 } = await db
      .from('admins')
      .select('user_id')
      .eq('user_id', uid)
      .maybeSingle();

    if(e2) throw e2;
    if(!adminRow){
      await db.auth.signOut();
      location.href = './login.html';
      return;
    }
  }catch(e){
    console.error(e);
    try{ await db.auth.signOut(); }catch{}
    location.href = './login.html';
  }
}

async function logout(){
  await db.auth.signOut();
  location.href = './login.html';
}

/* ========== HELPERS ========== */
function esc(s){
  return String(s ?? '').replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}
function fmtDate(ts){
  try{ return new Date(ts).toLocaleString('ar-EG'); }catch{ return ts; }
}
function badgeStatus(s){
  const cls =
    s==='pending' ? 'bg-yellow-50 text-yellow-700 border-yellow-200' :
    s==='accepted' ? 'bg-green-50 text-green-700 border-green-200' :
    s==='shipping' ? 'bg-orange-50 text-orange-700 border-orange-200' :
    s==='arrived' ? 'bg-blue-50 text-blue-700 border-blue-200' :
    s==='delivered' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' :
    s==='canceled' ? 'bg-red-50 text-red-700 border-red-200' :
    'bg-gray-50 text-gray-700 border-gray-200';

  return `<span class="badge ${cls}">${esc(s)}</span>`;
}

/* ========== STATS ========== */
async function loadStats(){
  const { data: orders, error: e1 } = await db.from('orders').select('status,pricing_snapshot');
  const { data: wds, error: e2 } = await db.from('withdraw_requests').select('status,amount_pi');

  if(e1) console.warn(e1);
  if(e2) console.warn(e2);

  const totalOrders = orders?.length || 0;
  const ordersPi = (orders||[]).reduce((sum,o)=> sum + (Number(o?.pricing_snapshot?.total_pi)||0), 0);

  const totalWithdraws = wds?.length || 0;
  const withdrawPi = (wds||[]).reduce((sum,w)=> sum + (Number(w?.amount_pi)||0), 0);

  document.getElementById('statOrders').innerText = totalOrders;
  document.getElementById('statOrdersPi').innerText = ordersPi.toFixed(3);
  document.getElementById('statWithdraws').innerText = totalWithdraws;
  document.getElementById('statWithdrawPi').innerText = withdrawPi.toFixed(3);
}

/* ========== ORDERS ========== */
async function loadOrders(){
  const statusFilter = document.getElementById('ordersFilter').value;
  const q = document.getElementById('searchUser').value.trim().toLowerCase();

  let query = db.from('orders')
    .select('id,created_at,product_name,order_type,customer_pi_username,delivery_id,total_price,status,pricing_snapshot')
    .order('created_at',{ascending:false})
    .limit(200);

  if(statusFilter !== 'all') query = query.eq('status', statusFilter);

  const { data, error } = await query;
  const tb = document.getElementById('ordersTable');

  if(error){
    console.error(error);
    tb.innerHTML = `<tr><td colspan="9" class="p-3 text-center text-red-600">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${esc(error.message)}</td></tr>`;
    return;
  }

  const filtered = (data||[]).filter(o=>{
    if(!q) return true;
    const a = (o.customer_pi_username||'').toLowerCase();
    const b = (o.delivery_id||'').toLowerCase();
    return a.includes(q) || b.includes(q);
  });

  tb.innerHTML = filtered.map(o=>{
    const pi = Number(o?.pricing_snapshot?.total_pi || 0);
    const egp = Number(o?.total_price || 0);

    return `
      <tr>
        <td>${esc(fmtDate(o.created_at))}</td>
        <td><b>${esc(o.product_name)}</b></td>
        <td>${esc(o.order_type || 'any')}</td>
        <td>${esc(o.customer_pi_username || '-')}</td>
        <td>${esc(o.delivery_id || '-')}</td>
        <td class="mono">${egp.toFixed(2)}</td>
        <td class="mono text-purple-700">${pi ? pi.toFixed(3) : 'â€”'}</td>
        <td>${badgeStatus(o.status)}</td>
        <td>
          <div class="flex gap-1 flex-wrap">
            <button class="btn btnB" onclick="setOrderStatus('${o.id}','shipping')">shipping</button>
            <button class="btn btnB" onclick="setOrderStatus('${o.id}','arrived')">arrived</button>
            <button class="btn btnG" onclick="setOrderStatus('${o.id}','delivered')">delivered</button>
            <button class="btn btnR" onclick="setOrderStatus('${o.id}','canceled')">cancel</button>
          </div>
        </td>
      </tr>
    `;
  }).join('') || `<tr><td colspan="9" class="p-3 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;

  loadStats();
}

async function setOrderStatus(id, st){
  const ok = await Swal.fire({
    icon:'question',
    title:'ØªØ£ÙƒÙŠØ¯',
    text:`ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰: ${st} ØŸ`,
    showCancelButton:true,
    confirmButtonText:'Ù†Ø¹Ù…',
    cancelButtonText:'Ø¥Ù„ØºØ§Ø¡'
  });
  if(!ok.isConfirmed) return;

  const { error } = await db.from('orders').update({ status: st }).eq('id', id);
  if(error){
    console.error(error);
    return Swal.fire('Ø®Ø·Ø£', error.message, 'error');
  }
  Swal.fire('ØªÙ…', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', 'success');
  loadOrders();
}

/* ========== WITHDRAWS ========== */
async function loadWithdraws(){
  const st = document.getElementById('wdFilter').value;

  let q = db.from('withdraw_requests')
    .select('id,created_at,delivery_id,amount_pi,wallet_address,status,note')
    .order('created_at',{ascending:false})
    .limit(200);

  if(st !== 'all') q = q.eq('status', st);

  const { data, error } = await q;
  const tb = document.getElementById('withdrawTable');

  if(error){
    console.error(error);
    tb.innerHTML = `<tr><td colspan="6" class="p-3 text-center text-red-600">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨: ${esc(error.message)}</td></tr>`;
    return;
  }

  tb.innerHTML = (data||[]).map(w=>{
    const amountPi = Number(w.amount_pi || 0).toFixed(3);
    const wallet = w.wallet_address || '-';

    const actions = `
      <div class="flex gap-1 flex-wrap">
        ${w.status==='pending' ? `<button class="btn btnB" onclick="approveWithdraw('${w.id}')">Ù…ÙˆØ§ÙÙ‚Ø©</button>` : ''}
        ${w.status==='approved' ? `<button class="btn btnS" onclick="markPaid('${w.id}')">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button>` : ''}
        ${(w.status==='pending' || w.status==='approved') ? `<button class="btn btnR" onclick="rejectWithdraw('${w.id}')">Ø±ÙØ¶</button>` : ''}
        <button class="btn btnW" onclick="copyText('${esc(wallet)}')">Ù†Ø³Ø® Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</button>
      </div>
    `;

    return `
      <tr>
        <td>${esc(fmtDate(w.created_at))}</td>
        <td><b>${esc(w.delivery_id)}</b></td>
        <td class="mono text-purple-700">${amountPi} Pi</td>
        <td class="mono" style="max-width:320px;overflow:hidden;text-overflow:ellipsis">${esc(wallet)}</td>
        <td>${badgeStatus(w.status)}</td>
        <td>${actions}</td>
      </tr>
    `;
  }).join('') || `<tr><td colspan="6" class="p-3 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;

  loadStats();
}

function copyText(t){
  navigator.clipboard?.writeText(t);
  Swal.fire({icon:'success', title:'ØªÙ… Ø§Ù„Ù†Ø³Ø®', timer:900, showConfirmButton:false});
}

async function approveWithdraw(id){
  const ok = await Swal.fire({
    icon:'question',
    title:'Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø¨ØŸ',
    text:'Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ approved',
    showCancelButton:true,
    confirmButtonText:'Ù…ÙˆØ§ÙÙ‚Ø©',
    cancelButtonText:'Ø¥Ù„ØºØ§Ø¡'
  });
  if(!ok.isConfirmed) return;

  const { error } = await db.from('withdraw_requests').update({ status:'approved' }).eq('id', id);
  if(error) return Swal.fire('Ø®Ø·Ø£', error.message, 'error');

  Swal.fire('ØªÙ…', 'ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©', 'success');
  loadWithdraws();
}

/**
 * markPaid:
 * - ÙŠØºÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ Ø¥Ù„Ù‰ paid
 * - ÙŠØ®ØµÙ… amount_pi Ù…Ù† delivery_wallet.balance_pi
 */
async function markPaid(id){
  try{
    const { data: w, error: e1 } = await db.from('withdraw_requests')
      .select('id,delivery_id,amount_pi,status')
      .eq('id', id)
      .single();

    if(e1) throw e1;
    if(!w) throw new Error('Withdraw not found');
    if(w.status !== 'approved') return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† approved Ø§Ù„Ø£ÙˆÙ„','warning');

    const ok = await Swal.fire({
      icon:'warning',
      title:'ØªØ£ÙƒÙŠØ¯ ØªÙ… Ø§Ù„Ø¯ÙØ¹',
      html:`Ø³ÙŠØªÙ… Ø®ØµÙ… <b class="mono">${Number(w.amount_pi).toFixed(3)} Pi</b> Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„ÙƒØ§Ø¨ØªÙ† <b>${esc(w.delivery_id)}</b>`,
      showCancelButton:true,
      confirmButtonText:'ØªÙ… Ø§Ù„Ø¯ÙØ¹',
      cancelButtonText:'Ø¥Ù„ØºØ§Ø¡'
    });
    if(!ok.isConfirmed) return;

    const { data: wal, error: e2 } = await db.from('delivery_wallet')
      .select('balance_pi')
      .eq('delivery_id', w.delivery_id)
      .maybeSingle();
    if(e2) throw e2;

    const cur = Number(wal?.balance_pi || 0);
    const amt = Number(w.amount_pi || 0);

    if(amt <= 0) return Swal.fire('Ø®Ø·Ø£','amount_pi ØºÙŠØ± ØµØ­ÙŠØ­','error');
    if(cur < amt) return Swal.fire('Ø®Ø·Ø£','Ø±ØµÙŠØ¯ Ø§Ù„ÙƒØ§Ø¨ØªÙ† ØºÙŠØ± ÙƒØ§ÙÙŠ','error');

    const { error: e3 } = await db.from('delivery_wallet')
      .update({ balance_pi: (cur - amt) })
      .eq('delivery_id', w.delivery_id);
    if(e3) throw e3;

    const { error: e4 } = await db.from('withdraw_requests')
      .update({ status:'paid' })
      .eq('id', id);
    if(e4) throw e4;

    Swal.fire('ØªÙ…','ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ ÙˆØ®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯','success');
    loadWithdraws();

  }catch(e){
    console.error(e);
    Swal.fire('Ø®Ø·Ø£', e?.message || 'Ø­ØµÙ„ Ø®Ø·Ø£', 'error');
  }
}

async function rejectWithdraw(id){
  const { value: note } = await Swal.fire({
    title:'Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
    input:'text',
    inputPlaceholder:'Ù…Ø«Ø§Ù„: Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± ØµØ­ÙŠØ­',
    showCancelButton:true,
    confirmButtonText:'Ø±ÙØ¶',
    cancelButtonText:'Ø¥Ù„ØºØ§Ø¡'
  });
  if(note === undefined) return;

  const { error } = await db.from('withdraw_requests')
    .update({ status:'rejected', note: note || null })
    .eq('id', id);

  if(error) return Swal.fire('Ø®Ø·Ø£', error.message, 'error');

  Swal.fire('ØªÙ…','ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨','info');
  loadWithdraws();
}

/* ========== INIT ========== */
async function refreshAll(){
  await Promise.allSettled([loadOrders(), loadWithdraws(), loadStats()]);
}

(async ()=>{
  await guardAdmin();
  await refreshAll();
})();
</script>

</body>
</html>
